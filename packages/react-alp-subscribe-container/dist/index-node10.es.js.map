{"version":3,"file":"index-node10.es.js","sources":["../src/index.ts"],"sourcesContent":["import React, { Component, ReactNode } from 'react';\nimport Logger from 'nightingale-logger';\nimport ReactAlpContext from 'react-alp-context';\n\nconst logger = new Logger('react-alp-subscribe-container');\n\nexport interface SubscribeContainerProps {\n  children: ReactNode;\n  onEvent: (e: any) => any;\n  name?: string;\n  names?: Array<string>;\n  visibleTimeout?: number;\n}\n\nexport default class SubscribeContainer extends Component<\n  SubscribeContainerProps\n> {\n  static defaultProps = {\n    visibleTimeout: 1000 * 60 * 2, // 2 minutes\n  };\n\n  static contextType = ReactAlpContext;\n\n  // eslint-disable-next-line react/sort-comp\n  context!: React.ContextType<typeof ReactAlpContext>;\n\n  subscribed: boolean = false;\n\n  timeout: number | undefined = undefined;\n\n  componentDidMount() {\n    const websocket = this.getWebsocket();\n    websocket.on('connect', this.subscribe);\n    if (websocket.isConnected()) {\n      this.subscribe();\n    }\n    document.addEventListener(\n      'visibilitychange',\n      this.handleVisibilityChange,\n      false,\n    );\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener(\n      'visibilitychange',\n      this.handleVisibilityChange,\n      false,\n    );\n    this.getWebsocket().off('connect', this.subscribe);\n    this.unsubscribe();\n  }\n\n  handleVisibilityChange = () => {\n    if (!document.hidden) {\n      if (this.timeout != null) {\n        logger.log('timeout cleared', {\n          names: this.props.names,\n          name: this.props.name,\n        });\n        clearTimeout(this.timeout);\n      } else {\n        logger.debug('resubscribe', {\n          names: this.props.names,\n          name: this.props.name,\n        });\n        this.subscribe();\n      }\n      return;\n    }\n\n    if (!this.subscribed) return;\n\n    logger.log('timeout visible', {\n      names: this.props.names,\n      name: this.props.name,\n    });\n    this.timeout = setTimeout(this.unsubscribe, this.props.visibleTimeout);\n  };\n\n  subscribe = () => {\n    if (document.hidden) return;\n\n    logger.log('subscribe', { names: this.props.names, name: this.props.name });\n    this.subscribed = true;\n    const names = this.props.names || [this.props.name];\n    const websocket = this.getWebsocket();\n    names.forEach((name) =>\n      websocket.emit(`subscribe:${name}`).then(this.props.onEvent),\n    );\n  };\n\n  unsubscribe = () => {\n    this.timeout = undefined;\n    if (!this.subscribed) return;\n    logger.log('unsubscribe', {\n      names: this.props.names,\n      name: this.props.name,\n    });\n    this.subscribed = false;\n    const names = this.props.names || [this.props.name];\n    const websocket = this.getWebsocket();\n    if (websocket.isConnected()) {\n      names.forEach((name) => websocket.emit(`unsubscribe:${name}`));\n    }\n  };\n\n  getWebsocket() {\n    return this.context.app.websocket;\n  }\n\n  render() {\n    return this.props.children;\n  }\n}\n"],"names":["logger","Logger","SubscribeContainer","Component","subscribed","timeout","undefined","handleVisibilityChange","document","hidden","log","names","props","name","clearTimeout","debug","subscribe","setTimeout","unsubscribe","visibleTimeout","websocket","getWebsocket","forEach","emit","then","onEvent","isConnected","componentDidMount","on","addEventListener","componentWillUnmount","removeEventListener","off","context","app","render","children","defaultProps","contextType","ReactAlpContext"],"mappings":"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"}