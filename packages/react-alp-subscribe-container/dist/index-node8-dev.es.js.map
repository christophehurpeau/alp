{"version":3,"file":"index-node8-dev.es.js","sources":["../src/SubscribeContainer.tsx","../src/index.ts"],"sourcesContent":["import { Component, ReactElement } from 'react';\nimport { Dispatch, AnyAction } from 'redux';\nimport PropTypes from 'prop-types';\nimport Logger from 'nightingale-logger';\n\nconst logger = new Logger('react-alp-subscribe-container');\n\nexport interface OwnProps {\n  children: ReactElement<any>;\n  // eslint-disable-next-line no-restricted-globals\n  name?: string;\n  names?: Array<string>;\n  visibleTimeout?: number;\n}\n\nexport interface ConnectProps {\n  dispatch: Dispatch<any>;\n}\n\nexport default class SubscribeContainer extends Component<OwnProps & ConnectProps, never> {\n  static defaultProps = {\n    visibleTimeout: 1000 * 60 * 2, // 2 minutes\n  };\n\n  static contextTypes = {\n    context: PropTypes.object,\n  };\n\n  subscribed: boolean = false;\n  timeout: number | undefined = undefined;\n\n  componentDidMount() {\n    const websocket = this.getWebsocket();\n    websocket.on('connect', this.subscribe);\n    if (websocket.isConnected()) {\n      this.subscribe();\n    }\n    document.addEventListener('visibilitychange', this.handleVisibilityChange, false);\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('visibilitychange', this.handleVisibilityChange, false);\n    this.getWebsocket().off('connect', this.subscribe);\n    this.unsubscribe();\n  }\n\n  getWebsocket() {\n    return this.context.context.app.websocket;\n  }\n\n  handleVisibilityChange = () => {\n    if (!document.hidden) {\n      if (this.timeout != null) {\n        logger.log('timeout cleared', {\n          names: this.props.names,\n          name: this.props.name,\n        });\n        clearTimeout(this.timeout);\n      } else {\n        logger.debug('resubscribe', {\n          names: this.props.names,\n          name: this.props.name,\n        });\n        this.subscribe();\n      }\n      return;\n    }\n\n    if (!this.subscribed) return;\n\n    logger.log('timeout visible', {\n      names: this.props.names,\n      name: this.props.name,\n    });\n    this.timeout = setTimeout(this.unsubscribe, this.props.visibleTimeout);\n  };\n\n  subscribe = () => {\n    if (document.hidden) return;\n\n    logger.log('subscribe', { names: this.props.names, name: this.props.name });\n    this.subscribed = true;\n    const { dispatch } = this.props;\n    const names = this.props.names || [this.props.name];\n    const websocket = this.getWebsocket();\n    names.forEach(name =>\n      websocket.emit(`subscribe:${name}`).then((action: AnyAction) => action && dispatch(action)),\n    );\n  };\n\n  unsubscribe = () => {\n    this.timeout = undefined;\n    if (!this.subscribed) return;\n    logger.log('unsubscribe', {\n      names: this.props.names,\n      name: this.props.name,\n    });\n    this.subscribed = false;\n    const names = this.props.names || [this.props.name];\n    const websocket = this.getWebsocket();\n    if (websocket.isConnected()) {\n      names.forEach(name => websocket.emit(`unsubscribe:${name}`));\n    }\n  };\n\n  render(): ReactElement<any> {\n    return this.props.children;\n  }\n}\n","import { ComponentClass } from 'react';\nimport { connect } from 'react-redux';\nimport SubscribeContainer, { OwnProps } from './SubscribeContainer';\n\nconst SubscribeContainerConnected: ComponentClass<OwnProps> = connect()(SubscribeContainer);\n\nexport default SubscribeContainerConnected;\n"],"names":["logger","Logger","SubscribeContainer","Component","subscribed","timeout","undefined","handleVisibilityChange","document","hidden","log","props","names","name","debug","subscribe","setTimeout","unsubscribe","visibleTimeout","websocket","getWebsocket","forEach","emit","then","action","dispatch","isConnected","on","addEventListener","removeEventListener","off","context","app","children","defaultProps","contextTypes","PropTypes","object","SubscribeContainerConnected","connect"],"mappings":";;;;;AAKA,MAAMA,SAAS,IAAIC,MAAJ,CAAW,+BAAX,CAAf;AAcA,AAAe,MAAMC,kBAAN,SAAiCC,SAAjC,CAA2E;;;;wCASxFC,UATwF,GASlE,KATkE,OAUxFC,OAVwF,GAU1DC,SAV0D,OA+BxFC,sBA/BwF,GA+B/D,MAAM;UACzB,CAACC,SAASC,MAAd,EAAsB;YAChB,KAAKJ,OAAL,IAAgB,IAApB,EAA0B;iBACjBK,GAAP,CAAW,iBAAX,EAA8B;mBACrB,KAAKC,KAAL,CAAWC,KADU;kBAEtB,KAAKD,KAAL,CAAWE;WAFnB;uBAIa,KAAKR,OAAlB;SALF,MAMO;iBACES,KAAP,CAAa,aAAb,EAA4B;mBACnB,KAAKH,KAAL,CAAWC,KADQ;kBAEpB,KAAKD,KAAL,CAAWE;WAFnB;eAIKE,SAAL;;;;;;UAKA,CAAC,KAAKX,UAAV,EAAsB;aAEfM,GAAP,CAAW,iBAAX,EAA8B;eACrB,KAAKC,KAAL,CAAWC,KADU;cAEtB,KAAKD,KAAL,CAAWE;OAFnB;WAIKR,OAAL,GAAeW,WAAW,KAAKC,WAAhB,EAA6B,KAAKN,KAAL,CAAWO,cAAxC,CAAf;KAvDsF,OA0DxFH,SA1DwF,GA0D5E,MAAM;UACZP,SAASC,MAAb,EAAqB;aAEdC,GAAP,CAAW,WAAX,EAAwB;eAAS,KAAKC,KAAL,CAAWC,KAApB;cAAiC,KAAKD,KAAL,CAAWE;OAApE;WACKT,UAAL,GAAkB,IAAlB;YACM;;UAAe,KAAKO,KAA1B;YACMC,QAAQ,KAAKD,KAAL,CAAWC,KAAX,IAAoB,CAAC,KAAKD,KAAL,CAAWE,IAAZ,CAAlC;YACMM,YAAY,KAAKC,YAAL,EAAlB;YACMC,OAAN,CAAcR,QACZM,UAAUG,IAAV,CAAgB,aAAYT,IAAK,EAAjC,EAAoCU,IAApC,CAA0CC,MAAD,IAAuBA,UAAUC,SAASD,MAAT,CAA1E,CADF;KAlEsF,OAuExFP,WAvEwF,GAuE1E,MAAM;WACbZ,OAAL,GAAeC,SAAf;UACI,CAAC,KAAKF,UAAV,EAAsB;aACfM,GAAP,CAAW,aAAX,EAA0B;eACjB,KAAKC,KAAL,CAAWC,KADM;cAElB,KAAKD,KAAL,CAAWE;OAFnB;WAIKT,UAAL,GAAkB,KAAlB;YACMQ,QAAQ,KAAKD,KAAL,CAAWC,KAAX,IAAoB,CAAC,KAAKD,KAAL,CAAWE,IAAZ,CAAlC;YACMM,YAAY,KAAKC,YAAL,EAAlB;;UACID,UAAUO,WAAV,EAAJ,EAA6B;cACrBL,OAAN,CAAcR,QAAQM,UAAUG,IAAV,CAAgB,eAAcT,IAAK,EAAnC,CAAtB;;KAlFoF;;;sBAYpE;UACZM,YAAY,KAAKC,YAAL,EAAlB;cACUO,EAAV,CAAa,SAAb,EAAwB,KAAKZ,SAA7B;;QACII,UAAUO,WAAV,EAAJ,EAA6B;WACtBX,SAAL;;;aAEOa,gBAAT,CAA0B,kBAA1B,EAA8C,KAAKrB,sBAAnD,EAA2E,KAA3E;;;yBAGqB;aACZsB,mBAAT,CAA6B,kBAA7B,EAAiD,KAAKtB,sBAAtD,EAA8E,KAA9E;SACKa,YAAL,GAAoBU,GAApB,CAAwB,SAAxB,EAAmC,KAAKf,SAAxC;SACKE,WAAL;;;iBAGa;WACN,KAAKc,OAAL,CAAaA,OAAb,CAAqBC,GAArB,CAAyBb,SAAhC;;;WA0D0B;WACnB,KAAKR,KAAL,CAAWsB,QAAlB;;;;AAvFiB/B,mBACZgC,eAAe;wBAAA;;;AADHhC,mBAKZiC,eAAe;WACXC,UAAUC;;;ACrBvB,MAAMC,8BAAwDC,UAAUrC,kBAAV,CAA9D;;;;"}