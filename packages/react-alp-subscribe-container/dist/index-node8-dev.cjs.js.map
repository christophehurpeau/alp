{"version":3,"file":"index-node8-dev.cjs.js","sources":["../src/index.js"],"sourcesContent":["import { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport { connect, type ReduxDispatchType } from 'alp-react-redux';\nimport Logger from 'nightingale-logger';\n\nconst logger = new Logger('react-alp-subscribe-container');\n\ntype Props = {|\n  children: Node,\n  dispatch: ReduxDispatchType,\n  name?: ?string,\n  names?: ?Array<string>,\n  visibleTimeout?: ?number,\n|};\n\nclass SubscribeContainerComponent extends Component<Props> {\n  static defaultProps = {\n    visibleTimeout: 1000 * 60 * 2, // 2 minutes\n  };\n\n  static contextTypes = {\n    context: PropTypes.object,\n  };\n\n  subscribed: boolean = false;\n  timeout = null;\n\n  componentDidMount() {\n    const websocket = this.getWebsocket();\n    websocket.on('connect', this.subscribe);\n    if (websocket.isConnected()) {\n      this.subscribe();\n    }\n    document.addEventListener('visibilitychange', this.handleVisibilityChange, false);\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('visibilitychange', this.handleVisibilityChange, false);\n    this.getWebsocket().off('connect', this.subscribe);\n    this.unsubscribe();\n  }\n\n  getWebsocket() {\n    return this.context.context.app.websocket;\n  }\n\n  handleVisibilityChange = () => {\n    if (!document.hidden) {\n      if (this.timeout) {\n        logger.log('timeout cleared', { names: this.props.names, name: this.props.name });\n        clearTimeout(this.timeout);\n      } else {\n        logger.debug('resubscribe', { names: this.props.names, name: this.props.name });\n        this.subscribe();\n      }\n      return;\n    }\n\n    if (!this.subscribed) return;\n\n    logger.log('timeout visible', { names: this.props.names, name: this.props.name });\n    this.timeout = setTimeout(this.unsubscribe, this.props.visibleTimeout);\n  };\n\n  subscribe = () => {\n    if (document.hidden) return;\n\n    logger.log('subscribe', { names: this.props.names, name: this.props.name });\n    this.subscribed = true;\n    const { dispatch } = this.props;\n    const names = this.props.names || [this.props.name];\n    const websocket = this.getWebsocket();\n    names.forEach(name =>\n      websocket.emit(`subscribe:${name}`).then(action => action && dispatch(action)),\n    );\n  };\n\n  unsubscribe = () => {\n    this.timeout = null;\n    if (!this.subscribed) return;\n    logger.log('unsubscribe', { names: this.props.names, name: this.props.name });\n    this.subscribed = false;\n    const names = this.props.names || [this.props.name];\n    const websocket = this.getWebsocket();\n    if (websocket.isConnected()) {\n      names.forEach(name => websocket.emit(`unsubscribe:${name}`));\n    }\n  };\n\n  render() {\n    return this.props.children;\n  }\n}\n\nexport default connect()(SubscribeContainerComponent);\n"],"names":["logger","Logger","SubscribeContainerComponent","Component","websocket","getWebsocket","on","subscribe","isConnected","addEventListener","handleVisibilityChange","removeEventListener","off","unsubscribe","context","app","timeout","document","hidden","log","names","props","name","debug","subscribed","setTimeout","visibleTimeout","dispatch","forEach","emit","then","action","children","defaultProps","contextTypes","PropTypes","object","connect"],"mappings":"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"}