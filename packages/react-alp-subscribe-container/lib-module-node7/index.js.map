{"version":3,"sources":["../src/index.js"],"names":["PropTypes","Component","connect","Logger","logger","SubscribeContainerComponent","subscribed","timeout","state","handleVisibilityChange","document","hidden","log","name","props","clearTimeout","debug","subscribe","setTimeout","unsubscribe","visibleTimeout","dispatch","websocket","getWebsocket","emit","then","action","isConnected","context","app","componentDidMount","on","addEventListener","componentWillUnmount","removeEventListener","off","render","children","propTypes","func","isRequired","string","node","number","defaultProps","contextTypes","object"],"mappings":"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","file":"index.js","sourcesContent":["import { PropTypes, Component } from 'react';\nimport { connect } from 'alp-react-redux';\nimport Logger from 'nightingale-logger';\n\nconst logger = new Logger('react-alp-subscribe-container');\n\nclass SubscribeContainerComponent extends Component {\n  static propTypes = {\n    dispatch: PropTypes.func.isRequired,\n    name: PropTypes.string.isRequired,\n    children: PropTypes.node,\n    visibleTimeout: PropTypes.number,\n  };\n\n  static defaultProps = {\n    visibleTimeout: 1000 * 60 * 2, // 2 minutes\n  };\n\n  static contextTypes = {\n    context: PropTypes.object,\n  };\n\n\n  subscribed: boolean = false;\n  timeout = null;\n  state = {};\n\n  getWebsocket() {\n    return this.context.context.app.websocket;\n  }\n\n\n  handleVisibilityChange = () => {\n    if (!document.hidden) {\n      if (this.timeout) {\n        logger.log('timeout cleared', { name: this.props.name });\n        clearTimeout(this.timeout);\n      } else {\n        logger.debug('resubscribe', { name: this.props.name });\n        this.subscribe();\n      }\n      return;\n    }\n\n    if (!this.subscribed) return;\n\n    logger.log('timeout visible', { name: this.props.name });\n    this.timeout = setTimeout(this.unsubscribe, this.props.visibleTimeout);\n  };\n\n  subscribe = () => {\n    if (document.hidden) return;\n\n    logger.log('subscribe', { name: this.props.name });\n    this.subscribed = true;\n    const { dispatch, name } = this.props;\n    const websocket = this.getWebsocket();\n    websocket.emit(`subscribe:${name}`)\n            .then(action => action && dispatch(action));\n  };\n\n  unsubscribe = () => {\n    this.timeout = null;\n    if (!this.subscribed) return;\n    logger.log('unsubscribe', { name: this.props.name });\n    this.subscribed = false;\n    const { name } = this.props;\n    const websocket = this.getWebsocket();\n    if (websocket.isConnected()) {\n      websocket.emit(`unsubscribe:${name}`);\n    }\n  };\n\n  componentDidMount() {\n    const websocket = this.getWebsocket();\n    websocket.on('connect', this.subscribe);\n    if (websocket.isConnected()) {\n      this.subscribe();\n    }\n    document.addEventListener('visibilitychange', this.handleVisibilityChange, false);\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('visibilitychange', this.handleVisibilityChange, false);\n    this.getWebsocket().off('connect', this.subscribe);\n    this.unsubscribe();\n  }\n\n  render() {\n    return this.props.children;\n  }\n}\n\nexport default connect()(SubscribeContainerComponent);\n"]}