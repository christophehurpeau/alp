{"version":3,"file":"index-node10.cjs.js","sources":["../src/layout/assetUrl.ts","../src/layout/uneval.ts","../src/layout/htmlLayout.ts","../src/createAlpAppWrapper.tsx","../src/contexts/LoadingFallbackContext.ts","../src/module/AlpModule.tsx","../src/module/SuspenseWrapper.tsx","../src/layout/Body.tsx","../src/layout/AppContainer.tsx","../src/index.ts"],"sourcesContent":["import { PRODUCTION } from 'pob-babel';\n\nexport type AssetUrl = (asset: string, version: string) => string;\n\nconst assetUrl: AssetUrl = PRODUCTION\n  ? (asset: string, version: string): string =>\n      asset.startsWith('/') ? `/${version}${asset}` : asset\n  : (asset: string, version: string): string =>\n      asset.startsWith('/') ? `${asset}?${version}` : asset;\n\nexport default assetUrl;\n","/* eslint-disable default-case */\nimport { PRODUCTION } from 'pob-babel';\n\nfunction uneval(\n  value: any,\n  keys: undefined | string,\n  objects = new Set(),\n): string {\n  switch (value) {\n    case null:\n      return 'null';\n    case undefined:\n      return 'undefined';\n    case Infinity:\n      return 'Infinity';\n    case -Infinity:\n      return '-Infinity';\n  }\n\n  if (Number.isNaN(value)) {\n    return 'NaN';\n  }\n\n  switch (typeof value) {\n    case 'function':\n      if (!PRODUCTION) console.log(value);\n      throw new Error(\n        PRODUCTION ? undefined : `Unsupported function \"${keys}\".`,\n      );\n    case 'string':\n    case 'number':\n    case 'boolean':\n      return JSON.stringify(value);\n  }\n\n  if (objects.has(value)) {\n    throw new Error(PRODUCTION ? undefined : 'Circular reference detected.');\n  }\n\n  objects.add(value);\n\n  // specialized types\n  if (Array.isArray(value)) {\n    return `[${value\n      .map((o, index) =>\n        uneval(o, PRODUCTION ? undefined : `${keys}[${index}]`, objects),\n      )\n      .join(',')}]`;\n  }\n\n  if (value instanceof Date) {\n    return `new Date(${value.getTime()})`;\n  }\n\n  if (value instanceof Set) {\n    return `new Set(${uneval([...value], keys)})`;\n  }\n\n  if (value instanceof Map) {\n    return `new Map(${uneval([...value], keys)})`;\n  }\n\n  return `{${Object.keys(value)\n    .map(\n      (key) =>\n        `${JSON.stringify(key)}:${uneval(\n          value[key],\n          PRODUCTION ? undefined : `${keys}.${key}`,\n        )}`,\n    )\n    .join(',')}}`;\n}\n\n// https://medium.com/node-security/the-most-common-xss-vulnerability-in-react-js-applications-2bdffbcc1fa0#.tm3hd6riw\nconst UNSAFE_CHARS_REGEXP = /[/<>\\u2028\\u2029]/g;\nconst ESCAPED_CHARS = {\n  '<': '\\\\u003C',\n  '>': '\\\\u003E',\n  '/': '\\\\u002F',\n  '\\u2028': '\\\\u2028',\n  '\\u2029': '\\\\u2029',\n};\n\nconst escapeUnsafeChars = (unsafeChar: keyof typeof ESCAPED_CHARS): string =>\n  ESCAPED_CHARS[unsafeChar];\n\nexport default function unevalValue(value: any): string {\n  return uneval(value, PRODUCTION ? undefined : 'obj').replace(\n    UNSAFE_CHARS_REGEXP,\n    escapeUnsafeChars as (unsafeChar: string) => string,\n  );\n}\n","/* eslint-disable jsx-a11y/html-has-lang */\nimport { HelmetData } from 'react-helmet';\nimport assetUrl from './assetUrl';\nimport uneval from './uneval';\n\nexport interface LayoutOptions {\n  version: string;\n  scriptName: string | false;\n  styleName: string | false;\n  initialData?: any;\n  polyfillFeatures?: string;\n}\n\nexport default function htmlLayout(\n  helmet: HelmetData,\n  content: string,\n  {\n    version,\n    scriptName,\n    styleName,\n    initialData,\n    polyfillFeatures = 'default,es2015,es2016,es2017,localStorage,fetch,Intl',\n  }: LayoutOptions,\n): string {\n  return `<!doctype html>\n<html ${helmet.htmlAttributes.toString()}>\n  <head>\n    ${helmet.title.toString()}\n    ${helmet.meta.toString()}\n    ${helmet.link.toString()}\n    ${helmet.base.toString()}\n    <link rel=\"stylesheet\" href=\"${assetUrl(\n      `/${styleName || 'index'}.css`,\n      version,\n    )}\" />\n    ${helmet.style.toString()}\n    ${polyfillFeatures &&\n      `<script defer src=\"${`https://polyfill.io/v2/polyfill.min.js?features=${polyfillFeatures}&unknown=polyfill`}\"></script>`}\n    ${helmet.script.toString()}\n    ${\n      scriptName === false\n        ? ''\n        : `<script>\nwindow.__VERSION__='${version}';\nwindow.__INITIAL_DATA__=${uneval(initialData)};\n</script>\n<script defer src=\"${assetUrl(`/${scriptName}.js`, version)}\"></script>`\n    }\n  </head>\n  <body ${helmet.bodyAttributes.toString()}>\n    <div id=\"react-app\">${content}</div>\n  </body>\n</html>`;\n}\n","import React, { Component, ReactChild } from 'react';\nimport { Context } from 'alp-types';\nimport ReactAlpContext from 'react-alp-context';\n\ndeclare global {\n  interface Window {\n    Raven: any;\n  }\n}\n\ninterface AlpAppProps {}\n\ninterface AlpAppState {\n  error: null | Error;\n  appState: any;\n}\n\nexport default function createAlpAppWrapper(app: ReactChild, context: Context) {\n  return class AlpAppWrapper extends Component<AlpAppProps, AlpAppState> {\n    state = {\n      error: null,\n      appState: context.sanitizedState,\n    };\n\n    componentDidCatch(error: Error, errorInfo: any) {\n      console.error(error, errorInfo);\n      if (window.Raven) {\n        window.Raven.captureException(error, { extra: errorInfo });\n      }\n    }\n\n    render() {\n      if (this.state.error) return <div>An unexpected error occured</div>;\n      return (\n        <ReactAlpContext.Provider value={context}>\n          {app}\n        </ReactAlpContext.Provider>\n      );\n    }\n  };\n}\n","import { createContext, ReactNode } from 'react';\n\nexport default createContext<NonNullable<ReactNode>>('Loading...');\n","import { POB_TARGET } from 'pob-babel';\nimport React, { ReactElement, ReactNode, Suspense, useContext } from 'react';\nimport LoadingFallbackContext from '../contexts/LoadingFallbackContext';\n\nexport interface AlpModuleProps {\n  children: ReactNode;\n}\n\nfunction AlpModuleNode(props: AlpModuleProps): ReactElement {\n  return <>{props.children}</>;\n}\n\nfunction AlpModuleBrowser(props: AlpModuleProps): ReactElement {\n  const loadingFallback = useContext(LoadingFallbackContext);\n  return <Suspense fallback={loadingFallback}>{props.children}</Suspense>;\n}\n\nexport default POB_TARGET === 'node' ? AlpModuleNode : AlpModuleBrowser;\n","import { POB_TARGET } from 'pob-babel';\nimport React, { Suspense, ReactNode, useContext } from 'react';\nimport LoadingFallbackContext from '../contexts/LoadingFallbackContext';\n\ninterface SuspenseWrapperProps {\n  children: ReactNode;\n}\n\nfunction NodeSuspenseWrapper({ children }: SuspenseWrapperProps) {\n  return children;\n}\n\nfunction BrowserSuspenseWrapper({ children }: SuspenseWrapperProps) {\n  const loader = useContext(LoadingFallbackContext);\n  return <Suspense fallback={loader}>{children}</Suspense>;\n}\n\nexport default POB_TARGET === 'node'\n  ? NodeSuspenseWrapper\n  : BrowserSuspenseWrapper;\n","import React, { ReactElement, ReactNode } from 'react';\n\nexport interface BodyProps {\n  children: ReactNode;\n}\n\nexport default function Body({ children }: BodyProps): ReactElement<'div'> {\n  return <div>{children}</div>;\n}\n","import React, { ReactElement } from 'react';\n\nexport interface AppContainerProps {\n  children: React.ReactNode;\n}\n\nexport default function AppContainer({\n  children,\n}: AppContainerProps): ReactElement {\n  return <>{children}</>;\n}\n","import React, { ElementType } from 'react';\nimport { renderToString } from 'react-dom/server';\nimport Helmet from 'react-helmet';\n// import Logger from 'nightingale-logger';\nimport createIsModernBrowser from 'modern-browsers';\nimport { Context } from 'alp-types';\nimport htmlLayout, { LayoutOptions } from './layout/htmlLayout';\nimport createAlpAppWrapper from './createAlpAppWrapper';\n\nexport { Helmet };\n\nexport { default as AlpModule } from './module/AlpModule';\nexport { default as SuspenseWrapper } from './module/SuspenseWrapper';\nexport { default as Body } from './layout/Body';\nexport { default as AppContainer } from './layout/AppContainer';\nexport { default as LoadingFallbackContext } from './contexts/LoadingFallbackContext';\n\n// const logger = new Logger( 'alp:react');\n\nconst renderHtml = (\n  app: React.ReactElement,\n  options: LayoutOptions,\n): string => {\n  const content = renderToString(app);\n  const helmet = Helmet.renderStatic();\n  return htmlLayout(helmet, content, options);\n};\n\nconst isModernBrowser = createIsModernBrowser();\n\ninterface Options {\n  polyfillFeatures?: string;\n  scriptName?: string | false;\n  styleName?: string | false;\n}\n\nexport type ReactAppCallback = (ctx: Context) => void;\n\nexport default function alpReact(\n  App: ElementType<{}>,\n  options: Options = {},\n): ReactAppCallback {\n  return (ctx: Context): void => {\n    const version: string = ctx.config.get('version');\n    // TODO create alp-useragent with getter in context\n    const ua = ctx.req.headers['user-agent'];\n    const name = isModernBrowser(ua) ? 'modern-browsers' : 'es5';\n\n    const app = React.createElement(App);\n    const WrappedApp = createAlpAppWrapper(app, ctx);\n\n    ctx.body = renderHtml(React.createElement(WrappedApp), {\n      version,\n      scriptName: options.scriptName !== undefined ? options.scriptName : name,\n      styleName: options.styleName !== undefined ? options.styleName : name,\n      polyfillFeatures: options.polyfillFeatures,\n      initialData: {\n        sanitizedState: ctx.sanitizedState,\n      },\n    });\n  };\n}\n"],"names":["assetUrl","asset","version","startsWith","uneval","value","keys","objects","Set","undefined","Infinity","Number","isNaN","Error","JSON","stringify","has","add","Array","isArray","map","o","index","join","Date","getTime","Map","Object","key","UNSAFE_CHARS_REGEXP","ESCAPED_CHARS","escapeUnsafeChars","unsafeChar","unevalValue","replace","htmlLayout","helmet","content","scriptName","styleName","initialData","polyfillFeatures","htmlAttributes","toString","title","meta","link","base","style","script","bodyAttributes","createAlpAppWrapper","app","context","AlpAppWrapper","Component","state","error","appState","sanitizedState","componentDidCatch","errorInfo","console","window","Raven","captureException","extra","render","React","createContext","AlpModuleNode","props","children","NodeSuspenseWrapper","Body","AppContainer","renderHtml","options","renderToString","Helmet","renderStatic","isModernBrowser","createIsModernBrowser","alpReact","App","ctx","config","get","ua","req","headers","name","createElement","WrappedApp","body"],"mappings":"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"}