{"version":3,"file":"index-node12.cjs.js","sources":["../src/createAlpAppWrapper.tsx","../src/layout/assetUrl.ts","../src/layout/uneval.ts","../src/layout/htmlLayout.ts","../src/contexts/LoadingFallbackContext.ts","../src/module/AlpModule.tsx","../src/module/SuspenseWrapper.tsx","../src/layout/Body.tsx","../src/layout/AppContainer.tsx","../src/index.ts"],"sourcesContent":["import type { Context } from 'alp-types';\nimport type {\n  ComponentClass,\n  ErrorInfo,\n  ReactChild,\n  ReactElement,\n} from 'react';\nimport React, { Component } from 'react';\nimport ReactAlpContext from 'react-alp-context';\n\ndeclare global {\n  interface Window {\n    Sentry?: { captureException: (error: Error, extra: unknown) => void };\n  }\n}\n\ninterface AlpAppProps {}\n\ninterface AlpAppState {\n  error: null | Error;\n}\n\nexport default function createAlpAppWrapper(\n  app: ReactChild,\n  context: Context,\n): ComponentClass<AlpAppProps, AlpAppState> {\n  return class AlpAppWrapper extends Component<AlpAppProps, AlpAppState> {\n    state = {\n      error: null,\n    };\n\n    componentDidCatch(error: Error, errorInfo: ErrorInfo): void {\n      console.error(error, errorInfo);\n      if (window.Sentry) {\n        window.Sentry.captureException(error, {\n          contexts: {\n            react: {\n              componentStack: errorInfo.componentStack,\n            },\n          },\n        });\n      }\n    }\n\n    render(): ReactElement {\n      if (this.state.error) return <div>An unexpected error occured</div>;\n      return (\n        <ReactAlpContext.Provider value={context}>\n          {app}\n        </ReactAlpContext.Provider>\n      );\n    }\n  };\n}\n","import { PRODUCTION } from 'pob-babel';\n\nexport type AssetUrl = (asset: string, version: string) => string;\n\nconst assetUrl: AssetUrl = PRODUCTION\n  ? (asset: string, version: string): string =>\n      asset.startsWith('/') ? `/${version}${asset}` : asset\n  : (asset: string, version: string): string =>\n      asset.startsWith('/') ? `${asset}?${version}` : asset;\n\nexport default assetUrl;\n","/* eslint-disable complexity */\nimport { PRODUCTION } from 'pob-babel';\n\nfunction uneval(\n  value: unknown,\n  keys: undefined | string,\n  objects = new Set(),\n): string {\n  switch (value) {\n    case null:\n      return 'null';\n    case undefined:\n      return 'undefined';\n    case Infinity:\n      return 'Infinity';\n    case -Infinity:\n      return '-Infinity';\n  }\n\n  if (Number.isNaN(value)) {\n    return 'NaN';\n  }\n\n  switch (typeof value) {\n    case 'function':\n      if (!PRODUCTION) console.log(value);\n      throw new Error(\n        PRODUCTION ? undefined : `Unsupported function \"${keys as string}\".`,\n      );\n    case 'string':\n    case 'number':\n    case 'boolean':\n      return JSON.stringify(value);\n  }\n\n  if (objects.has(value)) {\n    throw new Error(PRODUCTION ? undefined : 'Circular reference detected.');\n  }\n\n  objects.add(value);\n\n  // specialized types\n  if (Array.isArray(value)) {\n    return `[${value\n      .map((o, index) =>\n        uneval(\n          o,\n          PRODUCTION ? undefined : `${keys as string}[${index}]`,\n          objects,\n        ),\n      )\n      .join(',')}]`;\n  }\n\n  if (value instanceof Date) {\n    return `new Date(${value.getTime()})`;\n  }\n\n  if (value instanceof Set) {\n    return `new Set(${uneval([...value], keys)})`;\n  }\n\n  if (value instanceof Map) {\n    return `new Map(${uneval([...value], keys)})`;\n  }\n\n  return `{${Object.keys(value as Record<any, unknown>)\n    .map(\n      (key) =>\n        `${JSON.stringify(key)}:${uneval(\n          (value as Record<typeof key, unknown>)[key],\n          PRODUCTION ? undefined : `${keys as string}.${key}`,\n        )}`,\n    )\n    .join(',')}}`;\n}\n\n// https://medium.com/node-security/the-most-common-xss-vulnerability-in-react-js-applications-2bdffbcc1fa0#.tm3hd6riw\nconst UNSAFE_CHARS_REGEXP = /[/<>\\u2028\\u2029]/g;\nconst ESCAPED_CHARS = {\n  '<': '\\\\u003C',\n  '>': '\\\\u003E',\n  '/': '\\\\u002F',\n  '\\u2028': '\\\\u2028',\n  '\\u2029': '\\\\u2029',\n};\n\nconst escapeUnsafeChars = (unsafeChar: keyof typeof ESCAPED_CHARS): string =>\n  ESCAPED_CHARS[unsafeChar];\n\nexport default function unevalValue(value: unknown): string {\n  return uneval(value, PRODUCTION ? undefined : 'obj').replace(\n    UNSAFE_CHARS_REGEXP,\n    escapeUnsafeChars as (unsafeChar: string) => string,\n  );\n}\n","import type { HelmetData } from 'react-helmet';\nimport assetUrl from './assetUrl';\nimport uneval from './uneval';\n\nexport interface LayoutOptions {\n  version: string;\n  scriptName: string | false;\n  styleName: string | false;\n  initialData?: any;\n  polyfillFeatures?: string;\n}\n\nexport default function htmlLayout(\n  helmet: HelmetData,\n  content: string,\n  {\n    version,\n    scriptName,\n    styleName,\n    initialData,\n    polyfillFeatures = 'default,es2015,es2016,es2017,localStorage,fetch,Intl',\n  }: LayoutOptions,\n): string {\n  return `<!doctype html>\n<html ${helmet.htmlAttributes.toString()}>\n  <head>\n    ${helmet.title.toString()}\n    ${helmet.meta.toString()}\n    ${helmet.link.toString()}\n    ${helmet.base.toString()}\n    <link rel=\"stylesheet\" href=\"${assetUrl(\n      `/${styleName || 'index'}.css`,\n      version,\n    )}\" />\n    ${helmet.style.toString()}\n    ${\n      polyfillFeatures &&\n      `<script defer src=\"${`https://polyfill.io/v2/polyfill.min.js?features=${polyfillFeatures}&unknown=polyfill`}\"></script>`\n    }\n    ${helmet.script.toString()}\n    ${\n      scriptName === false\n        ? ''\n        : `<script>\nwindow.__VERSION__='${version}';\nwindow.__INITIAL_DATA__=${uneval(initialData)};\n</script>\n<script defer src=\"${assetUrl(`/${scriptName}.js`, version)}\"></script>`\n    }\n  </head>\n  <body ${helmet.bodyAttributes.toString()}>\n    <div id=\"react-app\">${content}</div>\n  </body>\n</html>`;\n}\n","import type { ReactNode } from 'react';\nimport { createContext } from 'react';\n\nexport default createContext<NonNullable<ReactNode>>('Loading...');\n","import { POB_TARGET } from 'pob-babel';\nimport type { ReactElement, ReactNode } from 'react';\nimport React, { Suspense, useContext } from 'react';\nimport LoadingFallbackContext from '../contexts/LoadingFallbackContext';\n\nexport interface AlpModuleProps {\n  children: ReactNode;\n}\n\nfunction AlpModuleNode(props: AlpModuleProps): ReactElement {\n  return <>{props.children}</>;\n}\n\nfunction AlpModuleBrowser(props: AlpModuleProps): ReactElement {\n  const loadingFallback = useContext(LoadingFallbackContext);\n  return <Suspense fallback={loadingFallback}>{props.children}</Suspense>;\n}\n\nexport default POB_TARGET === 'node' ? AlpModuleNode : AlpModuleBrowser;\n","import { POB_TARGET } from 'pob-babel';\nimport type { ReactElement, ReactNode } from 'react';\nimport React, { Suspense, useContext } from 'react';\nimport LoadingFallbackContext from '../contexts/LoadingFallbackContext';\n\ninterface SuspenseWrapperProps {\n  children: ReactNode;\n}\n\nfunction NodeSuspenseWrapper({ children }: SuspenseWrapperProps): ReactElement {\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n  return (children as unknown) as ReactElement;\n}\n\nfunction BrowserSuspenseWrapper({\n  children,\n}: SuspenseWrapperProps): ReactElement {\n  const loader = useContext(LoadingFallbackContext);\n  return <Suspense fallback={loader}>{children}</Suspense>;\n}\n\nexport default POB_TARGET === 'node'\n  ? NodeSuspenseWrapper\n  : BrowserSuspenseWrapper;\n","import type { ReactElement, ReactNode } from 'react';\nimport React from 'react';\n\nexport interface BodyProps {\n  children: ReactNode;\n}\n\nexport default function Body({ children }: BodyProps): ReactElement<'div'> {\n  return <div>{children}</div>;\n}\n","import type { ReactElement } from 'react';\nimport React from 'react';\n\nexport interface AppContainerProps {\n  children: React.ReactNode;\n}\n\nexport default function AppContainer({\n  children,\n}: AppContainerProps): ReactElement {\n  return <>{children}</>;\n}\n","import type { Context } from 'alp-types';\nimport createIsModernBrowser from 'modern-browsers';\nimport type { ElementType } from 'react';\nimport React from 'react';\nimport { renderToString } from 'react-dom/server';\nimport Helmet from 'react-helmet';\n// import Logger from 'nightingale-logger';\nimport createAlpAppWrapper from './createAlpAppWrapper';\nimport type { LayoutOptions } from './layout/htmlLayout';\nimport htmlLayout from './layout/htmlLayout';\n\nexport { Helmet };\n\nexport { default as AlpModule } from './module/AlpModule';\nexport { default as SuspenseWrapper } from './module/SuspenseWrapper';\nexport { default as Body } from './layout/Body';\nexport { default as AppContainer } from './layout/AppContainer';\nexport { default as LoadingFallbackContext } from './contexts/LoadingFallbackContext';\n\n// const logger = new Logger( 'alp:react');\n\nconst renderHtml = (\n  app: React.ReactElement,\n  options: LayoutOptions,\n): string => {\n  const content = renderToString(app);\n  const helmet = Helmet.renderStatic();\n  return htmlLayout(helmet, content, options);\n};\n\nconst isModernBrowser = createIsModernBrowser();\n\ninterface Options {\n  polyfillFeatures?: string;\n  scriptName?: string | false;\n  styleName?: string | false;\n}\n\nexport type ReactAppCallback = (ctx: Context) => void;\n\nexport default function alpReact(\n  App: ElementType<Record<string, never>>,\n  options: Options = {},\n): ReactAppCallback {\n  return (ctx: Context): void => {\n    const version: string = ctx.config.get('version');\n    // TODO create alp-useragent with getter in context\n    const ua = ctx.request.headers['user-agent'];\n    const name = isModernBrowser(ua) ? 'modern-browsers' : 'es5';\n\n    const app = React.createElement(App);\n    const WrappedApp = createAlpAppWrapper(app, ctx);\n\n    ctx.body = renderHtml(React.createElement(WrappedApp), {\n      version,\n      scriptName: options.scriptName !== undefined ? options.scriptName : name,\n      styleName: options.styleName !== undefined ? options.styleName : name,\n      polyfillFeatures: options.polyfillFeatures,\n      initialData: {\n        sanitizedState: ctx.sanitizedState,\n      },\n    });\n  };\n}\n"],"names":["createAlpAppWrapper","app","context","AlpAppWrapper","Component","state","error","componentDidCatch","errorInfo","console","window","Sentry","captureException","contexts","react","componentStack","render","React","ReactAlpContext","assetUrl","asset","version","startsWith","uneval","value","keys","objects","Set","undefined","Infinity","Number","isNaN","Error","JSON","stringify","has","add","Array","isArray","map","o","index","join","Date","getTime","Map","Object","key","UNSAFE_CHARS_REGEXP","ESCAPED_CHARS","escapeUnsafeChars","unsafeChar","unevalValue","replace","htmlLayout","helmet","content","scriptName","styleName","initialData","polyfillFeatures","htmlAttributes","toString","title","meta","link","base","style","script","bodyAttributes","createContext","AlpModuleNode","props","children","NodeSuspenseWrapper","Body","AppContainer","renderHtml","options","renderToString","Helmet","renderStatic","isModernBrowser","createIsModernBrowser","alpReact","App","ctx","config","get","ua","request","headers","name","createElement","WrappedApp","body","sanitizedState"],"mappings":"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"}