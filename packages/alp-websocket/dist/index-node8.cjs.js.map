{"version":3,"file":"index-node8.cjs.js","sources":["../src/index.js"],"sourcesContent":["/* eslint-disable no-use-before-define */\nimport { readFileSync } from 'fs';\nimport socketio from 'socket.io';\nimport Logger from 'nightingale-logger';\n\nconst logger = new Logger('alp:websocket');\n\nlet io;\n\n/**\n * @param {Koa|AlpNodeApp} app\n * @param {string} [dirname] for tls, dirname of server.key server.crt. If undefined: app.certPath\n */\nexport default function alpWebsocket(app, dirname) {\n  app.reduxReducers.websocket = (state = 'disconnected') => state;\n\n  start(app.config, dirname || app.certPath);\n  app.websocket = io;\n  app.on('close', close);\n  return io;\n}\n\nexport function close() {\n  io.close();\n}\n\nexport function subscribe(socket, name, callbackOnSubscribe, callbackOnUnsubscribe) {\n  const diconnect = callbackOnUnsubscribe && (() => callbackOnUnsubscribe());\n  socket.on(`subscribe:${name}`, callback => {\n    logger.info('join', { name });\n    socket.join(name);\n\n    if (callbackOnSubscribe) {\n      callback(null, callbackOnSubscribe());\n    } else {\n      callback(null);\n    }\n\n    if (diconnect) socket.on('disconnect', diconnect);\n  });\n\n  socket.on(`unsubscribe:${name}`, callback => {\n    logger.info('leave', { name });\n    socket.leave(name);\n    if (diconnect) socket.removeListener('disconnect', diconnect);\n\n    if (callbackOnUnsubscribe) {\n      callback(null, callbackOnUnsubscribe());\n    } else {\n      callback(null);\n    }\n  });\n}\n\nfunction start(config, dirname) {\n  if (io) {\n    throw new Error('Already started');\n  }\n\n  const webSocketConfig = config.get('webSocket') || config.get('websocket');\n\n  if (!webSocketConfig) {\n    throw new Error('Missing config webSocket');\n  }\n\n  if (!webSocketConfig.has('port')) {\n    throw new Error('Missing config webSocket.port');\n  }\n\n  const secure = webSocketConfig.get('secure');\n  const port = webSocketConfig.get('port');\n  // eslint-disable-next-line global-require, import/no-dynamic-require\n  const createServer = require(secure ? 'https' : 'http').createServer;\n\n  const server = (() => {\n    if (!secure) {\n      return createServer();\n    }\n\n    return createServer({\n      key: readFileSync(`${dirname}/server.key`),\n      cert: readFileSync(`${dirname}/server.crt`),\n    });\n  })();\n\n  logger.info('Starting', { port });\n  server.listen(port, () => logger.info('Listening', { port }));\n  server.on('error', err => logger.error(err));\n  io = socketio(server);\n\n  io.on('connection', socket => {\n    logger.debug('connected', { id: socket.id });\n    socket.emit('hello', { version: config.get('version') });\n\n    socket.on('error', err => logger.error(err));\n    socket.on('disconnect', () => {\n      logger.debug('disconnected', { id: socket.id });\n    });\n  });\n\n  io.on('error', err => logger.error(err));\n\n  return io;\n}\n"],"names":["logger","Logger","io","alpWebsocket","app","dirname","reduxReducers","websocket","state","config","certPath","on","close","subscribe","socket","name","callbackOnSubscribe","callbackOnUnsubscribe","diconnect","callback","info","join","leave","removeListener","start","Error","webSocketConfig","get","has","secure","port","createServer","require","server","readFileSync","listen","err","error","socketio","debug","id","emit","version"],"mappings":"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"}