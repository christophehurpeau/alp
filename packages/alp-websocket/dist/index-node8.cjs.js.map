{"version":3,"file":"index-node8.cjs.js","sources":["../src/index.ts"],"sourcesContent":["/* eslint-disable no-use-before-define */\nimport { chmodSync, readFileSync, unlinkSync } from 'fs';\nimport socketio, { Namespace, Server, Socket } from 'socket.io';\nimport Logger from 'nightingale-logger';\nimport { NodeApplication, NodeConfig } from 'alp-types';\n\ninterface NodeApplicationWithWebsocket extends NodeApplication {\n  websocket: Server;\n}\n\nconst logger = new Logger('alp:websocket');\n\nlet io: Server;\n\nexport function initNamespace(config: NodeConfig, ns: Namespace | Server) {\n  ns.on('connection', (socket): void => {\n    logger.debug('connected', { id: socket.id });\n    socket.emit('hello', { version: config.get('version') });\n\n    socket.on('error', (err): void => {\n      logger.error(err);\n    });\n    socket.on('disconnect', (): void => {\n      logger.debug('disconnected', { id: socket.id });\n    });\n  });\n}\n\nfunction start(config: NodeConfig, dirname: string): Promise<Server> {\n  if (io) {\n    throw new Error('Already started');\n  }\n\n  const webSocketConfig = config.get('webSocket') || config.get('websocket');\n\n  if (!webSocketConfig) {\n    throw new Error('Missing config webSocket');\n  }\n\n  if (!webSocketConfig.has('port') && !webSocketConfig.has('socketPath')) {\n    throw new Error('Missing config webSocket.port');\n  }\n\n  const secure = webSocketConfig.get('secure');\n  const socketPath = webSocketConfig.get('socketPath');\n  const port = webSocketConfig.get('port');\n  const hostname = webSocketConfig.get('hostname');\n  // eslint-disable-next-line global-require, import/no-dynamic-require\n  const createServer = require(secure ? 'https' : 'http').createServer;\n\n  const server = (() => {\n    if (!secure) {\n      return createServer();\n    }\n\n    return createServer({\n      key: readFileSync(`${dirname}/server.key`),\n      cert: readFileSync(`${dirname}/server.crt`),\n    });\n  })();\n\n  logger.info('Creating server', socketPath ? { socketPath } : { port });\n\n  return new Promise((resolve) => {\n    if (socketPath) {\n      try {\n        unlinkSync(socketPath);\n      } catch (err) {}\n\n      server.listen(socketPath, () => {\n        if (socketPath) {\n          chmodSync(socketPath, '777');\n        }\n\n        logger.info('Server listening', { socketPath });\n        resolve(io);\n      });\n    } else {\n      server.listen(port, hostname, () => {\n        logger.info('Server listening', { port });\n        resolve(io);\n      });\n    }\n\n    server.on('error', (err: Error) => logger.error(err));\n    io = socketio(server, {\n      // https://github.com/socketio/socket.io/issues/3259\n      pingTimeout: 30000,\n    });\n\n    initNamespace(config, io);\n\n    io.on('error', (err: Error) => logger.error(err));\n  });\n}\n\nexport function close(): void {\n  io.close();\n}\n\n/**\n * @param {Koa|AlpNodeApp} app\n * @param {string} [dirname] for tls, dirname of server.key server.crt. If undefined: app.certPath\n */\nexport default function alpWebsocket(app: NodeApplication, dirname?: string) {\n  // eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n  // @ts-ignore\n  start(app.config, dirname || app.certPath);\n\n  const appWithWebsocket: NodeApplicationWithWebsocket = Object.assign(app, {\n    websocket: io,\n  });\n\n  app.on('close', close);\n  return appWithWebsocket;\n}\n\nexport function subscribe(\n  socket: Socket,\n  name: string,\n  callbackOnSubscribe: () => void,\n  callbackOnUnsubscribe: () => void,\n) {\n  const diconnect = callbackOnUnsubscribe && (() => callbackOnUnsubscribe());\n  socket.on(`subscribe:${name}`, (callback) => {\n    logger.info('join', { name });\n    socket.join(name);\n\n    if (callbackOnSubscribe) {\n      callback(null, callbackOnSubscribe());\n    } else {\n      callback(null);\n    }\n\n    if (diconnect) socket.on('disconnect', diconnect);\n  });\n\n  socket.on(`unsubscribe:${name}`, (callback) => {\n    logger.info('leave', { name });\n    socket.leave(name);\n    if (diconnect) socket.removeListener('disconnect', diconnect);\n\n    if (callbackOnUnsubscribe) {\n      callback(null, callbackOnUnsubscribe());\n    } else {\n      callback(null);\n    }\n  });\n}\n"],"names":["logger","Logger","io","initNamespace","config","ns","on","socket","debug","id","emit","version","get","err","error","start","dirname","Error","webSocketConfig","has","secure","socketPath","port","hostname","createServer","require","server","key","readFileSync","cert","info","Promise","resolve","unlinkSync","listen","chmodSync","socketio","pingTimeout","close","alpWebsocket","app","certPath","appWithWebsocket","Object","assign","websocket","subscribe","name","callbackOnSubscribe","callbackOnUnsubscribe","diconnect","callback","join","leave","removeListener"],"mappings":"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"}