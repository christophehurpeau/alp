{"version":3,"file":"index-browser.es.js","sources":["../src/browser.ts"],"sourcesContent":["/* eslint-disable no-use-before-define, @typescript-eslint/no-use-before-define, max-lines */\nimport { PRODUCTION } from 'pob-babel';\nimport socketio from 'socket.io-client';\nimport Logger from 'nightingale-logger';\nimport { BrowserApplication } from 'alp-types';\n\nconst logger = new Logger('alp:websocket');\n\ntype Socket = ReturnType<typeof socketio>;\n\nlet socket: Socket | undefined;\nlet successfulConnection: boolean | null = null;\nlet connected = false;\n\ninterface Websocket {\n  connected: boolean;\n  isConnected: () => boolean;\n  isDisconnected: () => boolean;\n  on: typeof on;\n  off: typeof off;\n  emit: typeof emit;\n  socket?: Socket;\n}\n\ndeclare module 'alp-types' {\n  interface BrowserApplication {\n    websocket: Websocket;\n  }\n}\ndeclare global {\n  interface Window {\n    __VERSION__: string;\n  }\n}\n\nconst callbackFirstConnectionError = () => {\n  successfulConnection = false;\n};\n\nexport const websocket: Websocket = {\n  get connected() {\n    return connected;\n  },\n  on,\n  off,\n  emit,\n  isConnected,\n  isDisconnected,\n  socket,\n};\n\nfunction start(app: BrowserApplication, namespaceName: string): Socket {\n  const { config, context } = app;\n\n  if (socket) {\n    throw new Error('WebSocket already started');\n  }\n\n  const webSocketConfig = config.get('webSocket') || config.get('websocket');\n\n  if (!webSocketConfig) {\n    throw new Error('Missing config webSocket');\n  }\n\n  if (!webSocketConfig.has('port')) {\n    throw new Error('Missing config webSocket.port');\n  }\n\n  const secure = webSocketConfig.get('secure');\n  const port = webSocketConfig.get('port');\n\n  const createdSocket = socketio(\n    `http${secure ? 's' : ''}://${\n      window.location.hostname\n    }:${port}/${namespaceName}`,\n    {\n      reconnectionDelay: 500,\n      reconnectionDelayMax: 2500,\n      timeout: 4000,\n      transports: ['websocket'],\n    },\n  );\n  socket = createdSocket;\n\n  createdSocket.on('connect_error', callbackFirstConnectionError);\n\n  createdSocket.on('connect', () => {\n    createdSocket.off('connect_error', callbackFirstConnectionError);\n    logger.success('connected');\n    successfulConnection = true;\n    connected = true;\n  });\n\n  createdSocket.on('reconnect', () => {\n    logger.success('reconnected');\n    connected = true;\n  });\n\n  createdSocket.on('disconnect', () => {\n    logger.warn('disconnected');\n    connected = false;\n  });\n\n  createdSocket.on('hello', ({ version }: { version: string }) => {\n    if (version !== window.__VERSION__) {\n      // eslint-disable-next-line no-alert\n      if (PRODUCTION && window.confirm(context.t('newversion'))) {\n        return window.location.reload(true);\n      } else {\n        console.warn('Version mismatch', {\n          serverVersion: version,\n          clientVersion: window.__VERSION__,\n        });\n      }\n    }\n  });\n\n  createdSocket.on('redux:action', (action: any) => {\n    logger.debug('dispatch action from websocket', action);\n    // eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n    // @ts-ignore\n    app.store.dispatch(action);\n  });\n\n  return createdSocket;\n}\n\nfunction emit<Result>(event: string, ...args: any[]): Promise<Result> {\n  if (!socket) throw new Error('Cannot call emit() before start()');\n  const existingSocket = socket;\n  logger.debug('emit', { args });\n  return new Promise((resolve, reject) => {\n    const resolved = setTimeout(() => {\n      logger.warn('websocket emit timeout', { args });\n      reject(new Error('websocket response timeout'));\n    }, 10000);\n\n    existingSocket.emit(\n      event,\n      ...args,\n      (error: Error | string | null, result: Result): void => {\n        clearTimeout(resolved);\n        if (error != null) {\n          return reject(typeof error === 'string' ? new Error(error) : error);\n        }\n        resolve(result);\n      },\n    );\n  });\n}\n\nfunction on<T extends Function>(event: string, handler: T): T {\n  if (!socket) throw new Error('Cannot call on() before start()');\n  socket.on(event, handler);\n  return handler;\n}\n\nfunction off(event: string, handler: Function): void {\n  if (!socket) throw new Error('Cannot call off() before start()');\n  socket.off(event, handler);\n}\n\nfunction isConnected(): boolean {\n  // socket.connected is not updated after reconnect event\n  return !!socket && connected;\n}\n\nfunction isDisconnected(): boolean {\n  return !!successfulConnection && !isConnected();\n}\n\nexport default function alpWebsocket(\n  app: BrowserApplication,\n  namespaceName = '',\n): Socket {\n  const socket = start(app, namespaceName);\n  app.websocket = websocket;\n  websocket.socket = socket;\n  return socket;\n}\n"],"names":["logger","Logger","socket","successfulConnection","connected","callbackFirstConnectionError","websocket","on","off","emit","isConnected","isDisconnected","start","app","namespaceName","config","context","Error","webSocketConfig","get","has","secure","port","createdSocket","socketio","window","location","hostname","reconnectionDelay","reconnectionDelayMax","timeout","transports","success","warn","version","__VERSION__","confirm","t","reload","console","serverVersion","clientVersion","action","debug","store","dispatch","event","args","existingSocket","Promise","resolve","reject","resolved","setTimeout","error","result","clearTimeout","handler","alpWebsocket"],"mappings":";;;AAAA;AAEA,AAIA,IAAMA,MAAM,GAAG,IAAIC,MAAJ,CAAW,eAAX,CAAf;AAIA,IAAIC,MAAJ;AACA,IAAIC,oBAAoC,GAAG,IAA3C;AACA,IAAIC,SAAS,GAAG,KAAhB;;AAuBA,IAAMC,4BAA4B,GAAG,SAA/BA,4BAA+B,GAAM;EACzCF,oBAAoB,GAAG,KAAvB;CADF;;AAIA,IAAaG,SAAoB,GAAG;MAC9BF,SAAJ,GAAgB;WACPA,SAAP;GAFgC;;EAIlCG,EAAE,EAAFA,EAJkC;EAKlCC,GAAG,EAAHA,GALkC;EAMlCC,IAAI,EAAJA,IANkC;EAOlCC,WAAW,EAAXA,WAPkC;EAQlCC,cAAc,EAAdA,cARkC;EASlCT,MAAM,EAANA;CATK;;AAYP,SAASU,KAAT,CAAeC,GAAf,EAAwCC,aAAxC,EAAuE;MAC7DC,MAD6D,GACzCF,GADyC,CAC7DE,MAD6D;MACrDC,OADqD,GACzCH,GADyC,CACrDG,OADqD;;MAGjEd,MAAJ,EAAY;UACJ,IAAIe,KAAJ,CAAU,2BAAV,CAAN;;;MAGIC,eAAe,GAAGH,MAAM,CAACI,GAAP,CAAW,WAAX,KAA2BJ,MAAM,CAACI,GAAP,CAAW,WAAX,CAAnD;;MAEI,CAACD,eAAL,EAAsB;UACd,IAAID,KAAJ,CAAU,0BAAV,CAAN;;;MAGE,CAACC,eAAe,CAACE,GAAhB,CAAoB,MAApB,CAAL,EAAkC;UAC1B,IAAIH,KAAJ,CAAU,+BAAV,CAAN;;;MAGII,MAAM,GAAGH,eAAe,CAACC,GAAhB,CAAoB,QAApB,CAAf;MACMG,IAAI,GAAGJ,eAAe,CAACC,GAAhB,CAAoB,MAApB,CAAb;MAEMI,aAAa,GAAGC,QAAQ,WACrBH,MAAM,GAAG,GAAH,GAAS,EADM,YAE1BI,MAAM,CAACC,QAAP,CAAgBC,QAFU,SAGxBL,IAHwB,SAGhBR,aAHgB,EAI5B;IACEc,iBAAiB,EAAE,GADrB;IAEEC,oBAAoB,EAAE,IAFxB;IAGEC,OAAO,EAAE,IAHX;IAIEC,UAAU,EAAE,CAAC,WAAD;GARc,CAA9B;EAWA7B,MAAM,GAAGqB,aAAT;EAEAA,aAAa,CAAChB,EAAd,CAAiB,eAAjB,EAAkCF,4BAAlC;EAEAkB,aAAa,CAAChB,EAAd,CAAiB,SAAjB,EAA4B,YAAM;IAChCgB,aAAa,CAACf,GAAd,CAAkB,eAAlB,EAAmCH,4BAAnC;IACAL,MAAM,CAACgC,OAAP,CAAe,WAAf;IACA7B,oBAAoB,GAAG,IAAvB;IACAC,SAAS,GAAG,IAAZ;GAJF;EAOAmB,aAAa,CAAChB,EAAd,CAAiB,WAAjB,EAA8B,YAAM;IAClCP,MAAM,CAACgC,OAAP,CAAe,aAAf;IACA5B,SAAS,GAAG,IAAZ;GAFF;EAKAmB,aAAa,CAAChB,EAAd,CAAiB,YAAjB,EAA+B,YAAM;IACnCP,MAAM,CAACiC,IAAP,CAAY,cAAZ;IACA7B,SAAS,GAAG,KAAZ;GAFF;EAKAmB,aAAa,CAAChB,EAAd,CAAiB,OAAjB,EAA0B,gBAAsC;QAAnC2B,OAAmC,QAAnCA,OAAmC;;QAC1DA,OAAO,KAAKT,MAAM,CAACU,WAAvB,EAAoC;;UAEhBV,MAAM,CAACW,OAAP,CAAepB,OAAO,CAACqB,CAAR,CAAU,YAAV,CAAf,CAAlB,EAA2D;eAClDZ,MAAM,CAACC,QAAP,CAAgBY,MAAhB,CAAuB,IAAvB,CAAP;OADF,MAEO;QACLC,OAAO,CAACN,IAAR,CAAa,kBAAb,EAAiC;UAC/BO,aAAa,EAAEN,OADgB;UAE/BO,aAAa,EAAEhB,MAAM,CAACU;SAFxB;;;GANN;EAcAZ,aAAa,CAAChB,EAAd,CAAiB,cAAjB,EAAiC,UAACmC,MAAD,EAAiB;IAChD1C,MAAM,CAAC2C,KAAP,CAAa,gCAAb,EAA+CD,MAA/C,EADgD;;;IAIhD7B,GAAG,CAAC+B,KAAJ,CAAUC,QAAV,CAAmBH,MAAnB;GAJF;SAOOnB,aAAP;;;AAGF,SAASd,IAAT,CAAsBqC,KAAtB,EAAsE;gCAA9BC,IAA8B;IAA9BA,IAA8B;;;MAChE,CAAC7C,MAAL,EAAa,MAAM,IAAIe,KAAJ,CAAU,mCAAV,CAAN;;MACP+B,cAAc,GAAG9C,MAAvB;;MAFsC6C,IAEtC;;;EACA/C,MAAM,CAAC2C,KAAP,CAAa,MAAb,EAAqB;IAAEI,IAAI,EAAJA;GAAvB;SACO,IAAIE,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;QAChCC,QAAQ,GAAGC,UAAU,CAAC,YAAM;MAChCrD,MAAM,CAACiC,IAAP,CAAY,wBAAZ,EAAsC;QAAEc,IAAI,EAAJA;OAAxC;MACAI,MAAM,CAAC,IAAIlC,KAAJ,CAAU,4BAAV,CAAD,CAAN;KAFyB,EAGxB,KAHwB,CAA3B;IAKA+B,cAAc,CAACvC,IAAf,OAAAuC,cAAc,GACZF,KADY,SAETC,IAFS,GAGZ,UAACO,KAAD,EAA+BC,MAA/B,EAAwD;MACtDC,YAAY,CAACJ,QAAD,CAAZ;;UACIE,KAAK,IAAI,IAAb,EAAmB;eACVH,MAAM,CAAC,OAAOG,KAAP,KAAiB,QAAjB,GAA4B,IAAIrC,KAAJ,CAAUqC,KAAV,CAA5B,GAA+CA,KAAhD,CAAb;;;MAEFJ,OAAO,CAACK,MAAD,CAAP;KARU,GAAd;GANK,CAAP;;;AAoBF,SAAShD,EAAT,CAAgCuC,KAAhC,EAA+CW,OAA/C,EAA8D;MACxD,CAACvD,MAAL,EAAa,MAAM,IAAIe,KAAJ,CAAU,iCAAV,CAAN;EACbf,MAAM,CAACK,EAAP,CAAUuC,KAAV,EAAiBW,OAAjB;SACOA,OAAP;;;AAGF,SAASjD,GAAT,CAAasC,KAAb,EAA4BW,OAA5B,EAAqD;MAC/C,CAACvD,MAAL,EAAa,MAAM,IAAIe,KAAJ,CAAU,kCAAV,CAAN;EACbf,MAAM,CAACM,GAAP,CAAWsC,KAAX,EAAkBW,OAAlB;;;AAGF,SAAS/C,WAAT,GAAgC;;SAEvB,CAAC,CAACR,MAAF,IAAYE,SAAnB;;;AAGF,SAASO,cAAT,GAAmC;SAC1B,CAAC,CAACR,oBAAF,IAA0B,CAACO,WAAW,EAA7C;;;AAGF,AAAe,SAASgD,YAAT,CACb7C,GADa,EAEbC,aAFa,EAGL;MADRA,aACQ;IADRA,aACQ,GADQ,EACR;;;MACFZ,MAAM,GAAGU,KAAK,CAACC,GAAD,EAAMC,aAAN,CAApB;EACAD,GAAG,CAACP,SAAJ,GAAgBA,SAAhB;EACAA,SAAS,CAACJ,MAAV,GAAmBA,MAAnB;SACOA,MAAP;;;;;;"}