{"version":3,"file":"index-browser.es.js","sources":["../src/redux/middleware.js","../src/browser.js"],"sourcesContent":["import Logger from 'nightingale-logger';\n\nconst logger = new Logger('alp-websocket:middleware');\n\nexport default app => store => next => action => {\n  if (!action.meta || !action.meta.websocket) {\n    return next(action);\n  }\n\n  if (!action.meta.promise) {\n    app.websocket.emit(action.type, action);\n    return;\n  }\n\n  const resolved = setTimeout(() => {\n    logger.warn('websocket emit timeout', { action });\n    // eslint-disable-next-line no-console\n    console.log('alp.react-redux websocket emit timeout', action);\n  }, 10000);\n\n  app.websocket.emit(action.type, action, action => {\n    clearTimeout(resolved);\n    if (action) {\n      store.dispatch(action);\n    }\n  });\n};\n","/* eslint-disable no-use-before-define */\nimport socketio from 'socket.io-client';\nimport Logger from 'nightingale-logger';\nimport reduxMiddleware from './redux/middleware';\n\nconst logger = new Logger('alp:websocket');\n\nlet socket;\nlet successfulConnection = null;\nlet connected = false;\n\nexport const websocket = {\n  get connected() {\n    return connected;\n  },\n  on,\n  off,\n  emit,\n  isConnected,\n  isDisconnected,\n};\n\nconst REDUX_INIT_TYPE = '@@INIT';\nconst WEBSOCKET_STATE_ACTION_TYPE = 'alp:websocket/state';\n\nexport default function alpWebsocket(app, namespaceName) {\n  app.reduxReducers.websocket = (state = 'disconnected', action) => {\n    if (action.type === WEBSOCKET_STATE_ACTION_TYPE) return action.state;\n    if (action.type === REDUX_INIT_TYPE) {\n      setTimeout(() => {\n        if (successfulConnection !== false) {\n          app.store.dispatch({\n            type: WEBSOCKET_STATE_ACTION_TYPE,\n            state: connected ? 'connected' : 'connecting',\n          });\n        }\n      });\n      return state;\n    }\n    return state;\n  };\n\n  app.reduxMiddlewares.push(reduxMiddleware(app));\n\n  start(app, namespaceName);\n  app.websocket = websocket;\n  websocket.socket = socket;\n  return socket;\n}\n\nfunction start(app, namespaceName = '') {\n  const { config, context } = app;\n\n  if (socket) {\n    throw new Error('WebSocket already started');\n  }\n\n  const webSocketConfig = config.get('webSocket') || config.get('websocket');\n\n  if (!webSocketConfig) {\n    throw new Error('Missing config webSocket');\n  }\n\n  if (!webSocketConfig.has('port')) {\n    throw new Error('Missing config webSocket.port');\n  }\n\n  const secure = webSocketConfig.get('secure');\n  const port = webSocketConfig.get('port');\n\n  socket = socketio(\n    `http${secure ? 's' : ''}://${window.location.hostname}:${port}/${namespaceName}`,\n    {\n      reconnectionDelay: 500,\n      reconnectionDelayMax: 2500,\n      timeout: 4000,\n      transports: ['websocket'],\n    },\n  );\n\n  const callbackFirstConnectionError = () => {\n    successfulConnection = false;\n  };\n\n  socket.on('connect_error', callbackFirstConnectionError);\n\n  socket.on('connect', () => {\n    socket.off('connect_error', callbackFirstConnectionError);\n    logger.success('connected');\n    successfulConnection = true;\n    connected = true;\n    if (app.store) {\n      app.store.dispatch({ type: WEBSOCKET_STATE_ACTION_TYPE, state: 'connected' });\n    }\n  });\n\n  socket.on('reconnect', () => {\n    logger.success('reconnected');\n    connected = true;\n    app.store.dispatch({ type: WEBSOCKET_STATE_ACTION_TYPE, state: 'connected' });\n  });\n\n  socket.on('disconnect', () => {\n    logger.warn('disconnected');\n    connected = false;\n    app.store.dispatch({ type: WEBSOCKET_STATE_ACTION_TYPE, state: 'disconnected' });\n  });\n\n  socket.on('hello', ({ version }) => {\n    if (version !== window.VERSION) {\n      // eslint-disable-next-line no-alert\n      if (process.env.NODE_ENV === 'production' && window.confirm(context.t('newversion'))) {\n        return window.location.reload(true);\n      } else {\n        console.warn('Version mismatch', { serverVersion: version, clientVersion: window.VERSION });\n      }\n    }\n  });\n\n  socket.on('redux:action', action => {\n    logger.debug('dispatch action from websocket', action);\n    app.store.dispatch(action);\n  });\n\n  return socket;\n}\n\nfunction emit(...args): Promise<any> {\n  logger.debug('emit', { args });\n  return new Promise((resolve, reject) => {\n    const resolved = setTimeout(() => {\n      logger.warn('websocket emit timeout', { args });\n      reject(new Error('websocket response timeout'));\n    }, 10000);\n\n    socket.emit(...args, (error, result) => {\n      clearTimeout(resolved);\n      if (error != null) return reject(typeof error === 'string' ? new Error(error) : error);\n      resolve(result);\n    });\n  });\n}\n\nfunction on(type, handler) {\n  socket.on(type, handler);\n  return handler;\n}\n\nfunction off(type, handler) {\n  socket.off(type, handler);\n}\n\nfunction isConnected() {\n  // socket.connected is not updated after reconnect event\n  return socket && connected;\n}\n\nfunction isDisconnected() {\n  return successfulConnection && !isConnected();\n}\n"],"names":["logger","Logger","action","meta","websocket","next","promise","emit","type","resolved","setTimeout","warn","log","dispatch","socket","successfulConnection","connected","REDUX_INIT_TYPE","WEBSOCKET_STATE_ACTION_TYPE","alpWebsocket","app","namespaceName","reduxReducers","state","store","reduxMiddlewares","push","reduxMiddleware","start","config","context","Error","webSocketConfig","get","has","secure","port","socketio","window","location","hostname","callbackFirstConnectionError","on","off","success","version","VERSION","process","env","NODE_ENV","confirm","t","reload","serverVersion","clientVersion","debug","args","Promise","resolve","reject","error","result","handler","isConnected","isDisconnected"],"mappings":"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"}