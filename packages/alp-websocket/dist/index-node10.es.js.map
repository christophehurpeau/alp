{"version":3,"file":"index-node10.es.js","sources":["../src/index.ts"],"sourcesContent":["/* eslint-disable no-use-before-define */\nimport { readFileSync } from 'fs';\nimport socketio, { Server, Socket } from 'socket.io';\nimport Logger from 'nightingale-logger';\nimport { NodeApplication, NodeConfig } from 'alp-types';\n\ninterface NodeApplicationWithWebsocket extends NodeApplication {\n  websocket: Server;\n}\n\nconst logger = new Logger('alp:websocket');\n\nlet io: Server;\n\nfunction start(config: NodeConfig, dirname: string) {\n  if (io) {\n    throw new Error('Already started');\n  }\n\n  const webSocketConfig = config.get('webSocket') || config.get('websocket');\n\n  if (!webSocketConfig) {\n    throw new Error('Missing config webSocket');\n  }\n\n  if (!webSocketConfig.has('port')) {\n    throw new Error('Missing config webSocket.port');\n  }\n\n  const secure = webSocketConfig.get('secure');\n  const port = webSocketConfig.get('port');\n  // eslint-disable-next-line global-require, import/no-dynamic-require\n  const createServer = require(secure ? 'https' : 'http').createServer;\n\n  const server = (() => {\n    if (!secure) {\n      return createServer();\n    }\n\n    return createServer({\n      key: readFileSync(`${dirname}/server.key`),\n      cert: readFileSync(`${dirname}/server.crt`),\n    });\n  })();\n\n  logger.info('Starting', { port });\n  server.listen(port, () => logger.info('Listening', { port }));\n  server.on('error', (err: Error) => logger.error(err));\n  io = socketio(server);\n\n  io.on('connection', (socket) => {\n    logger.debug('connected', { id: socket.id });\n    socket.emit('hello', { version: config.get('version') });\n\n    socket.on('error', (err) => logger.error(err));\n    socket.on('disconnect', () => {\n      logger.debug('disconnected', { id: socket.id });\n    });\n  });\n\n  io.on('error', (err: Error) => logger.error(err));\n\n  return io;\n}\n\nexport function close() {\n  io.close();\n}\n\n/**\n * @param {Koa|AlpNodeApp} app\n * @param {string} [dirname] for tls, dirname of server.key server.crt. If undefined: app.certPath\n */\nexport default function alpWebsocket(app: NodeApplication, dirname?: string) {\n  // @ts-ignore\n  start(app.config, dirname || app.certPath);\n\n  const appWithWebsocket: NodeApplicationWithWebsocket = Object.assign(app, {\n    websocket: io,\n  });\n\n  app.on('close', close);\n  return appWithWebsocket;\n}\n\nexport function subscribe(\n  socket: Socket,\n  name: string,\n  callbackOnSubscribe: () => void,\n  callbackOnUnsubscribe: () => void,\n) {\n  const diconnect = callbackOnUnsubscribe && (() => callbackOnUnsubscribe());\n  socket.on(`subscribe:${name}`, (callback) => {\n    logger.info('join', { name });\n    socket.join(name);\n\n    if (callbackOnSubscribe) {\n      callback(null, callbackOnSubscribe());\n    } else {\n      callback(null);\n    }\n\n    if (diconnect) socket.on('disconnect', diconnect);\n  });\n\n  socket.on(`unsubscribe:${name}`, (callback) => {\n    logger.info('leave', { name });\n    socket.leave(name);\n    if (diconnect) socket.removeListener('disconnect', diconnect);\n\n    if (callbackOnUnsubscribe) {\n      callback(null, callbackOnUnsubscribe());\n    } else {\n      callback(null);\n    }\n  });\n}\n"],"names":["logger","Logger","io","start","config","dirname","Error","webSocketConfig","get","has","secure","port","createServer","require","server","key","readFileSync","cert","info","listen","on","err","error","socketio","socket","debug","id","emit","version","close","alpWebsocket","app","certPath","appWithWebsocket","Object","assign","websocket","subscribe","name","callbackOnSubscribe","callbackOnUnsubscribe","diconnect","callback","join","leave","removeListener"],"mappings":"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"}