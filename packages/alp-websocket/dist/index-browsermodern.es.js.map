{"version":3,"file":"index-browsermodern.es.js","sources":["../src/browser.ts"],"sourcesContent":["/* eslint-disable no-use-before-define, @typescript-eslint/no-use-before-define, max-lines */\nimport { PRODUCTION } from 'pob-babel';\nimport socketio from 'socket.io-client';\nimport Logger from 'nightingale-logger';\nimport { BrowserApplication } from 'alp-types';\n\nconst logger = new Logger('alp:websocket');\n\ntype Socket = ReturnType<typeof socketio>;\n\nlet socket: Socket | undefined;\nlet successfulConnection: boolean | null = null;\nlet connected = false;\n\ninterface Websocket {\n  connected: boolean;\n  isConnected: () => boolean;\n  isDisconnected: () => boolean;\n  on: typeof on;\n  off: typeof off;\n  emit: typeof emit;\n  socket?: Socket;\n}\n\ndeclare module 'alp-types' {\n  interface BrowserApplication {\n    websocket: Websocket;\n  }\n}\ndeclare global {\n  interface Window {\n    __VERSION__: string;\n  }\n}\n\nexport const websocket: Websocket = {\n  get connected() {\n    return connected;\n  },\n  on,\n  off,\n  emit,\n  isConnected,\n  isDisconnected,\n  socket,\n};\n\nfunction start(app: BrowserApplication, namespaceName: string): Socket {\n  const { config, context } = app;\n\n  if (socket) {\n    throw new Error('WebSocket already started');\n  }\n\n  const webSocketConfig = config.get('webSocket') || config.get('websocket');\n\n  if (!webSocketConfig) {\n    throw new Error('Missing config webSocket');\n  }\n\n  if (!webSocketConfig.has('port')) {\n    throw new Error('Missing config webSocket.port');\n  }\n\n  const secure = webSocketConfig.get('secure');\n  const port = webSocketConfig.get('port');\n\n  const createdSocket = socketio(\n    `http${secure ? 's' : ''}://${\n      window.location.hostname\n    }:${port}/${namespaceName}`,\n    {\n      reconnectionDelay: 500,\n      reconnectionDelayMax: 2500,\n      timeout: 4000,\n      transports: ['websocket'],\n    },\n  );\n  socket = createdSocket;\n\n  const callbackFirstConnectionError = () => {\n    successfulConnection = false;\n  };\n\n  createdSocket.on('connect_error', callbackFirstConnectionError);\n\n  createdSocket.on('connect', () => {\n    createdSocket.off('connect_error', callbackFirstConnectionError);\n    logger.success('connected');\n    successfulConnection = true;\n    connected = true;\n  });\n\n  createdSocket.on('reconnect', () => {\n    logger.success('reconnected');\n    connected = true;\n  });\n\n  createdSocket.on('disconnect', () => {\n    logger.warn('disconnected');\n    connected = false;\n  });\n\n  createdSocket.on('hello', ({ version }: { version: string }) => {\n    if (version !== window.__VERSION__) {\n      // eslint-disable-next-line no-alert\n      if (PRODUCTION && window.confirm(context.t('newversion'))) {\n        return window.location.reload(true);\n      } else {\n        console.warn('Version mismatch', {\n          serverVersion: version,\n          clientVersion: window.__VERSION__,\n        });\n      }\n    }\n  });\n\n  createdSocket.on('redux:action', (action: any) => {\n    logger.debug('dispatch action from websocket', action);\n    // eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n    // @ts-ignore\n    app.store.dispatch(action);\n  });\n\n  return createdSocket;\n}\n\nfunction emit<Result>(event: string, ...args: any[]): Promise<Result> {\n  if (!socket) throw new Error('Cannot call emit() before start()');\n  const existingSocket = socket;\n  logger.debug('emit', { args });\n  return new Promise((resolve, reject) => {\n    const resolved = setTimeout(() => {\n      logger.warn('websocket emit timeout', { args });\n      reject(new Error('websocket response timeout'));\n    }, 10000);\n\n    existingSocket.emit(\n      event,\n      ...args,\n      (error: Error | string | null, result: Result): void => {\n        clearTimeout(resolved);\n        if (error != null) {\n          return reject(typeof error === 'string' ? new Error(error) : error);\n        }\n        resolve(result);\n      },\n    );\n  });\n}\n\nfunction on<T extends Function>(event: string, handler: T): T {\n  if (!socket) throw new Error('Cannot call on() before start()');\n  socket.on(event, handler);\n  return handler;\n}\n\nfunction off(event: string, handler: Function): void {\n  if (!socket) throw new Error('Cannot call off() before start()');\n  socket.off(event, handler);\n}\n\nfunction isConnected(): boolean {\n  // socket.connected is not updated after reconnect event\n  return !!socket && connected;\n}\n\nfunction isDisconnected(): boolean {\n  return !!successfulConnection && !isConnected();\n}\n\nexport default function alpWebsocket(\n  app: BrowserApplication,\n  namespaceName = '',\n): Socket {\n  const socket = start(app, namespaceName);\n  app.websocket = websocket;\n  websocket.socket = socket;\n  return socket;\n}\n"],"names":["logger","Logger","socket","successfulConnection","connected","websocket","on","off","emit","isConnected","isDisconnected","start","app","namespaceName","config","context","Error","webSocketConfig","get","has","secure","port","createdSocket","socketio","window","location","hostname","reconnectionDelay","reconnectionDelayMax","timeout","transports","callbackFirstConnectionError","success","warn","version","__VERSION__","confirm","t","reload","console","serverVersion","clientVersion","action","debug","store","dispatch","event","args","existingSocket","Promise","resolve","reject","resolved","setTimeout","error","result","clearTimeout","handler","alpWebsocket"],"mappings":"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"}