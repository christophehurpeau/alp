{"version":3,"file":"index-browsermodern.es.js","sources":["../src/browser.ts"],"sourcesContent":["/* eslint-disable no-use-before-define, @typescript-eslint/no-use-before-define, max-lines */\nimport socketio from 'socket.io-client';\nimport Logger from 'nightingale-logger';\nimport { BrowserApplication } from 'alp-types';\n\nconst logger = new Logger('alp:websocket');\n\ntype Socket = ReturnType<typeof socketio>;\n\nlet socket: Socket | undefined;\nlet successfulConnection: boolean | null = null;\nlet connected = false;\n\ninterface Websocket {\n  connected: boolean;\n  isConnected: () => boolean;\n  isDisconnected: () => boolean;\n  on: typeof on;\n  off: typeof off;\n  emit: typeof emit;\n  socket?: Socket;\n}\n\ndeclare module 'alp-types' {\n  interface BrowserApplication {\n    websocket: Websocket;\n  }\n}\ndeclare global {\n  interface Window {\n    __VERSION__: string;\n  }\n}\n\nexport const websocket: Websocket = {\n  get connected() {\n    return connected;\n  },\n  on,\n  off,\n  emit,\n  isConnected,\n  isDisconnected,\n  socket,\n};\n\nfunction start(app: BrowserApplication, namespaceName: string) {\n  const { config, context } = app;\n\n  if (socket) {\n    throw new Error('WebSocket already started');\n  }\n\n  const webSocketConfig = config.get('webSocket') || config.get('websocket');\n\n  if (!webSocketConfig) {\n    throw new Error('Missing config webSocket');\n  }\n\n  if (!webSocketConfig.has('port')) {\n    throw new Error('Missing config webSocket.port');\n  }\n\n  const secure = webSocketConfig.get('secure');\n  const port = webSocketConfig.get('port');\n\n  socket = socketio(\n    `http${secure ? 's' : ''}://${\n      window.location.hostname\n    }:${port}/${namespaceName}`,\n    {\n      reconnectionDelay: 500,\n      reconnectionDelayMax: 2500,\n      timeout: 4000,\n      transports: ['websocket'],\n    },\n  );\n\n  const callbackFirstConnectionError = () => {\n    successfulConnection = false;\n  };\n\n  socket.on('connect_error', callbackFirstConnectionError);\n\n  socket.on('connect', () => {\n    (socket as Socket).off('connect_error', callbackFirstConnectionError);\n    logger.success('connected');\n    successfulConnection = true;\n    connected = true;\n  });\n\n  socket.on('reconnect', () => {\n    logger.success('reconnected');\n    connected = true;\n  });\n\n  socket.on('disconnect', () => {\n    logger.warn('disconnected');\n    connected = false;\n  });\n\n  socket.on('hello', ({ version }: { version: string }) => {\n    if (version !== window.__VERSION__) {\n      // eslint-disable-next-line no-alert\n      if (\n        process.env.NODE_ENV === 'production' &&\n        window.confirm(context.t('newversion'))\n      ) {\n        return window.location.reload(true);\n      } else {\n        console.warn('Version mismatch', {\n          serverVersion: version,\n          clientVersion: window.__VERSION__,\n        });\n      }\n    }\n  });\n\n  socket.on('redux:action', (action: any) => {\n    logger.debug('dispatch action from websocket', action);\n    // @ts-ignore\n    app.store.dispatch(action);\n  });\n\n  return socket;\n}\n\nfunction emit(event: string, ...args: any[]): Promise<any> {\n  if (!socket) throw new Error('Cannot call emit() before start()');\n  logger.debug('emit', { args });\n  return new Promise((resolve, reject) => {\n    const resolved = setTimeout(() => {\n      logger.warn('websocket emit timeout', { args });\n      reject(new Error('websocket response timeout'));\n    }, 10000);\n\n    (socket as Socket).emit(\n      event,\n      ...args,\n      (error: Error | string | null, result: any) => {\n        clearTimeout(resolved);\n        if (error != null) {\n          return reject(typeof error === 'string' ? new Error(error) : error);\n        }\n        resolve(result);\n      },\n    );\n  });\n}\n\nfunction on<T extends Function>(event: string, handler: T): T {\n  if (!socket) throw new Error('Cannot call on() before start()');\n  socket.on(event, handler);\n  return handler;\n}\n\nfunction off(event: string, handler: Function): void {\n  if (!socket) throw new Error('Cannot call off() before start()');\n  socket.off(event, handler);\n}\n\nfunction isConnected(): boolean {\n  // socket.connected is not updated after reconnect event\n  return !!socket && connected;\n}\n\nfunction isDisconnected(): boolean {\n  return !!successfulConnection && !isConnected();\n}\n\nexport default function alpWebsocket(\n  app: BrowserApplication,\n  namespaceName: string = '',\n): Socket {\n  start(app, namespaceName);\n  app.websocket = websocket;\n  websocket.socket = socket;\n  return socket;\n}\n"],"names":["logger","Logger","socket","successfulConnection","connected","websocket","on","off","emit","isConnected","isDisconnected","start","app","namespaceName","config","context","Error","webSocketConfig","get","has","secure","port","socketio","window","location","hostname","reconnectionDelay","reconnectionDelayMax","timeout","transports","callbackFirstConnectionError","success","warn","version","__VERSION__","process","env","NODE_ENV","confirm","t","reload","console","serverVersion","clientVersion","action","debug","store","dispatch","event","args","Promise","resolve","reject","resolved","setTimeout","error","result","clearTimeout","handler","alpWebsocket"],"mappings":"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"}