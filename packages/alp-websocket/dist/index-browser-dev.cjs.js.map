{"version":3,"file":"index-browser-dev.cjs.js","sources":["../src/browser.ts"],"sourcesContent":["/* eslint-disable no-use-before-define, @typescript-eslint/no-use-before-define, max-lines */\nimport { PRODUCTION } from 'pob-babel';\nimport socketio from 'socket.io-client';\nimport Logger from 'nightingale-logger';\nimport { BrowserApplication } from 'alp-types';\n\nconst logger = new Logger('alp:websocket');\n\ntype Socket = ReturnType<typeof socketio>;\n\nlet socket: Socket | undefined;\nlet successfulConnection: boolean | null = null;\nlet connected = false;\n\ninterface Websocket {\n  connected: boolean;\n  isConnected: () => boolean;\n  isDisconnected: () => boolean;\n  on: typeof on;\n  off: typeof off;\n  emit: typeof emit;\n  socket?: Socket;\n}\n\ndeclare module 'alp-types' {\n  interface BrowserApplication {\n    websocket: Websocket;\n  }\n}\ndeclare global {\n  interface Window {\n    __VERSION__: string;\n  }\n}\n\nconst callbackFirstConnectionError = () => {\n  successfulConnection = false;\n};\n\nexport const websocket: Websocket = {\n  get connected() {\n    return connected;\n  },\n  on,\n  off,\n  emit,\n  isConnected,\n  isDisconnected,\n  socket,\n};\n\nfunction start(app: BrowserApplication, namespaceName: string): Socket {\n  const { config, context } = app;\n\n  if (socket) {\n    throw new Error('WebSocket already started');\n  }\n\n  const webSocketConfig = config.get('webSocket') || config.get('websocket');\n\n  if (!webSocketConfig) {\n    throw new Error('Missing config webSocket');\n  }\n\n  if (!webSocketConfig.has('port')) {\n    throw new Error('Missing config webSocket.port');\n  }\n\n  const secure = webSocketConfig.get('secure');\n  const port = webSocketConfig.get('port');\n\n  const createdSocket = socketio(\n    `http${secure ? 's' : ''}://${\n      window.location.hostname\n    }:${port}/${namespaceName}`,\n    {\n      reconnectionDelay: 500,\n      reconnectionDelayMax: 2500,\n      timeout: 4000,\n      transports: ['websocket'],\n    },\n  );\n  socket = createdSocket;\n\n  createdSocket.on('connect_error', callbackFirstConnectionError);\n\n  createdSocket.on('connect', () => {\n    createdSocket.off('connect_error', callbackFirstConnectionError);\n    logger.success('connected');\n    successfulConnection = true;\n    connected = true;\n  });\n\n  createdSocket.on('reconnect', () => {\n    logger.success('reconnected');\n    connected = true;\n  });\n\n  createdSocket.on('disconnect', () => {\n    logger.warn('disconnected');\n    connected = false;\n  });\n\n  createdSocket.on('hello', ({ version }: { version: string }) => {\n    if (version !== window.__VERSION__) {\n      // eslint-disable-next-line no-alert\n      if (PRODUCTION && window.confirm(context.t('newversion'))) {\n        return window.location.reload(true);\n      } else {\n        console.warn('Version mismatch', {\n          serverVersion: version,\n          clientVersion: window.__VERSION__,\n        });\n      }\n    }\n  });\n\n  createdSocket.on('redux:action', (action: any) => {\n    logger.debug('dispatch action from websocket', action);\n    // eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n    // @ts-ignore\n    app.store.dispatch(action);\n  });\n\n  return createdSocket;\n}\n\nfunction emit<Result>(event: string, ...args: any[]): Promise<Result> {\n  if (!socket) throw new Error('Cannot call emit() before start()');\n  const existingSocket = socket;\n  logger.debug('emit', { args });\n  return new Promise((resolve, reject) => {\n    const resolved = setTimeout(() => {\n      logger.warn('websocket emit timeout', { args });\n      reject(new Error('websocket response timeout'));\n    }, 10000);\n\n    existingSocket.emit(\n      event,\n      ...args,\n      (error: Error | string | null, result: Result): void => {\n        clearTimeout(resolved);\n        if (error != null) {\n          return reject(typeof error === 'string' ? new Error(error) : error);\n        }\n        resolve(result);\n      },\n    );\n  });\n}\n\nfunction on<T extends Function>(event: string, handler: T): T {\n  if (!socket) throw new Error('Cannot call on() before start()');\n  socket.on(event, handler);\n  return handler;\n}\n\nfunction off(event: string, handler: Function): void {\n  if (!socket) throw new Error('Cannot call off() before start()');\n  socket.off(event, handler);\n}\n\nfunction isConnected(): boolean {\n  // socket.connected is not updated after reconnect event\n  return !!socket && connected;\n}\n\nfunction isDisconnected(): boolean {\n  return !!successfulConnection && !isConnected();\n}\n\nexport default function alpWebsocket(\n  app: BrowserApplication,\n  namespaceName = '',\n): Socket {\n  const socket = start(app, namespaceName);\n  app.websocket = websocket;\n  websocket.socket = socket;\n  return socket;\n}\n"],"names":["logger","Logger","socket","successfulConnection","connected","callbackFirstConnectionError","websocket","on","off","emit","isConnected","isDisconnected","start","app","namespaceName","config","context","Error","webSocketConfig","get","has","secure","port","createdSocket","socketio","window","location","hostname","reconnectionDelay","reconnectionDelayMax","timeout","transports","success","warn","version","__VERSION__","console","serverVersion","clientVersion","action","debug","store","dispatch","event","args","existingSocket","Promise","resolve","reject","resolved","setTimeout","error","result","clearTimeout","handler","alpWebsocket"],"mappings":"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"}