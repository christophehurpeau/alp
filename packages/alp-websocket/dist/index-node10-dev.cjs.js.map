{"version":3,"file":"index-node10-dev.cjs.js","sources":["../src/index.ts"],"sourcesContent":["/* eslint-disable no-use-before-define */\nimport { chmodSync, readFileSync, unlinkSync } from 'fs';\nimport socketio, { Namespace, Server, Socket } from 'socket.io';\nimport Logger from 'nightingale-logger';\nimport { NodeApplication, NodeConfig } from 'alp-types';\n\ninterface NodeApplicationWithWebsocket extends NodeApplication {\n  websocket: Server;\n}\n\nconst logger = new Logger('alp:websocket');\n\nlet io: Server;\n\nexport function initNamespace(config: NodeConfig, ns: Namespace | Server) {\n  ns.on('connection', (socket): void => {\n    logger.debug('connected', { id: socket.id });\n    socket.emit('hello', { version: config.get('version') });\n\n    socket.on('error', (err): void => {\n      logger.error(err);\n    });\n    socket.on('disconnect', (): void => {\n      logger.debug('disconnected', { id: socket.id });\n    });\n  });\n}\n\nfunction start(config: NodeConfig, dirname: string): Promise<Server> {\n  if (io) {\n    throw new Error('Already started');\n  }\n\n  const webSocketConfig = config.get('webSocket') || config.get('websocket');\n\n  if (!webSocketConfig) {\n    throw new Error('Missing config webSocket');\n  }\n\n  if (!webSocketConfig.has('port') && !webSocketConfig.has('socketPath')) {\n    throw new Error('Missing config webSocket.port');\n  }\n\n  const secure = webSocketConfig.get('secure');\n  const socketPath = webSocketConfig.get('socketPath');\n  const port = webSocketConfig.get('port');\n  const hostname = webSocketConfig.get('hostname');\n  // eslint-disable-next-line global-require, import/no-dynamic-require\n  const createServer = require(secure ? 'https' : 'http').createServer;\n\n  const server = (() => {\n    if (!secure) {\n      return createServer();\n    }\n\n    return createServer({\n      key: readFileSync(`${dirname}/server.key`),\n      cert: readFileSync(`${dirname}/server.crt`),\n    });\n  })();\n\n  logger.info('Creating server', socketPath ? { socketPath } : { port });\n\n  return new Promise((resolve) => {\n    if (socketPath) {\n      try {\n        unlinkSync(socketPath);\n      } catch (err) {}\n\n      server.listen(socketPath, () => {\n        if (socketPath) {\n          chmodSync(socketPath, '777');\n        }\n\n        logger.info('Server listening', { socketPath });\n        resolve(io);\n      });\n    } else {\n      server.listen(port, hostname, () => {\n        logger.info('Server listening', { port });\n        resolve(io);\n      });\n    }\n\n    server.on('error', (err: Error) => logger.error(err));\n    io = socketio(server, {\n      // https://github.com/socketio/socket.io/issues/3259\n      pingTimeout: 30000,\n    });\n\n    initNamespace(config, io);\n\n    io.on('error', (err: Error) => logger.error(err));\n  });\n}\n\nexport function close(): void {\n  io.close();\n}\n\n/**\n * @param {Koa|AlpNodeApp} app\n * @param {string} [dirname] for tls, dirname of server.key server.crt. If undefined: app.certPath\n */\nexport default function alpWebsocket(app: NodeApplication, dirname?: string) {\n  // eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n  // @ts-ignore\n  start(app.config, dirname || app.certPath);\n\n  const appWithWebsocket: NodeApplicationWithWebsocket = Object.assign(app, {\n    websocket: io,\n  });\n\n  app.on('close', close);\n  return appWithWebsocket;\n}\n\nexport function subscribe(\n  socket: Socket,\n  name: string,\n  callbackOnSubscribe: () => void,\n  callbackOnUnsubscribe: () => void,\n) {\n  const diconnect = callbackOnUnsubscribe && (() => callbackOnUnsubscribe());\n  socket.on(`subscribe:${name}`, (callback) => {\n    logger.info('join', { name });\n    socket.join(name);\n\n    if (callbackOnSubscribe) {\n      callback(null, callbackOnSubscribe());\n    } else {\n      callback(null);\n    }\n\n    if (diconnect) socket.on('disconnect', diconnect);\n  });\n\n  socket.on(`unsubscribe:${name}`, (callback) => {\n    logger.info('leave', { name });\n    socket.leave(name);\n    if (diconnect) socket.removeListener('disconnect', diconnect);\n\n    if (callbackOnUnsubscribe) {\n      callback(null, callbackOnUnsubscribe());\n    } else {\n      callback(null);\n    }\n  });\n}\n"],"names":["logger","Logger","io","initNamespace","config","ns","on","socket","debug","id","emit","version","get","err","error","start","dirname","Error","webSocketConfig","has","secure","socketPath","port","hostname","createServer","require","server","key","readFileSync","cert","info","Promise","resolve","unlinkSync","listen","chmodSync","socketio","pingTimeout","close","alpWebsocket","app","certPath","appWithWebsocket","Object","assign","websocket","subscribe","name","callbackOnSubscribe","callbackOnUnsubscribe","diconnect","callback","join","leave","removeListener"],"mappings":"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"}