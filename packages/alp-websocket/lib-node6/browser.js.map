{"version":3,"sources":["../src/browser.js"],"names":[],"mappings":";;;;;kBAMwB,Y;;AANxB;;;;AACA;;;;;;AAEA,MAAM,SAAS,gCAAW,eAAX,CAAf;AACA,IAAI,MAAJ;;AAEe,SAAS,YAAT,CAAsB,GAAtB,EAA2B,aAA3B,EAA0C;AACrD,UAAM,IAAI,MAAV,EAAkB,aAAlB;AACA,QAAI,SAAJ,GAAgB;AACZ,cADY;AAEZ,UAFY;AAGZ,WAHY;AAIZ;AAJY,KAAhB;;AAOA,WAAO,MAAP;AACH;;AAED,SAAS,KAAT,CAAe,MAAf,EAA2C;AAAA,QAApB,aAAoB,yDAAJ,EAAI;;AACvC,QAAI,MAAJ,EAAY;AACR,cAAM,IAAI,KAAJ,CAAU,2BAAV,CAAN;AACH;;AAED,UAAM,kBAAkB,OAAO,GAAP,CAAW,WAAX,CAAxB;;AAEA,QAAI,CAAC,eAAL,EAAsB;AAClB,cAAM,IAAI,KAAJ,CAAU,0BAAV,CAAN;AACH;;AAED,QAAI,CAAC,gBAAgB,GAAhB,CAAoB,MAApB,CAAL,EAAkC;AAC9B,cAAM,IAAI,KAAJ,CAAU,+BAAV,CAAN;AACH;;AAED,UAAM,SAAS,gBAAgB,GAAhB,CAAoB,QAApB,CAAf;AACA,UAAM,OAAO,gBAAgB,GAAhB,CAAoB,MAApB,CAAb;;AAEA,aAAS,sBAAU,QAAM,SAAS,GAAT,GAAe,EAAG,QAAK,SAAS,QAAS,MAAG,IAAK,MAAG,aAAc,GAAlF,EAAqF;AAC1F,2BAAmB,GADuE;AAE1F,8BAAsB,IAFoE;AAG1F,iBAAS,IAHiF;AAI1F,oBAAY,CAAC,WAAD;AAJ8E,KAArF,CAAT;;AAOA,WAAO,EAAP,CAAU,SAAV,EAAqB,MAAM;AACvB,eAAO,OAAP,CAAe,WAAf;AACH,KAFD;;AAIA,WAAO,EAAP,CAAU,YAAV,EAAwB,MAAM;AAC1B,eAAO,IAAP,CAAY,cAAZ;AACH,KAFD;;AAIA,WAAO,EAAP,CAAU,OAAV,EAAmB,QAAiB;AAAA,YAAd,OAAc,QAAd,OAAc;;AAChC,YAAI,YAAY,OAAO,OAAvB,EAAgC;AAC5B,mBAAO,SAAS,MAAT,CAAgB,IAAhB,CAAP;AACH;AACJ,KAJD;;AAMA,WAAO,MAAP;AACH;;AAED,SAAS,IAAT,GAAgC;AAAA,sCAAf,IAAe;AAAf,YAAe;AAAA;;AAC5B,WAAO,KAAP,CAAa,MAAb,EAAqB,EAAE,IAAF,EAArB;AACA,WAAO,IAAI,OAAJ,CAAY,CAAC,OAAD,EAAU,MAAV,KAAqB;AACpC,cAAM,WAAW,WAAW,MAAM;AAC9B,mBAAO,IAAP,CAAY,wBAAZ,EAAsC,EAAE,IAAF,EAAtC;AACA,mBAAO,SAAP;AACH,SAHgB,EAGd,KAHc,CAAjB;;AAKA,eAAO,IAAP,CAAY,GAAG,IAAf,EAAqB,UAAU;AAC3B,yBAAa,QAAb;AACA,oBAAQ,MAAR;AACH,SAHD;AAIH,KAVM,CAAP;AAWH;;AAED,SAAS,EAAT,CAAY,IAAZ,EAAkB,OAAlB,EAA2B;AACvB,WAAO,EAAP,CAAU,IAAV,EAAgB,OAAhB;AACA,WAAO,OAAP;AACH;;AAED,SAAS,GAAT,CAAa,IAAb,EAAmB,OAAnB,EAA4B;AACxB,WAAO,GAAP,CAAW,IAAX,EAAiB,OAAjB;AACH","file":"browser.js","sourcesContent":["import socketio from 'socket.io-client';\nimport Logger from 'nightingale-logger';\n\nconst logger = new Logger('alp.websocket');\nlet socket;\n\nexport default function alpWebsocket(app, namespaceName) {\n    start(app.config, namespaceName);\n    app.websocket = {\n        socket,\n        on,\n        off,\n        emit,\n    };\n\n    return socket;\n}\n\nfunction start(config, namespaceName = '') {\n    if (socket) {\n        throw new Error('WebSocket already started');\n    }\n\n    const webSocketConfig = config.get('webSocket');\n\n    if (!webSocketConfig) {\n        throw new Error('Missing config webSocket');\n    }\n\n    if (!webSocketConfig.has('port')) {\n        throw new Error('Missing config webSocket.port');\n    }\n\n    const secure = webSocketConfig.get('secure');\n    const port = webSocketConfig.get('port');\n\n    socket = socketio(`http${secure ? 's' : ''}://${location.hostname}:${port}/${namespaceName}`, {\n        reconnectionDelay: 500,\n        reconnectionDelayMax: 1000,\n        timeout: 4000,\n        transports: ['websocket'],\n    });\n\n    socket.on('connect', () => {\n        logger.success('connected');\n    });\n\n    socket.on('disconnect', () => {\n        logger.warn('disconnected');\n    });\n\n    socket.on('hello', ({ version }) => {\n        if (version !== window.VERSION) {\n            return location.reload(true);\n        }\n    });\n\n    return socket;\n}\n\nfunction emit(...args): Promise {\n    logger.debug('emit', { args });\n    return new Promise((resolve, reject) => {\n        const resolved = setTimeout(() => {\n            logger.warn('websocket emit timeout', { args });\n            reject('timeout');\n        }, 10000);\n\n        socket.emit(...args, result => {\n            clearTimeout(resolved);\n            resolve(result);\n        });\n    });\n}\n\nfunction on(type, handler) {\n    socket.on(type, handler);\n    return handler;\n}\n\nfunction off(type, handler) {\n    socket.off(type, handler);\n}\n"]}