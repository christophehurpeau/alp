{"version":3,"sources":["../src/index.js"],"names":["readFileSync","socketio","Logger","logger","io","alpWebsocket","app","dirname","start","config","websocket","on","close","subscribe","socket","name","callbackOnSubscribe","info","join","callback","leave","Error","webSocketConfig","get","has","secure","port","createServer","require","server","key","cert","listen","error","err","debug","id","emit","version"],"mappings":"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","file":"index.js","sourcesContent":["import { readFileSync } from 'fs';\nimport socketio from 'socket.io';\nimport Logger from 'nightingale-logger';\n\nconst logger = new Logger('alp.websocket');\n\nlet io;\n\n/**\n * @param {Koa} app\n * @param {string} dirname for tls server, dirname of the server.key and server.crt\n */\nexport default function alpWebsocket(app, dirname) {\n  start(app.config, dirname);\n  app.websocket = io;\n  app.on('close', close);\n  return io;\n}\n\nexport function close() {\n  io.close();\n}\n\nexport function subscribe(socket, name, callbackOnSubscribe) {\n  socket.on(`subscribe:${name}`, callback => {\n    logger.info('join', { name });\n    socket.join(name);\n\n    if (callbackOnSubscribe) {\n      callback(null, callbackOnSubscribe());\n    } else {\n      callback(null);\n    }\n  });\n\n  socket.on(`unsubscribe:${name}`, callback => {\n    logger.info('leave', { name });\n    socket.leave(name);\n    callback(null);\n  });\n}\n\nfunction start(config, dirname) {\n  if (io) {\n    throw new Error('Already started');\n  }\n\n  const webSocketConfig = config.get('webSocket') || config.get('websocket');\n\n  if (!webSocketConfig) {\n    throw new Error('Missing config webSocket');\n  }\n\n  if (!webSocketConfig.has('port')) {\n    throw new Error('Missing config webSocket.port');\n  }\n\n  const secure = webSocketConfig.get('secure');\n  const port = webSocketConfig.get('port');\n  // eslint-disable-next-line global-require\n  const createServer = require(secure ? 'https' : 'http').createServer;\n\n  const server = (() => {\n    if (!secure) {\n      return createServer();\n    }\n\n    return createServer({\n      key: readFileSync(`${dirname}/server.key`),\n      cert: readFileSync(`${dirname}/server.crt`),\n    });\n  })();\n\n  logger.info('Starting', { port });\n  server.listen(port, () => logger.info('Listening', { port }));\n  server.on('error', err => logger.error(err));\n  io = socketio(server);\n\n  io.on('connection', socket => {\n    logger.debug('connected', { id: socket.id });\n    socket.emit('hello', { version: config.get('version') });\n\n    socket.on('disconnect', () => {\n      logger.debug('disconnected', { id: socket.id });\n    });\n  });\n\n  io.on('error', err => logger.error(err));\n\n  return io;\n}\n"]}