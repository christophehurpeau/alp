{"version":3,"sources":["../src/browser.js"],"names":["socketio","Logger","logger","socket","successfullConnection","connected","websocket","on","off","emit","isConnected","isDisconnected","alpWebsocket","app","namespaceName","start","config","context","Error","webSocketConfig","get","has","secure","port","location","hostname","reconnectionDelay","reconnectionDelayMax","timeout","transports","success","warn","version","window","VERSION","process","env","NODE_ENV","confirm","t","reload","args","debug","Promise","resolve","reject","resolved","setTimeout","error","result","clearTimeout","type","handler"],"mappings":"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","file":"browser.js","sourcesContent":["/* global location, window, confirm */\nimport socketio from 'socket.io-client';\nimport Logger from 'nightingale-logger';\n\nconst logger = new Logger('alp.websocket');\nlet socket;\nlet successfullConnection = false;\nlet connected = false;\n\nexport const websocket = {\n  get socket() { return socket; },\n  get connected() { return connected; },\n  on,\n  off,\n  emit,\n  isConnected,\n  isDisconnected,\n};\n\nexport default function alpWebsocket(app, namespaceName) {\n  start(app, namespaceName);\n  app.websocket = socket;\n  return socket;\n}\n\nfunction start({ config, context }, namespaceName = '') {\n  if (socket) {\n    throw new Error('WebSocket already started');\n  }\n\n  const webSocketConfig = config.get('webSocket') || config.get('websocket');\n\n  if (!webSocketConfig) {\n    throw new Error('Missing config webSocket');\n  }\n\n  if (!webSocketConfig.has('port')) {\n    throw new Error('Missing config webSocket.port');\n  }\n\n  const secure = webSocketConfig.get('secure');\n  const port = webSocketConfig.get('port');\n\n  socket = socketio(`http${secure ? 's' : ''}://${location.hostname}:${port}/${namespaceName}`, {\n    reconnectionDelay: 500,\n    reconnectionDelayMax: 2500,\n    timeout: 4000,\n    transports: ['websocket'],\n  });\n\n  socket.on('connect', () => {\n    logger.success('connected');\n    successfullConnection = true;\n    connected = true;\n  });\n\n  socket.on('reconnect', () => {\n    logger.success('reconnected');\n    connected = true;\n  });\n\n  socket.on('disconnect', () => {\n    logger.warn('disconnected');\n    connected = false;\n  });\n\n  socket.on('hello', ({ version }) => {\n    if (version !== window.VERSION) {\n      // eslint-disable-next-line no-alert\n      if (process.env.NODE_ENV !== 'production' || confirm(context.t('newversion'))) {\n        return location.reload(true);\n      }\n    }\n  });\n\n  return socket;\n}\n\nfunction emit(...args): Promise {\n  logger.debug('emit', { args });\n  return new Promise((resolve, reject) => {\n    const resolved = setTimeout(() => {\n      logger.warn('websocket emit timeout', { args });\n      reject(new Error('websocket response timeout'));\n    }, 10000);\n\n    socket.emit(...args, (error, result) => {\n      clearTimeout(resolved);\n      if (error != null) return reject(error);\n      resolve(result);\n    });\n  });\n}\n\nfunction on(type, handler) {\n  socket.on(type, handler);\n  return handler;\n}\n\nfunction off(type, handler) {\n  socket.off(type, handler);\n}\n\n\nfunction isConnected() {\n  // socket.connected is not updated after reconnect event\n  return socket && connected;\n}\n\nfunction isDisconnected() {\n  return successfullConnection && !isConnected();\n}\n"]}