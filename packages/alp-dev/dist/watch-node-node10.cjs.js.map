{"version":3,"file":"watch-node-node10.cjs.js","sources":["../src/webpack/createPobpackConfig.ts","../src/webpack/node.ts","../src/watch-node.ts"],"sourcesContent":["/* eslint-disable max-lines */\n\nimport fs from 'fs';\nimport path from 'path';\nimport OptimizeCssAssetsPlugin from 'optimize-css-assets-webpack-plugin';\nimport MiniCssExtractPlugin from 'mini-css-extract-plugin';\nimport autoprefixer from 'autoprefixer';\nimport { createModuleRules, createCssModuleUse } from 'ynnub-webpack-config';\nimport { Options } from 'pobpack-types';\n\n// stylesCacheGroups\n\ntype TargetType = 'node' | 'modern-browser' | 'browser';\n\nconst ExcludesFalsy = (Boolean as any) as <T>(\n  x: T | false | null | undefined,\n) => x is T;\n\nexport default (\n  target: TargetType,\n  production: boolean = false,\n): Partial<Options> => {\n  const pkg = JSON.parse(\n    fs.readFileSync(path.resolve('package.json'), 'utf-8'),\n  );\n  const deps = pkg.dependencies || {};\n  const devdeps = pkg.devDependencies || {};\n\n  const hasAntd = !!deps.antd;\n\n  if (deps.antd) {\n    if (!devdeps.less) {\n      throw new Error('less missing: yarn add --dev less');\n    }\n  }\n\n  return {\n    env: process.env.NODE_ENV,\n    hmr: !production,\n    typescript: true,\n\n    whitelistExternalExtensions: ['png', 'jpg', 'jpeg', 'gif', 'svg'],\n    includeModules: ['ynnub', 'react-alp-login'],\n\n    paths: {\n      build: target === 'node' ? 'build' : 'public',\n    },\n\n    entries: [\n      {\n        key:\n          // eslint-disable-next-line no-nested-ternary\n          target === 'node'\n            ? 'index'\n            : target === 'browser'\n            ? 'es5'\n            : 'modern-browsers',\n        path: target === 'node' ? 'index.server.ts' : 'index.browser.ts',\n      },\n    ],\n\n    resolveLoaderModules: [\n      path.join(__dirname, '../..', 'node_modules'),\n      'node_modules',\n    ],\n\n    babel: {\n      minified: target !== 'node' && production,\n      comments: !(target !== 'node' && production),\n\n      presets: [\n        // add react preset with jsx\n        [\n          require.resolve('@babel/preset-react'),\n          { development: !production, useBuiltIns: true },\n        ],\n        // pob preset: flow, import `src`, export default function name, replacements, exnext features, ...\n        [\n          require.resolve('babel-preset-pob-env'),\n          {\n            resolvePreset: (preset: string): string => require.resolve(preset),\n            production,\n            typescript: true,\n            exportDefaultName: false,\n            optimizations: true,\n            target: target === 'node' ? 'node' : 'browser',\n            version:\n              // eslint-disable-next-line no-nested-ternary\n              target === 'node'\n                ? 8.3\n                : target === 'modern-browser'\n                ? 'modern'\n                : undefined,\n            loose: true,\n            modules: false,\n          },\n        ],\n      ],\n      plugins: [\n        require.resolve('babel-plugin-inline-classnames-babel7'),\n        hasAntd && [\n          require.resolve('babel-plugin-import'),\n          {\n            libraryName: 'antd',\n            libraryDirectory: target === 'node' ? 'lib' : 'es',\n            style: target !== 'node',\n          },\n        ],\n      ].filter(ExcludesFalsy),\n    },\n\n    moduleRules: [\n      // SCSS RULE, CSS RULE\n      ...createModuleRules({\n        target,\n        extractLoader: MiniCssExtractPlugin.loader,\n        production,\n        themeFile: './src/theme.scss',\n        plugins: [autoprefixer],\n        includePaths: [path.resolve('./node_modules')],\n        resolveLoader: (loader: string): string => require.resolve(loader),\n      }),\n\n      // LESS RULE (antd)\n      {\n        test: /\\.less$/,\n        use: createCssModuleUse({\n          global: true,\n          target,\n          extractLoader: MiniCssExtractPlugin.loader,\n          production,\n          plugins: [autoprefixer],\n          resolveLoader: (loader: string): string => require.resolve(loader),\n          otherLoaders: [\n            {\n              loader: require.resolve('less-loader'),\n              options: {\n                javascriptEnabled: true,\n                // modifyVars: path.resolve('./src/less-modifyVars.js'),\n              },\n            },\n            {\n              loader: require.resolve('less-modify-var-loader'),\n              options: {\n                filePath: path.resolve('./src/theme.less'),\n              },\n            },\n          ],\n        }),\n      },\n\n      // IMG RULE\n      {\n        test: /\\.(png|jpg|jpeg|gif|svg)$/,\n        loader: require.resolve('url-loader'),\n        options: {\n          /* config to emit with node doesn't work anymore because css is ignored by node */\n          // emitFile: target === 'node', // only write file if node\n          // outputPath: '../public/', // because it's node who is writing the file, node is in build/\n          // publicPath: (url: string): string => url.replace(/^..\\/public\\//, ''),\n          emitFile: target === 'modern-browser',\n          limit: 1000,\n          name: 'images/[hash].[ext]',\n        },\n      },\n    ],\n\n    // TODO https://github.com/zeit/next.js/blob/7d78c3b64185d6d6417f1af9cde4a69d32b18cc6/packages/next/build/webpack.js\n    // optimization: {\n    //   minimizer:\n    //     target === 'browser' ? [new OptimizeCssAssetsPlugin()] : undefined,\n    //   splitChunks: {\n    //     cacheGroups: {\n    //       styles: stylesCacheGroups,\n    //     },\n    //   },\n    // },\n\n    plugins: [\n      new MiniCssExtractPlugin({\n        // disable: target === 'node',\n        filename: `${\n          // eslint-disable-next-line no-nested-ternary\n          target === 'node'\n            ? 'server'\n            : target === 'browser'\n            ? 'es5'\n            : 'modern-browsers'\n        }.css`,\n      }),\n      new OptimizeCssAssetsPlugin(),\n\n      // target === 'browser' &&\n      // target !== 'node' &&\n      //   production &&\n      //   new optimize.UglifyJsPlugin({\n      //     compress: {\n      //       warnings: false,\n      //     },\n      //     sourcleMap: !production,\n      //   }),!== 'node' &&\n      //   production &&\n      //   new optimize.UglifyJsPlugin({\n      //     compress: {\n      //       warnings: false,\n      //     },\n      //     sourceMap: !production,\n      //   }),\n      // TODO https://github.com/NekR/offline-plugin\n    ].filter(ExcludesFalsy),\n  };\n};\n","import path from 'path';\nimport { createAppNodeCompiler, watchAndRunCompiler } from 'pobpack-node';\nimport { PobpackCompiler } from 'pobpack-types';\nimport { Watching } from 'webpack';\nimport createPobpackConfig from './createPobpackConfig';\n\nexport const createNodeCompiler = (production: boolean) =>\n  createAppNodeCompiler(createPobpackConfig('node', production));\n\nexport const watchAndRun = (\n  nodeCompiler: PobpackCompiler,\n  port: string | number,\n): Watching =>\n  watchAndRunCompiler(nodeCompiler, {\n    key: 'alp-dev:watch',\n    args: ['--trace-warnings', '--port', port, '--version', Date.now()],\n    cwd: path.resolve('.'),\n  });\n","import argv from 'minimist-argv';\nimport { createNodeCompiler, watchAndRun } from './webpack/node';\n\nconst nodeCompiler = createNodeCompiler(false);\n\nlet watching = watchAndRun(nodeCompiler, argv.port);\n\nprocess.on('SIGUSR2', () => {\n  watching.close(() => {\n    watching = watchAndRun(nodeCompiler, argv.port);\n  });\n});\n"],"names":["ExcludesFalsy","Boolean","target","production","pkg","JSON","parse","fs","readFileSync","path","resolve","deps","dependencies","devdeps","devDependencies","hasAntd","antd","less","Error","env","process","NODE_ENV","hmr","typescript","whitelistExternalExtensions","includeModules","paths","build","entries","key","resolveLoaderModules","join","__dirname","babel","minified","comments","presets","require","development","useBuiltIns","resolvePreset","preset","exportDefaultName","optimizations","version","undefined","loose","modules","plugins","libraryName","libraryDirectory","style","filter","moduleRules","createModuleRules","extractLoader","MiniCssExtractPlugin","loader","themeFile","autoprefixer","includePaths","resolveLoader","test","use","createCssModuleUse","global","otherLoaders","options","javascriptEnabled","filePath","emitFile","limit","name","filename","OptimizeCssAssetsPlugin","createNodeCompiler","createAppNodeCompiler","createPobpackConfig","watchAndRun","nodeCompiler","port","watchAndRunCompiler","args","Date","now","cwd","watching","argv","on","close"],"mappings":";;;;;;;;;;;;;AAAA;AAEA,AAYA,MAAMA,aAAa,GAAIC,OAAvB;AAIA,6BAAe,CACbC,MADa,EAEbC,UAAmB,GAAG,KAFT,KAGQ;QACfC,GAAG,GAAGC,IAAI,CAACC,KAAL,CACVC,EAAE,CAACC,YAAH,CAAgBC,IAAI,CAACC,OAAL,CAAa,cAAb,CAAhB,EAA8C,OAA9C,CADU,CAAZ;QAGMC,IAAI,GAAGP,GAAG,CAACQ,YAAJ,IAAoB,EAAjC;QACMC,OAAO,GAAGT,GAAG,CAACU,eAAJ,IAAuB,EAAvC;QAEMC,OAAO,GAAG,CAAC,CAACJ,IAAI,CAACK,IAAvB;;MAEIL,IAAI,CAACK,IAAT,EAAe;QACT,CAACH,OAAO,CAACI,IAAb,EAAmB;YACX,IAAIC,KAAJ,CAAU,mCAAV,CAAN;;;;SAIG;IACLC,GAAG,EAAEC,OAAO,CAACD,GAAR,CAAYE,QADZ;IAELC,GAAG,EAAE,CAACnB,UAFD;IAGLoB,UAAU,EAAE,IAHP;IAKLC,2BAA2B,EAAE,CAAC,KAAD,EAAQ,KAAR,EAAe,MAAf,EAAuB,KAAvB,EAA8B,KAA9B,CALxB;IAMLC,cAAc,EAAE,CAAC,OAAD,EAAU,iBAAV,CANX;IAQLC,KAAK,EAAE;MACLC,KAAK,EAAEzB,MAAM,KAAK,MAAX,GAAoB,OAApB,GAA8B;KATlC;IAYL0B,OAAO,EAAE,CACP;MACEC,GAAG;MAED3B,MAAM,KAAK,MAAX,GACI,OADJ,GAEIA,MAAM,KAAK,SAAX,GACA,KADA,GAEA,iBAPR;MAQEO,IAAI,EAAEP,MAAM,KAAK,MAAX,GAAoB,iBAApB,GAAwC;KATzC,CAZJ;IAyBL4B,oBAAoB,EAAE,CACpBrB,IAAI,CAACsB,IAAL,CAAUC,SAAV,EAAqB,OAArB,EAA8B,cAA9B,CADoB,EAEpB,cAFoB,CAzBjB;IA8BLC,KAAK,EAAE;MACLC,QAAQ,EAAEhC,MAAM,KAAK,MAAX,IAAqBC,UAD1B;MAELgC,QAAQ,EAAE,EAAEjC,MAAM,KAAK,MAAX,IAAqBC,UAAvB,CAFL;MAILiC,OAAO,EAAE;OAGLC,OAAO,CAAC3B,OAAR,CAAgB,qBAAhB,CADF,EAEE;QAAE4B,WAAW,EAAE,CAACnC,UAAhB;QAA4BoC,WAAW,EAAE;OAF3C,CAFO;OAQLF,OAAO,CAAC3B,OAAR,CAAgB,sBAAhB,CADF,EAEE;QACE8B,aAAa,EAAGC,MAAD,IAA4BJ,OAAO,CAAC3B,OAAR,CAAgB+B,MAAhB,CAD7C;QAEEtC,UAFF;QAGEoB,UAAU,EAAE,IAHd;QAIEmB,iBAAiB,EAAE,KAJrB;QAKEC,aAAa,EAAE,IALjB;QAMEzC,MAAM,EAAEA,MAAM,KAAK,MAAX,GAAoB,MAApB,GAA6B,SANvC;QAOE0C,OAAO;QAEL1C,MAAM,KAAK,MAAX,GACI,GADJ,GAEIA,MAAM,KAAK,gBAAX,GACA,QADA,GAEA2C,SAbR;QAcEC,KAAK,EAAE,IAdT;QAeEC,OAAO,EAAE;OAjBb,CAPO,CAJJ;MAgCLC,OAAO,EAAE,CACPX,OAAO,CAAC3B,OAAR,CAAgB,uCAAhB,CADO,EAEPK,OAAO,IAAI,CACTsB,OAAO,CAAC3B,OAAR,CAAgB,qBAAhB,CADS,EAET;QACEuC,WAAW,EAAE,MADf;QAEEC,gBAAgB,EAAEhD,MAAM,KAAK,MAAX,GAAoB,KAApB,GAA4B,IAFhD;QAGEiD,KAAK,EAAEjD,MAAM,KAAK;OALX,CAFJ,EAUPkD,MAVO,CAUApD,aAVA;KA9DN;IA2ELqD,WAAW,EAAE;OAERC,oCAAiB,CAAC;MACnBpD,MADmB;MAEnBqD,aAAa,EAAEC,oBAAoB,CAACC,MAFjB;MAGnBtD,UAHmB;MAInBuD,SAAS,EAAE,kBAJQ;MAKnBV,OAAO,EAAE,CAACW,YAAD,CALU;MAMnBC,YAAY,EAAE,CAACnD,IAAI,CAACC,OAAL,CAAa,gBAAb,CAAD,CANK;MAOnBmD,aAAa,EAAGJ,MAAD,IAA4BpB,OAAO,CAAC3B,OAAR,CAAgB+C,MAAhB;KAPzB,CAFT;;MAcTK,IAAI,EAAE,SADR;MAEEC,GAAG,EAAEC,qCAAkB,CAAC;QACtBC,MAAM,EAAE,IADc;QAEtB/D,MAFsB;QAGtBqD,aAAa,EAAEC,oBAAoB,CAACC,MAHd;QAItBtD,UAJsB;QAKtB6C,OAAO,EAAE,CAACW,YAAD,CALa;QAMtBE,aAAa,EAAGJ,MAAD,IAA4BpB,OAAO,CAAC3B,OAAR,CAAgB+C,MAAhB,CANrB;QAOtBS,YAAY,EAAE,CACZ;UACET,MAAM,EAAEpB,OAAO,CAAC3B,OAAR,CAAgB,aAAhB,CADV;UAEEyD,OAAO,EAAE;YACPC,iBAAiB,EAAE,IADZ;;;SAHC,EAQZ;UACEX,MAAM,EAAEpB,OAAO,CAAC3B,OAAR,CAAgB,wBAAhB,CADV;UAEEyD,OAAO,EAAE;YACPE,QAAQ,EAAE5D,IAAI,CAACC,OAAL,CAAa,kBAAb;;SAXF;OAPO;KAfd;;MA0CToD,IAAI,EAAE,2BADR;MAEEL,MAAM,EAAEpB,OAAO,CAAC3B,OAAR,CAAgB,YAAhB,CAFV;MAGEyD,OAAO,EAAE;;;;;QAKPG,QAAQ,EAAEpE,MAAM,KAAK,gBALd;QAMPqE,KAAK,EAAE,IANA;QAOPC,IAAI,EAAE;;KAnDC,CA3ER;;;;;;;;;;;IA8ILxB,OAAO,EAAE,CACP,IAAIQ,oBAAJ,CAAyB;;MAEvBiB,QAAQ,EAAG;MAETvE,MAAM,KAAK,MAAX,GACI,QADJ,GAEIA,MAAM,KAAK,SAAX,GACA,KADA,GAEA,iBACL;KATH,CADO,EAYP,IAAIwE,uBAAJ,EAZO,EA+BPtB,MA/BO,CA+BApD,aA/BA;GA9IX;CAlBF;;ACZO,MAAM2E,kBAAkB,GAAIxE,UAAD,IAChCyE,iCAAqB,CAACC,mBAAmB,CAAC,MAAD,EAAS1E,UAAT,CAApB,CADhB;AAGP,AAAO,MAAM2E,WAAW,GAAG,CACzBC,YADyB,EAEzBC,IAFyB,KAIzBC,+BAAmB,CAACF,YAAD,EAAe;EAChClD,GAAG,EAAE,eAD2B;EAEhCqD,IAAI,EAAE,CAAC,kBAAD,EAAqB,QAArB,EAA+BF,IAA/B,EAAqC,WAArC,EAAkDG,IAAI,CAACC,GAAL,EAAlD,CAF0B;EAGhCC,GAAG,EAAE5E,IAAI,CAACC,OAAL,CAAa,GAAb;CAHY,CAJd;;ACNP,MAAMqE,YAAY,GAAGJ,kBAAkB,CAAC,KAAD,CAAvC;AAEA,IAAIW,QAAQ,GAAGR,WAAW,CAACC,YAAD,EAAeQ,IAAI,CAACP,IAApB,CAA1B;AAEA5D,OAAO,CAACoE,EAAR,CAAW,SAAX,EAAsB,MAAM;EAC1BF,QAAQ,CAACG,KAAT,CAAe,MAAM;IACnBH,QAAQ,GAAGR,WAAW,CAACC,YAAD,EAAeQ,IAAI,CAACP,IAApB,CAAtB;GADF;CADF"}