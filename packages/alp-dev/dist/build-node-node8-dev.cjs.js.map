{"version":3,"file":"build-node-node8-dev.cjs.js","sources":["../src/webpack/createPobpackConfig.js","../src/webpack/node.js","../src/build-node.js"],"sourcesContent":["import path from 'path';\nimport presetPob from 'babel-preset-pob';\nimport presetPobReact from 'babel-preset-pob-react';\nimport presetPobStages from 'babel-preset-pob-stages';\nimport presetEnv from 'babel-preset-env';\nimport { buildPreset as presetModernBrowsers } from 'babel-preset-modern-browsers';\nimport presetLatestNode from 'babel-preset-latest-node';\nimport presetOptimizations from 'babel-preset-optimizations';\nimport pluginDiscardModuleReference from 'babel-plugin-discard-module-references';\nimport pluginFlowRuntime from 'babel-plugin-flow-runtime';\nimport OptimizeCssAssetsPlugin from 'optimize-css-assets-webpack-plugin';\nimport BabelMinifyPlugin from 'babel-minify-webpack-plugin';\nimport { optimize } from 'webpack';\nimport MiniCssExtractPlugin from 'mini-css-extract-plugin';\nimport autoprefixer from 'autoprefixer';\nimport { createModuleRules, createExtractPlugin } from 'ynnub/webpack-config';\n\ntype TargetType = 'node' | 'modern-browser' | 'browser';\n\nexport default (target: TargetType, production: ?boolean = false) => ({\n  env: process.env.NODE_ENV,\n  hmr: !production,\n\n  includeModules: ['ynnub', 'react-alp-login'],\n\n  paths: {\n    build: target === 'node' ? 'build' : 'public',\n  },\n\n  entries: [\n    {\n      // eslint-disable-next-line no-nested-ternary\n      key: target === 'node' ? 'index' : target === 'browser' ? 'es5' : 'modern-browsers',\n      path: target === 'node' ? 'index.server.js' : 'index.browser.js',\n    },\n  ],\n\n  resolveLoaderModules: [path.join(__dirname, '../..', 'node_modules'), 'node_modules'],\n\n  babel: {\n    minified: target !== 'node' && production,\n    comments: !(target !== 'node' && production),\n\n    // preset order is last to first, so we reverse it for clarity.\n    presets: [\n      // add react preset with jsx\n      [presetPobReact, { production }],\n      // add stage-1 to stage-3 features\n      presetPobStages,\n      // pob preset: flow, import `src`, export default function name, replacements\n      [\n        presetPob,\n        {\n          production,\n          replacements: {\n            BROWSER: target !== 'node',\n            NODEJS: target === 'node',\n            SERVER: target === 'node',\n            MODERN_BROWSERS: target === 'modern-browser',\n          },\n        },\n      ],\n      // optimizations: remove dead-code\n      presetOptimizations,\n      // flow runtime\n      !production && {\n        plugins: [\n          [\n            pluginFlowRuntime,\n            {\n              assert: true,\n              annotate: false,\n            },\n          ],\n        ],\n      },\n      // discard unused imports (like production-only or node-only imports)\n      { plugins: [pluginDiscardModuleReference] },\n      // transpile for browser\n      target === 'modern-browser' && [presetModernBrowsers, { modules: false }],\n      target === 'browser' && [\n        presetEnv,\n        {\n          modules: false,\n          useBuiltIns: true,\n          targets: [\n            '>1%',\n            'not ie < 9', // react doesn't support ie < 9\n          ],\n        },\n      ],\n\n      target === 'node' && [\n        presetLatestNode,\n        {\n          modules: false,\n          target: 8.3,\n        },\n      ],\n    ]\n      .reverse()\n      .filter(Boolean),\n    plugins: [],\n  },\n\n  moduleRules: [\n    // SCSS RULE, CSS RULE\n    ...createModuleRules({\n      MiniCssExtractPlugin,\n      production,\n      themeFile: './src/theme.scss',\n      plugins: [autoprefixer],\n      includePaths: [path.resolve('./node_modules')],\n    }),\n\n    // IMG RULE\n    {\n      test: /\\.(png|jpg|jpeg|gif|svg)$/,\n      loader: require.resolve('url-loader'),\n      options: {\n        emitFile: target === 'node', // only write file if node\n        limit: 1000,\n        name: 'images/[hash].[ext]',\n        outputPath: '../public/', // because it's node who is writing the file, node is in build/\n        publicPath: url => url.replace(/^..\\/public\\//, ''),\n      },\n    },\n  ],\n\n  plugins: [\n    createExtractPlugin(MiniCssExtractPlugin, {\n      // disable: target === 'node',\n      filename: `${\n        // eslint-disable-next-line no-nested-ternary\n        target === 'node' ? 'server' : target === 'browser' ? 'es5' : 'modern-browsers'\n      }.css`,\n    }),\n\n    new OptimizeCssAssetsPlugin(),\n\n    target !== 'node' &&\n      production &&\n      new BabelMinifyPlugin(\n        {\n          booleans: true,\n          builtIns: false,\n          consecutiveAdds: true,\n          deadcode: true,\n          evaluate: true,\n          flipComparisons: true,\n          guards: true,\n          infinity: false,\n          mangle: true,\n          memberExpressions: true,\n          mergeVars: true,\n          numericLiterals: true,\n          propertyLiterals: true,\n          regexpConstructors: true,\n          removeConsole: false,\n          removeDebugger: true,\n          removeUndefined: true,\n          replace: false,\n          simplify: true,\n          simplifyComparisons: true,\n          typeConstructors: true,\n          undefinedToVoid: false,\n          // keepFnName: true,\n          // keepClassName: true,\n        },\n        { comments: false },\n      ),\n\n    target === 'browser' &&\n      production &&\n      new optimize.UglifyJsPlugin({\n        compress: {\n          warnings: false,\n        },\n        sourceMap: !production,\n      }),\n    // TODO https://github.com/NekR/offline-plugin\n  ].filter(Boolean),\n\n  defines: {\n    BROWSER: target !== 'node',\n    SERVER: target === 'node',\n    NODEJS: target === 'node',\n    PRODUCTION: production,\n    MODERN_BROWSERS: target === 'modern-browser',\n  },\n});\n","import { createAppNodeCompiler, watchAndRunCompiler } from 'pobpack-node/src';\nimport createPobpackConfig from './createPobpackConfig';\n\nexport const createNodeCompiler = production =>\n  createAppNodeCompiler(createPobpackConfig('node', production));\n\nexport const watchAndRun = (nodeCompiler, port) =>\n  watchAndRunCompiler(nodeCompiler, {\n    key: 'alp-dev:watch',\n    args: ['--port', port],\n    cwd: nodeCompiler.webpackConfig.output.path,\n  });\n","import { createNodeCompiler } from './webpack/node';\n\nconst nodeCompiler = createNodeCompiler(process.env.NODE_ENV === 'production');\n\nnodeCompiler.run();\n"],"names":["target","production","process","env","NODE_ENV","path","join","__dirname","presetLatestNode","presetEnv","presetModernBrowsers","modules","plugins","pluginDiscardModuleReference","pluginFlowRuntime","presetPob","presetPobReact","filter","Boolean","createModuleRules","autoprefixer","resolve","require","url","replace","createExtractPlugin","MiniCssExtractPlugin","OptimizeCssAssetsPlugin","BabelMinifyPlugin","comments","optimize","UglifyJsPlugin","createNodeCompiler","createAppNodeCompiler","createPobpackConfig","nodeCompiler","run"],"mappings":"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"}