{"version":3,"file":"watch-node-node8.cjs.js","sources":["../src/webpack/createPobpackConfig.ts","../src/webpack/node.ts","../src/watch-node.ts"],"sourcesContent":["import path from 'path';\nimport OptimizeCssAssetsPlugin from 'optimize-css-assets-webpack-plugin';\nimport MiniCssExtractPlugin from 'mini-css-extract-plugin';\nimport autoprefixer from 'autoprefixer';\nimport { createModuleRules } from 'ynnub-webpack-config';\nimport { Options } from 'pobpack-types';\n\n// stylesCacheGroups\n\ntype TargetType = 'node' | 'modern-browser' | 'browser';\n\nexport default (\n  target: TargetType,\n  production: boolean = false,\n): Partial<Options> => ({\n  env: process.env.NODE_ENV,\n  hmr: !production,\n  typescript: true,\n\n  includeModules: ['ynnub', 'react-alp-login'],\n\n  paths: {\n    build: target === 'node' ? 'build' : 'public',\n  },\n\n  entries: [\n    {\n      key:\n        // eslint-disable-next-line no-nested-ternary\n        target === 'node'\n          ? 'index'\n          : target === 'browser'\n          ? 'es5'\n          : 'modern-browsers',\n      path: target === 'node' ? 'index.server.ts' : 'index.browser.ts',\n    },\n  ],\n\n  resolveLoaderModules: [\n    path.join(__dirname, '../..', 'node_modules'),\n    'node_modules',\n  ],\n\n  babel: {\n    minified: target !== 'node' && production,\n    comments: !(target !== 'node' && production),\n\n    presets: [\n      // add react preset with jsx\n      [\n        require.resolve('@babel/preset-react'),\n        { development: !production, useBuiltIns: true },\n      ],\n      // pob preset: export default function name, replacements, exnext features, ...\n      [\n        require.resolve('babel-preset-pob-env'),\n        {\n          resolvePreset: (preset: string): string => require.resolve(preset),\n          production,\n          typescript: true,\n          exportDefaultName: false,\n          optimizations: true,\n          target: target === 'node' ? 'node' : 'browser',\n          version:\n            // eslint-disable-next-line no-nested-ternary\n            target === 'node'\n              ? 8.3\n              : target === 'modern-browser'\n              ? 'modern'\n              : undefined,\n          loose: true,\n          modules: false,\n        },\n      ],\n    ].filter(Boolean),\n    plugins: [require.resolve('babel-plugin-inline-classnames-babel7')],\n  },\n\n  aliases: {\n    '@app': path.resolve('src'),\n  },\n\n  moduleRules: [\n    // SCSS RULE, CSS RULE\n    ...createModuleRules({\n      target,\n      extractLoader: MiniCssExtractPlugin.loader,\n      production,\n      themeFile: './src/theme.scss',\n      plugins: [autoprefixer],\n      includePaths: [path.resolve('./node_modules')],\n      resolveLoader: (loader: string): string => require.resolve(loader),\n    }),\n\n    // IMG RULE\n    {\n      test: /\\.(png|jpg|jpeg|gif|svg)$/,\n      loader: require.resolve('url-loader'),\n      options: {\n        emitFile: target === 'node', // only write file if node\n        limit: 1000,\n        name: 'images/[hash].[ext]',\n        outputPath: '../public/', // because it's node who is writing the file, node is in build/\n        publicPath: (url: string): string => url.replace(/^..\\/public\\//, ''),\n      },\n    },\n  ],\n\n  // TODO https://github.com/zeit/next.js/blob/7d78c3b64185d6d6417f1af9cde4a69d32b18cc6/packages/next/build/webpack.js\n  // optimization: {\n  //   minimizer:\n  //     target === 'browser' ? [new OptimizeCssAssetsPlugin()] : undefined,\n  //   splitChunks: {\n  //     cacheGroups: {\n  //       styles: stylesCacheGroups,\n  //     },\n  //   },\n  // },\n\n  plugins: [\n    new MiniCssExtractPlugin({\n      // disable: target === 'node',\n      filename: `${\n        // eslint-disable-next-line no-nested-ternary\n        target === 'node'\n          ? 'server'\n          : target === 'browser'\n          ? 'es5'\n          : 'modern-browsers'\n      }.css`,\n    }),\n    new OptimizeCssAssetsPlugin(),\n\n    // target === 'browser' &&\n    // target !== 'node' &&\n    //   production &&\n    //   new optimize.UglifyJsPlugin({\n    //     compress: {\n    //       warnings: false,\n    //     },\n    //     sourcleMap: !production,\n    //   }),!== 'node' &&\n    //   production &&\n    //   new optimize.UglifyJsPlugin({\n    //     compress: {\n    //       warnings: false,\n    //     },\n    //     sourceMap: !production,\n    //   }),\n    // TODO https://github.com/NekR/offline-plugin\n  ].filter(Boolean),\n});\n","import path from 'path';\nimport { createAppNodeCompiler, watchAndRunCompiler } from 'pobpack-node';\nimport { PobpackCompiler } from 'pobpack-types';\nimport { Watching } from 'webpack';\nimport createPobpackConfig from './createPobpackConfig';\n\nexport const createNodeCompiler = (production: boolean) =>\n  createAppNodeCompiler(createPobpackConfig('node', production));\n\nexport const watchAndRun = (\n  nodeCompiler: PobpackCompiler,\n  port: string | number,\n): Watching =>\n  watchAndRunCompiler(nodeCompiler, {\n    key: 'alp-dev:watch',\n    args: ['--trace-warnings', '--port', port, '--version', Date.now()],\n    cwd: path.resolve('.'),\n  });\n","import argv from 'minimist-argv';\nimport { createNodeCompiler, watchAndRun } from './webpack/node';\n\nconst nodeCompiler = createNodeCompiler(false);\n\nlet watching = watchAndRun(nodeCompiler, argv.port);\n\nprocess.on('SIGUSR2', () => {\n  watching.close(() => {\n    watching = watchAndRun(nodeCompiler, argv.port);\n  });\n});\n"],"names":["target","production","env","process","NODE_ENV","hmr","typescript","includeModules","paths","build","entries","key","path","resolveLoaderModules","join","__dirname","babel","minified","comments","presets","require","resolve","development","useBuiltIns","resolvePreset","preset","exportDefaultName","optimizations","version","undefined","loose","modules","filter","Boolean","plugins","aliases","moduleRules","createModuleRules","extractLoader","MiniCssExtractPlugin","loader","themeFile","autoprefixer","includePaths","resolveLoader","test","options","emitFile","limit","name","outputPath","publicPath","url","replace","filename","OptimizeCssAssetsPlugin","createNodeCompiler","createAppNodeCompiler","createPobpackConfig","watchAndRun","nodeCompiler","port","watchAndRunCompiler","args","Date","now","cwd","watching","argv","on","close"],"mappings":";;;;;;;;;;;;AAWA,2BAAe,CACbA,MADa,EAEbC,UAAmB,GAAG,KAFT,MAGS;EACtBC,GAAG,EAAEC,OAAO,CAACD,GAAR,CAAYE,QADK;EAEtBC,GAAG,EAAE,CAACJ,UAFgB;EAGtBK,UAAU,EAAE,IAHU;EAKtBC,cAAc,EAAE,CAAC,OAAD,EAAU,iBAAV,CALM;EAOtBC,KAAK,EAAE;IACLC,KAAK,EAAET,MAAM,KAAK,MAAX,GAAoB,OAApB,GAA8B;GARjB;EAWtBU,OAAO,EAAE,CACP;IACEC,GAAG;IAEDX,MAAM,KAAK,MAAX,GACI,OADJ,GAEIA,MAAM,KAAK,SAAX,GACA,KADA,GAEA,iBAPR;IAQEY,IAAI,EAAEZ,MAAM,KAAK,MAAX,GAAoB,iBAApB,GAAwC;GATzC,CAXa;EAwBtBa,oBAAoB,EAAE,CACpBD,IAAI,CAACE,IAAL,CAAUC,SAAV,EAAqB,OAArB,EAA8B,cAA9B,CADoB,EAEpB,cAFoB,CAxBA;EA6BtBC,KAAK,EAAE;IACLC,QAAQ,EAAEjB,MAAM,KAAK,MAAX,IAAqBC,UAD1B;IAELiB,QAAQ,EAAE,EAAElB,MAAM,KAAK,MAAX,IAAqBC,UAAvB,CAFL;IAILkB,OAAO,EAAE;KAGLC,OAAO,CAACC,OAAR,CAAgB,qBAAhB,CADF,EAEE;MAAEC,WAAW,EAAE,CAACrB,UAAhB;MAA4BsB,WAAW,EAAE;KAF3C,CAFO;KAQLH,OAAO,CAACC,OAAR,CAAgB,sBAAhB,CADF,EAEE;MACEG,aAAa,EAAGC,MAAD,IAA4BL,OAAO,CAACC,OAAR,CAAgBI,MAAhB,CAD7C;MAEExB,UAFF;MAGEK,UAAU,EAAE,IAHd;MAIEoB,iBAAiB,EAAE,KAJrB;MAKEC,aAAa,EAAE,IALjB;MAME3B,MAAM,EAAEA,MAAM,KAAK,MAAX,GAAoB,MAApB,GAA6B,SANvC;MAOE4B,OAAO;MAEL5B,MAAM,KAAK,MAAX,GACI,GADJ,GAEIA,MAAM,KAAK,gBAAX,GACA,QADA,GAEA6B,SAbR;MAcEC,KAAK,EAAE,IAdT;MAeEC,OAAO,EAAE;KAjBb,CAPO,EA2BPC,MA3BO,CA2BAC,OA3BA,CAJJ;IAgCLC,OAAO,EAAE,CAACd,OAAO,CAACC,OAAR,CAAgB,uCAAhB,CAAD;GA7DW;EAgEtBc,OAAO,EAAE;YACCvB,IAAI,CAACS,OAAL,CAAa,KAAb;GAjEY;EAoEtBe,WAAW,EAAE;KAERC,oCAAiB,CAAC;IACnBrC,MADmB;IAEnBsC,aAAa,EAAEC,oBAAoB,CAACC,MAFjB;IAGnBvC,UAHmB;IAInBwC,SAAS,EAAE,kBAJQ;IAKnBP,OAAO,EAAE,CAACQ,YAAD,CALU;IAMnBC,YAAY,EAAE,CAAC/B,IAAI,CAACS,OAAL,CAAa,gBAAb,CAAD,CANK;IAOnBuB,aAAa,EAAGJ,MAAD,IAA4BpB,OAAO,CAACC,OAAR,CAAgBmB,MAAhB;GAPzB,CAFT;;IAcTK,IAAI,EAAE,2BADR;IAEEL,MAAM,EAAEpB,OAAO,CAACC,OAAR,CAAgB,YAAhB,CAFV;IAGEyB,OAAO,EAAE;MACPC,QAAQ,EAAE/C,MAAM,KAAK,MADd;;MAEPgD,KAAK,EAAE,IAFA;MAGPC,IAAI,EAAE,qBAHC;MAIPC,UAAU,EAAE,YAJL;;MAKPC,UAAU,EAAGC,GAAD,IAAyBA,GAAG,CAACC,OAAJ,CAAY,eAAZ,EAA6B,EAA7B;;GArB9B,CApES;;;;;;;;;;;EAyGtBnB,OAAO,EAAE,CACP,IAAIK,oBAAJ,CAAyB;;IAEvBe,QAAQ,EAAG;IAETtD,MAAM,KAAK,MAAX,GACI,QADJ,GAEIA,MAAM,KAAK,SAAX,GACA,KADA,GAEA,iBACL;GATH,CADO,EAYP,IAAIuD,uBAAJ,EAZO,EA+BPvB,MA/BO,CA+BAC,OA/BA;CA5GI,CAAf;;ACLO,MAAMuB,kBAAkB,GAAIvD,UAAD,IAChCwD,iCAAqB,CAACC,mBAAmB,CAAC,MAAD,EAASzD,UAAT,CAApB,CADhB;AAGP,AAAO,MAAM0D,WAAW,GAAG,CACzBC,YADyB,EAEzBC,IAFyB,KAIzBC,+BAAmB,CAACF,YAAD,EAAe;EAChCjD,GAAG,EAAE,eAD2B;EAEhCoD,IAAI,EAAE,CAAC,kBAAD,EAAqB,QAArB,EAA+BF,IAA/B,EAAqC,WAArC,EAAkDG,IAAI,CAACC,GAAL,EAAlD,CAF0B;EAGhCC,GAAG,EAAEtD,IAAI,CAACS,OAAL,CAAa,GAAb;CAHY,CAJd;;ACNP,MAAMuC,YAAY,GAAGJ,kBAAkB,CAAC,KAAD,CAAvC;AAEA,IAAIW,QAAQ,GAAGR,WAAW,CAACC,YAAD,EAAeQ,IAAI,CAACP,IAApB,CAA1B;AAEA1D,OAAO,CAACkE,EAAR,CAAW,SAAX,EAAsB,MAAM;EAC1BF,QAAQ,CAACG,KAAT,CAAe,MAAM;IACnBH,QAAQ,GAAGR,WAAW,CAACC,YAAD,EAAeQ,IAAI,CAACP,IAApB,CAAtB;GADF;CADF"}