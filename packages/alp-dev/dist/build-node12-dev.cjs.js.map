{"version":3,"file":"build-node12-dev.cjs.js","sources":["../src/utils/loadConfigFile.ts","../src/utils/readFile.ts","../src/utils/writeFile.ts","../src/config-build.ts","../src/build.ts"],"sourcesContent":["import { readFileSync } from 'fs';\nimport path from 'path';\nimport { safeLoad as saveLoadYml } from 'js-yaml';\n\nexport interface Config {\n  [key: string]: any;\n}\n\nexport default function loadConfigFile(\n  content: string,\n  dirname: string,\n): [Config, Config] {\n  const data: any = saveLoadYml(content) || {};\n\n  const config = data.shared || data.common || {};\n  const serverConfig = { ...config, ...data.server };\n  const browserConfig = { ...config, ...data.browser };\n\n  if (data.include) {\n    const includePaths = data.include.map((includePath: string) =>\n      path.resolve(dirname, includePath),\n    );\n    includePaths\n      .map((includePath: string) => readFileSync(includePath, 'utf-8'))\n      .map((content: string, index: number) =>\n        loadConfigFile(content, path.dirname(includePaths[index])),\n      )\n      .forEach(\n        ([includeServerConfig, includeBrowserConfig]: [Config, Config]) => {\n          [\n            { config: serverConfig, include: includeServerConfig },\n            { config: browserConfig, include: includeBrowserConfig },\n          ].forEach(({ config, include }) =>\n            Object.keys(include).forEach((key) => {\n              if (!(key in config)) {\n                config[key] = include[key];\n                return;\n              }\n              if (Array.isArray(config[key])) {\n                config[key].push(include[key]);\n              } else if (typeof config[key] === 'object') {\n                Object.assign(config[key], include[key]);\n              } else {\n                throw new TypeError(\n                  `Unexpected override \"${key}\", filename = ${includePaths[key]}`,\n                );\n              }\n            }),\n          );\n        },\n      );\n  }\n\n  return [serverConfig, browserConfig];\n}\n","import fs from 'fs';\n\nexport default function readFile(target: string): Promise<string> {\n  return new Promise((resolve, reject) => {\n    fs.readFile(target, 'utf-8', (err, content) => {\n      if (err) {\n        return reject(\n          new Error(`Failed to read file \"${target}\": ${err.message || err}`),\n        );\n      }\n\n      resolve(content);\n    });\n  });\n}\n","import fs from 'fs';\nimport path from 'path';\nimport mkdirp from 'mkdirp';\n\nexport default function writeFile(\n  target: string,\n  content: string,\n): Promise<void> {\n  return new Promise((resolve, reject) => {\n    mkdirp(path.dirname(target), () => {\n      fs.writeFile(target, content, (err) => {\n        if (err) {\n          return reject(\n            new Error(\n              `Failed to write file \"${target}\": ${err.message || err}`,\n            ),\n          );\n        }\n\n        resolve();\n      });\n    });\n  });\n}\n","import type { FSWatcher } from 'fs';\nimport { watch as fsWatch } from 'fs';\nimport { dirname, join } from 'path';\nimport glob from 'glob';\nimport loadConfigFile from './utils/loadConfigFile';\nimport readFile from './utils/readFile';\nimport writeFile from './utils/writeFile';\n\nexport const clean = () => {};\n\nconst compileYml = async (filename: string) => {\n  const content = await readFile(filename);\n\n  const [serverConfig, browserConfig] = loadConfigFile(\n    content,\n    dirname(filename),\n  );\n  const destFile = `${filename.slice('src/'.length, -'yml'.length)}json`;\n\n  return Promise.all([\n    writeFile(`build/${destFile}`, JSON.stringify(serverConfig)),\n    writeFile(`public/${destFile}`, JSON.stringify(browserConfig)),\n  ]);\n};\n\nexport const build = (\n  src = './src/config',\n  onChanged?: () => void,\n): Promise<any> =>\n  Promise.all(\n    glob.sync(join(src, '**/*.yml')).map(\n      async (filename: string): Promise<() => void> => {\n        const compilePromise = compileYml(filename);\n\n        if (onChanged) {\n          const fsWatcher: FSWatcher = fsWatch(\n            filename,\n            { persistent: false, recursive: false },\n            (eventType: string): void => {\n              console.log(eventType, filename);\n              if (eventType === 'change') {\n                compileYml(filename).then(() => {\n                  onChanged();\n                });\n              }\n            },\n          );\n\n          await compilePromise;\n\n          return () => fsWatcher.close();\n        }\n\n        return () => {};\n      },\n    ),\n  ).then((closeFns: (() => void)[]) => () => {\n    closeFns.forEach((closeFn) => closeFn());\n  });\n\nexport const watch = (envs: string[]) => {};\n","import { execSync } from 'child_process';\nimport { resolve as pathResolve } from 'path';\nimport execa from 'execa';\nimport { clean, build } from './config-build';\n\nexecSync(`rm -Rf ${pathResolve('public')}/* ${pathResolve('build')}/*`);\n\nclean();\n\nPromise.all([\n  build(),\n  ...['build-node', 'build-modern-browser', 'build-older-browser'].map(\n    (path) => {\n      const instance = execa('node', [\n        __filename.replace('/build-', `/${path}-`),\n      ]);\n      if (instance.stdout) instance.stdout.pipe(process.stdout);\n      return instance;\n    },\n  ),\n]).then(\n  () => {\n    console.log('done !');\n  },\n  (err) => {\n    console.error(err);\n    process.exit(1);\n  },\n);\n"],"names":["loadConfigFile","content","dirname","data","saveLoadYml","config","shared","common","serverConfig","server","browserConfig","browser","include","includePaths","map","includePath","path","resolve","readFileSync","index","forEach","includeServerConfig","includeBrowserConfig","Object","keys","key","Array","isArray","push","assign","TypeError","readFile","target","Promise","reject","fs","err","Error","message","writeFile","mkdirp","compileYml","filename","destFile","slice","all","JSON","stringify","build","src","onChanged","glob","sync","join","compilePromise","fsWatcher","fsWatch","persistent","recursive","eventType","console","log","then","close","closeFns","closeFn","execSync","pathResolve","instance","execa","__filename","replace","stdout","pipe","process","error","exit"],"mappings":"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"}