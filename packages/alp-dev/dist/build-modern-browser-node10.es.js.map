{"version":3,"file":"build-modern-browser-node10.es.js","sources":["../src/webpack/createPobpackConfig.ts","../src/webpack/browser.ts","../src/build-modern-browser.ts"],"sourcesContent":["/* eslint-disable max-lines */\n\nimport fs from 'fs';\nimport path from 'path';\nimport webpack from 'webpack';\nimport OptimizeCssAssetsPlugin from 'optimize-css-assets-webpack-plugin';\nimport MiniCssExtractPlugin from 'mini-css-extract-plugin';\nimport autoprefixer from 'autoprefixer';\nimport { createModuleRules, createCssModuleUse } from 'ynnub-webpack-config';\nimport { Options } from 'pobpack-types';\n\n// stylesCacheGroups\n\ntype TargetType = 'node' | 'modern-browser' | 'browser';\n\nconst ExcludesFalsy = (Boolean as any) as <T>(\n  x: T | false | null | undefined,\n) => x is T;\n\nexport default function createPobpackConfig(\n  target: TargetType,\n  production = false,\n): Partial<Options> {\n  const pkg = JSON.parse(\n    fs.readFileSync(path.resolve('package.json'), 'utf-8'),\n  );\n  const deps = pkg.dependencies || {};\n  const devdeps = pkg.devDependencies || {};\n\n  const hasAntd = !!deps.antd;\n\n  if (deps.antd) {\n    if (!devdeps.less) {\n      throw new Error('less missing: yarn add --dev less');\n    }\n  }\n\n  return {\n    env: process.env.NODE_ENV,\n    hmr: !production,\n    typescript: true,\n\n    whitelistExternalExtensions: [\n      'png',\n      'jpg',\n      'jpeg',\n      'gif',\n      'svg',\n      'scss',\n      'css',\n    ],\n    includeModules: [],\n\n    paths: {\n      build: target === 'node' ? 'build' : 'public',\n    },\n\n    entries: [\n      {\n        key:\n          target === 'node'\n            ? 'index'\n            : // eslint-disable-next-line unicorn/no-nested-ternary\n            target === 'browser'\n            ? 'es5'\n            : 'modern-browsers',\n        path: target === 'node' ? 'index.server.ts' : 'index.browser.ts',\n      },\n    ],\n\n    resolveLoaderModules: [\n      path.join(__dirname, '../..', 'node_modules'),\n      'node_modules',\n    ],\n\n    babel: {\n      minified: target !== 'node' && production,\n      comments: !(target !== 'node' && production),\n\n      presets: [\n        // add react preset with jsx\n        [\n          require.resolve('@babel/preset-react'),\n          { development: !production, useBuiltIns: true },\n        ],\n        // pob preset: flow, import `src`, export default function name, replacements, exnext features, ...\n        [\n          require.resolve('babel-preset-pob-env'),\n          {\n            resolvePreset: (preset: string): string => require.resolve(preset),\n            production,\n            typescript: true,\n            exportDefaultName: false,\n            optimizations: true,\n            target: target === 'node' ? 'node' : 'browser',\n            version:\n              target === 'node'\n                ? 10.13\n                : // eslint-disable-next-line unicorn/no-nested-ternary\n                target === 'modern-browser'\n                ? 'modern'\n                : undefined,\n            loose: true,\n            modules: false,\n          },\n        ],\n      ],\n      plugins: [\n        require.resolve('babel-plugin-inline-classnames-babel7'),\n        hasAntd && [\n          require.resolve('babel-plugin-import'),\n          {\n            libraryName: 'antd',\n            libraryDirectory: target === 'node' ? 'lib' : 'es',\n            style: target !== 'node',\n          },\n        ],\n      ].filter(ExcludesFalsy),\n    },\n\n    moduleRules: [\n      // SCSS RULE, CSS RULE\n      ...createModuleRules({\n        target,\n        extractLoader: {\n          loader: MiniCssExtractPlugin.loader as any,\n          options: { hmr: false },\n        },\n        production,\n        themeFile: './src/theme.scss',\n        plugins: [autoprefixer],\n        includePaths: [path.resolve('./node_modules')],\n        resolveLoader: (loader: string): string => require.resolve(loader),\n      }),\n\n      // LESS RULE (antd)\n      {\n        test: /\\.less$/,\n        use: createCssModuleUse({\n          global: true,\n          target,\n          extractLoader: {\n            loader: MiniCssExtractPlugin.loader as any,\n            options: { hmr: false },\n          },\n          production,\n          plugins: [autoprefixer],\n          resolveLoader: (loader: string): string => require.resolve(loader),\n          otherLoaders: [\n            {\n              loader: require.resolve('less-loader'),\n              options: {\n                javascriptEnabled: true,\n                // modifyVars: path.resolve('./src/less-modifyVars.js'),\n              },\n            },\n            {\n              loader: require.resolve('less-modify-var-loader'),\n              options: {\n                filePath: path.resolve('./src/theme.less'),\n              },\n            },\n          ],\n        }),\n      },\n\n      // IMG RULE\n      {\n        test: /\\.(png|jpg|jpeg|gif|svg)$/,\n        loader: require.resolve('url-loader'),\n        options: {\n          /* config to emit with node doesn't work anymore because css is ignored by node */\n          // emitFile: target === 'node', // only write file if node\n          // outputPath: '../public/', // because it's node who is writing the file, node is in build/\n          // publicPath: (url: string): string => url.replace(/^..\\/public\\//, ''),\n          emitFile: target === 'modern-browser',\n          limit: 1000,\n          name: 'images/[hash].[ext]',\n        },\n      },\n    ],\n\n    // TODO https://github.com/zeit/next.js/blob/7d78c3b64185d6d6417f1af9cde4a69d32b18cc6/packages/next/build/webpack.js\n    // optimization: {\n    //   minimizer:\n    //     target === 'browser' ? [new OptimizeCssAssetsPlugin()] : undefined,\n    //   splitChunks: {\n    //     cacheGroups: {\n    //       styles: stylesCacheGroups,\n    //     },\n    //   },\n    // },\n\n    plugins: [\n      new MiniCssExtractPlugin({\n        // disable: target === 'node',\n        filename: `${\n          target === 'node'\n            ? 'server'\n            : // eslint-disable-next-line unicorn/no-nested-ternary\n            target === 'browser'\n            ? 'es5'\n            : 'modern-browsers'\n        }.css`,\n      }),\n      new OptimizeCssAssetsPlugin(),\n\n      process.send &&\n        new webpack.ProgressPlugin(\n          (percentage: number, message: string): void => {\n            (process.send as NonNullable<typeof process.send>)({\n              type: 'webpack-progress',\n              percentage,\n              message,\n            });\n          },\n        ),\n\n      // target === 'browser' &&\n      // target !== 'node' &&\n      //   production &&\n      //   new optimize.UglifyJsPlugin({\n      //     compress: {\n      //       warnings: false,\n      //     },\n      //     sourcleMap: !production,\n      //   }),!== 'node' &&\n      //   production &&\n      //   new optimize.UglifyJsPlugin({\n      //     compress: {\n      //       warnings: false,\n      //     },\n      //     sourceMap: !production,\n      //   }),\n      // TODO https://github.com/NekR/offline-plugin\n    ].filter(ExcludesFalsy),\n  };\n}\n","import path from 'path';\nimport {\n  createAppBrowserCompiler,\n  MODERN,\n  ALL,\n  runDevServer as runDevServerPobpack,\n  RunOptions,\n} from 'pobpack-browser';\nimport { PobpackCompiler } from 'pobpack-types';\nimport WebpackDevServer from 'webpack-dev-server';\nimport createPobpackConfig from './createPobpackConfig';\n\nexport const createModernBrowserCompiler = (production: boolean) =>\n  createAppBrowserCompiler(\n    MODERN,\n    createPobpackConfig('modern-browser', production),\n    { progressBar: false },\n  );\n\nexport const createOlderBrowserCompiler = (production: boolean) =>\n  createAppBrowserCompiler(ALL, createPobpackConfig('browser', production));\n\nexport type RunDevServerOptions = Pick<\n  RunOptions,\n  Exclude<keyof RunOptions, 'port' | 'https' | 'headers' | 'proxy'>\n>;\n\nexport const runDevServer = (\n  compiler: PobpackCompiler,\n  port: number,\n  proxyPort: number,\n  options?: RunDevServerOptions,\n): WebpackDevServer =>\n  runDevServerPobpack(compiler, {\n    port: proxyPort,\n    https: false,\n\n    contentBase: path.resolve('public'),\n    watchContentBase: true,\n\n    headers: {\n      // avoid errors in console\n      'Access-Control-Expose-Headers': 'SourceMap,X-SourceMap',\n    },\n\n    proxy: {\n      '**': { target: `http://localhost:${port}`, ws: true },\n    },\n\n    ...options,\n  });\n","import { createModernBrowserCompiler } from './webpack/browser';\n\nconst browserCompiler = createModernBrowserCompiler(\n  process.env.NODE_ENV === 'production',\n);\n\nbrowserCompiler.run();\n"],"names":["ExcludesFalsy","Boolean","createPobpackConfig","target","production","pkg","JSON","parse","fs","readFileSync","path","resolve","deps","dependencies","devdeps","devDependencies","hasAntd","antd","less","Error","env","process","NODE_ENV","hmr","typescript","whitelistExternalExtensions","includeModules","paths","build","entries","key","resolveLoaderModules","join","__dirname","babel","minified","comments","presets","require","development","useBuiltIns","resolvePreset","preset","exportDefaultName","optimizations","version","undefined","loose","modules","plugins","libraryName","libraryDirectory","style","filter","moduleRules","createModuleRules","extractLoader","loader","MiniCssExtractPlugin","options","themeFile","autoprefixer","includePaths","resolveLoader","test","use","createCssModuleUse","global","otherLoaders","javascriptEnabled","filePath","emitFile","limit","name","filename","OptimizeCssAssetsPlugin","send","webpack","ProgressPlugin","percentage","message","type","createModernBrowserCompiler","createAppBrowserCompiler","MODERN","progressBar","browserCompiler","run"],"mappings":"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"}