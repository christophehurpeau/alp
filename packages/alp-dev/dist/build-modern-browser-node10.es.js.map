{"version":3,"file":"build-modern-browser-node10.es.js","sources":["../src/webpack/createPobpackConfig.ts","../src/webpack/browser.ts","../src/build-modern-browser.ts"],"sourcesContent":["/* eslint-disable max-lines */\n\nimport fs from 'fs';\nimport path from 'path';\nimport webpack from 'webpack';\nimport OptimizeCssAssetsPlugin from 'optimize-css-assets-webpack-plugin';\nimport MiniCssExtractPlugin from 'mini-css-extract-plugin';\nimport autoprefixer from 'autoprefixer';\nimport { createModuleRules, createCssModuleUse } from 'ynnub-webpack-config';\nimport { Options } from 'pobpack-types';\n\n// stylesCacheGroups\n\ntype TargetType = 'node' | 'modern-browser' | 'browser';\n\nconst ExcludesFalsy = (Boolean as any) as <T>(\n  x: T | false | null | undefined,\n) => x is T;\n\nexport default function createPobpackConfig(\n  target: TargetType,\n  production = false,\n): Partial<Options> {\n  const pkg = JSON.parse(\n    fs.readFileSync(path.resolve('package.json'), 'utf-8'),\n  );\n  const deps = pkg.dependencies || {};\n  const devdeps = pkg.devDependencies || {};\n\n  const hasAntd = !!deps.antd;\n\n  if (deps.antd) {\n    if (!devdeps.less) {\n      throw new Error('less missing: yarn add --dev less');\n    }\n  }\n\n  return {\n    env: process.env.NODE_ENV,\n    hmr: !production,\n    typescript: true,\n\n    whitelistExternalExtensions: [\n      'png',\n      'jpg',\n      'jpeg',\n      'gif',\n      'svg',\n      'scss',\n      'css',\n    ],\n    includeModules: [],\n\n    paths: {\n      build: target === 'node' ? 'build' : 'public',\n    },\n\n    entries: [\n      {\n        key:\n          // eslint-disable-next-line no-nested-ternary\n          target === 'node'\n            ? 'index'\n            : target === 'browser'\n            ? 'es5'\n            : 'modern-browsers',\n        path: target === 'node' ? 'index.server.ts' : 'index.browser.ts',\n      },\n    ],\n\n    resolveLoaderModules: [\n      path.join(__dirname, '../..', 'node_modules'),\n      'node_modules',\n    ],\n\n    babel: {\n      minified: target !== 'node' && production,\n      comments: !(target !== 'node' && production),\n\n      presets: [\n        // add react preset with jsx\n        [\n          require.resolve('@babel/preset-react'),\n          { development: !production, useBuiltIns: true },\n        ],\n        // pob preset: flow, import `src`, export default function name, replacements, exnext features, ...\n        [\n          require.resolve('babel-preset-pob-env'),\n          {\n            resolvePreset: (preset: string): string => require.resolve(preset),\n            production,\n            typescript: true,\n            exportDefaultName: false,\n            optimizations: true,\n            target: target === 'node' ? 'node' : 'browser',\n            version:\n              // eslint-disable-next-line no-nested-ternary\n              target === 'node'\n                ? 8.3\n                : target === 'modern-browser'\n                ? 'modern'\n                : undefined,\n            loose: true,\n            modules: false,\n          },\n        ],\n      ],\n      plugins: [\n        require.resolve('babel-plugin-inline-classnames-babel7'),\n        hasAntd && [\n          require.resolve('babel-plugin-import'),\n          {\n            libraryName: 'antd',\n            libraryDirectory: target === 'node' ? 'lib' : 'es',\n            style: target !== 'node',\n          },\n        ],\n      ].filter(ExcludesFalsy),\n    },\n\n    moduleRules: [\n      // SCSS RULE, CSS RULE\n      ...createModuleRules({\n        target,\n        extractLoader: {\n          loader: MiniCssExtractPlugin.loader as any,\n          options: { hmr: false },\n        },\n        production,\n        themeFile: './src/theme.scss',\n        plugins: [autoprefixer],\n        includePaths: [path.resolve('./node_modules')],\n        resolveLoader: (loader: string): string => require.resolve(loader),\n      }),\n\n      // LESS RULE (antd)\n      {\n        test: /\\.less$/,\n        use: createCssModuleUse({\n          global: true,\n          target,\n          extractLoader: {\n            loader: MiniCssExtractPlugin.loader as any,\n            options: { hmr: false },\n          },\n          production,\n          plugins: [autoprefixer],\n          resolveLoader: (loader: string): string => require.resolve(loader),\n          otherLoaders: [\n            {\n              loader: require.resolve('less-loader'),\n              options: {\n                javascriptEnabled: true,\n                // modifyVars: path.resolve('./src/less-modifyVars.js'),\n              },\n            },\n            {\n              loader: require.resolve('less-modify-var-loader'),\n              options: {\n                filePath: path.resolve('./src/theme.less'),\n              },\n            },\n          ],\n        }),\n      },\n\n      // IMG RULE\n      {\n        test: /\\.(png|jpg|jpeg|gif|svg)$/,\n        loader: require.resolve('url-loader'),\n        options: {\n          /* config to emit with node doesn't work anymore because css is ignored by node */\n          // emitFile: target === 'node', // only write file if node\n          // outputPath: '../public/', // because it's node who is writing the file, node is in build/\n          // publicPath: (url: string): string => url.replace(/^..\\/public\\//, ''),\n          emitFile: target === 'modern-browser',\n          limit: 1000,\n          name: 'images/[hash].[ext]',\n        },\n      },\n    ],\n\n    // TODO https://github.com/zeit/next.js/blob/7d78c3b64185d6d6417f1af9cde4a69d32b18cc6/packages/next/build/webpack.js\n    // optimization: {\n    //   minimizer:\n    //     target === 'browser' ? [new OptimizeCssAssetsPlugin()] : undefined,\n    //   splitChunks: {\n    //     cacheGroups: {\n    //       styles: stylesCacheGroups,\n    //     },\n    //   },\n    // },\n\n    plugins: [\n      new MiniCssExtractPlugin({\n        // disable: target === 'node',\n        filename: `${\n          // eslint-disable-next-line no-nested-ternary\n          target === 'node'\n            ? 'server'\n            : target === 'browser'\n            ? 'es5'\n            : 'modern-browsers'\n        }.css`,\n      }),\n      new OptimizeCssAssetsPlugin(),\n\n      process.send &&\n        new webpack.ProgressPlugin((percentage: number, message: string) => {\n          (process.send as NonNullable<typeof process.send>)({\n            type: 'webpack-progress',\n            percentage,\n            message,\n          });\n        }),\n\n      // target === 'browser' &&\n      // target !== 'node' &&\n      //   production &&\n      //   new optimize.UglifyJsPlugin({\n      //     compress: {\n      //       warnings: false,\n      //     },\n      //     sourcleMap: !production,\n      //   }),!== 'node' &&\n      //   production &&\n      //   new optimize.UglifyJsPlugin({\n      //     compress: {\n      //       warnings: false,\n      //     },\n      //     sourceMap: !production,\n      //   }),\n      // TODO https://github.com/NekR/offline-plugin\n    ].filter(ExcludesFalsy),\n  };\n}\n","import path from 'path';\nimport {\n  createAppBrowserCompiler,\n  MODERN,\n  ALL,\n  runDevServer as runDevServerPobpack,\n  RunOptions,\n} from 'pobpack-browser';\nimport { PobpackCompiler } from 'pobpack-types';\nimport WebpackDevServer from 'webpack-dev-server';\nimport createPobpackConfig from './createPobpackConfig';\n\nexport const createModernBrowserCompiler = (production: boolean) =>\n  createAppBrowserCompiler(\n    MODERN,\n    createPobpackConfig('modern-browser', production),\n    { progressBar: false },\n  );\n\nexport const createOlderBrowserCompiler = (production: boolean) =>\n  createAppBrowserCompiler(ALL, createPobpackConfig('browser', production));\n\nexport type RunDevServerOptions = Pick<\n  RunOptions,\n  Exclude<keyof RunOptions, 'port' | 'https' | 'headers' | 'proxy'>\n>;\n\nexport const runDevServer = (\n  compiler: PobpackCompiler,\n  port: number,\n  proxyPort: number,\n  options?: RunDevServerOptions,\n): WebpackDevServer =>\n  runDevServerPobpack(compiler, {\n    port: proxyPort,\n    https: false,\n\n    contentBase: path.resolve('public'),\n    watchContentBase: true,\n\n    headers: {\n      // avoid errors in console\n      'Access-Control-Expose-Headers': 'SourceMap,X-SourceMap',\n    },\n\n    proxy: {\n      '**': `http://localhost:${port}`,\n    },\n\n    ...options,\n  });\n","import { createModernBrowserCompiler } from './webpack/browser';\n\nconst browserCompiler = createModernBrowserCompiler(\n  process.env.NODE_ENV === 'production',\n);\n\nbrowserCompiler.run();\n"],"names":["ExcludesFalsy","Boolean","createPobpackConfig","target","production","pkg","JSON","parse","fs","readFileSync","path","resolve","deps","dependencies","devdeps","devDependencies","hasAntd","antd","less","Error","env","process","NODE_ENV","hmr","typescript","whitelistExternalExtensions","includeModules","paths","build","entries","key","resolveLoaderModules","join","__dirname","babel","minified","comments","presets","require","development","useBuiltIns","resolvePreset","preset","exportDefaultName","optimizations","version","undefined","loose","modules","plugins","libraryName","libraryDirectory","style","filter","moduleRules","createModuleRules","extractLoader","loader","MiniCssExtractPlugin","options","themeFile","autoprefixer","includePaths","resolveLoader","test","use","createCssModuleUse","global","otherLoaders","javascriptEnabled","filePath","emitFile","limit","name","filename","OptimizeCssAssetsPlugin","send","webpack","ProgressPlugin","percentage","message","type","createModernBrowserCompiler","createAppBrowserCompiler","MODERN","progressBar","browserCompiler","run"],"mappings":"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"}