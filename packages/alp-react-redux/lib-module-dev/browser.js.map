{"version":3,"sources":["../src/browser.jsx"],"names":["render","unmountComponentAtNode","Logger","createStore","applyMiddleware","compose","combineReducers","promiseMiddleware","createFunctionMiddleware","websocketMiddleware","loadingBar","AlpReactApp","AlpReduxApp","alpReducers","ReactComponentType","Helmet","connect","createAction","createReducer","createLoader","createPureStatelessComponent","classNames","createEmitAction","createEmitPromiseAction","HYDRATE_STATE","logger","store","currentModuleDescriptorIdentifier","renderApp","App","appProps","View","props","element","app","createHydratableReducer","reducer","state","action","type","getReactAppElement","document","getElementById","alpReactRedux","appHOC","sharedReducers","AlpReactAppLayout","AlpReduxAppLayout","middleware","websocket","loggerWebsocket","child","debug","on","dispatch","push","context","moduleDescriptor","data","_loaded","_loadingBar","Error","loader","currentState","identifier","getState","Object","create","then","moduleHasReducers","reducers","undefined","composeEnhancers","window","__REDUX_DEVTOOLS_EXTENSION_COMPOSE__","assign","isSameModule","replaceReducer","err"],"mappings":";;;;;;AAAA,SAASA,MAAT,EAAiBC,sBAAjB,QAA+C,WAA/C;AACA,OAAOC,MAAP;AACA,SAASC,WAAT,EAAsBC,eAAtB,EAAuCC,OAAvC,EAAgDC,eAAhD;AACA,SAASC,iBAAT,EAA4BC,wBAA5B,QAA4D,sBAA5D;AACA,SAASC,mBAAT,QAAoC,aAApC;AACA,OAAOC,UAAP,MAAuB,eAAvB;AACA,OAAOC,WAAP,MAAwB,sBAAxB;AACA,OAAOC,WAAP,MAAwB,sBAAxB;AACA,OAAO,KAAKC,WAAZ,MAA6B,YAA7B;AACA,SAAcC,yCAAd,QAAwC,SAAxC;;;;;;AAEA,SAASH,WAAT,EAAsBC,WAAtB;oBACmB,c;oBAAZG,M;;AACP,SAAST,eAAT;AACA,SAASU,OAAT;AACA,SAASC,YAAT,EAAuBC,aAAvB,EAAsCC,YAAtC,EAAoDC,4BAApD,EAAkFC,UAAlF,QAAoG,SAApG;AACA,SAASC,gBAAT,EAA2BC,uBAA3B,QAA0D,aAA1D;;AAEA,IAAMC,gBAAgB,eAAtB;AACA,IAAMC,SAAS,IAAIvB,MAAJ,CAAW,iBAAX,CAAf;;AAEA,IAAIwB,cAAJ;AACA,IAAIC,0CAAJ;;AAEA,8CAAsB,cACpB,sBAAS,OAAT,CADoB,EAEpB,kBAAK,yBAAL,CAFoB,EAGpB,uBAAU,UAAV,CAHoB,EAIpB,mBAAM,yBAAN,CAJoB,EAKpB,oBAAO,WAAC,UAAD,CAAP,CALoB,CAAtB;;;AAQA,IAAMC,YAAY,SAAZA,SAAY,OAA6D;AAAA,8BAArB,cAAqB;AAAA,MAA1DC,GAA0D,yBAA1DA,GAA0D;AAAA,MAArDC,QAAqD,yBAArDA,QAAqD;AAAA,MAA3CC,IAA2C,yBAA3CA,IAA2C;AAAA,MAArCC,KAAqC,yBAArCA,KAAqC;AAAA,MAA9BC,OAA8B,yBAA9BA,OAA8B;;AAC7E,MAAIC,MAAM;AAAC,OAAD;AAAA,iBAASJ,QAAT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAmB,wBAAC,IAAD,eAAUE,KAAV;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAnB,GAAV;AACA,SAAOhC,OAAOkC,GAAP,EAAYD,OAAZ,CAAP;AACD,CAHD;;AAKA,IAAME,0BAA0B,SAA1BA,uBAA0B,CAACC,OAAD;AAAA,qBAAQ,YAAR;;AAAA;AAAA,SAC9B,UAACC,KAAD,EAAQC,MAAR,EAAmB;AACjB,QAAIA,OAAOC,IAAP,KAAgBf,aAApB,EAAmC;AACjCa,cAAQC,OAAOD,KAAf;AACD;;AAED,WAAOD,QAAQC,KAAR,EAAeC,MAAf,CAAP;AACD,GAP6B;AAAA,CAAhC;;AAUA,wCAAmB,cACjB,qBAAQ,WAAC,YAAD,CAAR,CADiB,EAEjB,6BAAgB,WAAC,UAAD,CAAhB,CAFiB,CAAnB;;;AAKA,IAAME,qBAAqB,SAArBA,kBAAqB;AAAA,SAAMC,SAASC,cAAT,CAAwB,WAAxB,CAAN;AAAA,CAA3B;;AAEA,eAAe,SAASC,aAAT,GAA2E;AAAA;;AAAA,2BAArB,WAAG,WAAH,CAAqB;AAAA,MAAlDC,MAAkD,sBAAlDA,MAAkD;AAAA,iDAA1CC,cAA0C;AAAA,MAA1CA,cAA0C;;AACxF,MAAMC,oBAAoBF,SAASA,OAAOjC,WAAP,CAAT,GAA+BA,WAAzD;AACA,MAAMoC,oBAAoBH,SAASA,OAAOhC,WAAP,CAAT,GAA+BA,WAAzD;;AAEA,SAAO,UAACsB,GAAD,EAAS;AACd,QAAMc,aAAa,CACjBxC,yBAAyB0B,GAAzB,CADiB,EAEjB3B,iBAFiB,CAAnB;;AAKA,QAAI2B,IAAIe,SAAR,EAAmB;AACjB,UAAMC,kBAAkBzB,OAAO0B,KAAP,CAAa,WAAb,CAAxB;AACAD,sBAAgBE,KAAhB,CAAsB,iCAAtB;AACAlB,UAAIe,SAAJ,CAAcI,EAAd,CAAiB,cAAjB,EAAiC,UAACf,MAAD,EAAY;AAC3CY,wBAAgBE,KAAhB,CAAsB,gCAAtB,EAAwDd,MAAxD;AACA,YAAIZ,KAAJ,EAAW;AACTA,gBAAM4B,QAAN,CAAehB,MAAf;AACD;AACF,OALD;AAMAU,iBAAWO,IAAX,CAAgB9C,oBAAoByB,GAApB,CAAhB;AACD;;AAEDA,QAAIsB,OAAJ,CAAYxD,MAAZ,GAAqB,UAAUyD,gBAAV,EAA4BC,IAA5B,EAAkCC,OAAlC,EAA2CC,WAA3C,EAAwD;AAAA;;AAC3E,UAAI,CAACA,WAAL,EAAkBA,cAAclD,YAAd;AAClBe,aAAO2B,KAAP,CAAa,aAAb,EAA4B,EAAEM,UAAF,EAA5B;;AAEA,UAAI;AACF,YAAmB,CAACD,iBAAiB1B,IAArC,EAA2C;AACzC,gBAAM,IAAI8B,KAAJ,CAAU,mCAAV,CAAN;AACD;;AAED,YAAI,CAACF,OAAD,IAAYF,iBAAiBK,MAAjC,EAAyC;AACvC,cAAMC,eAAerC,SACrBC,sCAAsC8B,iBAAiBO,UADlC,GAEnBtC,MAAMuC,QAAN,EAFmB,GAEAC,OAAOC,MAAP,CAAc,IAAd,CAFrB;;AAIA;AACA,iBAAOV,iBAAiBK,MAAjB,CAAwBC,YAAxB,EAAsCL,IAAtC,EAA4CU,IAA5C,CAAiD;AAAA,mBACtD,OAAKpE,MAAL,CAAYyD,gBAAZ,EAA8BC,IAA9B,EAAoC,IAApC,EAA0CE,WAA1C,CADsD;AAAA,WAAjD,CAAP;AAGD;;AAED,YAAMS,oBAAoB,CAAC,EAAEZ,iBAAiBrB,OAAjB,IAA4BqB,iBAAiBa,QAA/C,CAA3B;AACA,YAAIlC,UAAUqB,iBAAiBrB,OAAjB,GACZqB,iBAAiBrB,OADL,GAEV9B,kCAAqBmD,iBAAiBa,QAAtC,EAAmDzD,WAAnD,EAAmEgC,cAAnE,EAFJ;;AAKA,YAAI,CAACT,OAAL,EAAc;AACZ,cAAIV,KAAJ,EAAW;AACTU,sBAAU,mBAAM,CAAE,CAAlB;AACAV,kBAAM4B,QAAN,CAAe,EAAEf,MAAMf,aAAR,EAAuBa,OAAO6B,OAAOC,MAAP,CAAc,IAAd,CAA9B,EAAf;AACD;AACF,SALD,MAKO,IAAIzC,UAAU6C,SAAd,EAAyB;AAC9B,cAAMC,mBAAmBC,OAAOC,oCAAP,IAA+CrE,OAAxE;AACAqB,kBAAQvB,YACNgC,wBAAwBC,OAAxB,CADM,EAEN8B,OAAOS,MAAP,CAAcT,OAAOC,MAAP,CAAc,IAAd,CAAd,EAAmC,EAAEX,SAAS,IAAX,EAAnC,EAAsDE,IAAtD,CAFM,EAGNc,iBAAiBpE,iCAAmB4C,UAAnB,CAAjB,CAHM,CAAR;AAKD,SAPM,MAOA;AACL,cAAMX,QAAQ6B,OAAOC,MAAP,CAAc,IAAd,CAAd;AACA,cAAMS,eAAejD,sCAAsC8B,iBAAiBO,UAA5E;;AAEA,cAAItC,KAAJ,EAAW;AACT,gBAAIkD,YAAJ,EAAkB;AAChB;AACAV,qBAAOS,MAAP,CAActC,KAAd,EAAqBX,MAAMuC,QAAN,EAArB;AACD,aAHD,MAGO;AACL;AACAhE,qCAAuBuC,oBAAvB;AACA;AACAd,oBAAMmD,cAAN,CAAqB1C,wBAAwBC,OAAxB,CAArB;AACA;AACAC,oBAAMmB,OAAN,GAAgB,IAAhB;AACD;AACF;;AAED,cAAIa,iBAAJ,EAAuBH,OAAOS,MAAP,CAActC,KAAd,EAAqBqB,IAArB;AACvBhC,gBAAM4B,QAAN,CAAe,EAAEf,MAAMf,aAAR,EAAuBa,YAAvB,EAAf;AACD;;AAEDV,4CAAoC8B,iBAAiBO,UAArD;;AAEA,YAAI5B,OAAJ,EAAa;AACX,eAAKV,KAAL,GAAaA,KAAb;AACD;;AAEDE,kBAAU;AACRK,mBAASO,oBADD;AAERX,eAAKO,UAAUW,iBAAV,GAA8BD,iBAF3B;AAGRhB,oBAAU;AACRJ,wBADQ;AAER8B,qBAAS,IAFD;AAGRC;AAHQ,WAHF;AAQR1B,gBAAM0B,iBAAiB1B,IARf;AASRC,iBAAOqC,oBAAoBE,SAApB,GAAgCb;AAT/B,SAAV;AAWD,OAzED,CAyEE,OAAOoB,GAAP,EAAY;AACZlB;AACA,cAAMkB,GAAN;AACD;;AAEDlB;AACD,KAnFD;AAoFD,GAtGD;AAuGD","file":"browser.jsx","sourcesContent":["import { render, unmountComponentAtNode } from 'react-dom';\nimport Logger from 'nightingale-logger/src';\nimport { createStore, applyMiddleware, compose, combineReducers } from 'redux/src';\nimport { promiseMiddleware, createFunctionMiddleware } from './middleware-browser';\nimport { websocketMiddleware } from './websocket';\nimport loadingBar from './loading-bar';\nimport AlpReactApp from './layout/AlpReactApp';\nimport AlpReduxApp from './layout/AlpReduxApp';\nimport * as alpReducers from './reducers';\nimport type { ReactComponentType } from './types';\n\nexport { AlpReactApp, AlpReduxApp };\nexport Helmet from 'react-helmet';\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport { createAction, createReducer, createLoader, createPureStatelessComponent, classNames } from './utils';\nexport { createEmitAction, createEmitPromiseAction } from './websocket';\n\nconst HYDRATE_STATE = 'HYDRATE_STATE';\nconst logger = new Logger('alp:react-redux');\n\nlet store;\nlet currentModuleDescriptorIdentifier;\n\ntype AppOptionsType = {|\n  element: any,\n  App: ReactComponentType,\n  appProps: Object,\n  View: ReactComponentType,\n  props: ?Object,\n|};\n\nconst renderApp = ({ App, appProps, View, props, element }: AppOptionsType) => {\n  let app = <App {...appProps}><View {...props} /></App>;\n  return render(app, element);\n};\n\nconst createHydratableReducer = (reducer: Function) => (\n  (state, action) => {\n    if (action.type === HYDRATE_STATE) {\n      state = action.state;\n    }\n\n    return reducer(state, action);\n  }\n);\n\ntype OptionsType = {|\n  appHOC: ?Function,\n  sharedReducers: ?Object,\n|};\n\nconst getReactAppElement = () => document.getElementById('react-app');\n\nexport default function alpReactRedux({ appHOC, sharedReducers = {} }: ?OptionsType = {}) {\n  const AlpReactAppLayout = appHOC ? appHOC(AlpReactApp) : AlpReactApp;\n  const AlpReduxAppLayout = appHOC ? appHOC(AlpReduxApp) : AlpReduxApp;\n\n  return (app) => {\n    const middleware = [\n      createFunctionMiddleware(app),\n      promiseMiddleware,\n    ];\n\n    if (app.websocket) {\n      const loggerWebsocket = logger.child('websocket');\n      loggerWebsocket.debug('register websocket redux:action');\n      app.websocket.on('redux:action', (action) => {\n        loggerWebsocket.debug('dispatch action from websocket', action);\n        if (store) {\n          store.dispatch(action);\n        }\n      });\n      middleware.push(websocketMiddleware(app));\n    }\n\n    app.context.render = function (moduleDescriptor, data, _loaded, _loadingBar) {\n      if (!_loadingBar) _loadingBar = loadingBar();\n      logger.debug('render view', { data });\n\n      try {\n        if (!PRODUCTION && !moduleDescriptor.View) {\n          throw new Error('View is undefined, class expected');\n        }\n\n        if (!_loaded && moduleDescriptor.loader) {\n          const currentState = store &&\n          currentModuleDescriptorIdentifier === moduleDescriptor.identifier ?\n            store.getState() : Object.create(null);\n\n          // const _state = data;\n          return moduleDescriptor.loader(currentState, data).then(data => (\n            this.render(moduleDescriptor, data, true, _loadingBar)\n          ));\n        }\n\n        const moduleHasReducers = !!(moduleDescriptor.reducer || moduleDescriptor.reducers);\n        let reducer = moduleDescriptor.reducer ?\n          moduleDescriptor.reducer : (\n            combineReducers({ ...moduleDescriptor.reducers, ...alpReducers, ...sharedReducers })\n          );\n\n        if (!reducer) {\n          if (store) {\n            reducer = () => {};\n            store.dispatch({ type: HYDRATE_STATE, state: Object.create(null) });\n          }\n        } else if (store === undefined) {\n          const composeEnhancers = window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || compose;\n          store = createStore(\n            createHydratableReducer(reducer),\n            Object.assign(Object.create(null), { context: this }, data),\n            composeEnhancers(applyMiddleware(...middleware)),\n          );\n        } else {\n          const state = Object.create(null);\n          const isSameModule = currentModuleDescriptorIdentifier === moduleDescriptor.identifier;\n\n          if (store) {\n            if (isSameModule) {\n              // keep state\n              Object.assign(state, store.getState());\n            } else {\n              // destroy current component\n              unmountComponentAtNode(getReactAppElement());\n              // replace reducer\n              store.replaceReducer(createHydratableReducer(reducer));\n              // add initial context\n              state.context = this;\n            }\n          }\n\n          if (moduleHasReducers) Object.assign(state, data);\n          store.dispatch({ type: HYDRATE_STATE, state });\n        }\n\n        currentModuleDescriptorIdentifier = moduleDescriptor.identifier;\n\n        if (reducer) {\n          this.store = store;\n        }\n\n        renderApp({\n          element: getReactAppElement(),\n          App: reducer ? AlpReduxAppLayout : AlpReactAppLayout,\n          appProps: {\n            store,\n            context: this,\n            moduleDescriptor,\n          },\n          View: moduleDescriptor.View,\n          props: moduleHasReducers ? undefined : data,\n        });\n      } catch (err) {\n        _loadingBar();\n        throw err;\n      }\n\n      _loadingBar();\n    };\n  };\n}\n"]}