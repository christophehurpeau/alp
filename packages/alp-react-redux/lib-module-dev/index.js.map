{"version":3,"sources":["../src/index.js"],"names":["React","renderToString","Helmet","reactTreeWalker","Logger","createIsModernBrowser","htmlLayout","createAlpAppWrapper","createServerStore","createModuleVisitor","combineReducers","connect","createAction","createReducer","createLoader","classNames","createPureStatelessComponent","identityReducer","AlpModule","AlpReduxModule","Body","AppContainer","logger","renderHtml","app","options","content","helmet","renderStatic","isModernBrowser","App","ctx","config","get","ua","req","headers","name","createElement","moduleVisitor","preRenderStore","getState","PreRenderWrappedApp","context","store","visitor","getReducers","sharedReducers","WrappedApp","removeCtxFromInitialData","initialData","version","scriptName","styleName","polyfillFeatures","body","loggerWebsocket","child","emitAction","to","action","debug","emit"],"mappings":"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","file":"index.js","sourcesContent":["import React from 'react';\nimport { renderToString } from 'react-dom/server';\nimport Helmet from 'react-helmet';\nimport reactTreeWalker from 'react-tree-walker';\nimport Logger from 'nightingale-logger/src';\nimport createIsModernBrowser from 'modern-browsers';\nimport htmlLayout from './layout/htmlLayout';\nimport createAlpAppWrapper from './createAlpAppWrapper';\nimport createServerStore from './store/createServerStore';\nimport createModuleVisitor from './module/createModuleVisitor';\n\nexport { Helmet };\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport {\n  createAction,\n  createReducer,\n  createLoader,\n  classNames,\n  createPureStatelessComponent,\n  identityReducer,\n} from './utils/index';\nexport AlpModule from './module/AlpModule';\nexport AlpReduxModule from './module/AlpReduxModuleServer';\nexport Body from './layout/Body';\nexport AppContainer from './layout/AppContainer';\n\nconst logger = new Logger('alp:react-redux');\n\nconst renderHtml = (app, options) => {\n  const content = renderToString(app);\n  const helmet = Helmet.renderStatic();\n  return htmlLayout(helmet, content, options);\n};\n\nconst isModernBrowser = createIsModernBrowser();\n\ntype OptionsType = {|\n  sharedReducers: ?{ [string]: any },\n  scriptName: ?string | false,\n  styleName: ?string | false,\n  polyfillFeatures: ?string,\n|};\n\nexport default (App, options: ?OptionsType = {}) => async ctx => {\n  const version: string = ctx.config.get('version');\n  // TODO create alp-useragent with getter in context\n  const ua = ctx.req.headers['user-agent'];\n  const name = isModernBrowser(ua) ? 'modern-browsers' : 'es5';\n\n  const app = React.createElement(App);\n  const moduleVisitor = createModuleVisitor();\n  const preRenderStore = { getState: () => ({ ctx }) };\n  const PreRenderWrappedApp = createAlpAppWrapper(app, { context: ctx, store: preRenderStore });\n  await reactTreeWalker(React.createElement(PreRenderWrappedApp), moduleVisitor.visitor);\n\n  const store = createServerStore(ctx, moduleVisitor.getReducers(), {\n    sharedReducers: options.sharedReducers,\n  });\n\n  const WrappedApp = createAlpAppWrapper(app, { context: ctx, store });\n\n  // eslint-disable-next-line no-unused-vars\n  const { ctx: removeCtxFromInitialData, ...initialData } = store.getState();\n  ctx.body = await renderHtml(React.createElement(WrappedApp), {\n    version,\n    scriptName: options.scriptName !== undefined ? options.scriptName : name,\n    styleName: options.styleName !== undefined ? options.styleName : name,\n    polyfillFeatures: options.polyfillFeatures,\n    initialData,\n  });\n};\n\nconst loggerWebsocket = logger.child('websocket');\n\nexport function emitAction(to, action) {\n  loggerWebsocket.debug('emitAction', action);\n  to.emit('redux:action', action);\n}\n"]}