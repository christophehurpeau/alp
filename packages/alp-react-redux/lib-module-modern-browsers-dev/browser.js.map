{"version":3,"sources":["../src/browser.js"],"names":["contentLoaded","React","hydrate","Helmet","reactTreeWalker","Logger","BrowserAppContainer","createAlpAppWrapper","createBrowserStore","createBrowserModuleStoreReducer","createModuleVisitor","ReduxActionType","combineReducers","connect","createAction","createReducer","createLoader","classNames","createPureStatelessComponent","identityReducer","AlpModule","AlpReduxModule","Body","AppContainer","logger","renderApp","createElement","App","document","getElementById","preRender","ctx","appElement","moduleVisitor","PreRenderWrappedApp","context","store","getState","visitor","getReducers","app","reduxReducers","loading","state","action","meta","undefined","reduxMiddlewares","middlewares","sharedReducers","moduleStoreReducer","createStore","moduleReducers","reducer","window","createContext","render","WrappedApp","setModuleReducers","set","reducers","success"],"mappings":"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","file":"browser.js","sourcesContent":["import contentLoaded from 'content-loaded';\nimport React from 'react';\nimport { hydrate } from 'react-dom';\nimport Helmet from 'react-helmet';\nimport reactTreeWalker from 'react-tree-walker';\nimport Logger from 'nightingale-logger/src';\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport BrowserAppContainer from 'alp-dev/BrowserAppContainer';\nimport createAlpAppWrapper from './createAlpAppWrapper';\nimport createBrowserStore from './store/createBrowserStore';\nimport createBrowserModuleStoreReducer from './store/createBrowserModuleStoreReducer';\nimport createModuleVisitor from './module/createModuleVisitor';\nimport type { ReduxActionType } from './types';\n\nexport { Helmet };\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport {\n  createAction,\n  createReducer,\n  createLoader,\n  classNames,\n  createPureStatelessComponent,\n  identityReducer,\n} from './utils/index';\nexport AlpModule from './module/AlpModule';\nexport AlpReduxModule from './module/AlpReduxModuleBrowser';\nexport Body from './layout/Body';\nexport AppContainer from './layout/AppContainer';\n\nconst logger = new Logger('alp:react-redux');\n\nconst renderApp = App => hydrate(React.createElement(App), document.getElementById('react-app'));\n\nconst preRender = async (ctx, appElement) => {\n  const moduleVisitor = createModuleVisitor();\n  const preRenderStore = { getState: () => ({ ctx }) };\n  const PreRenderWrappedApp = createAlpAppWrapper(appElement, {\n    context: ctx,\n    store: preRenderStore,\n  });\n  await reactTreeWalker(React.createElement(PreRenderWrappedApp), moduleVisitor.visitor);\n\n  return moduleVisitor.getReducers();\n};\n\nexport default app => {\n  app.reduxReducers = {\n    loading: (state: ?number = 0, action: ReduxActionType) => {\n      if (action.meta && action.meta.loading !== undefined) {\n        return state + (action.meta.loading ? 1 : -1);\n      }\n      return state;\n    },\n  };\n  app.reduxMiddlewares = [];\n\n  return {\n    renderApp: async (App, { middlewares = [], sharedReducers } = {}) => {\n      let store;\n      let moduleStoreReducer;\n\n      const createStore = (ctx, moduleReducers) => {\n        moduleStoreReducer = createBrowserModuleStoreReducer(moduleReducers);\n        const store = createBrowserStore(app, ctx, moduleStoreReducer.reducer, {\n          middlewares,\n          sharedReducers,\n        });\n        app.store = store;\n        window.store = store;\n        return store;\n      };\n\n      const ctx = app.createContext();\n\n      const render = async App => {\n        let appElement = React.createElement(App);\n        if (!PRODUCTION) {\n          appElement = React.createElement(BrowserAppContainer, {}, appElement);\n        }\n\n        const moduleReducers = await preRender(ctx, appElement);\n\n        if (!PRODUCTION) {\n          store = createStore(ctx, moduleReducers);\n        } else {\n          // in DEV\n          // eslint-disable-next-line no-lonely-if\n          if (!store) {\n            store = createStore(ctx, moduleReducers);\n          } else {\n            moduleStoreReducer.setReducers(moduleReducers);\n          }\n        }\n\n        const WrappedApp = createAlpAppWrapper(appElement, {\n          context: ctx,\n          store,\n          setModuleReducers: reducers => moduleStoreReducer.set(store, reducers),\n        });\n\n        await contentLoaded();\n        renderApp(WrappedApp);\n        logger.success('rendered');\n      };\n\n      await render(App);\n\n      return render;\n    },\n  };\n};\n"]}