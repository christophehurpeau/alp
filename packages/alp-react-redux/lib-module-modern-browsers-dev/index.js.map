{"version":3,"sources":["../src/index.jsx"],"names":["renderToString","Helmet","Logger","isModernBrowser","createStore","combineReducers","htmlLayout","LayoutOptionsType","AlpReactApp","AlpReduxApp","alpReducers","ReactComponentType","ModuleDescriptorType","connect","createAction","createReducer","createLoader","classNames","createPureStatelessComponent","Error","logger","renderToStringApp","App","appProps","View","props","app","renderHtml","layoutOptions","content","helmet","renderStatic","alpReactRedux","layoutBody","appHOC","sharedReducers","AlpReactAppLayout","AlpReduxAppLayout","context","render","moduleDescriptor","data","_loaded","debug","loader","Object","create","then","moduleHasReducers","reducer","reducers","store","config","get","identifier","getState","unusedContext","initialData","ua","req","headers","name","body","version","moduleIdentifier","scriptName","styleName","initialBrowserContext","computeInitialContextForBrowser","undefined","loggerWebsocket","child","emitAction","to","action","emit"],"mappings":"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","file":"index.jsx","sourcesContent":["import { renderToString } from 'react-dom/server';\nimport Helmet from 'react-helmet';\nimport Logger from 'nightingale-logger/src';\nimport isModernBrowser from 'modern-browsers';\nimport { createStore, combineReducers } from 'redux/src';\nimport htmlLayout, { type LayoutOptionsType } from './layout/htmlLayout';\nimport AlpReactApp from './layout/AlpReactApp';\nimport AlpReduxApp from './layout/AlpReduxApp';\nimport * as alpReducers from './reducers';\nimport type { ReactComponentType, ModuleDescriptorType } from './types';\n\nexport { AlpReactApp, AlpReduxApp, Helmet };\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport { createAction, createReducer, createLoader, classNames, createPureStatelessComponent } from './utils';\n\nif (BROWSER) throw new Error('Not supposed to be loaded browser-side.');\n\nconst logger = new Logger('alp:react-redux');\n\nconst renderToStringApp = (App, appProps, View, props): string => {\n  const app = <App {...appProps}><View {...props} /></App>;\n  return renderToString(app);\n};\n\ntype AppOptionsType = {|\n  App: ReactComponentType,\n  appProps: Object,\n  View: ReactComponentType,\n  props: ?Object,\n  layoutOptions: ?LayoutOptionsType,\n|};\n\nconst renderHtml = ({ App, appProps, View, props, layoutOptions }: AppOptionsType) => {\n  const content = renderToStringApp(App, appProps, View, props);\n  const helmet = Helmet.renderStatic();\n  return `<!doctype html>\\n${htmlLayout(helmet, content, layoutOptions)}`;\n};\n\n\ntype OptionsType = {|\n  layoutBody: ?Function,\n  appHOC: ?Function,\n  sharedReducers: ?Object,\n|};\n\nexport default function alpReactRedux(\n  { layoutBody, appHOC, sharedReducers = {} }: OptionsType = {}\n) {\n  const AlpReactAppLayout = appHOC ? appHOC(AlpReactApp) : AlpReactApp;\n  const AlpReduxAppLayout = appHOC ? appHOC(AlpReduxApp) : AlpReduxApp;\n\n  return (app: Object) => {\n    app.context.render = function (moduleDescriptor: ModuleDescriptorType, data: ?Object, _loaded) {\n      logger.debug('render view', { data });\n\n      if (!_loaded && moduleDescriptor.loader) {\n        // const _state = data;\n        return moduleDescriptor.loader(Object.create(null), data).then(data => (\n          this.render(moduleDescriptor, data, true)\n        ));\n      }\n\n      const moduleHasReducers = !!(moduleDescriptor.reducer || moduleDescriptor.reducers);\n      const reducer = moduleDescriptor.reducer ? moduleDescriptor.reducer : (\n          combineReducers({ ...moduleDescriptor.reducers, ...alpReducers, ...sharedReducers })\n        );\n\n      if (reducer) {\n        this.store = createStore(reducer, { context: this, ...data });\n      }\n\n      const version: string = this.config.get('version');\n      const moduleIdentifier: ?string = moduleDescriptor && moduleDescriptor.identifier;\n\n      // eslint-disable-next-line no-unused-vars\n      const { context: unusedContext, ...initialData } =\n        moduleHasReducers ? this.store.getState() : {};\n\n      // TODO create alp-useragent with getter in context\n      const ua = this.req.headers['user-agent'];\n      const name = isModernBrowser(ua) ? 'modern-browsers' : 'es5';\n\n      this.body = renderHtml({\n        layoutOptions: {\n          layoutBody,\n          version,\n          moduleIdentifier,\n          scriptName: name,\n          styleName: name,\n          initialBrowserContext: this.computeInitialContextForBrowser(),\n          initialData: moduleHasReducers ? initialData : null,\n        },\n\n        App: reducer ? AlpReduxAppLayout : AlpReactAppLayout,\n        appProps: {\n          store: this.store,\n          context: this,\n        },\n\n        View: moduleDescriptor.View,\n        props: moduleHasReducers ? undefined : data,\n      });\n    };\n  };\n}\n\nconst loggerWebsocket = logger.child('websocket');\n\nexport function emitAction(to, action) {\n  loggerWebsocket.debug('emitAction', action);\n  to.emit('redux:action', action);\n}\n"]}