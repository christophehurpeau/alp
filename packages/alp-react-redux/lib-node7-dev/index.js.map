{"version":3,"sources":["../src/index.jsx"],"names":["combineReducers","connect","createAction","createReducer","createLoader","classNames","createPureStatelessComponent","alpReactRedux","emitAction","alpReducers","AlpReactApp","AlpReduxApp","Helmet","logger","renderToStringApp","App","appProps","View","props","app","renderHtml","layoutOptions","content","helmet","renderStatic","layoutBody","appHOC","sharedReducers","AlpReactAppLayout","AlpReduxAppLayout","context","render","moduleDescriptor","data","_loaded","debug","loader","Object","create","then","moduleHasReducers","reducer","reducers","store","config","get","identifier","getState","unusedContext","initialData","ua","req","headers","name","body","version","moduleIdentifier","scriptName","styleName","initialBrowserContext","computeInitialContextForBrowser","undefined","loggerWebsocket","child","to","action","emit"],"mappings":"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","file":"index.jsx","sourcesContent":["import { renderToString } from 'react-dom/server';\nimport Helmet from 'react-helmet';\nimport Logger from 'nightingale-logger/src';\nimport isModernBrowser from 'modern-browsers';\nimport { createStore, combineReducers } from 'redux/src';\nimport htmlLayout, { type LayoutOptionsType } from './layout/htmlLayout';\nimport AlpReactApp from './layout/AlpReactApp';\nimport AlpReduxApp from './layout/AlpReduxApp';\nimport * as alpReducers from './reducers';\nimport type { ReactComponentType, ModuleDescriptorType } from './types';\n\nexport { AlpReactApp, AlpReduxApp, Helmet };\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport { createAction, createReducer, createLoader, classNames, createPureStatelessComponent } from './utils';\n\nif (BROWSER) throw new Error('Not supposed to be loaded browser-side.');\n\nconst logger = new Logger('alp:react-redux');\n\nconst renderToStringApp = (App, appProps, View, props): string => {\n  const app = <App {...appProps}><View {...props} /></App>;\n  return renderToString(app);\n};\n\ntype AppOptionsType = {|\n  App: ReactComponentType,\n  appProps: Object,\n  View: ReactComponentType,\n  props: ?Object,\n  layoutOptions: ?LayoutOptionsType,\n|};\n\nconst renderHtml = ({ App, appProps, View, props, layoutOptions }: AppOptionsType) => {\n  const content = renderToStringApp(App, appProps, View, props);\n  const helmet = Helmet.renderStatic();\n  return `<!doctype html>\\n${htmlLayout(helmet, content, layoutOptions)}`;\n};\n\n\ntype OptionsType = {|\n  layoutBody: ?Function,\n  appHOC: ?Function,\n  sharedReducers: ?Object,\n|};\n\nexport default function alpReactRedux(\n  { layoutBody, appHOC, sharedReducers = {} }: OptionsType = {}\n) {\n  const AlpReactAppLayout = appHOC ? appHOC(AlpReactApp) : AlpReactApp;\n  const AlpReduxAppLayout = appHOC ? appHOC(AlpReduxApp) : AlpReduxApp;\n\n  return (app: Object) => {\n    app.context.render = function (moduleDescriptor: ModuleDescriptorType, data: ?Object, _loaded) {\n      logger.debug('render view', { data });\n\n      if (!_loaded && moduleDescriptor.loader) {\n        // const _state = data;\n        return moduleDescriptor.loader(Object.create(null), data).then(data => (\n          this.render(moduleDescriptor, data, true)\n        ));\n      }\n\n      const moduleHasReducers = !!(moduleDescriptor.reducer || moduleDescriptor.reducers);\n      const reducer = moduleDescriptor.reducer ? moduleDescriptor.reducer : (\n          combineReducers({ ...moduleDescriptor.reducers, ...alpReducers, ...sharedReducers })\n        );\n\n      if (reducer) {\n        this.store = createStore(reducer, { context: this, ...data });\n      }\n\n      const version: string = this.config.get('version');\n      const moduleIdentifier: ?string = moduleDescriptor && moduleDescriptor.identifier;\n\n      // eslint-disable-next-line no-unused-vars\n      const { context: unusedContext, ...initialData } =\n        moduleHasReducers ? this.store.getState() : {};\n\n      // TODO create alp-useragent with getter in context\n      const ua = this.req.headers['user-agent'];\n      const name = isModernBrowser(ua) ? 'modern-browsers' : 'es5';\n\n      this.body = renderHtml({\n        layoutOptions: {\n          layoutBody,\n          version,\n          moduleIdentifier,\n          scriptName: name,\n          styleName: name,\n          initialBrowserContext: this.computeInitialContextForBrowser(),\n          initialData: moduleHasReducers ? initialData : null,\n        },\n\n        App: reducer ? AlpReduxAppLayout : AlpReactAppLayout,\n        appProps: {\n          store: this.store,\n          context: this,\n        },\n\n        View: moduleDescriptor.View,\n        props: moduleHasReducers ? undefined : data,\n      });\n    };\n  };\n}\n\nconst loggerWebsocket = logger.child('websocket');\n\nexport function emitAction(to, action) {\n  loggerWebsocket.debug('emitAction', action);\n  to.emit('redux:action', action);\n}\n"]}