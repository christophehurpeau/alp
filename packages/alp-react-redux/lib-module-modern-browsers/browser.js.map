{"version":3,"sources":["../src/browser.js"],"names":["contentLoaded","React","render","Helmet","reactTreeWalker","Logger","createAlpAppWrapper","createBrowserStore","createBrowserModuleStoreReducer","createModuleVisitor","combineReducers","connect","createAction","createReducer","createLoader","classNames","createPureStatelessComponent","identityReducer","AlpModule","AlpReduxModule","Body","AppContainer","logger","renderApp","createElement","App","document","getElementById","preRender","ctx","appElement","moduleVisitor","PreRenderWrappedApp","context","store","getState","visitor","getReducers","app","reduxReducers","loading","state","action","meta","undefined","reduxMiddlewares","middlewares","sharedReducers","moduleStoreReducer","createStore","moduleReducers","reducer","window","createContext","setReducers","WrappedApp","setModuleReducers","set","reducers","success"],"mappings":"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","file":"browser.js","sourcesContent":["import BrowserAppContainer from 'alp-dev/BrowserAppContainer';\nimport contentLoaded from 'content-loaded';\nimport React from 'react';\nimport { render } from 'react-dom';\nimport Helmet from 'react-helmet';\nimport reactTreeWalker from 'react-tree-walker';\nimport Logger from 'nightingale-logger/src';\nimport createAlpAppWrapper from './createAlpAppWrapper';\nimport createBrowserStore from './store/createBrowserStore';\nimport createBrowserModuleStoreReducer from './store/createBrowserModuleStoreReducer';\nimport createModuleVisitor from './module/createModuleVisitor';\nimport type { ReduxActionType } from './types';\n\nexport { Helmet };\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport {\n  createAction,\n  createReducer,\n  createLoader,\n  classNames,\n  createPureStatelessComponent,\n  identityReducer,\n} from './utils/index';\nexport AlpModule from './module/AlpModule';\nexport AlpReduxModule from './module/AlpReduxModuleBrowser';\nexport Body from './layout/Body';\nexport AppContainer from './layout/AppContainer';\n\nconst logger = new Logger('alp:react-redux');\n\nconst renderApp = App => render(React.createElement(App), document.getElementById('react-app'));\n\nconst preRender = async (ctx, appElement) => {\n  const moduleVisitor = createModuleVisitor();\n  const preRenderStore = { getState: () => ({ ctx }) };\n  const PreRenderWrappedApp = createAlpAppWrapper(appElement, {\n    context: ctx,\n    store: preRenderStore,\n  });\n  await reactTreeWalker(React.createElement(PreRenderWrappedApp), moduleVisitor.visitor);\n\n  return moduleVisitor.getReducers();\n};\n\nexport default app => {\n  app.reduxReducers = {\n    loading: (state: ?number = 0, action: ReduxActionType) => {\n      if (action.meta && action.meta.loading !== undefined) {\n        return state + (action.meta.loading ? 1 : -1);\n      }\n      return state;\n    },\n  };\n  app.reduxMiddlewares = [];\n\n  return {\n    renderApp: async (App, { middlewares = [], sharedReducers } = {}) => {\n      let store;\n      let moduleStoreReducer;\n\n      const createStore = (ctx, moduleReducers) => {\n        moduleStoreReducer = createBrowserModuleStoreReducer(moduleReducers);\n        const store = createBrowserStore(app, ctx, moduleStoreReducer.reducer, {\n          middlewares,\n          sharedReducers,\n        });\n        app.store = store;\n        window.store = store;\n        return store;\n      };\n\n      const ctx = app.createContext();\n\n      const render = async App => {\n        let appElement = React.createElement(App);\n        if (!PRODUCTION) {\n          appElement = React.createElement(BrowserAppContainer, {}, appElement);\n        }\n\n        const moduleReducers = await preRender(ctx, appElement);\n\n        if (!PRODUCTION) {\n          store = createStore(ctx, moduleReducers);\n        } else {\n          // in DEV\n          // eslint-disable-next-line no-lonely-if\n          if (!store) {\n            store = createStore(ctx, moduleReducers);\n          } else {\n            moduleStoreReducer.setReducers(moduleReducers);\n          }\n        }\n\n        const WrappedApp = createAlpAppWrapper(appElement, {\n          context: ctx,\n          store,\n          setModuleReducers: reducers => moduleStoreReducer.set(store, reducers),\n        });\n\n        await contentLoaded();\n        renderApp(WrappedApp);\n        logger.success('rendered');\n      };\n\n      await render(App);\n\n      return render;\n    },\n  };\n};\n"]}