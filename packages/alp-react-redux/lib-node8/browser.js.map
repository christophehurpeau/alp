{"version":3,"sources":["../src/browser.js"],"names":["combineReducers","connect","createAction","createReducer","createLoader","classNames","createPureStatelessComponent","identityReducer","Helmet","AlpModule","AlpReduxModule","Body","AppContainer","logger","renderApp","App","createElement","document","getElementById","preRender","ctx","appElement","moduleVisitor","PreRenderWrappedApp","context","store","getState","visitor","getReducers","app","reduxReducers","loading","state","action","meta","undefined","reduxMiddlewares","middlewares","sharedReducers","moduleStoreReducer","createStore","moduleReducers","reducer","window","createContext","render","setReducers","WrappedApp","setModuleReducers","reducers","set","success"],"mappings":";;;;;;;;;;;;kBAeSA,e;;;;;;;;;uBACAC,O;;;;;;;;;kBAEPC,Y;;;;;;kBACAC,a;;;;;;kBACAC,Y;;;;;;kBACAC,U;;;;;;kBACAC,4B;;;;;;kBACAC,e;;;;AAvBF;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;AAGA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;;;;;;;;;;;;;AALA;QAQSC,M;QAWFC,S;QACAC,c;QACAC,I;QACAC,Y;;;AAEP,MAAMC,SAAS,gCAAW,iBAAX,CAAf;;AAEA,MAAMC,YAAYC,OAAO,uBAAQ,gBAAMC,aAAN,CAAoBD,GAApB,CAAR,EAAkCE,SAASC,cAAT,CAAwB,WAAxB,CAAlC,CAAzB;;AAEA,MAAMC,YAAY,OAAOC,GAAP,EAAYC,UAAZ,KAA2B;AAC3C,QAAMC,gBAAgB,oCAAtB;;AAEA,QAAMC,sBAAsB,mCAAoBF,UAApB,EAAgC;AAC1DG,aAASJ,GADiD;AAE1DK,WAHqB,EAAEC,UAAU,OAAO,EAAEN,GAAF,EAAP,CAAZ;AACqC,GAAhC,CAA5B;AAIA,QAAM,+BAAgB,gBAAMJ,aAAN,CAAoBO,mBAApB,CAAhB,EAA0DD,cAAcK,OAAxE,CAAN;;AAEA,SAAOL,cAAcM,WAAd,EAAP;AACD,CAVD;;kBAYeC,OAAO;AACpBA,MAAIC,aAAJ,GAAoB;AAClBC,aAAS,CAACC,QAAiB,CAAlB,EAAqBC,MAArB,KAAiD;AACxD,UAAIA,OAAOC,IAAP,IAAeD,OAAOC,IAAP,CAAYH,OAAZ,KAAwBI,SAA3C,EAAsD;AACpD,eAAOH,SAASC,OAAOC,IAAP,CAAYH,OAAZ,GAAsB,CAAtB,GAA0B,CAAC,CAApC,CAAP;AACD;AACD,aAAOC,KAAP;AACD;AANiB,GAApB;AAQAH,MAAIO,gBAAJ;;AAEA,SAAO;AACLtB,eAAW,OAAOC,GAAP,EAAY,EAAEsB,gBAAF,EAAoBC,cAApB,OAAZ,KAA0D;AACnE,UAAIb,KAAJ;AACA,UAAIc,kBAAJ;;AAEA,YAAMC,cAAc,CAACpB,GAAD,EAAMqB,cAAN,KAAyB;AAC3CF,6BAAqB,+CAAgCE,cAAhC,CAArB;AACA,cAAMhB,QAAQ,kCAAmBI,GAAnB,EAAwBT,GAAxB,EAA6BmB,mBAAmBG,OAAhD,EAAyD;AACrEL,qBADqE;AAErEC;AAFqE,SAAzD,CAAd;AAIAT,YAAIJ,KAAJ,GAAYA,KAAZ;AACAkB,eAAOlB,KAAP,GAAeA,KAAf;AACA,eAAOA,KAAP;AACD,OATD;;AAWA,YAAML,MAAMS,IAAIe,aAAJ,EAAZ;;AAEA,YAAMC,SAAS,MAAM9B,GAAN,IAAa;AAC1B,YAAIM,aAAa,gBAAML,aAAN,CAAoBD,GAApB,CAAjB;;;AAKA,cAAM0B,iBAAiB,MAAMtB,UAAUC,GAAV,EAAeC,UAAf,CAA7B;;AAKE;AACA;AACA,YAAI,CAACI,KAAL,EAAY;AACVA,kBAAQe,YAAYpB,GAAZ,EAAiBqB,cAAjB,CAAR;AACD,SAFD,MAEO;AACLF,6BAAmBO,WAAnB,CAA+BL,cAA/B;AACD;;;AAGH,cAAMM,aAAa,mCAAoB1B,UAApB,EAAgC;AACjDG,mBAASJ,GADwC;AAEjDK,eAFiD;AAGjDuB,6BAAmBC,YAAYV,mBAAmBW,GAAnB,CAAuBzB,KAAvB,EAA8BwB,QAA9B;AAHkB,SAAhC,CAAnB;;AAMA,cAAM,8BAAN;AACAnC,kBAAUiC,UAAV;AACAlC,eAAOsC,OAAP,CAAe,UAAf;AACD,OA7BD;;AA+BA,YAAMN,OAAO9B,GAAP,CAAN;;AAEA,aAAO8B,MAAP;AACD;AApDI,GAAP;AAsDD,C","file":"browser.js","sourcesContent":["import contentLoaded from 'content-loaded';\nimport React from 'react';\nimport { hydrate } from 'react-dom';\nimport Helmet from 'react-helmet';\nimport reactTreeWalker from 'react-tree-walker';\nimport Logger from 'nightingale-logger/src';\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport BrowserAppContainer from 'alp-dev/BrowserAppContainer';\nimport createAlpAppWrapper from './createAlpAppWrapper';\nimport createBrowserStore from './store/createBrowserStore';\nimport createBrowserModuleStoreReducer from './store/createBrowserModuleStoreReducer';\nimport createModuleVisitor from './module/createModuleVisitor';\nimport type { ReduxActionType } from './types';\n\nexport { Helmet };\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport {\n  createAction,\n  createReducer,\n  createLoader,\n  classNames,\n  createPureStatelessComponent,\n  identityReducer,\n} from './utils/index';\nexport AlpModule from './module/AlpModule';\nexport AlpReduxModule from './module/AlpReduxModuleBrowser';\nexport Body from './layout/Body';\nexport AppContainer from './layout/AppContainer';\n\nconst logger = new Logger('alp:react-redux');\n\nconst renderApp = App => hydrate(React.createElement(App), document.getElementById('react-app'));\n\nconst preRender = async (ctx, appElement) => {\n  const moduleVisitor = createModuleVisitor();\n  const preRenderStore = { getState: () => ({ ctx }) };\n  const PreRenderWrappedApp = createAlpAppWrapper(appElement, {\n    context: ctx,\n    store: preRenderStore,\n  });\n  await reactTreeWalker(React.createElement(PreRenderWrappedApp), moduleVisitor.visitor);\n\n  return moduleVisitor.getReducers();\n};\n\nexport default app => {\n  app.reduxReducers = {\n    loading: (state: ?number = 0, action: ReduxActionType) => {\n      if (action.meta && action.meta.loading !== undefined) {\n        return state + (action.meta.loading ? 1 : -1);\n      }\n      return state;\n    },\n  };\n  app.reduxMiddlewares = [];\n\n  return {\n    renderApp: async (App, { middlewares = [], sharedReducers } = {}) => {\n      let store;\n      let moduleStoreReducer;\n\n      const createStore = (ctx, moduleReducers) => {\n        moduleStoreReducer = createBrowserModuleStoreReducer(moduleReducers);\n        const store = createBrowserStore(app, ctx, moduleStoreReducer.reducer, {\n          middlewares,\n          sharedReducers,\n        });\n        app.store = store;\n        window.store = store;\n        return store;\n      };\n\n      const ctx = app.createContext();\n\n      const render = async App => {\n        let appElement = React.createElement(App);\n        if (!PRODUCTION) {\n          appElement = React.createElement(BrowserAppContainer, {}, appElement);\n        }\n\n        const moduleReducers = await preRender(ctx, appElement);\n\n        if (!PRODUCTION) {\n          store = createStore(ctx, moduleReducers);\n        } else {\n          // in DEV\n          // eslint-disable-next-line no-lonely-if\n          if (!store) {\n            store = createStore(ctx, moduleReducers);\n          } else {\n            moduleStoreReducer.setReducers(moduleReducers);\n          }\n        }\n\n        const WrappedApp = createAlpAppWrapper(appElement, {\n          context: ctx,\n          store,\n          setModuleReducers: reducers => moduleStoreReducer.set(store, reducers),\n        });\n\n        await contentLoaded();\n        renderApp(WrappedApp);\n        logger.success('rendered');\n      };\n\n      await render(App);\n\n      return render;\n    },\n  };\n};\n"]}