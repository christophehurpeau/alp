{"version":3,"sources":["../src/index.jsx"],"names":["renderToString","Helmet","Logger","isModernBrowser","createStore","combineReducers","htmlLayout","AlpReactApp","AlpReduxApp","alpReducers","connect","createAction","createReducer","createLoader","classNames","createPureStatelessComponent","Error","logger","renderToStringApp","App","appProps","View","props","app","renderHtml","layoutOptions","content","helmet","renderStatic","alpReactRedux","layoutBody","appHOC","sharedReducers","AlpReactAppLayout","AlpReduxAppLayout","context","render","moduleDescriptor","data","_loaded","debug","loader","Object","create","then","moduleHasReducers","reducer","reducers","store","version","config","get","moduleIdentifier","identifier","getState","unusedContext","initialData","ua","req","headers","name","body","scriptName","styleName","initialBrowserContext","computeInitialContextForBrowser","undefined","loggerWebsocket","child","emitAction","to","action","emit"],"mappings":"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","file":"index.jsx","sourcesContent":["import { renderToString } from 'react-dom/server';\nimport Helmet from 'react-helmet';\nimport Logger from 'nightingale-logger/src';\nimport isModernBrowser from 'modern-browsers';\nimport { createStore, combineReducers } from 'redux/src';\nimport htmlLayout, { type LayoutOptionsType } from './layout/htmlLayout';\nimport AlpReactApp from './layout/AlpReactApp';\nimport AlpReduxApp from './layout/AlpReduxApp';\nimport * as alpReducers from './reducers';\nimport type { ReactComponentType, ModuleDescriptorType } from './types';\n\nexport { AlpReactApp, AlpReduxApp, Helmet };\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport { createAction, createReducer, createLoader, classNames, createPureStatelessComponent } from './utils';\n\nif (BROWSER) throw new Error('Not supposed to be loaded browser-side.');\n\nconst logger = new Logger('alp:react-redux');\n\nconst renderToStringApp = (App, appProps, View, props): string => {\n  const app = <App {...appProps}><View {...props} /></App>;\n  return renderToString(app);\n};\n\ntype AppOptionsType = {|\n  App: ReactComponentType,\n  appProps: Object,\n  View: ReactComponentType,\n  props: ?Object,\n  layoutOptions: ?LayoutOptionsType,\n|};\n\nconst renderHtml = ({ App, appProps, View, props, layoutOptions }: AppOptionsType) => {\n  const content = renderToStringApp(App, appProps, View, props);\n  const helmet = Helmet.renderStatic();\n  return `<!doctype html>\\n${htmlLayout(helmet, content, layoutOptions)}`;\n};\n\n\ntype OptionsType = {|\n  layoutBody: ?Function,\n  appHOC: ?Function,\n  sharedReducers: ?Object,\n|};\n\nexport default function alpReactRedux(\n  { layoutBody, appHOC, sharedReducers = {} }: OptionsType = {}\n) {\n  const AlpReactAppLayout = appHOC ? appHOC(AlpReactApp) : AlpReactApp;\n  const AlpReduxAppLayout = appHOC ? appHOC(AlpReduxApp) : AlpReduxApp;\n\n  return (app: Object) => {\n    app.context.render = function (moduleDescriptor: ModuleDescriptorType, data: ?Object, _loaded) {\n      logger.debug('render view', { data });\n\n      if (!_loaded && moduleDescriptor.loader) {\n        // const _state = data;\n        return moduleDescriptor.loader(Object.create(null), data).then(data => (\n          this.render(moduleDescriptor, data, true)\n        ));\n      }\n\n      const moduleHasReducers = !!(moduleDescriptor.reducer || moduleDescriptor.reducers);\n      const reducer = moduleDescriptor.reducer ? moduleDescriptor.reducer : (\n          combineReducers({ ...moduleDescriptor.reducers, ...alpReducers, ...sharedReducers })\n        );\n\n      if (reducer) {\n        this.store = createStore(reducer, { context: this, ...data });\n      }\n\n      const version: string = this.config.get('version');\n      const moduleIdentifier: ?string = moduleDescriptor && moduleDescriptor.identifier;\n\n      // eslint-disable-next-line no-unused-vars\n      const { context: unusedContext, ...initialData } =\n        moduleHasReducers ? this.store.getState() : {};\n\n      // TODO create alp-useragent with getter in context\n      const ua = this.req.headers['user-agent'];\n      const name = isModernBrowser(ua) ? 'modern-browsers' : 'es5';\n\n      this.body = renderHtml({\n        layoutOptions: {\n          layoutBody,\n          version,\n          moduleIdentifier,\n          scriptName: name,\n          styleName: name,\n          initialBrowserContext: this.computeInitialContextForBrowser(),\n          initialData: moduleHasReducers ? initialData : null,\n        },\n\n        App: reducer ? AlpReduxAppLayout : AlpReactAppLayout,\n        appProps: {\n          store: this.store,\n          context: this,\n        },\n\n        View: moduleDescriptor.View,\n        props: moduleHasReducers ? undefined : data,\n      });\n    };\n  };\n}\n\nconst loggerWebsocket = logger.child('websocket');\n\nexport function emitAction(to, action) {\n  loggerWebsocket.debug('emitAction', action);\n  to.emit('redux:action', action);\n}\n"]}