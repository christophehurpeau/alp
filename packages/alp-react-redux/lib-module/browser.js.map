{"version":3,"sources":["../src/browser.js"],"names":["React","render","Helmet","reactTreeWalker","Logger","createAlpAppWrapper","createBrowserStore","createBrowserModuleStoreReducer","websocketMiddleware","createModuleVisitor","combineReducers","connect","createAction","createReducer","createLoader","classNames","createPureStatelessComponent","identityReducer","AlpModule","AlpReduxModule","Body","AppContainer","logger","renderApp","createElement","App","document","getElementById","app","sharedReducers","ctx","createContext","store","moduleStoreReducer","createStore","moduleReducers","reducer","middlewares","websocket","filter","Boolean","preRender","moduleVisitor","preRenderStore","getState","PreRenderWrappedApp","context","visitor","getReducers","setReducers","WrappedApp","setModuleReducers","set","reducers","success","loggerWebsocket","child","debug","on","action","dispatch"],"mappings":"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","file":"browser.js","sourcesContent":["import BrowserAppContainer from 'alp-dev/BrowserAppContainer';\nimport React from 'react';\nimport { render } from 'react-dom';\nimport Helmet from 'react-helmet';\nimport reactTreeWalker from 'react-tree-walker';\nimport Logger from 'nightingale-logger/src';\nimport createAlpAppWrapper from './createAlpAppWrapper';\nimport createBrowserStore from './store/createBrowserStore';\nimport createBrowserModuleStoreReducer from './store/createBrowserModuleStoreReducer';\nimport { websocketMiddleware } from './websocket';\nimport createModuleVisitor from './module/createModuleVisitor';\n\nexport { Helmet };\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport {\n  createAction,\n  createReducer,\n  createLoader,\n  classNames,\n  createPureStatelessComponent,\n  identityReducer,\n} from './utils/index';\nexport AlpModule from './module/AlpModule';\nexport AlpReduxModule from './module/AlpReduxModuleBrowser';\nexport Body from './layout/Body';\nexport AppContainer from './layout/AppContainer';\n\nconst logger = new Logger('alp:react-redux');\n\nconst renderApp = App => render(React.createElement(App), document.getElementById('react-app'));\n\nexport default async (app, App, { sharedReducers } = {}) => {\n  const ctx = app.createContext();\n  let store;\n  let moduleStoreReducer;\n\n  const createStore = (ctx, moduleReducers) => {\n    moduleStoreReducer = createBrowserModuleStoreReducer(moduleReducers);\n    const store = createBrowserStore(app, ctx, moduleStoreReducer.reducer, {\n      sharedReducers,\n      middlewares: [app.websocket && websocketMiddleware(app)].filter(Boolean),\n    });\n    app.store = store;\n    return store;\n  };\n\n  const preRender = async app => {\n    const moduleVisitor = createModuleVisitor();\n    const preRenderStore = { getState: () => ({ ctx }) };\n    const PreRenderWrappedApp = createAlpAppWrapper(app, {\n      context: ctx,\n      store: preRenderStore,\n    });\n    await reactTreeWalker(React.createElement(PreRenderWrappedApp), moduleVisitor.visitor);\n\n    return moduleVisitor.getReducers();\n  };\n\n  const render = async App => {\n    let app = React.createElement(App);\n    if (!PRODUCTION) {\n      app = React.createElement(BrowserAppContainer, {}, app);\n    }\n\n    const moduleReducers = await preRender(app);\n\n    if (!PRODUCTION) {\n      store = createStore(ctx, moduleReducers);\n    } else {\n      // in DEV\n      // eslint-disable-next-line no-lonely-if\n      if (!store) {\n        store = createStore(ctx, moduleReducers);\n      } else {\n        moduleStoreReducer.setReducers(moduleReducers);\n      }\n    }\n\n    const WrappedApp = createAlpAppWrapper(app, {\n      context: ctx,\n      store,\n      setModuleReducers: reducers => moduleStoreReducer.set(store, reducers),\n    });\n\n    renderApp(WrappedApp);\n    logger.success('rendered');\n  };\n\n  if (app.websocket) {\n    const loggerWebsocket = logger.child('websocket');\n    loggerWebsocket.debug('register websocket redux:action');\n    app.websocket.on('redux:action', action => {\n      loggerWebsocket.debug('dispatch action from websocket', action);\n      if (store) {\n        store.dispatch(action);\n      }\n    });\n  }\n\n  await render(App);\n\n  return render;\n};\n"]}