{"version":3,"sources":["../src/browser.js"],"names":["Helmet","combineReducers","connect","createEmitAction","createEmitPromiseAction","alpReactRedux","AlpReactApp","AlpReduxApp","createPureStatelessComponent","createAction","createReducer","createLoader","HYDRATE_STATE","logger","store","currentModuleDescriptorIdentifier","element","app","middlewares","websocket","loggerWebsocket","child","debug","on","action","dispatch","push","context","render","moduleDescriptor","data","_loaded","_loadingBar","View","Error","loader","currentState","identifier","getState","Object","create","then","reducer","type","state","undefined","window","devToolsExtension","f","assign","replaceReducer","App","appProps","props","err"],"mappings":"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","file":"browser.js","sourcesContent":["/* global window */\nimport render from 'fody/src';\nimport Logger from 'nightingale-logger/src';\nimport { createStore, applyMiddleware, compose } from 'redux/src';\nimport { promiseMiddleware, createFunctionMiddleware } from './middlewares-browser';\nimport { websocketMiddleware } from './websocket';\nimport loadingBar from './loading-bar';\nimport AlpReactApp from './AlpReactApp';\nimport AlpReduxApp from './AlpReduxApp';\n\nexport { AlpReactApp, AlpReduxApp };\nexport { Helmet } from 'fody/src';\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport createPureStatelessComponent from 'react-pure-stateless-component';\nexport createAction from './utils/createAction';\nexport createReducer from './utils/createReducer';\nexport createLoader from './utils/createLoader';\nexport { createEmitAction, createEmitPromiseAction } from './websocket';\n\nconst HYDRATE_STATE = 'HYDRATE_STATE';\nconst logger = new Logger('alp:react-redux');\n\nlet store;\nlet currentModuleDescriptorIdentifier;\n\n\nexport default function alpReactRedux(element) {\n  return (app) => {\n    const middlewares = [\n      createFunctionMiddleware(app),\n      promiseMiddleware,\n    ];\n\n    if (app.websocket) {\n      const loggerWebsocket = logger.child('websocket');\n      loggerWebsocket.debug('register websocket redux:action');\n      app.websocket.on('redux:action', action => {\n        loggerWebsocket.debug('dispatch action from websocket', action);\n        if (store) {\n          store.dispatch(action);\n        }\n      });\n      middlewares.push(websocketMiddleware(app));\n    }\n\n    app.context.render = function (moduleDescriptor, data, _loaded, _loadingBar) {\n      if (!_loadingBar) _loadingBar = loadingBar();\n      logger.debug('render view', { data });\n\n      try {\n        if (!PRODUCTION && !moduleDescriptor.View) {\n          throw new Error('View is undefined, class expected');\n        }\n\n        if (!_loaded && moduleDescriptor.loader) {\n          const currentState = store &&\n          currentModuleDescriptorIdentifier === moduleDescriptor.identifier ?\n            store.getState() : Object.create(null);\n\n          // const _state = data;\n          return moduleDescriptor.loader(currentState, data).then(data => (\n            this.render(moduleDescriptor, data, true, _loadingBar)\n          ));\n        }\n\n        let reducer = moduleDescriptor.reducer;\n\n        if (!reducer) {\n          if (store) {\n            reducer = () => {};\n            store.dispatch({ type: HYDRATE_STATE, state: Object.create(null) });\n          }\n        } else if (store === undefined) {\n          store = createStore(\n            (state, action) => {\n              if (action.type === HYDRATE_STATE) {\n                state = action.state;\n              }\n\n              return reducer(state, action);\n            },\n            data,\n            compose(\n              applyMiddleware(...middlewares),\n              window.devToolsExtension ? window.devToolsExtension() : f => f,\n            ),\n          );\n        } else {\n          const state = Object.create(null);\n\n          if (store && currentModuleDescriptorIdentifier === moduleDescriptor.identifier) {\n            // keep state\n            Object.assign(state, store.getState());\n          } else {\n            // replace reducer\n            store.replaceReducer(reducer);\n          }\n\n          Object.assign(state, data);\n          store.dispatch({ type: HYDRATE_STATE, state });\n        }\n\n        currentModuleDescriptorIdentifier = moduleDescriptor.identifier;\n        this.store = store;\n\n        render({\n          App: reducer ? AlpReduxApp : AlpReactApp,\n          appProps: {\n            store,\n            context: this,\n            moduleDescriptor,\n          },\n          View: moduleDescriptor.View,\n          props: data,\n          element,\n        });\n      } catch (err) {\n        _loadingBar();\n        throw err;\n      }\n\n      _loadingBar();\n    };\n  };\n}\n"]}