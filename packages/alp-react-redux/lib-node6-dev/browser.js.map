{"version":3,"sources":["../src/browser.js"],"names":[],"mappings":"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","file":"browser.js","sourcesContent":["/* global window, PRODUCTION */\nimport render, { App as DefaultApp } from 'fody';\nimport ReduxApp from 'fody-redux-app';\nimport Logger from 'nightingale-logger';\nimport { createStore, applyMiddleware, compose } from 'redux';\nimport { promiseMiddleware, createFunctionMiddleware } from './middlewares';\nimport { websocketMiddleware } from './websocket';\nimport loadingBar from './loading-bar';\n\nexport { combineReducers } from 'redux';\nexport { connect } from 'react-redux';\nexport createPureStatelessComponent from 'react-pure-stateless-component';\nexport createAction from './createAction';\nexport createReducer from './createReducer';\nexport createLoader from './createLoader';\nexport { createEmitAction, createEmitPromiseAction } from './websocket';\n\nconst HYDRATE_STATE = 'HYDRATE_STATE';\nconst logger = new Logger('alp.react-redux');\n\nlet store;\nlet currentModuleDescriptorIdentifier;\n\nexport default function alpReactRedux(element) {\n  return (app) => {\n    const middlewares = [\n      createFunctionMiddleware(app),\n      promiseMiddleware,\n    ];\n    if (app.websocket) {\n      logger.debug('register websocket redux:action');\n      app.websocket.on('redux:action', action => {\n        logger.info('dispatch action from websocket', action);\n        if (store) {\n          store.dispatch(action);\n        }\n      });\n      middlewares.push(websocketMiddleware(app));\n    }\n\n    app.context.render = function (moduleDescriptor, data, _loaded, _loadingBar) {\n      if (!_loadingBar) _loadingBar = loadingBar();\n      logger.debug('render view', { data });\n\n      if (!PRODUCTION && !moduleDescriptor.View) {\n        throw new Error('View is undefined, class expected');\n      }\n\n      if (!_loaded && moduleDescriptor.loader) {\n        const currentState = store &&\n        currentModuleDescriptorIdentifier === moduleDescriptor.identifier ?\n          store.getState() : undefined;\n\n        // const _state = data;\n        return moduleDescriptor.loader(currentState, data).then(data => (\n          this.render(moduleDescriptor, data, true, _loadingBar)\n        ));\n      }\n\n      let reducer = moduleDescriptor.reducer;\n\n      if (!reducer) {\n        if (store) {\n          reducer = () => {};\n          store.dispatch({ type: HYDRATE_STATE, state: Object.create(null) });\n        }\n      } else if (store === undefined) {\n        store = createStore(\n          (state, action) => {\n            if (action.type === HYDRATE_STATE) {\n              state = action.state;\n            }\n\n            return reducer(state, action);\n          },\n          data,\n          compose(\n            applyMiddleware(...middlewares),\n            window.devToolsExtension ? window.devToolsExtension() : f => f,\n          ),\n        );\n      } else {\n        const state = Object.create(null);\n\n        if (store && currentModuleDescriptorIdentifier === moduleDescriptor.identifier) {\n          // keep state\n          Object.assign(state, store.getState());\n        }\n\n        Object.assign(state, data);\n        store.dispatch({ type: HYDRATE_STATE, state });\n      }\n\n      currentModuleDescriptorIdentifier = moduleDescriptor.identifier;\n      this.store = store;\n\n      render({\n        context: this,\n        View: moduleDescriptor.View,\n        data: data,\n        element,\n        App: reducer ? ReduxApp : DefaultApp,\n      });\n\n      _loadingBar();\n    };\n  };\n}\n"]}