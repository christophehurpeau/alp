{"version":3,"sources":["../src/browser.js"],"names":["Helmet","combineReducers","connect","createEmitAction","createEmitPromiseAction","alpReactRedux","alpReducers","AlpReactApp","AlpReduxApp","createPureStatelessComponent","createAction","createReducer","createLoader","HYDRATE_STATE","logger","store","currentModuleDescriptorIdentifier","createHydratableReducer","reducer","state","action","type","OptionsType","sharedReducers","element","app","middleware","websocket","loggerWebsocket","child","debug","on","dispatch","push","context","render","moduleDescriptor","data","_loaded","_loadingBar","View","Error","loader","currentState","identifier","getState","Object","create","then","moduleHasReducers","reducers","undefined","composeEnhancers","window","__REDUX_DEVTOOLS_EXTENSION_COMPOSE__","assign","isSameModule","replaceReducer","App","appProps","props","err"],"mappings":"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","file":"browser.js","sourcesContent":["/* global window */\nimport render, { unmountComponentAtNode } from 'fody/src';\nimport Logger from 'nightingale-logger/src';\nimport { createStore, applyMiddleware, compose, combineReducers } from 'redux/src';\nimport { promiseMiddleware, createFunctionMiddleware } from './middleware-browser';\nimport { websocketMiddleware } from './websocket';\nimport loadingBar from './loading-bar';\nimport AlpReactApp from './AlpReactApp';\nimport AlpReduxApp from './AlpReduxApp';\nimport * as alpReducers from './reducers';\n\nexport { AlpReactApp, AlpReduxApp };\nexport { Helmet } from 'fody/src';\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport createPureStatelessComponent from 'react-pure-stateless-component';\nexport createAction from './utils/createAction';\nexport createReducer from './utils/createReducer';\nexport createLoader from './utils/createLoader';\nexport { createEmitAction, createEmitPromiseAction } from './websocket';\n\nconst HYDRATE_STATE = 'HYDRATE_STATE';\nconst logger = new Logger('alp:react-redux');\n\nlet store;\nlet currentModuleDescriptorIdentifier;\n\nconst createHydratableReducer = (reducer: Function) => (\n  (state, action) => {\n    // ignore redux init\n    if (action.type === '@@redux/INIT') {\n      return;\n    }\n\n    if (action.type === HYDRATE_STATE) {\n      state = action.state;\n    }\n\n    return reducer(state, action);\n  }\n);\n\ntype OptionsType = {|\n  sharedReducers: ?Object,\n|}\n\nexport default function alpReactRedux(element, { sharedReducers = {} }: OptionsType = {}) {\n  return (app) => {\n    const middleware = [\n      createFunctionMiddleware(app),\n      promiseMiddleware,\n    ];\n\n    if (app.websocket) {\n      const loggerWebsocket = logger.child('websocket');\n      loggerWebsocket.debug('register websocket redux:action');\n      app.websocket.on('redux:action', action => {\n        loggerWebsocket.debug('dispatch action from websocket', action);\n        if (store) {\n          store.dispatch(action);\n        }\n      });\n      middleware.push(websocketMiddleware(app));\n    }\n\n    app.context.render = function (moduleDescriptor, data, _loaded, _loadingBar) {\n      if (!_loadingBar) _loadingBar = loadingBar();\n      logger.debug('render view', { data });\n\n      try {\n        if (!PRODUCTION && !moduleDescriptor.View) {\n          throw new Error('View is undefined, class expected');\n        }\n\n        if (!_loaded && moduleDescriptor.loader) {\n          const currentState = store &&\n          currentModuleDescriptorIdentifier === moduleDescriptor.identifier ?\n            store.getState() : Object.create(null);\n\n          // const _state = data;\n          return moduleDescriptor.loader(currentState, data).then(data => (\n            this.render(moduleDescriptor, data, true, _loadingBar)\n          ));\n        }\n\n        const moduleHasReducers = !!(moduleDescriptor.reducer || moduleDescriptor.reducers);\n        let reducer = moduleDescriptor.reducer ?\n          moduleDescriptor.reducer : (\n            combineReducers({ ...moduleDescriptor.reducers, ...alpReducers, ...sharedReducers })\n          );\n\n        if (!reducer) {\n          if (store) {\n            reducer = () => {};\n            store.dispatch({ type: HYDRATE_STATE, state: Object.create(null) });\n          }\n        } else if (store === undefined) {\n          const composeEnhancers = window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || compose;\n          store = createStore(\n            createHydratableReducer(reducer),\n            Object.assign(Object.create(null), { context: this }, data),\n            composeEnhancers(applyMiddleware(...middleware)),\n          );\n        } else {\n          const state = Object.create(null);\n          const isSameModule = currentModuleDescriptorIdentifier === moduleDescriptor.identifier;\n\n          if (store) {\n            if (isSameModule) {\n              // keep state\n              Object.assign(state, store.getState());\n            } else {\n              // destroy current component\n              unmountComponentAtNode(element);\n              // replace reducer\n              store.replaceReducer(createHydratableReducer(reducer));\n              // add initial context\n              state.context = this;\n            }\n          }\n\n          if (moduleHasReducers) Object.assign(state, data);\n          store.dispatch({ type: HYDRATE_STATE, state });\n        }\n\n        currentModuleDescriptorIdentifier = moduleDescriptor.identifier;\n\n        if (reducer) {\n          this.store = store;\n        }\n\n        render({\n          App: reducer ? AlpReduxApp : AlpReactApp,\n          appProps: {\n            store,\n            context: this,\n            moduleDescriptor,\n          },\n          View: moduleDescriptor.View,\n          props: moduleHasReducers ? undefined : data,\n          element,\n        });\n      } catch (err) {\n        _loadingBar();\n        throw err;\n      }\n\n      _loadingBar();\n    };\n  };\n}\n"]}