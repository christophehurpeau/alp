{"version":3,"sources":["../src/index.js"],"names":["combineReducers","connect","createAction","createReducer","createLoader","classNames","createPureStatelessComponent","identityReducer","emitAction","Helmet","AlpModule","AlpReduxModule","Body","AppContainer","logger","renderHtml","app","options","content","helmet","renderStatic","isModernBrowser","reduxReducers","reduxMiddlewares","middleware","ctx","next","reduxInitialContext","createApp","App","config","get","ua","req","headers","name","createElement","moduleVisitor","PreRenderWrappedApp","context","store","getState","visitor","getReducers","sharedReducers","WrappedApp","removeCtxFromInitialData","initialData","body","version","scriptName","undefined","styleName","polyfillFeatures","loggerWebsocket","child","to","action","debug","emit"],"mappings":"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","file":"index.js","sourcesContent":["import React from 'react';\nimport { renderToString } from 'react-dom/server';\nimport Helmet from 'react-helmet';\nimport reactTreeWalker from 'react-tree-walker';\nimport Logger from 'nightingale-logger/src';\nimport createIsModernBrowser from 'modern-browsers';\nimport htmlLayout from './layout/htmlLayout';\nimport createAlpAppWrapper from './createAlpAppWrapper';\nimport createServerStore from './store/createServerStore';\nimport createModuleVisitor from './module/createModuleVisitor';\n\nexport { Helmet };\nexport { combineReducers } from 'redux/src';\nexport { connect } from 'react-redux/src';\nexport {\n  createAction,\n  createReducer,\n  createLoader,\n  classNames,\n  createPureStatelessComponent,\n  identityReducer,\n} from './utils/index';\nexport AlpModule from './module/AlpModule';\nexport AlpReduxModule from './module/AlpReduxModuleServer';\nexport Body from './layout/Body';\nexport AppContainer from './layout/AppContainer';\n\nconst logger = new Logger('alp:react-redux');\n\nconst renderHtml = (app, options) => {\n  const content = renderToString(app);\n  const helmet = Helmet.renderStatic();\n  return htmlLayout(helmet, content, options);\n};\n\nconst isModernBrowser = createIsModernBrowser();\n\ntype OptionsType = {|\n  sharedReducers?: ?{ [string]: any },\n  scriptName?: ?string | false,\n  styleName?: ?string | false,\n  polyfillFeatures?: ?string,\n|};\n\nexport default () => app => {\n  app.reduxReducers = {};\n  app.reduxMiddlewares = [];\n\n  return {\n    middleware: (ctx, next) => {\n      ctx.reduxInitialContext = {};\n      return next();\n    },\n\n    createApp: (App, options: ?OptionsType = {}) => async ctx => {\n      const version: string = ctx.config.get('version');\n      // TODO create alp-useragent with getter in context\n      const ua = ctx.req.headers['user-agent'];\n      const name = isModernBrowser(ua) ? 'modern-browsers' : 'es5';\n\n      const app = React.createElement(App);\n      const moduleVisitor = createModuleVisitor();\n      const preRenderStore = { getState: () => ({ ctx }) };\n      const PreRenderWrappedApp = createAlpAppWrapper(app, { context: ctx, store: preRenderStore });\n      await reactTreeWalker(React.createElement(PreRenderWrappedApp), moduleVisitor.visitor);\n\n      const store = createServerStore(ctx, moduleVisitor.getReducers(), {\n        sharedReducers: options.sharedReducers,\n      });\n\n      const WrappedApp = createAlpAppWrapper(app, { context: ctx, store });\n\n      // eslint-disable-next-line no-unused-vars\n      const { ctx: removeCtxFromInitialData, ...initialData } = store.getState();\n      ctx.body = await renderHtml(React.createElement(WrappedApp), {\n        version,\n        scriptName: options.scriptName !== undefined ? options.scriptName : name,\n        styleName: options.styleName !== undefined ? options.styleName : name,\n        polyfillFeatures: options.polyfillFeatures,\n        initialData,\n      });\n    },\n  };\n};\n\nconst loggerWebsocket = logger.child('websocket');\n\nexport function emitAction(to, action) {\n  loggerWebsocket.debug('emitAction', action);\n  to.emit('redux:action', action);\n}\n"]}