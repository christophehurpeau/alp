{"version":3,"file":"index-node14.mjs","sources":["../src/readRecursiveDirectory.ts","../src/Manager.ts","../src/index.ts"],"sourcesContent":["import type { Stats } from 'fs';\nimport { readdir, stat as fsStat } from 'fs/promises';\n\nexport interface CallbackParam {\n  filename: string;\n  basedir: string;\n  path: string;\n  stat: Stats;\n}\n\nexport default async function readRecursiveDirectory(\n  directory: string,\n  callback: (param: CallbackParam) => void | Promise<void>,\n): Promise<void> {\n  const files = await readdir(directory);\n\n  await Promise.all(\n    files.map(async (file): Promise<void> => {\n      const path = `${directory}/${file}`;\n      const stat = await fsStat(path);\n\n      if (stat?.isDirectory()) {\n        await readRecursiveDirectory(path, callback);\n        return;\n      }\n      await callback({\n        filename: file,\n        basedir: directory,\n        path,\n        stat,\n      });\n    }),\n  );\n}\n","import type { MongoStore, MongoInsertType, MongoBaseModel } from 'liwi-mongo';\n\nexport interface Migration extends MongoBaseModel {\n  version: string;\n  fileName: string;\n}\n\nexport default class MigrationsManager {\n  store: MongoStore<Migration>;\n\n  constructor(store: MongoStore<Migration>) {\n    this.store = store;\n  }\n\n  findLastVersion(): Promise<string | undefined> {\n    return this.store.findOne({}, { created: -1 }).then((row) => row?.version);\n  }\n\n  addMigrationDone(migration: MongoInsertType<Migration>): Promise<Migration> {\n    return this.store.insertOne(migration);\n  }\n}\n","/* eslint-disable unicorn/no-process-exit */\nimport type { NodeApplication, NodeConfig } from 'alp-types';\nimport { Logger } from 'nightingale-logger';\nimport semver from 'semver';\nimport type MigrationsManager from './Manager';\nimport type { CallbackParam } from './readRecursiveDirectory';\nimport readRecursiveDirectory from './readRecursiveDirectory';\n\nconst logger = new Logger('alp:migrations');\n\nexport { default as MigrationsManager } from './Manager';\n\nexport interface Options {\n  app: NodeApplication;\n  migrationsManager: MigrationsManager;\n  config?: NodeConfig;\n  dirname?: string;\n}\n\nexport default async function migrate({\n  app,\n  migrationsManager,\n  config = app.config,\n  dirname = `${app.dirname}/migrations`,\n}: Options): Promise<void> {\n  const unhandledRejectionHandler = (reason: unknown): void => {\n    logger.error('unhandledRejection', { err: reason });\n    process.exit(1);\n  };\n  process.on('unhandledRejection', unhandledRejectionHandler);\n\n  const packageVersion = config.packageConfig.version as string;\n  const currentVersion = await migrationsManager.findLastVersion();\n\n  let migrations: { version: string; fileName: string }[] = [];\n\n  logger.info('migrate', { packageVersion, currentVersion });\n\n  await readRecursiveDirectory(dirname, (res: CallbackParam) => {\n    const fileName = res.path.slice(dirname.length + 1);\n\n    if (!fileName.endsWith('.js')) {\n      return;\n    }\n\n    const versionExecResult = /([\\d.]+)(_.*|\\.js)$/.exec(fileName);\n\n    if (!versionExecResult || !versionExecResult[1]) {\n      return;\n    }\n\n    const version: string = versionExecResult[1];\n\n    if (currentVersion && semver.lte(version, currentVersion)) return;\n\n    migrations.push({ version, fileName });\n  });\n\n  migrations = migrations.sort((a, b) =>\n    semver.gt(a.version, b.version) ? 1 : -1,\n  );\n\n  try {\n    for (const migration of migrations) {\n      logger.info(`Migration to ${migration.fileName}`);\n      try {\n        const migrateFn: unknown = await import(\n          `${dirname}/${migration.fileName}`\n        );\n        await (migrateFn as () => Promise<void>)();\n      } catch (err) {\n        logger.error(`Migration to ${migration.version} Failed !`);\n        throw err;\n      }\n\n      logger.success(`Migration to ${migration.fileName} done !`);\n\n      // only add to db if migration version <= package version\n      if (semver.lte(migration.version, packageVersion)) {\n        await migrationsManager.addMigrationDone(migration);\n      }\n    }\n  } catch (err: any) {\n    logger.error(err as Error);\n    process.exit(1);\n  }\n\n  process.removeListener('unhandledRejection', unhandledRejectionHandler);\n}\n"],"names":["readRecursiveDirectory","directory","callback","files","readdir","Promise","all","map","file","path","stat","fsStat","isDirectory","filename","basedir","MigrationsManager","constructor","store","findLastVersion","findOne","created","then","row","version","addMigrationDone","migration","insertOne","logger","Logger","migrate","app","migrationsManager","config","dirname","unhandledRejectionHandler","reason","error","err","process","exit","on","packageVersion","packageConfig","currentVersion","migrations","info","res","fileName","slice","length","endsWith","versionExecResult","exec","semver","lte","push","sort","a","b","gt","migrateFn","success","removeListener"],"mappings":"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"}