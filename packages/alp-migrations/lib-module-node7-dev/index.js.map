{"version":3,"sources":["../src/index.js"],"names":["semver","Logger","readRecursiveDirectory","logger","MigrationsManager","migrate","app","config","dirname","migrationsManager","unhandledRejectionHandler","err","error","process","exit","on","packageVersion","packageConfig","version","currentVersion","findLastVersion","migrations","info","res","fileName","path","substr","length","slice","exec","lte","push","sort","a","b","gt","migration","require","default","success","addMigrationDone","removeListener"],"mappings":"AAAA,OAAOA,MAAP,MAAmB,QAAnB;AACA,OAAOC,MAAP;AACA,OAAOC,sBAAP,MAAmC,0BAAnC;;AAEA,MAAMC,SAAS,IAAIF,MAAJ,CAAW,gBAAX,CAAf;;+BAE8B,W;+BAAvBG,iB;;;AAEP,gBAAe,eAAeC,OAAf,CAAuB,EAAEC,GAAF,EAAOC,MAAP,EAAeC,OAAf,EAAwBC,iBAAxB,EAAvB,EAAoE;AACjF,MAAI,CAACF,MAAL,EAAaA,SAASD,IAAIC,MAAb;AACb,MAAI,CAACC,OAAL,EAAcA,UAAW,GAAEF,IAAIE,OAAQ,aAAzB;;AAEd,QAAME,4BAA6BC,GAAD,IAAS;AACzCR,WAAOS,KAAP,CAAa,oBAAb,EAAmC,EAAED,GAAF,EAAnC;AACAE,YAAQC,IAAR,CAAa,CAAb;AACD,GAHD;AAIAD,UAAQE,EAAR,CAAW,oBAAX,EAAiCL,yBAAjC;;AAEA,QAAMM,iBAAiBT,OAAOU,aAAP,CAAqBC,OAA5C;AACA,MAAIC,iBAAiB,MAAMV,kBAAkBW,eAAlB,EAA3B;AACA,MAAIC,eAAJ;;AAEAlB,SAAOmB,IAAP,CAAY,SAAZ,EAAuB,EAAEN,cAAF,EAAkBG,cAAlB,EAAvB;;AAEA,QAAMjB,uBAAuBM,OAAvB,EAAiCe,GAAD,IAAS;AAC7C,QAAIC,WAAWD,IAAIE,IAAJ,CAASC,MAAT,CAAgBlB,QAAQmB,MAAR,GAAiB,CAAjC,CAAf;;AAEA,QAAIH,SAASI,KAAT,CAAe,CAAC,CAAhB,MAAuB,KAA3B,EAAkC;AAChC;AACD;;AAED,QAAIV,UAAU,sBAAsBW,IAAtB,CAA2BL,QAA3B,CAAd;;AAEA,QAAI,CAACN,OAAD,IAAY,CAACA,QAAQ,CAAR,CAAjB,EAA6B;AAC3B;AACD;;AAEDA,cAAUA,QAAQ,CAAR,CAAV;;AAEA,QAAIC,kBAAkBnB,OAAO8B,GAAP,CAAWZ,OAAX,EAAoBC,cAApB,CAAtB,EAA2D;;AAE3DE,eAAWU,IAAX,CAAgB,EAAEb,OAAF,EAAWM,QAAX,EAAhB;AACD,GAlBK,CAAN;;AAoBAH,eAAaA,WAAWW,IAAX,CAAgB,CAACC,CAAD,EAAIC,CAAJ,KAAUlC,OAAOmC,EAAP,CAAUF,EAAEf,OAAZ,EAAqBgB,EAAEhB,OAAvB,CAA1B,CAAb;;AAEA,MAAI;AACF;AACA,SAAK,IAAIkB,SAAT,IAAsBf,UAAtB,EAAkC;AAChClB,aAAOmB,IAAP,CAAa,gBAAec,UAAUZ,QAAS,EAA/C;AACA,UAAI;AACF;AACA,cAAMa,QAAS,GAAE7B,OAAQ,IAAG4B,UAAUZ,QAAS,EAAzC,EAA4Cc,OAA5C,EAAN;AACD,OAHD,CAGE,OAAO3B,GAAP,EAAY;AACZR,eAAOS,KAAP,CAAc,gBAAewB,UAAUlB,OAAQ,WAA/C;AACA,cAAMP,GAAN;AACD;;AAEDR,aAAOoC,OAAP,CAAgB,gBAAeH,UAAUZ,QAAS,SAAlD;;AAEA;AACA,UAAIxB,OAAO8B,GAAP,CAAWM,UAAUlB,OAArB,EAA8BF,cAA9B,CAAJ,EAAmD;AACjD;AACA,cAAMP,kBAAkB+B,gBAAlB,CAAmCJ,SAAnC,CAAN;AACD;AACF;AACF,GApBD,CAoBE,OAAOzB,GAAP,EAAY;AACZR,WAAOS,KAAP,CAAaD,GAAb;AACAE,YAAQC,IAAR,CAAa,CAAb;AACD;;AAEDD,UAAQ4B,cAAR,CAAuB,oBAAvB,EAA6C/B,yBAA7C;AACD,CAhED","file":"index.js","sourcesContent":["import semver from 'semver';\nimport Logger from 'nightingale-logger/src';\nimport readRecursiveDirectory from './readRecursiveDirectory';\n\nconst logger = new Logger('alp:migrations');\n\nexport MigrationsManager from './Manager';\n\nexport default async function migrate({ app, config, dirname, migrationsManager }) {\n  if (!config) config = app.config;\n  if (!dirname) dirname = `${app.dirname}/migrations`;\n\n  const unhandledRejectionHandler = (err) => {\n    logger.error('unhandledRejection', { err });\n    process.exit(1);\n  };\n  process.on('unhandledRejection', unhandledRejectionHandler);\n\n  const packageVersion = config.packageConfig.version;\n  let currentVersion = await migrationsManager.findLastVersion();\n  let migrations = [];\n\n  logger.info('migrate', { packageVersion, currentVersion });\n\n  await readRecursiveDirectory(dirname, (res) => {\n    let fileName = res.path.substr(dirname.length + 1);\n\n    if (fileName.slice(-3) !== '.js') {\n      return;\n    }\n\n    let version = /([\\d.]+)(_.*|\\.js)$/.exec(fileName);\n\n    if (!version || !version[1]) {\n      return;\n    }\n\n    version = version[1];\n\n    if (currentVersion && semver.lte(version, currentVersion)) return;\n\n    migrations.push({ version, fileName });\n  });\n\n  migrations = migrations.sort((a, b) => semver.gt(a.version, b.version));\n\n  try {\n    // eslint-disable-next-line no-restricted-syntax\n    for (let migration of migrations) {\n      logger.info(`Migration to ${migration.fileName}`);\n      try {\n        // eslint-disable-next-line global-require, import/no-dynamic-require, no-await-in-loop\n        await require(`${dirname}/${migration.fileName}`).default();\n      } catch (err) {\n        logger.error(`Migration to ${migration.version} Failed !`);\n        throw err;\n      }\n\n      logger.success(`Migration to ${migration.fileName} done !`);\n\n      // only add to db if migration version <= package version\n      if (semver.lte(migration.version, packageVersion)) {\n        // eslint-disable-next-line no-await-in-loop\n        await migrationsManager.addMigrationDone(migration);\n      }\n    }\n  } catch (err) {\n    logger.error(err);\n    process.exit(1);\n  }\n\n  process.removeListener('unhandledRejection', unhandledRejectionHandler);\n}\n"]}