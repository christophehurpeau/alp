{"version":3,"sources":["../src/index.js"],"names":["logger","MigrationsManager","config","dirname","migrationsManager","unhandledRejectionHandler","err","error","process","exit","on","packageVersion","packageConfig","version","currentVersion","findLastVersion","migrations","info","res","fileName","path","substr","length","slice","exec","lte","gt","push","sort","a","b","migration","require","default","success","addMigrationDone","removeListener","migrate"],"mappings":";;;;;;;AAAA;;;;AACA;;;;AACA;;;;;;;;;;;;AAEA,MAAMA,SAAS,gCAAW,gBAAX,CAAf;;QAEOC,iB;;;+BAEQ,kBAA+D;AAAA,QAAtCC,MAAsC,SAAtCA,MAAsC;AAAA,QAA9BC,OAA8B,SAA9BA,OAA8B;AAAA,QAArBC,iBAAqB,SAArBA,iBAAqB;;AAC5E,UAAMC,4BAA4B,SAA5BA,yBAA4B,CAACC,GAAD,EAAS;AACzCN,aAAOO,KAAP,CAAa,oBAAb,EAAmC,EAAED,GAAF,EAAnC;AACAE,cAAQC,IAAR,CAAa,CAAb;AACD,KAHD;AAIAD,YAAQE,EAAR,CAAW,oBAAX,EAAiCL,yBAAjC;;AAEA,UAAMM,iBAAiBT,OAAOU,aAAP,CAAqBC,OAA5C;AACA,QAAIC,iBAAiB,MAAMV,kBAAkBW,eAAlB,EAA3B;AACA,QAAIC,aAAa,EAAjB;;AAEAhB,WAAOiB,IAAP,CAAY,SAAZ,EAAuB,EAAEN,cAAF,EAAkBG,cAAlB,EAAvB;;AAEA,UAAM,sCAAuBX,OAAvB,EAAgC,UAACe,GAAD,EAAS;AAC7C,UAAIC,WAAWD,IAAIE,IAAJ,CAASC,MAAT,CAAgBlB,QAAQmB,MAAR,GAAiB,CAAjC,CAAf;;AAEA,UAAIH,SAASI,KAAT,SAAuB,KAA3B,EAAkC;AAChC;AACD;;AAED,UAAIV,UAAU,uBAAuBW,IAAvB,CAA4BL,QAA5B,CAAd;;AAEA,UAAI,CAACN,OAAD,IAAY,CAACA,QAAQ,CAAR,CAAjB,EAA6B;AAC3B;AACD;;AAEDA,gBAAUA,QAAQ,CAAR,CAAV;;AAEA,UAAIC,kBAAkB,iBAAOW,GAAP,CAAWZ,OAAX,EAAoBC,cAApB,CAAtB,EAA2D;AAC3D,UAAI,iBAAOY,EAAP,CAAUb,OAAV,EAAmBF,cAAnB,CAAJ,EAAwC;;AAExCK,iBAAWW,IAAX,CAAgB,EAAEd,SAASA,OAAX,EAAoBM,UAAUA,QAA9B,EAAhB;AACD,KAnBK,CAAN;;AAqBAH,iBAAaA,WAAWY,IAAX,CAAgB,UAACC,CAAD,EAAIC,CAAJ;AAAA,aAAU,iBAAOJ,EAAP,CAAUG,EAAEhB,OAAZ,EAAqBiB,EAAEjB,OAAvB,CAAV;AAAA,KAAhB,CAAb;;AAEA,QAAI;AACF,WAAK,IAAIkB,SAAT,IAAsBf,UAAtB,EAAkC;AAChChB,eAAOiB,IAAP,CAAa,iBAAec,UAAUZ,QAAS,GAA/C;AACA,YAAI;AACF;AACA,gBAAMa,QAAS,IAAE7B,OAAQ,MAAG4B,UAAUZ,QAAS,GAAzC,EAA4Cc,OAA5C,EAAN;AACD,SAHD,CAGE,OAAO3B,GAAP,EAAY;AACZN,iBAAOO,KAAP,CAAc,iBAAewB,UAAUlB,OAAQ,YAA/C;AACA,gBAAMP,GAAN;AACD;;AAEDN,eAAOkC,OAAP,CAAgB,iBAAeH,UAAUZ,QAAS,UAAlD;AACA,cAAMf,kBAAkB+B,gBAAlB,CAAmCJ,SAAnC,CAAN;AACD;AACF,KAdD,CAcE,OAAOzB,GAAP,EAAY;AACZN,aAAOO,KAAP,CAAaD,GAAb;AACAE,cAAQC,IAAR,CAAa,CAAb;AACD;;AAEDD,YAAQ4B,cAAR,CAAuB,oBAAvB,EAA6C/B,yBAA7C;AACD,G;;WAxD6BgC,O;;;;SAAAA,O","file":"index.js","sourcesContent":["import semver from 'semver';\nimport Logger from 'nightingale-logger';\nimport readRecursiveDirectory from './readRecursiveDirectory';\n\nconst logger = new Logger('alp.migrations');\n\nexport MigrationsManager from './Manager';\n\nexport default async function migrate({ config, dirname, migrationsManager }) {\n  const unhandledRejectionHandler = (err) => {\n    logger.error('unhandledRejection', { err });\n    process.exit(1);\n  };\n  process.on('unhandledRejection', unhandledRejectionHandler);\n\n  const packageVersion = config.packageConfig.version;\n  let currentVersion = await migrationsManager.findLastVersion();\n  let migrations = [];\n\n  logger.info('migrate', { packageVersion, currentVersion });\n\n  await readRecursiveDirectory(dirname, (res) => {\n    let fileName = res.path.substr(dirname.length + 1);\n\n    if (fileName.slice(-3) !== '.js') {\n      return;\n    }\n\n    let version = /([\\d\\.]+)(_.*|\\.js)$/.exec(fileName);\n\n    if (!version || !version[1]) {\n      return;\n    }\n\n    version = version[1];\n\n    if (currentVersion && semver.lte(version, currentVersion)) return;\n    if (semver.gt(version, packageVersion)) return;\n\n    migrations.push({ version: version, fileName: fileName });\n  });\n\n  migrations = migrations.sort((a, b) => semver.gt(a.version, b.version));\n\n  try {\n    for (let migration of migrations) {\n      logger.info(`Migration to ${migration.fileName}`);\n      try {\n        // eslint-disable-next-line global-require\n        await require(`${dirname}/${migration.fileName}`).default();\n      } catch (err) {\n        logger.error(`Migration to ${migration.version} Failed !`);\n        throw err;\n      }\n\n      logger.success(`Migration to ${migration.fileName} done !`);\n      await migrationsManager.addMigrationDone(migration);\n    }\n  } catch (err) {\n    logger.error(err);\n    process.exit(1);\n  }\n\n  process.removeListener('unhandledRejection', unhandledRejectionHandler);\n}\n"]}