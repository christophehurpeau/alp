{"version":3,"file":"index-node8-dev.es.js","sources":["../src/index.js"],"sourcesContent":["import { existsSync, readFileSync } from 'fs';\nimport path from 'path';\nimport { deprecate } from 'util';\nimport Koa from 'koa';\nimport compress from 'koa-compress';\nimport serve from 'koa-static';\nimport _config, { Config } from 'alp-config/src';\nimport errors from 'alp-errors-node/src';\nimport params from 'alp-params/src';\nimport language from 'alp-language/src';\nimport translate from 'alp-translate';\nimport _listen from 'alp-listen/src';\nimport Logger from 'nightingale-logger/src';\nimport findUp from 'findup-sync';\n\nexport { Config } from 'alp-config';\n\nconst logger = new Logger('alp');\n\nexport const appDirname = path.dirname(process.argv[1]);\n\nconst packagePath = findUp('package.json', { cwd: appDirname });\nif (!packagePath) throw new Error(`Could not find package.json: \"${packagePath}\"`);\nexport const packageDirname = path.dirname(packagePath);\n\nlogger.debug('init', { appDirname, packageDirname });\n\n// eslint-disable-next-line import/no-dynamic-require, global-require\nexport const packageConfig = JSON.parse(readFileSync(packagePath));\n\nconst buildedConfigPath = `${appDirname}/build/config/`;\nconst configPath = existsSync(buildedConfigPath) ? buildedConfigPath : `${appDirname}/config/`;\nexport const config = new Config(configPath);\nconfig.loadSync({ packageConfig });\n\nexport default class Alp extends Koa {\n  dirname: string;\n  packageDirname: string;\n\n  /**\n   * @param {Object} [options]\n   * @param {string} [options.dirname] directory of the application\n   * @param {string} [options.certPath] directory of the ssl certificates\n   * @param {string} [options.publicPath] directory of public files\n   * @param {Config} [options.config] alp-config object\n   * @param {Array} [options.argv] deprecated, list of overridable config by argv\n   */\n  constructor(options = {}) {\n    super();\n    if (options.packageDirname) {\n      throw new Error('options.packageDirname is deprecated');\n    }\n    if (options.config) {\n      throw new Error('options.config is deprecated');\n    }\n    if (options.srcDirname) {\n      throw new Error('options.srcDirname is deprecated');\n    }\n    if (options.dirname) {\n      throw new Error('options.dirname is deprecated');\n    }\n\n    this.dirname = path.normalize(appDirname);\n\n    Object.defineProperty(this, 'packageDirname', {\n      get: deprecate(() => packageDirname, 'packageDirname'),\n      configurable: false,\n      enumerable: false,\n    });\n\n    this.certPath = options.certPath || `${packageDirname}/config/cert`;\n    this.publicPath = options.publicPath || `${packageDirname}/public/`;\n\n    _config()(this, config);\n\n    params(this);\n    language(this);\n    translate('locales')(this);\n\n    this.use(compress());\n  }\n\n  get environment() {\n    deprecate(() => () => null, 'app.environment, use app.env instead')();\n    return this.env;\n  }\n\n  get production() {\n    deprecate(() => () => null, 'app.production, use global.PRODUCTION instead')();\n    return this.env === 'prod' || this.env === 'production';\n  }\n  servePublic() {\n    this.use(serve(this.publicPath)); // static files\n  }\n\n  catchErrors() {\n    this.use(errors);\n  }\n\n  listen() {\n    return _listen(this.certPath)(this)\n      .then(server => {\n        this._server = server;\n        return server;\n      })\n      .catch(err => {\n        logger.error(err);\n        throw err;\n      });\n  }\n\n  /**\n   * Close server and emit close event\n   */\n  close() {\n    if (this._server) {\n      this._server.close();\n      this.emit('close');\n    }\n  }\n\n  start(fn: Function) {\n    fn()\n      .then(() => logger.success('started'))\n      .catch(err => logger.error('start fail', { err }));\n  }\n}\n"],"names":["logger","Logger","appDirname","path","dirname","process","argv","packagePath","findUp","cwd","Error","packageDirname","debug","packageConfig","JSON","parse","readFileSync","buildedConfigPath","configPath","existsSync","config","Config","loadSync","Alp","Koa","options","srcDirname","normalize","defineProperty","deprecate","certPath","publicPath","use","compress","environment","env","production","serve","errors","_listen","then","server","_server","catch","err","error","close","emit","fn","success"],"mappings":";;;;;;;;;;;;;;;;;AAiBA,MAAMA,SAAS,IAAIC,MAAJ,CAAW,KAAX,CAAf;;AAEA,MAAaC,aAAaC,KAAKC,OAAL,CAAaC,QAAQC,IAAR,CAAa,CAAb,CAAb,CAAnB;;AAEP,MAAMC,cAAcC,OAAO,cAAP,EAAuB,EAAEC,KAAKP,UAAP,EAAvB,CAApB;AACA,IAAI,CAACK,WAAL,EAAkB,MAAM,IAAIG,KAAJ,CAAW,iCAAgCH,WAAY,GAAvD,CAAN;AAClB,MAAaI,iBAAiBR,KAAKC,OAAL,CAAaG,WAAb,CAAvB;;AAEPP,OAAOY,KAAP,CAAa,MAAb,EAAqB,EAAEV,UAAF,EAAcS,cAAd,EAArB;;;AAGA,MAAaE,gBAAgBC,KAAKC,KAAL,CAAWC,aAAaT,WAAb,CAAX,CAAtB;;AAEP,MAAMU,oBAAqB,GAAEf,UAAW,gBAAxC;AACA,MAAMgB,aAAaC,WAAWF,iBAAX,IAAgCA,iBAAhC,GAAqD,GAAEf,UAAW,UAArF;AACA,MAAakB,SAAS,IAAIC,MAAJ,CAAWH,UAAX,CAAf;AACPE,OAAOE,QAAP,CAAgB,EAAET,aAAF,EAAhB;;IAEqBU,MAAN,cAAkBC,GAAlB,CAAsB;;;;;;;;;;cAYvBC,YAAZ,EAA0B;;QAEpBA,QAAQd,cAAZ,EAA4B;YACpB,IAAID,KAAJ,CAAU,sCAAV,CAAN;;QAEEe,QAAQL,MAAZ,EAAoB;YACZ,IAAIV,KAAJ,CAAU,8BAAV,CAAN;;QAEEe,QAAQC,UAAZ,EAAwB;YAChB,IAAIhB,KAAJ,CAAU,kCAAV,CAAN;;QAEEe,QAAQrB,OAAZ,EAAqB;YACb,IAAIM,KAAJ,CAAU,+BAAV,CAAN;;;SAGGN,OAAL,GAAeD,KAAKwB,SAAL,CAAezB,UAAf,CAAf;;WAEO0B,cAAP,CAAsB,IAAtB,EAA4B,gBAA5B,EAA8C;WACvCC,UAAU,MAAMlB,cAAhB,EAAgC,gBAAhC,CADuC;oBAE9B,KAF8B;kBAGhC;KAHd;;SAMKmB,QAAL,GAAgBL,QAAQK,QAAR,IAAqB,GAAEnB,cAAe,cAAtD;SACKoB,UAAL,GAAkBN,QAAQM,UAAR,IAAuB,GAAEpB,cAAe,UAA1D;;cAEU,IAAV,EAAgBS,MAAhB;;WAEO,IAAP;aACS,IAAT;cACU,SAAV,EAAqB,IAArB;;SAEKY,GAAL,CAASC,UAAT;;;MAGEC,WAAJ,GAAkB;cACN,MAAM,MAAM,IAAtB,EAA4B,sCAA5B;WACO,KAAKC,GAAZ;;;MAGEC,UAAJ,GAAiB;cACL,MAAM,MAAM,IAAtB,EAA4B,+CAA5B;WACO,KAAKD,GAAL,KAAa,MAAb,IAAuB,KAAKA,GAAL,KAAa,YAA3C;;gBAEY;SACPH,GAAL,CAASK,MAAM,KAAKN,UAAX,CAAT,EADY;;;gBAIA;SACPC,GAAL,CAASM,MAAT;;;WAGO;WACAC,QAAQ,KAAKT,QAAb,EAAuB,IAAvB,EACJU,IADI,CACCC,UAAU;WACTC,OAAL,GAAeD,MAAf;aACOA,MAAP;KAHG,EAKJE,KALI,CAKEC,OAAO;aACLC,KAAP,CAAaD,GAAb;YACMA,GAAN;KAPG,CAAP;;;;;;UAcM;QACF,KAAKF,OAAT,EAAkB;WACXA,OAAL,CAAaI,KAAb;WACKC,IAAL,CAAU,OAAV;;;;QAIEC,EAAN,EAAoB;kBAAZ,YAAY;;;;SAEfR,IADH,CACQ,MAAMxC,OAAOiD,OAAP,CAAe,SAAf,CADd,EAEGN,KAFH,CAESC,OAAO5C,OAAO6C,KAAP,CAAa,YAAb,EAA2B,EAAED,GAAF,EAA3B,CAFhB;;;;;;;"}