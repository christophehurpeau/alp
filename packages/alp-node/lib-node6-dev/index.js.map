{"version":3,"sources":["../src/index.js"],"names":["Config","MigrationsManager","newController","logger","appDirname","dirname","process","argv","info","packagePath","cwd","Error","packageDirname","packageConfig","require","config","loadSync","Alp","constructor","options","srcDirname","normalize","Object","defineProperty","get","configurable","enumerable","certPath","publicPath","use","browserStateTransformers","browserContextTransformers","initialBrowserContext","context","state","create","forEach","transformer","computeInitialContextForBrowser","app","registerBrowserContextTransformer","push","registerBrowserStateTransformer","registerBrowserStateTransformers","migrate","migrationsManager","environment","env","production","servePublic","catchErrors","listen","then","server","_server","catch","err","error","close","emit","start","fn","success"],"mappings":"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","file":"index.js","sourcesContent":["import { deprecate } from 'util';\nimport Koa from 'koa';\nimport compress from 'koa-compress';\nimport serve from 'koa-static';\nimport _config, { Config } from 'alp-config/src';\nimport errors from 'alp-errors-node/src';\nimport params from 'alp-params/src';\nimport language from 'alp-language/src';\nimport translate from 'alp-translate';\nimport _listen from 'alp-listen/src';\nimport migrations from 'alp-migrations/src';\nimport Logger from 'nightingale-logger/src';\nimport findUp from 'findup-sync';\nimport path from 'path';\n\nexport { Config } from 'alp-config';\nexport newController from 'alp-controller';\nexport { MigrationsManager } from 'alp-migrations';\n\nconst logger = new Logger('alp');\n\nexport const appDirname = path.dirname(process.argv[1]);\nlogger.info('appDirname', { appDirname });\n\nconst packagePath = findUp('package.json', { cwd: appDirname });\nif (!packagePath) throw new Error(`Could not find package.json: \"${packagePath}\"`);\nexport const packageDirname = path.dirname(packagePath);\n\n// eslint-disable-next-line import/no-dynamic-require, global-require\nexport const packageConfig = require(packagePath);\nexport const config = new Config(`${appDirname}/config/`);\nconfig.loadSync({ packageConfig });\n\nexport default class Alp extends Koa {\n  dirname: string;\n  packageDirname: string;\n  browserStateTransformers: Array<Function>;\n  config;\n\n  /**\n   * @param {Object} [options]\n   * @param {string} [options.dirname] directory of the application\n   * @param {string} [options.certPath] directory of the ssl certificates\n   * @param {string} [options.publicPath] directory of public files\n   * @param {Config} [options.config] alp-config object\n   * @param {Array} [options.argv] deprecated, list of overridable config by argv\n   */\n  constructor(options = {}) {\n    super();\n    if (options.packageDirname) {\n      throw new Error('options.packageDirname is deprecated');\n    }\n    if (options.config) {\n      throw new Error('options.config is deprecated');\n    }\n    if (options.srcDirname) {\n      throw new Error('options.srcDirname is deprecated');\n    }\n    if (options.dirname) {\n      throw new Error('options.dirname is deprecated');\n    }\n\n    this.dirname = path.normalize(appDirname);\n\n    Object.defineProperty(this, 'packageDirname', {\n      get: deprecate(() => packageDirname, 'packageDirname'),\n      configurable: false,\n      enumerable: false,\n    });\n\n    this.certPath = options.certPath || `${this.packageDirname}/config/cert`;\n    this.publicPath = options.publicPath || `${this.packageDirname}/public/`;\n\n    _config()(this, config);\n\n    params(this);\n    language(this);\n    translate('locales')(this);\n\n    this.use(compress());\n\n    this.browserStateTransformers = [];\n    this.browserContextTransformers = [\n      (initialBrowserContext, context) => {\n        initialBrowserContext.state = Object.create(null);\n        this.browserStateTransformers.forEach(transformer => (\n          transformer(initialBrowserContext.state, context)\n        ));\n      },\n    ];\n\n    this.context.computeInitialContextForBrowser = function () {\n      const initialBrowserContext = Object.create(null);\n\n      this.app.browserContextTransformers.forEach(transformer => (\n        transformer(initialBrowserContext, this)\n      ));\n\n      return initialBrowserContext;\n    };\n  }\n\n  registerBrowserContextTransformer(transformer: Function) {\n    this.browserContextTransformers.push(transformer);\n  }\n\n  registerBrowserStateTransformer(transformer: Function) {\n    this.browserStateTransformers.push(transformer);\n  }\n\n  registerBrowserStateTransformers(transformer) {\n    deprecate(() => () => null, 'breaking: use registerBrowserStateTransformer instead')();\n    this.browserStateTransformers.push(transformer);\n  }\n\n  migrate(migrationsManager) {\n    return migrations({\n      config: this.config,\n      dirname: `${this.dirname}/migrations`,\n      migrationsManager,\n    });\n  }\n\n  get environment() {\n    deprecate(() => () => null, 'app.environment, use app.env instead')();\n    return this.env;\n  }\n\n  get production() {\n    deprecate(() => () => null, 'app.production, use global.PRODUCTION instead')();\n    return this.env === 'prod' || this.env === 'production';\n  }\n  servePublic() {\n    this.use(serve(this.publicPath)); // static files\n  }\n\n  catchErrors() {\n    this.use(errors);\n  }\n\n  listen() {\n    return _listen(this.certPath)(this)\n      .then(server => this._server = server)\n      .catch(err => {\n        logger.error(err);\n        throw err;\n      });\n  }\n\n  /**\n   * Close server and emit close event\n   */\n  close() {\n    if (this._server) {\n      this._server.close();\n      this.emit('close');\n    }\n  }\n\n  start(fn: Function) {\n    fn()\n      .then(() => logger.success('started'))\n      .catch(err => logger.error('start fail', { err }));\n  }\n}\n"]}