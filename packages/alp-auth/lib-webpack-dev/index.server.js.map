{"version":3,"sources":["../src/index.server.js"],"names":[],"mappings":"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","file":"index.server.js","sourcesContent":["import { sign, verify } from 'jsonwebtoken';\nimport promiseCallback from 'promise-callback-factory';\nimport Logger from 'nightingale-logger';\nimport UsersManager from './models/user/UsersManager';\nimport AuthenticationService from './services/AuthenticationService';\nimport UserAccountsService from './services/user/UserAccountsService';\nimport createAuthController from './controllers/authController';\n\nexport { UsersManager };\nexport { default as routes } from './routes';\n\nconst COOKIE_NAME = 'connectedUser';\nconst logger = new Logger('alp-auth');\n\nexport default function init({\n    controllers,\n    usersManager,\n    strategies,\n    loginModuleDescriptor,\n    homeRouterKey,\n}: {\n    controllers: Map,\n    usersManager: UsersManager,\n    strategies: Object,\n    loginModuleDescriptor: Object,\n    homeRouterKey: ?string,\n}) {\n    return app => {\n        const userAccountsService = new UserAccountsService(usersManager);\n\n        const authenticationService = new AuthenticationService(\n            app.config,\n            strategies,\n            userAccountsService\n        );\n\n        controllers.set('auth', createAuthController({\n            authenticationService,\n            loginModuleDescriptor,\n            homeRouterKey,\n        }));\n\n        app.context.setConnected = async function (connected: number|string, user: Object) {\n            logger.debug('setConnected', { connected });\n            if (!connected) {\n                throw new Error('Illegal value for setConnected');\n            }\n\n            this.state.connected = connected;\n            this.state.user = user;\n\n            const token = await promiseCallback(done => sign(\n                { connected, time: Date.now() },\n                this.config.get('authentication').get('secretKey'),\n                {\n                    algorithm: 'HS512',\n                    audience: this.request.headers['user-agent'],\n                    expiresIn: '30 days',\n                },\n                done\n            ));\n\n            this.cookies.set(COOKIE_NAME, token, {\n                httpOnly: true,\n                secure: this.config.get('allowHttps'),\n            });\n        };\n\n        app.context.logout = function () {\n            delete this.state.connected;\n            delete this.state.user;\n            this.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n        };\n\n        app.registerBrowserStateTransformers((initialBrowserState, ctx) => {\n            if (ctx.state.connected) {\n                initialBrowserState.connected = ctx.state.connected;\n                initialBrowserState.user = usersManager.transformForBrowser(ctx.state.user);\n            }\n        });\n\n        return async (ctx, next) => {\n            let token = ctx.cookies.get(COOKIE_NAME);\n            logger.debug('middleware', { token });\n            if (!token) return await next();\n\n            let connected;\n            try {\n                let decoded = await verify(token, ctx.config.get('authentication').get('secretKey'), {\n                    algorithm: 'HS512',\n                    audience: ctx.request.headers['user-agent'],\n                });\n                connected = decoded.connected;\n            } catch (err) {\n                logger.info('failed to verify authentification', { err });\n                ctx.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n                return await next();\n            }\n            logger.debug('middleware', { connected });\n\n            if (!connected) return await next();\n\n            const user = await usersManager.findConnected(connected);\n\n            if (!user) {\n                ctx.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n                return await next();\n            }\n\n            ctx.state.connected = connected;\n            ctx.state.user = user;\n\n            await next();\n        };\n    };\n}\n"]}