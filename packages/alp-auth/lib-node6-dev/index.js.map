{"version":3,"sources":["../src/index.js"],"names":["init","abstractUsersManager","mongoUsersManager","rethinkUsersManager","COOKIE_NAME","logger","usersManager","strategies","homeRouterKey","app","userAccountsService","authenticationService","config","controller","reduxReducers","user","state","connected","context","setConnected","debug","Error","token","time","Date","now","get","algorithm","audience","request","headers","expiresIn","done","cookies","set","httpOnly","secure","logout","expires","decodeJwt","userAgent","result","websocket","Cookies","require","users","Map","use","socket","next","handshakeData","keys","err","info","findConnected","client","id","on","delete","routes","login","segment","add","loginResponse","defaultRoute","middleware","ctx","setState","reduxInitialContext","transformForBrowser","notConnected"],"mappings":"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","file":"index.js","sourcesContent":["import { sign, verify } from 'jsonwebtoken';\nimport promiseCallback from 'promise-callback-factory';\nimport Logger from 'nightingale-logger/src';\nimport abstractUsersManager from './models/user/abstractUsersManager';\nimport mongoUsersManager from './models/user/mongoUsersManager';\nimport rethinkUsersManager from './models/user/rethinkUsersManager';\nimport AuthenticationService from './services/AuthenticationService';\nimport UserAccountsService from './services/user/UserAccountsService';\nimport createAuthController from './createAuthController';\n\nexport { abstractUsersManager, mongoUsersManager, rethinkUsersManager };\n\nconst COOKIE_NAME = 'connectedUser';\nconst logger = new Logger('alp:auth');\n\nexport default function init({\n  usersManager,\n  strategies,\n  homeRouterKey,\n}: {\n  usersManager: Object,\n  strategies: Object,\n  homeRouterKey: ?string,\n}) {\n  return app => {\n    const userAccountsService = new UserAccountsService(usersManager);\n\n    const authenticationService = new AuthenticationService(\n      app.config,\n      strategies,\n      userAccountsService,\n    );\n\n    const controller = createAuthController({\n      usersManager,\n      authenticationService,\n      homeRouterKey,\n    });\n\n    app.reduxReducers.user = (state = null) => state;\n    app.reduxReducers.connected = (state = null) => state;\n\n    app.context.setConnected = async function(connected: number | string, user: Object) {\n      logger.debug('setConnected', { connected });\n      if (!connected) {\n        throw new Error('Illegal value for setConnected');\n      }\n\n      this.state.connected = connected;\n      this.state.user = user;\n\n      const token = await promiseCallback(done =>\n        sign(\n          { connected, time: Date.now() },\n          this.config.get('authentication').get('secretKey'),\n          {\n            algorithm: 'HS512',\n            audience: this.request.headers['user-agent'],\n            expiresIn: '30 days',\n          },\n          done,\n        ),\n      );\n\n      this.cookies.set(COOKIE_NAME, token, {\n        httpOnly: true,\n        secure: this.config.get('allowHttps'),\n      });\n    };\n\n    app.context.logout = function() {\n      delete this.state.connected;\n      delete this.state.user;\n      this.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n    };\n\n    const decodeJwt = (token, userAgent) => {\n      const result = verify(token, app.config.get('authentication').get('secretKey'), {\n        algorithm: 'HS512',\n        audience: userAgent,\n      });\n      return result && result.connected;\n    };\n\n    if (app.websocket) {\n      logger.debug('app has websocket');\n      // eslint-disable-next-line global-require\n      const Cookies = require('cookies');\n\n      const users = new Map();\n      app.websocket.users = users;\n\n      app.websocket.use(async (socket, next) => {\n        const handshakeData = socket.request;\n        const cookies = new Cookies(handshakeData, null, { keys: app.keys });\n        let token = cookies.get(COOKIE_NAME);\n        logger.debug('middleware websocket', { token });\n\n        if (!token) return next();\n\n        let connected;\n        try {\n          connected = await decodeJwt(token, handshakeData.headers['user-agent']);\n        } catch (err) {\n          logger.info('failed to verify authentication', { err });\n          return next();\n        }\n        logger.debug('middleware websocket', { connected });\n\n        if (!connected) return next();\n\n        const user = await usersManager.findConnected(connected);\n\n        if (!user) return next();\n\n        socket.user = user;\n        users.set(socket.client.id, user);\n\n        socket.on('disconnected', () => users.delete(socket.client.id));\n\n        await next();\n      });\n    }\n\n    return {\n      routes: {\n        login: [\n          '/login/:strategy',\n          segment => {\n            segment.add('/response', controller.loginResponse, 'loginResponse');\n            segment.defaultRoute(controller.login, 'login');\n          },\n        ],\n        logout: ['/logout', controller.logout],\n      },\n\n      middleware: async (ctx, next) => {\n        let token = ctx.cookies.get(COOKIE_NAME);\n        logger.debug('middleware', { token });\n\n        const setState = (connected, user) => {\n          ctx.state.connected = connected;\n          ctx.state.user = user;\n          if (ctx.reduxInitialContext) {\n            ctx.reduxInitialContext.connected = connected;\n            ctx.reduxInitialContext.user = user && usersManager.transformForBrowser(user);\n          }\n        };\n\n        const notConnected = () => {\n          setState(null, null);\n          return next();\n        };\n\n        if (!token) return notConnected();\n\n        let connected;\n        try {\n          connected = await decodeJwt(token, ctx.request.headers['user-agent']);\n        } catch (err) {\n          logger.info('failed to verify authentification', { err });\n          ctx.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n          return notConnected();\n        }\n        logger.debug('middleware', { connected });\n\n        if (!connected) return notConnected();\n\n        const user = await usersManager.findConnected(connected);\n\n        if (!user) {\n          ctx.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n          return notConnected();\n        }\n\n        setState(connected, user);\n        return next();\n      },\n    };\n  };\n}\n"]}