{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import { sign, verify } from 'jsonwebtoken';\nimport promiseCallback from 'promise-callback-factory';\nimport Logger from 'nightingale-logger';\nimport UsersManager from './models/user/UsersManager';\n\nexport { default as createAuthController } from './controllers/authController';\nexport { UsersManager };\nexport { default as AuthenticationService } from './services/AuthenticationService';\nexport { default as UserAccountsService } from './services/user/UserAccountsService';\n\nconst COOKIE_NAME = 'connectedUser';\nconst logger = new Logger('alp-auth');\n\nexport function init(app, usersManager: UsersManager) {\n    app.context.setConnected = async function (connected: number|string, user: Object) {\n        logger.debug('setConnected', { connected });\n        if (!connected) {\n            throw new Error('Illegal value for setConnected');\n        }\n\n        this.state.connected = connected;\n        this.state.user = user;\n\n        const token = await promiseCallback(done => sign(\n            { connected, time: Date.now() },\n            this.config.get('authentication').get('secretKey'),\n            {\n                algorithm: 'HS512',\n                audience: this.request.headers['user-agent'],\n                expiresIn: '30 days',\n            },\n            done\n        ));\n\n        this.cookies.set(COOKIE_NAME, token, {\n            httpOnly: true,\n            secure: this.config.get('allowHttps'),\n        });\n    };\n\n    app.context.logout = function () {\n        delete this.state.connected;\n        delete this.state.user;\n        this.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n    };\n\n    app.registerBrowserStateTransformers((initialBrowserState, ctx) => {\n        if (ctx.state.connected) {\n            initialBrowserState.connected = ctx.state.connected;\n            initialBrowserState.user = usersManager.transformForBrowser(ctx.state.user);\n        }\n    });\n}\n\n\nexport function middleware(usersManager: UsersManager) {\n    return async (ctx, next) => {\n        let token = ctx.cookies.get(COOKIE_NAME);\n        logger.debug('middleware', { token });\n        if (!token) return await next();\n\n        let connected;\n        try {\n            let decoded = await verify(token, ctx.config.get('authentication').get('secretKey'), {\n                algorithm: 'HS512',\n                audience: ctx.request.headers['user-agent'],\n            });\n            connected = decoded.connected;\n        } catch (err) {\n            logger.info('failed to verify authentification', { err });\n            ctx.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n            return await next();\n        }\n        logger.debug('middleware', { connected });\n\n        if (!connected) return await next();\n\n        const user = await usersManager.findConnected(connected);\n\n        if (!user) {\n            ctx.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n            return await next();\n        }\n\n        ctx.state.connected = connected;\n        ctx.state.user = user;\n\n        await next();\n    };\n}\n"]}