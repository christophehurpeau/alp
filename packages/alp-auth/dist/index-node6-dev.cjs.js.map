{"version":3,"file":"index-node6-dev.cjs.js","sources":["../src/models/user/types/index.js","../src/models/user/abstractUsersManager.js","../src/models/user/mongoUsersManager.js","../src/models/user/rethinkUsersManager.js","../src/utils/generators.js","../src/services/user/userAccountGoogleService.js","../src/services/user/UserAccountsService.js","../src/services/AuthenticationService.js","../src/createAuthController.js","../src/index.js"],"sourcesContent":["export type UserNameType = {\n  familyName: string,\n  givenName: string,\n};\n\nexport type AccountType = {\n  accessToken: string,\n  accountId: string,\n  name: string,\n  profile?: Object,\n  provider: string,\n  refreshToken?: string,\n  scope: Array<string>,\n  status: string,\n  tokenExpireDate: Date,\n};\n\nexport type UserType = {\n  _id?: string,\n  accounts: Array<AccountType>,\n  displayName: string,\n  emailDomains: Array<string>,\n  emails: Array<string>,\n  fullName: UserNameType,\n  id?: string,\n  status: string,\n};\n\nexport type AccountBrowserType = {\n  accountId: string,\n  name: string,\n  provider: string,\n  status: string,\n};\n\nexport type UserBrowserType = {\n  _id?: string,\n  accounts: Array<AccountBrowserType>,\n  displayName: string,\n  emailDomains: Array<string>,\n  emails: Array<string>,\n  fullName: UserNameType,\n  id?: string,\n  status: string,\n};\n","import type { UserType, UserBrowserType } from './types';\n\nexport default {\n  STATUSES: {\n    VALIDATED: 'validated',\n    DELETED: 'deleted',\n  },\n\n  findOneByAccountOrEmails({\n    provider,\n    accountId,\n    emails,\n  }: {\n    accountId: string | number,\n    emails: ?Array<string>,\n    provider: string,\n  }): Promise<?UserType> {\n    throw new Error('Not implemented');\n  },\n\n  findConnected(connected): Promise<?UserType> {\n    return this.store.findByKey(connected);\n  },\n\n  insertOne(user): Promise<any> {\n    return this.store.insertOne(user);\n  },\n\n  updateOne(user): Promise<any> {\n    return this.store.updateOne(user);\n  },\n\n  transformForBrowser(user): UserBrowserType {\n    return {\n      id: user.id,\n      _id: user._id,\n      displayName: user.displayName,\n      fullName: user.fullName,\n      status: user.status,\n      emails: user.emails,\n      emailDomains: user.emailDomains,\n      accounts: user.accounts.map(account => ({\n        provider: account.provider,\n        accountId: account.accountId,\n        name: account.name,\n        status: account.status,\n        profile: account.profile,\n      })),\n    };\n  },\n};\n","import abstractUsersManager from './abstractUsersManager';\nimport type { UserType, AccountType } from './types/index';\n\nconst mongoUsersManager = Object.create(abstractUsersManager);\nexport default mongoUsersManager;\n\nObject.assign(mongoUsersManager, {\n  findOneByAccountOrEmails({\n    accountId,\n    emails,\n    provider,\n  }: {\n    accountId: string | number,\n    emails?: ?Array<string>,\n    provider: string,\n  }): Promise<?UserType> {\n    let query = {\n      'accounts.provider': provider,\n      'accounts.accountId': accountId,\n    };\n\n    if (emails && emails.length) {\n      query = {\n        $or: [\n          query,\n          {\n            emails: { $in: emails },\n          },\n        ],\n      };\n    }\n\n    return this.store.findOne(query);\n  },\n\n  updateAccount(user: UserType, account: AccountType) {\n    const accountIndex = user.accounts.indexOf(account);\n    if (accountIndex === -1) {\n      throw new Error('Invalid account');\n    }\n\n    return this.store.partialUpdateOne(user, { [`accounts.${accountIndex}`]: account });\n  },\n});\n","import abstractUsersManager from './abstractUsersManager';\nimport type { UserType, AccountType } from './types/index';\n\nconst mongoUsersManager = Object.create(abstractUsersManager);\nexport default mongoUsersManager;\n\nObject.assign(mongoUsersManager, {\n  findOneByAccountOrEmails({\n    accountId,\n    emails,\n    provider,\n  }: {\n    accountId: string | number,\n    emails: ?Array<string>,\n    provider: string,\n  }): Promise<?UserType> {\n    const r = this.store.r;\n    let filter = r\n      .row('accounts')\n      .contains(row => r.and(row('provider').eq(provider), row('accountId').eq(accountId)));\n\n    if (emails && emails.length) {\n      filter = r.or(filter, r.row('emails').contains(row => r.expr(emails).contains(row)));\n    }\n\n    const query = this.store.query().filter(filter);\n    return this.store.findOne(query);\n  },\n\n  updateAccount(user: UserType, account: AccountType) {\n    const accountIndex = user.accounts.indexOf(account);\n    if (accountIndex === -1) {\n      throw new Error('Invalid account');\n    }\n\n    return this.store.partialUpdateOne(user, {\n      accounts: this.store.r.row('accounts').changeAt(accountIndex, account),\n    });\n  },\n});\n","import { randomBytes } from 'crypto';\nimport { promisify } from 'util';\n\nconst randomBytesPromisified = promisify(randomBytes);\n\nexport function randomBase64(size: number): Promise<string> {\n  return randomBytesPromisified(size).then(buffer => buffer.toString('base64'));\n}\n\nexport function randomHex(size: number): Promise<string> {\n  return randomBytesPromisified(size).then(buffer => buffer.toString('hex'));\n}\n","/* global fetch */\nimport EventEmitter from 'events';\n\nexport default new class UserAccountGoogleService extends EventEmitter {\n  static scopeKeyToScope = {\n    login: 'openid profile email https://www.googleapis.com/auth/plus.profile.emails.read',\n  };\n\n  providerKey = 'google';\n\n  getProfile(tokens) {\n    return fetch(\n      `https://www.googleapis.com/oauth2/v1/userinfo?access_token=${tokens.accessToken}`,\n    ).then(response => response.json());\n  }\n\n  isAccount(account, profile) {\n    return account.googleId === profile.id;\n  }\n\n  getId(profile) {\n    return profile.id;\n  }\n\n  getAccountName(profile) {\n    return profile.email;\n  }\n\n  getEmails(profile, plusProfile) {\n    const emails = [];\n\n    if (profile.email) {\n      emails.push(profile.email);\n    }\n\n    if (plusProfile.emails) {\n      plusProfile.emails.forEach(email => {\n        if (emails.indexOf(email.value) === -1) {\n          emails.push(email.value);\n        }\n      });\n    }\n\n    return emails;\n  }\n\n  getDisplayName(profile) {\n    return profile.name;\n  }\n\n  getFullName(profile) {\n    return {\n      givenName: profile.given_name,\n      familyName: profile.family_name,\n    };\n  }\n\n  getDefaultScope(newScope) {\n    return this.getScope(newScope);\n  }\n\n  getScope(oldScope, newScope) {\n    return !oldScope\n      ? newScope.split(' ')\n      : oldScope.concat(newScope.split(' ')).filter((item, i, ar) => ar.indexOf(item) === i);\n  }\n}();\n","/* global fetch */\nimport EventEmitter from 'events';\nimport Logger from 'nightingale-logger';\nimport userAccountGoogleService from './userAccountGoogleService';\n\ntype TokensObject = {\n  accessToken: string,\n  expireDate: Date,\n  idToken: string,\n  refreshToken?: string,\n  tokenType: string,\n};\n\nconst logger = new Logger('alp:auth:userAccounts');\n\nexport default class UserAccountsService extends EventEmitter {\n  static strategyToService = {\n    google: userAccountGoogleService,\n  };\n\n  constructor(usersManager) {\n    super();\n    this.usersManager = usersManager;\n  }\n\n  getScope(strategy: string, scopeKey: string, user, accountId) {\n    logger.debug('getScope', { strategy, userId: user && user._id });\n    const service = this.constructor.strategyToService[strategy];\n    const newScope = service.constructor.scopeKeyToScope[scopeKey];\n    if (!user || !accountId) {\n      return newScope;\n    }\n    const account = user.accounts.find(\n      account => account.provider === strategy && account.accountId === accountId,\n    );\n\n    if (!account) {\n      throw new Error('Could not found associated account');\n    }\n    return service.getScope(account.scope, newScope).join(' ');\n  }\n\n  async update(user, strategy, tokens, scope, subservice) {\n    const service = this.constructor.strategyToService[strategy];\n    const profile = await service.getProfile(tokens);\n    const account = user.accounts.find(\n      account => account.provider === strategy && service.isAccount(account, profile),\n    );\n    if (!account) {\n      // TODO check if already exists in other user => merge\n      // TODO else add a new account in this user\n      throw new Error('Could not found associated account');\n    }\n    account.status = 'valid';\n    account.accessToken = tokens.accessToken;\n    if (tokens.refreshToken) {\n      account.refreshToken = tokens.refreshToken;\n    }\n    if (tokens.expireDate) {\n      account.tokenExpireDate = tokens.expireDate;\n    }\n    account.scope = service.getScope(account.scope, scope);\n    account.subservices = account.subservices || [];\n    if (subservice && account.subservices.indexOf(subservice) === -1) {\n      account.subservices.push(subservice);\n    }\n\n    await this.usersManager.update(user);\n    return user;\n  }\n\n  async findOrCreateFromGoogle(strategy: string, tokens: TokensObject, scope: string, subservice) {\n    if (strategy !== 'google') {\n      throw new Error('Not supported at the moment');\n    }\n\n    const service = this.constructor.strategyToService[strategy];\n\n    const profile = await service.getProfile(tokens);\n\n    const plusProfile = await fetch(\n      `https://www.googleapis.com/plus/v1/people/me?access_token=${tokens.accessToken}`,\n    ).then(response => response.json());\n\n    const emails = service.getEmails(profile, plusProfile);\n\n    let user = await this.usersManager.findOneByAccountOrEmails({\n      provider: service.providerKey,\n      accountId: service.getId(profile),\n      emails,\n    });\n\n    logger.info(!user ? 'create user' : 'existing user', { emails, user });\n\n    if (!user) {\n      user = {};\n    }\n\n    Object.assign(user, {\n      displayName: service.getDisplayName(profile),\n      fullName: service.getFullName(profile),\n      status: this.usersManager.STATUSES.VALIDATED,\n    });\n\n    if (!user.accounts) user.accounts = [];\n\n    const accountId = service.getId(profile);\n\n    let account = user.accounts.find(\n      account => account.provider === strategy && account.accountId === accountId,\n    );\n\n    if (!account) {\n      account = { provider: strategy, accountId };\n      user.accounts.push(account);\n    }\n\n    account.name = service.getAccountName(profile);\n    account.status = 'valid';\n    account.profile = profile;\n    account.accessToken = tokens.accessToken;\n    if (tokens.refreshToken) {\n      account.refreshToken = tokens.refreshToken;\n    }\n    if (tokens.expireDate) {\n      account.tokenExpireDate = tokens.expireDate;\n    }\n    account.scope = service.getScope(account.scope, scope);\n\n    if (!account.subservices) account.subservices = [];\n    if (subservice && !account.subservices.includes(subservice)) {\n      account.subservices.push(subservice);\n    }\n\n    if (!user.emails) user.emails = [];\n    const userEmails = user.emails;\n    emails.forEach(email => {\n      if (!userEmails.includes(email)) {\n        userEmails.push(email);\n      }\n    });\n\n    user.emailDomains = Array.from(\n      user.emails.reduce((domains, email) => domains.add(email.split('@', 2)[1]), new Set()),\n    );\n\n    const keyPath: string = this.usersManager.store.keyPath;\n    await this.usersManager[user[keyPath] ? 'updateOne' : 'insertOne'](user);\n    return user;\n  }\n\n  updateAccount(user, account) {\n    return this.usersManager.updateAccount(user, account).then(() => user);\n  }\n}\n","/* eslint camelcase: 'off', max-lines: 'off' */\nimport EventEmitter from 'events';\nimport Logger from 'nightingale-logger';\nimport { randomHex } from '../utils/generators';\nimport UserAccountsService from './user/UserAccountsService';\n\nconst logger = new Logger('alp:auth:authentication');\n\ntype GenerateAuthUrlOptionsType = {\n  accessType?: string,\n  grantType?: string,\n  includeGrantedScopes?: boolean,\n  loginHint?: string,\n  prompt?: string,\n  redirectUri?: string,\n  scope?: string,\n  state?: string,\n};\n\ntype GetTokensOptionsType = {\n  code: string,\n  redirectUri: string,\n};\n\nexport default class AuthenticationService extends EventEmitter {\n  config: Object;\n  strategies: Object;\n  userAccountsService: UserAccountsService;\n\n  constructor(config, strategies: Object, userAccountsService: UserAccountsService) {\n    super();\n    this.config = config;\n    this.strategies = strategies;\n    this.userAccountsService = userAccountsService;\n  }\n\n  /**\n   * @param {string} strategy\n   * @param {Object} options\n   * @param {string} [options.redirectUri]\n   * @param {string} [options.scope]\n   * Space-delimited set of permissions that the application requests.\n   * @param {string} [options.state]\n   * Any string that might be useful to your application upon receipt of the response\n   * @param {string} [options.grantType]\n   * @param {string} [options.accessType = 'online']\n   * online or offline\n   * @param {string} [options.prompt]\n   * Space-delimited, case-sensitive list of prompts to present the user.\n   * Values: none, consent, select_account\n   * @param {string} [options.loginHint] email address or sub identifier\n   * @param {boolean} [options.includeGrantedScopes]\n   * If this is provided with the value true, and the authorization request is granted,\n   * the authorization will include any previous authorizations granted\n   * to this user/application combination for other scopes\n   * @returns {string}\n   */\n  generateAuthUrl(strategy: string, options: GenerateAuthUrlOptionsType = {}) {\n    logger.debug('generateAuthUrl', { strategy, options });\n    const strategyInstance = this.strategies[strategy];\n    switch (strategyInstance.type) {\n      case 'oauth2':\n        return strategyInstance.oauth2.authorizationCode.authorizeURL({\n          redirect_uri: options.redirectUri,\n          scope: options.scope,\n          state: options.state,\n          grant_type: options.grantType,\n          access_type: options.accessType,\n          login_hint: options.loginHint,\n          include_granted_scopes: options.includeGrantedScopes,\n        });\n    }\n  }\n\n  getTokens(strategy: string, options: GetTokensOptionsType = {}) {\n    logger.debug('getTokens', { strategy, options });\n    const strategyInstance = this.strategies[strategy];\n    switch (strategyInstance.type) {\n      case 'oauth2':\n        return strategyInstance.oauth2.authorizationCode\n          .getToken({\n            code: options.code,\n            redirect_uri: options.redirectUri,\n          })\n          .then(\n            result =>\n              result && {\n                accessToken: result.access_token,\n                refreshToken: result.refresh_token,\n                tokenType: result.token_type,\n                expiresIn: result.expires_in,\n                expireDate: (() => {\n                  const d = new Date();\n                  d.setTime(d.getTime() + result.expires_in * 1000);\n                  return d;\n                })(),\n                idToken: result.id_token,\n              },\n            // return strategyInstance.accessToken.create(result);\n          );\n    }\n  }\n\n  refreshToken(strategy: string, tokens) {\n    logger.debug('refreshToken', { strategy });\n    if (!tokens.refreshToken) {\n      throw new Error('Missing refresh token');\n    }\n    const strategyInstance = this.strategies[strategy];\n    switch (strategyInstance.type) {\n      case 'oauth2': {\n        const token = strategyInstance.oauth2.accessToken.create({\n          refresh_token: tokens.refreshToken,\n        });\n        return token.refresh().then(result => {\n          const tokens = result.token;\n          return (\n            result && {\n              accessToken: tokens.access_token,\n              tokenType: tokens.token_type,\n              expiresIn: tokens.expires_in,\n              expireDate: (() => {\n                const d = new Date();\n                d.setTime(d.getTime() + tokens.expires_in * 1000);\n                return d;\n              })(),\n              idToken: tokens.id_token,\n            }\n          );\n        });\n      }\n    }\n  }\n\n  redirectUri(ctx, strategy: string) {\n    const host = `http${this.config.get('allowHttps') ? 's' : ''}://${ctx.request.host}`;\n    return `${host}${ctx.urlGenerator('loginResponse', { strategy })}`;\n  }\n\n  /**\n   *\n   * @param {Koa.Context} ctx\n   * @param {string} strategy\n   * @param {string} [refreshToken]\n   * @param {string} [scopeKey='login']\n   * @param user\n   * @param accountId\n   * @returns {*}\n   */\n  async redirectAuthUrl(\n    ctx: Object,\n    strategy: string,\n    refreshToken: ?string,\n    scopeKey: ?string,\n    user,\n    accountId,\n  ) {\n    logger.debug('redirectAuthUrl', { strategy, scopeKey, refreshToken });\n    const state = await randomHex(8);\n    const isLoginAccess = !scopeKey || scopeKey === 'login';\n    const scope = this.userAccountsService.getScope(strategy, scopeKey || 'login', user, accountId);\n\n    ctx.cookies.set(\n      `auth_${strategy}_${state}`,\n      JSON.stringify({\n        scopeKey,\n        scope,\n        isLoginAccess,\n      }),\n      {\n        maxAge: 10 * 60 * 1000,\n        httpOnly: true,\n        secure: this.config.get('allowHttps'),\n      },\n    );\n    const redirectUri = this.generateAuthUrl(strategy, {\n      redirectUri: this.redirectUri(ctx, strategy),\n      scope,\n      state,\n      accessType: refreshToken ? 'offline' : 'online',\n    });\n\n    return ctx.redirect(redirectUri);\n  }\n\n  /**\n   * @param {Koa.Context} ctx\n   * @param {string} strategy\n   * @param {boolean} isConnected\n   * @returns {*}\n   */\n  async accessResponse(ctx, strategy: string, isConnected: ?boolean) {\n    if (ctx.query.error) {\n      const error = new Error(ctx.query.error);\n      error.status = 403;\n      error.expose = true;\n      throw error;\n    }\n\n    const code = ctx.query.code;\n    const state = ctx.query.state;\n    const cookieName = `auth_${strategy}_${state}`;\n    let cookie = ctx.cookies.get(cookieName);\n    ctx.cookies.set(cookieName, '', { expires: new Date(1) });\n    if (!cookie) {\n      throw new Error('No cookie for this state');\n    }\n\n    cookie = JSON.parse(cookie);\n    if (!cookie || !cookie.scope) {\n      throw new Error('Unexpected cookie value');\n    }\n\n    if (!cookie.isLoginAccess) {\n      if (!isConnected) {\n        throw new Error('You are not connected');\n      }\n    }\n\n    const tokens = await this.getTokens(strategy, {\n      code,\n      redirectUri: this.redirectUri(ctx, strategy),\n    });\n\n    if (cookie.isLoginAccess) {\n      const user = await this.userAccountsService.findOrCreateFromGoogle(\n        strategy,\n        tokens,\n        cookie.scope,\n        cookie.scopeKey,\n      );\n      return user;\n    }\n\n    ctx.cookies.set(cookieName, '', { expires: new Date(1) });\n    const connectedUser = ctx.state.connected;\n    await this.userAccountsService.update(\n      connectedUser,\n      strategy,\n      tokens,\n      cookie.scope,\n      cookie.scopeKey,\n    );\n    return connectedUser;\n  }\n\n  refreshAccountTokens(user, account) {\n    if (account.tokenExpireDate && account.tokenExpireDate.getTime() > Date.now()) {\n      return Promise.resolve(false);\n    }\n    return this.refreshToken(account.provider, {\n      accessToken: account.accessToken,\n      refreshToken: account.refreshToken,\n    }).then(tokens => {\n      if (!tokens) {\n        // serviceGoogle.updateFields({ accessToken:null, refreshToken:null, status: .OUTDATED });\n        return false;\n      }\n      account.accessToken = tokens.accessToken;\n      account.tokenExpireDate = tokens.expireDate;\n      return this.userAccountsService.updateAccount(user, account).then(() => true);\n    });\n  }\n}\n","import AuthenticationService from './services/AuthenticationService';\n\nexport default function createAuthController({\n  usersManager,\n  authenticationService,\n  homeRouterKey = '/',\n}: {\n  authenticationService: AuthenticationService,\n  homeRouterKey?: ?string,\n  usersManager: Object,\n}) {\n  return {\n    async login(ctx) {\n      const strategy = ctx.namedParam('strategy');\n      if (!strategy) throw new Error('Strategy missing');\n      await authenticationService.redirectAuthUrl(ctx, strategy);\n    },\n\n    async loginResponse(ctx) {\n      if (ctx.state.connected) {\n        ctx.redirect(ctx.urlGenerator(homeRouterKey));\n      }\n\n      const strategy = ctx.namedParam('strategy');\n      ctx.assert(strategy);\n\n      const connectedUser = await authenticationService.accessResponse(ctx, strategy);\n      const keyPath: string = usersManager.store.keyPath;\n      await ctx.setConnected(connectedUser[keyPath], connectedUser);\n      ctx.state.connected = connectedUser;\n      await ctx.redirect(ctx.urlGenerator(homeRouterKey));\n    },\n\n    async logout(ctx) {\n      ctx.logout();\n      await ctx.redirect(ctx.urlGenerator(homeRouterKey));\n    },\n  };\n}\n","import { promisify } from 'util';\nimport { sign, verify } from 'jsonwebtoken';\nimport Logger from 'nightingale-logger/src';\nimport abstractUsersManager from './models/user/abstractUsersManager';\nimport mongoUsersManager from './models/user/mongoUsersManager';\nimport rethinkUsersManager from './models/user/rethinkUsersManager';\nimport AuthenticationService from './services/AuthenticationService';\nimport UserAccountsService from './services/user/UserAccountsService';\nimport createAuthController from './createAuthController';\n\nexport { abstractUsersManager, mongoUsersManager, rethinkUsersManager };\nexport * from './models/user/types';\n\nconst COOKIE_NAME = 'connectedUser';\nconst logger = new Logger('alp:auth');\n\nconst signPromisified = promisify(sign);\nconst verifyPromisified = promisify(verify);\n\nexport default function init({\n  usersManager,\n  strategies,\n  homeRouterKey,\n}: {\n  homeRouterKey?: ?string,\n  strategies: Object,\n  usersManager: Object,\n}) {\n  return app => {\n    const userAccountsService = new UserAccountsService(usersManager);\n\n    const authenticationService = new AuthenticationService(\n      app.config,\n      strategies,\n      userAccountsService,\n    );\n\n    const controller = createAuthController({\n      usersManager,\n      authenticationService,\n      homeRouterKey,\n    });\n\n    app.reduxReducers.user = (state = null) => state;\n    app.reduxReducers.connected = (state = null) => state;\n\n    app.context.setConnected = async function(connected: number | string, user: Object) {\n      logger.debug('setConnected', { connected });\n      if (!connected) {\n        throw new Error('Illegal value for setConnected');\n      }\n\n      this.state.connected = connected;\n      this.state.user = user;\n\n      const token = signPromisified(\n        { connected, time: Date.now() },\n        this.config.get('authentication').get('secretKey'),\n        {\n          algorithm: 'HS512',\n          audience: this.request.headers['user-agent'],\n          expiresIn: '30 days',\n        },\n      );\n\n      this.cookies.set(COOKIE_NAME, token, {\n        httpOnly: true,\n        secure: this.config.get('allowHttps'),\n      });\n    };\n\n    app.context.logout = function() {\n      delete this.state.connected;\n      delete this.state.user;\n      this.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n    };\n\n    const decodeJwt = async (token, userAgent) => {\n      const result = await verifyPromisified(\n        token,\n        app.config.get('authentication').get('secretKey'),\n        {\n          algorithm: 'HS512',\n          audience: userAgent,\n        },\n      );\n      return result && result.connected;\n    };\n\n    if (app.websocket) {\n      logger.debug('app has websocket');\n      // eslint-disable-next-line global-require\n      const Cookies = require('cookies');\n\n      const users = new Map();\n      app.websocket.users = users;\n\n      app.websocket.use(async (socket, next) => {\n        const handshakeData = socket.request;\n        const cookies = new Cookies(handshakeData, null, { keys: app.keys });\n        const token = cookies.get(COOKIE_NAME);\n        logger.debug('middleware websocket', { token });\n\n        if (!token) return next();\n\n        let connected;\n        try {\n          connected = await decodeJwt(token, handshakeData.headers['user-agent']);\n        } catch (err) {\n          logger.info('failed to verify authentication', { err });\n          return next();\n        }\n        logger.debug('middleware websocket', { connected });\n\n        if (!connected) return next();\n\n        const user = await usersManager.findConnected(connected);\n\n        if (!user) return next();\n\n        socket.user = user;\n        users.set(socket.client.id, user);\n\n        socket.on('disconnected', () => users.delete(socket.client.id));\n\n        await next();\n      });\n    }\n\n    return {\n      routes: {\n        login: [\n          '/login/:strategy',\n          segment => {\n            segment.add('/response', controller.loginResponse, 'loginResponse');\n            segment.defaultRoute(controller.login, 'login');\n          },\n        ],\n        logout: ['/logout', controller.logout],\n      },\n\n      middleware: async (ctx, next) => {\n        const token = ctx.cookies.get(COOKIE_NAME);\n        logger.debug('middleware', { token });\n\n        const setState = (connected, user) => {\n          ctx.state.connected = connected;\n          ctx.state.user = user;\n          if (ctx.reduxInitialContext) {\n            ctx.reduxInitialContext.connected = connected;\n            ctx.reduxInitialContext.user = user && usersManager.transformForBrowser(user);\n          }\n        };\n\n        const notConnected = () => {\n          setState(null, null);\n          return next();\n        };\n\n        if (!token) return notConnected();\n\n        let connected;\n        try {\n          connected = await decodeJwt(token, ctx.request.headers['user-agent']);\n        } catch (err) {\n          logger.info('failed to verify authentification', { err });\n          ctx.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n          return notConnected();\n        }\n        logger.debug('middleware', { connected });\n\n        if (!connected) return notConnected();\n\n        const user = await usersManager.findConnected(connected);\n\n        if (!user) {\n          ctx.cookies.set(COOKIE_NAME, '', { expires: new Date(1) });\n          return notConnected();\n        }\n\n        setState(connected, user);\n        return next();\n      },\n    };\n  };\n}\n"],"names":["Error","connected","store","findByKey","user","insertOne","updateOne","id","_id","displayName","fullName","status","emails","emailDomains","accounts","map","account","provider","accountId","name","profile","mongoUsersManager","Object","create","abstractUsersManager","assign","query","length","$in","findOne","accountIndex","indexOf","partialUpdateOne","r","filter","row","contains","and","eq","or","expr","changeAt","randomBytesPromisified","promisify","randomBytes","randomHex","size","then","buffer","toString","EventEmitter","providerKey","tokens","fetch","accessToken","response","json","googleId","email","plusProfile","push","forEach","value","given_name","family_name","newScope","getScope","oldScope","split","concat","item","i","ar","scopeKeyToScope","logger","Logger","UserAccountsService","usersManager","strategy","scopeKey","debug","userId","service","constructor","strategyToService","find","scope","join","subservice","getProfile","isAccount","refreshToken","expireDate","tokenExpireDate","subservices","update","getEmails","findOneByAccountOrEmails","getId","info","getDisplayName","getFullName","STATUSES","VALIDATED","getAccountName","includes","userEmails","Array","from","reduce","domains","add","Set","keyPath","updateAccount","userAccountGoogleService","AuthenticationService","config","strategies","userAccountsService","options","strategyInstance","type","oauth2","authorizationCode","authorizeURL","redirectUri","state","grantType","accessType","loginHint","includeGrantedScopes","getToken","code","result","access_token","refresh_token","token_type","expires_in","d","Date","setTime","getTime","id_token","token","refresh","ctx","host","get","request","urlGenerator","cookies","set","JSON","stringify","generateAuthUrl","redirect","isConnected","error","expose","cookieName","cookie","expires","parse","isLoginAccess","getTokens","findOrCreateFromGoogle","connectedUser","now","Promise","resolve","createAuthController","namedParam","authenticationService","redirectAuthUrl","homeRouterKey","assert","accessResponse","setConnected","logout","COOKIE_NAME","signPromisified","sign","verifyPromisified","verify","init","app","controller","reduxReducers","context","time","headers","decodeJwt","userAgent","websocket","Cookies","require","users","Map","use","socket","next","handshakeData","keys","err","findConnected","client","on","delete","segment","loginResponse","defaultRoute","login","setState","reduxInitialContext","transformForBrowser","notConnected"],"mappings":"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"}