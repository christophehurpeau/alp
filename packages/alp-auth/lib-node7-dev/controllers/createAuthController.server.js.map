{"version":3,"sources":["../../src/controllers/createAuthController.server.js"],"names":["createAuthController","usersManager","authenticationService","loginModuleDescriptor","homeRouterKey","login","ctx","state","connected","redirect","urlGenerator","strategy","namedParam","redirectAuthUrl","render","loginResponse","assert","connectedUser","accessResponse","store","keyPath","setConnected","logout"],"mappings":";;;;;kBAEwBA,oB;;AAFxB;;;;;;;;;;AAEe,SAASA,oBAAT,OAUZ;AAAA,MAV0C;AAC3CC,gBAD2C;AAE3CC,yBAF2C;AAG3CC,yBAH2C;AAI3CC,oBAAgB;AAJ2B,GAU1C,GALF,6BACC,+CAAc,8BAAd,CADD,EAEC,wDAAuB,0DAAvB,CAFD,EAGC,wDAAuB,8BAAvB,CAHD,EAIC,gDAAe,+BAAC,8BAAD,CAAf,CAJD,CAKE;;AACD,SAAO;AACL,UAAMC,KAAN,CAAYC,GAAZ,EAAiB;AACf,UAAIA,IAAIC,KAAJ,CAAUC,SAAd,EAAyB;AACvBF,YAAIG,QAAJ,CAAaH,IAAII,YAAJ,CAAiBN,aAAjB,CAAb;AACD;;AAED,YAAMO,WAAWL,IAAIM,UAAJ,CAAe,UAAf,CAAjB;AACA,UAAID,QAAJ,EAAc;AACZ,cAAMT,sBAAsBW,eAAtB,CAAsCP,GAAtC,EAA2CK,QAA3C,CAAN;AACA;AACD;;AAED,YAAML,IAAIQ,MAAJ,CAAWX,qBAAX,CAAN;AACD,KAbI;;AAeL,UAAMY,aAAN,CAAoBT,GAApB,EAAyB;AACvB,UAAIA,IAAIC,KAAJ,CAAUC,SAAd,EAAyB;AACvBF,YAAIG,QAAJ,CAAaH,IAAII,YAAJ,CAAiBN,aAAjB,CAAb;AACD;;AAED,YAAMO,WAAWL,IAAIM,UAAJ,CAAe,UAAf,CAAjB;AACAN,UAAIU,MAAJ,CAAWL,QAAX;;AAEA,YAAMM,gBAAgB,MAAMf,sBAAsBgB,cAAtB,CAAqCZ,GAArC,EAA0CK,QAA1C,CAA5B;AACA,sBAAa,8BAAb,QAAwBV,aAAakB,KAAb,CAAmBC,OAA3C;AACA,YAAMd,IAAIe,YAAJ,CAAiBJ,cAAcG,OAAd,CAAjB,EAAyCH,aAAzC,CAAN;AACAX,UAAIC,KAAJ,CAAUC,SAAV,GAAsBS,aAAtB;AACA,YAAMX,IAAIG,QAAJ,CAAaH,IAAII,YAAJ,CAAiBN,aAAjB,CAAb,CAAN;AACD,KA5BI;;AA8BL,UAAMkB,MAAN,CAAahB,GAAb,EAAkB;AAChBA,UAAIgB,MAAJ;AACA,YAAMhB,IAAIG,QAAJ,CAAaH,IAAII,YAAJ,CAAiBN,aAAjB,CAAb,CAAN;AACD;AAjCI,GAAP;AAmCD","file":"createAuthController.server.js","sourcesContent":["import AuthenticationService from '../services/AuthenticationService';\n\nexport default function createAuthController({\n  usersManager,\n  authenticationService,\n  loginModuleDescriptor,\n  homeRouterKey = 'home',\n}: {\n  usersManager: Object,\n  authenticationService: AuthenticationService,\n  loginModuleDescriptor: Object,\n  homeRouterKey: ?string,\n}) {\n  return {\n    async login(ctx) {\n      if (ctx.state.connected) {\n        ctx.redirect(ctx.urlGenerator(homeRouterKey));\n      }\n\n      const strategy = ctx.namedParam('strategy');\n      if (strategy) {\n        await authenticationService.redirectAuthUrl(ctx, strategy);\n        return;\n      }\n\n      await ctx.render(loginModuleDescriptor);\n    },\n\n    async loginResponse(ctx) {\n      if (ctx.state.connected) {\n        ctx.redirect(ctx.urlGenerator(homeRouterKey));\n      }\n\n      const strategy = ctx.namedParam('strategy');\n      ctx.assert(strategy);\n\n      const connectedUser = await authenticationService.accessResponse(ctx, strategy);\n      const keyPath: string = usersManager.store.keyPath;\n      await ctx.setConnected(connectedUser[keyPath], connectedUser);\n      ctx.state.connected = connectedUser;\n      await ctx.redirect(ctx.urlGenerator(homeRouterKey));\n    },\n\n    async logout(ctx) {\n      ctx.logout();\n      await ctx.redirect(ctx.urlGenerator(homeRouterKey));\n    },\n  };\n}\n"]}