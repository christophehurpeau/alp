{"version":3,"file":"index-browsermodern-dev.es.js","sources":["../src/browserStoredConfig.ts","../src/index.ts"],"sourcesContent":["import deepFreeze from 'deep-freeze-es6';\nimport parseJSON from 'parse-json-object-as-map';\nimport stringify from 'stringify-json';\n\nconst LOCAL_STORAGE_NAME = 'alp-browser-config';\n\nconst map = (() => {\n  const config = localStorage.getItem(LOCAL_STORAGE_NAME);\n  if (config === null) {\n    return new Map();\n  }\n\n  return parseJSON(config);\n})();\n\nmap.forEach((value: any) => deepFreeze(value));\n\nexport function getVersion() {\n  return map.get('version');\n}\n\nexport function has(key: string) {\n  return map.has(key);\n}\n\nexport function get(key: string) {\n  return map.get(key);\n}\n\nexport function save() {\n  localStorage.setItem(LOCAL_STORAGE_NAME, stringify(map));\n}\n\nexport function set(key: string, value: any) {\n  map.set(key, value);\n  save();\n}\n\nexport function clear(version: string) {\n  map.clear();\n  map.set('version', version);\n  save();\n}\n","import { POB_ENV } from 'pob-babel';\nimport { BrowserApplicationInCreation } from 'alp-types';\nimport parseJSON from 'parse-json-object-as-map';\nimport deepFreeze from 'deep-freeze-es6';\nimport * as storedConfig from './browserStoredConfig';\n\ntype RawConfig = Map<string, any>;\nconst ExcludesFalsy = (Boolean as any) as <T>(\n  x: T | boolean | null | undefined,\n) => x is T;\n\nfunction fetchConfig(path: string): Promise<RawConfig> {\n  return fetch(`${path}.json`)\n    .then((res) => res.text())\n    .then((text) => (text.startsWith('{') ? parseJSON(text) : new Map()));\n}\n\nexport function getConfig(path: string): Promise<RawConfig> {\n  if (storedConfig.has(path)) {\n    return Promise.resolve(storedConfig.get(path));\n  }\n\n  return fetchConfig(path).then((result: RawConfig) => {\n    deepFreeze(result);\n    storedConfig.set(path, result);\n    return result;\n  });\n}\n\nexport function existsConfig(path: string): Promise<boolean> | boolean {\n  if (storedConfig.has(path)) {\n    return storedConfig.get(path) !== false;\n  }\n  return fetchConfig(path).then((result) => result !== undefined);\n}\n\nconst getOrFetchAppConfig = function(\n  version: string,\n  environment: string,\n  configPath: string,\n) {\n  if (storedConfig.getVersion() === version && storedConfig.has('_appConfig')) {\n    return Promise.resolve(storedConfig.get('_appConfig'));\n  }\n\n  storedConfig.clear(version);\n\n  return Promise.all([\n    fetchConfig(`${configPath}/common`),\n    environment ? fetchConfig(`${configPath}/${environment}`) : undefined,\n    fetchConfig(`${configPath}/local`),\n  ] as Array<Promise<RawConfig | undefined> | undefined>).then(\n    ([config, ...others]: [...Array<RawConfig | undefined>]) => {\n      if (!config) config = new Map();\n      config.set('version', version);\n\n      others.filter(ExcludesFalsy).forEach((jsonConfig) => {\n        jsonConfig.forEach((value: any, key: string) =>\n          (config as RawConfig).set(key, value),\n        );\n      });\n\n      storedConfig.set('_appConfig', config);\n      return deepFreeze(config);\n    },\n  );\n};\n\nexport default function alpConfig(\n  app: BrowserApplicationInCreation,\n  configPath: string,\n) {\n  const version = app.appVersion;\n\n  if (!version) {\n    throw new Error('Missing appVersion');\n  }\n\n  return getOrFetchAppConfig(version, POB_ENV, configPath).then((config) => {\n    app.config = config;\n    app.context.config = config;\n    return config;\n  });\n}\n"],"names":["LOCAL_STORAGE_NAME","map","config","localStorage","getItem","Map","parseJSON","forEach","value","deepFreeze","getVersion","get","has","key","save","setItem","stringify","set","clear","version","ExcludesFalsy","Boolean","fetchConfig","path","fetch","then","res","text","startsWith","getConfig","storedConfig","Promise","resolve","result","existsConfig","undefined","getOrFetchAppConfig","environment","configPath","all","others","filter","jsonConfig","alpConfig","app","appVersion","Error","context"],"mappings":"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"}