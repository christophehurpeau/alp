{"version":3,"file":"index-browser.cjs.js","sources":["../src/browserStoredConfig.ts","../src/index.ts"],"sourcesContent":["import deepFreeze from 'deep-freeze-es6';\nimport parseJSON from 'parse-json-object-as-map';\nimport stringify from 'stringify-json';\n\nconst LOCAL_STORAGE_NAME = 'alp-browser-config';\n\nconst map = (() => {\n  const config = localStorage.getItem(LOCAL_STORAGE_NAME);\n  if (config === null) {\n    return new Map();\n  }\n\n  return parseJSON(config);\n})();\n\nmap.forEach((value: any) => deepFreeze(value));\n\nexport function getVersion() {\n  return map.get('version');\n}\n\nexport function has(key: string) {\n  return map.has(key);\n}\n\nexport function get(key: string) {\n  return map.get(key);\n}\n\nexport function save() {\n  localStorage.setItem(LOCAL_STORAGE_NAME, stringify(map));\n}\n\nexport function set(key: string, value: any) {\n  map.set(key, value);\n  save();\n}\n\nexport function clear(version: string) {\n  map.clear();\n  map.set('version', version);\n  save();\n}\n","import { POB_ENV } from 'pob-babel';\nimport { BrowserApplicationInCreation } from 'alp-types';\nimport parseJSON from 'parse-json-object-as-map';\nimport deepFreeze from 'deep-freeze-es6';\nimport * as storedConfig from './browserStoredConfig';\n\ntype RawConfig = Map<string, any>;\nconst ExcludesFalsy = (Boolean as any) as <T>(\n  x: T | boolean | null | undefined,\n) => x is T;\n\nfunction fetchConfig(path: string): Promise<RawConfig> {\n  return fetch(`${path}.json`)\n    .then((res) => res.text())\n    .then((text) => (text.startsWith('{') ? parseJSON(text) : new Map()));\n}\n\nexport function getConfig(path: string): Promise<RawConfig> {\n  if (storedConfig.has(path)) {\n    return Promise.resolve(storedConfig.get(path));\n  }\n\n  return fetchConfig(path).then((result: RawConfig) => {\n    deepFreeze(result);\n    storedConfig.set(path, result);\n    return result;\n  });\n}\n\nexport function existsConfig(path: string): Promise<boolean> | boolean {\n  if (storedConfig.has(path)) {\n    return storedConfig.get(path) !== false;\n  }\n  return fetchConfig(path).then((result) => result !== undefined);\n}\n\nconst getOrFetchAppConfig = function (\n  version: string,\n  environment: string,\n  configPath: string,\n) {\n  if (storedConfig.getVersion() === version && storedConfig.has('_appConfig')) {\n    return Promise.resolve(storedConfig.get('_appConfig'));\n  }\n\n  storedConfig.clear(version);\n\n  return Promise.all([\n    fetchConfig(`${configPath}/common`),\n    environment ? fetchConfig(`${configPath}/${environment}`) : undefined,\n    fetchConfig(`${configPath}/local`),\n  ] as (Promise<RawConfig | undefined> | undefined)[]).then(\n    ([config, ...others]: [...(RawConfig | undefined)[]]) => {\n      if (!config) config = new Map();\n      config.set('version', version);\n\n      others.filter(ExcludesFalsy).forEach((jsonConfig) => {\n        jsonConfig.forEach((value: any, key: string) =>\n          (config as RawConfig).set(key, value),\n        );\n      });\n\n      storedConfig.set('_appConfig', config);\n      return deepFreeze(config);\n    },\n  );\n};\n\nexport default function alpConfig(\n  app: BrowserApplicationInCreation,\n  configPath: string,\n) {\n  const version = app.appVersion;\n\n  if (!version) {\n    throw new Error('Missing appVersion');\n  }\n\n  return getOrFetchAppConfig(version, POB_ENV, configPath).then((config) => {\n    app.config = config;\n    app.context.config = config;\n    return config;\n  });\n}\n"],"names":["LOCAL_STORAGE_NAME","map","config","localStorage","getItem","Map","parseJSON","forEach","value","deepFreeze","getVersion","get","has","key","save","setItem","stringify","set","clear","version","ExcludesFalsy","Boolean","fetchConfig","path","fetch","then","res","text","startsWith","getConfig","storedConfig","Promise","resolve","result","existsConfig","undefined","getOrFetchAppConfig","environment","configPath","all","others","filter","jsonConfig","alpConfig","app","appVersion","Error","context"],"mappings":";;;;;;;;;;AAIA,IAAMA,kBAAkB,GAAG,oBAA3B;;AAEA,IAAMC,GAAG,GAAI,YAAM;AACjB,MAAMC,MAAM,GAAGC,YAAY,CAACC,OAAb,CAAqBJ,kBAArB,CAAf;;AACA,MAAIE,MAAM,KAAK,IAAf,EAAqB;AACnB,WAAO,IAAIG,GAAJ,EAAP;AACD;;AAED,SAAOC,SAAS,CAACJ,MAAD,CAAhB;AACD,CAPW,EAAZ;;AASAD,GAAG,CAACM,OAAJ,CAAY,UAACC,KAAD;AAAA,SAAgBC,UAAU,CAACD,KAAD,CAA1B;AAAA,CAAZ;AAEO,SAASE,UAAT,GAAsB;AAC3B,SAAOT,GAAG,CAACU,GAAJ,CAAQ,SAAR,CAAP;AACD;AAEM,SAASC,GAAT,CAAaC,GAAb,EAA0B;AAC/B,SAAOZ,GAAG,CAACW,GAAJ,CAAQC,GAAR,CAAP;AACD;AAEM,SAASF,GAAT,CAAaE,GAAb,EAA0B;AAC/B,SAAOZ,GAAG,CAACU,GAAJ,CAAQE,GAAR,CAAP;AACD;AAEM,SAASC,IAAT,GAAgB;AACrBX,EAAAA,YAAY,CAACY,OAAb,CAAqBf,kBAArB,EAAyCgB,SAAS,CAACf,GAAD,CAAlD;AACD;AAEM,SAASgB,GAAT,CAAaJ,GAAb,EAA0BL,KAA1B,EAAsC;AAC3CP,EAAAA,GAAG,CAACgB,GAAJ,CAAQJ,GAAR,EAAaL,KAAb;AACAM,EAAAA,IAAI;AACL;AAEM,SAASI,KAAT,CAAeC,OAAf,EAAgC;AACrClB,EAAAA,GAAG,CAACiB,KAAJ;AACAjB,EAAAA,GAAG,CAACgB,GAAJ,CAAQ,SAAR,EAAmBE,OAAnB;AACAL,EAAAA,IAAI;AACL;;ACnCD,IAAMM,aAAa,GAAIC,OAAvB;;AAIA,SAASC,WAAT,CAAqBC,IAArB,EAAuD;AACrD,SAAOC,KAAK,CAAID,IAAJ,WAAL,CACJE,IADI,CACC,UAACC,GAAD;AAAA,WAASA,GAAG,CAACC,IAAJ,EAAT;AAAA,GADD,EAEJF,IAFI,CAEC,UAACE,IAAD;AAAA,WAAWA,IAAI,CAACC,UAAL,CAAgB,GAAhB,IAAuBtB,SAAS,CAACqB,IAAD,CAAhC,GAAyC,IAAItB,GAAJ,EAApD;AAAA,GAFD,CAAP;AAGD;;AAED,AAAO,SAASwB,SAAT,CAAmBN,IAAnB,EAAqD;AAC1D,MAAIO,GAAA,CAAiBP,IAAjB,CAAJ,EAA4B;AAC1B,WAAOQ,OAAO,CAACC,OAAR,CAAgBF,GAAA,CAAiBP,IAAjB,CAAhB,CAAP;AACD;;AAED,SAAOD,WAAW,CAACC,IAAD,CAAX,CAAkBE,IAAlB,CAAuB,UAACQ,MAAD,EAAuB;AACnDxB,IAAAA,UAAU,CAACwB,MAAD,CAAV;AACAH,IAAAA,GAAA,CAAiBP,IAAjB,EAAuBU,MAAvB;AACA,WAAOA,MAAP;AACD,GAJM,CAAP;AAKD;AAED,AAAO,SAASC,YAAT,CAAsBX,IAAtB,EAAgE;AACrE,MAAIO,GAAA,CAAiBP,IAAjB,CAAJ,EAA4B;AAC1B,WAAOO,GAAA,CAAiBP,IAAjB,MAA2B,KAAlC;AACD;;AACD,SAAOD,WAAW,CAACC,IAAD,CAAX,CAAkBE,IAAlB,CAAuB,UAACQ,MAAD;AAAA,WAAYA,MAAM,KAAKE,SAAvB;AAAA,GAAvB,CAAP;AACD;;AAED,IAAMC,mBAAmB,GAAG,SAAtBA,mBAAsB,CAC1BjB,OAD0B,EAE1BkB,WAF0B,EAG1BC,UAH0B,EAI1B;AACA,MAAIR,UAAA,OAA8BX,OAA9B,IAAyCW,GAAA,CAAiB,YAAjB,CAA7C,EAA6E;AAC3E,WAAOC,OAAO,CAACC,OAAR,CAAgBF,GAAA,CAAiB,YAAjB,CAAhB,CAAP;AACD;;AAEDA,EAAAA,KAAA,CAAmBX,OAAnB;AAEA,SAAOY,OAAO,CAACQ,GAAR,CAAY,CACjBjB,WAAW,CAAIgB,UAAJ,aADM,EAEjBD,WAAW,GAAGf,WAAW,CAAIgB,UAAJ,SAAkBD,WAAlB,CAAd,GAAiDF,SAF3C,EAGjBb,WAAW,CAAIgB,UAAJ,YAHM,CAAZ,EAI8Cb,IAJ9C,CAKL,gBAAyD;AAAA,QAAvDvB,MAAuD;AAAA,QAA5CsC,MAA4C;;AACvD,QAAI,CAACtC,MAAL,EAAaA,MAAM,GAAG,IAAIG,GAAJ,EAAT;AACbH,IAAAA,MAAM,CAACe,GAAP,CAAW,SAAX,EAAsBE,OAAtB;AAEAqB,IAAAA,MAAM,CAACC,MAAP,CAAcrB,aAAd,EAA6Bb,OAA7B,CAAqC,UAACmC,UAAD,EAAgB;AACnDA,MAAAA,UAAU,CAACnC,OAAX,CAAmB,UAACC,KAAD,EAAaK,GAAb;AAAA,eAChBX,MAAD,CAAsBe,GAAtB,CAA0BJ,GAA1B,EAA+BL,KAA/B,CADiB;AAAA,OAAnB;AAGD,KAJD;AAMAsB,IAAAA,GAAA,CAAiB,YAAjB,EAA+B5B,MAA/B;AACA,WAAOO,UAAU,CAACP,MAAD,CAAjB;AACD,GAjBI,CAAP;AAmBD,CA9BD;;AAgCA,AAAe,SAASyC,SAAT,CACbC,GADa,EAEbN,UAFa,EAGb;AACA,MAAMnB,OAAO,GAAGyB,GAAG,CAACC,UAApB;;AAEA,MAAI,CAAC1B,OAAL,EAAc;AACZ,UAAM,IAAI2B,KAAJ,CAAU,oBAAV,CAAN;AACD;;AAED,SAAOV,mBAAmB,CAACjB,OAAD,gBAAmBmB,UAAnB,CAAnB,CAAkDb,IAAlD,CAAuD,UAACvB,MAAD,EAAY;AACxE0C,IAAAA,GAAG,CAAC1C,MAAJ,GAAaA,MAAb;AACA0C,IAAAA,GAAG,CAACG,OAAJ,CAAY7C,MAAZ,GAAqBA,MAArB;AACA,WAAOA,MAAP;AACD,GAJM,CAAP;AAKD;;;;;;"}