{"version":3,"file":"index-node10-dev.es.js","sources":["../src/index.ts"],"sourcesContent":["import { existsSync, readFileSync } from 'fs';\nimport argv from 'minimist-argv';\nimport deepFreeze from 'deep-freeze-es6';\nimport parseJSON from 'parse-json-object-as-map';\nimport { NodeApplication, NodeConfig, PackageConfig } from 'alp-types';\n\nfunction _existsConfigSync(dirname: string, name: string) {\n  return existsSync(`${dirname}${name}.json`);\n}\n\nfunction _loadConfigSync(dirname: string, name: string) {\n  const content = readFileSync(`${dirname}${name}.json`, 'utf-8');\n  return parseJSON(content);\n}\n\nexport interface ConfigOptions {\n  argv?: Array<string>;\n  packageConfig?: PackageConfig;\n  version?: string;\n}\n\nexport class Config {\n  packageConfig?: PackageConfig;\n\n  private _map: Map<string, any>;\n\n  private _dirname: string;\n\n  constructor(dirname: string, options?: ConfigOptions) {\n    this._map = new Map();\n    this._dirname = dirname.replace(/\\/*$/, '/');\n    if (options) {\n      this.loadSync(options);\n    }\n  }\n\n  loadSync(options: ConfigOptions = {}): Config & NodeConfig {\n    const env = process.env.CONFIG_ENV || process.env.NODE_ENV || 'development';\n    const { argv: argvOverrides = [], packageConfig, version } = options;\n    this.packageConfig = packageConfig;\n\n    const config = this.loadConfigSync('common');\n    // eslint-disable-next-line no-restricted-syntax\n    for (const [key, value] of this.loadConfigSync(env)) {\n      config.set(key, value);\n    }\n\n    if (this.existsConfigSync('local')) {\n      // eslint-disable-next-line no-restricted-syntax\n      for (const [key, value] of this.loadConfigSync('local')) {\n        config.set(key, value);\n      }\n    }\n\n    if (config.has('version')) {\n      throw new Error('Cannot have \"version\", in config.');\n    }\n\n    config.set(\n      'version',\n      version || argv.version || (packageConfig && packageConfig.version),\n    );\n\n    const socketPath = argv['socket-path'] || argv.socketPath;\n    if (socketPath) {\n      config.set('socketPath', socketPath);\n    } else if (argv.port) {\n      config.set('port', argv.port);\n      config.delete('socketPath');\n    } else if (process.env.PORT) {\n      config.set('port', Number(process.env.PORT));\n      config.delete('socketPath');\n    }\n\n    argvOverrides.forEach((key) => {\n      const splitted = key.split('.');\n      const value =\n        splitted.length !== 0 &&\n        splitted.reduce(\n          (config, partialKey) => config && config[partialKey],\n          argv,\n        );\n      if (value !== undefined) {\n        const last = splitted.pop();\n        const map =\n          splitted.length === 0\n            ? config\n            : splitted.reduce(\n                (config, partialKey) => config.get(partialKey),\n                config,\n              );\n        map.set(last as string, value);\n      }\n    });\n\n    this._map = deepFreeze(config);\n    return this as Config & NodeConfig;\n  }\n\n  get(key: string): any {\n    return this._map.get(key);\n  }\n\n  existsConfigSync(name: string): boolean {\n    return _existsConfigSync(this._dirname, name);\n  }\n\n  loadConfigSync(name: string): Map<string, any> {\n    return _loadConfigSync(this._dirname, name);\n  }\n}\n\nexport default (app: NodeApplication, config: Config & NodeConfig) => config;\n"],"names":["_existsConfigSync","dirname","name","existsSync","_loadConfigSync","content","readFileSync","parseJSON","Config","constructor","options","_map","Map","_dirname","replace","loadSync","env","process","CONFIG_ENV","NODE_ENV","argv","argvOverrides","packageConfig","version","config","loadConfigSync","key","value","set","existsConfigSync","has","Error","socketPath","port","delete","PORT","Number","forEach","splitted","split","length","reduce","partialKey","undefined","last","pop","map","get","deepFreeze","app"],"mappings":"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"}