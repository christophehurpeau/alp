{"version":3,"file":"index-node10.cjs.js","sources":["../src/index.ts"],"sourcesContent":["import { existsSync, readFileSync } from 'fs';\nimport argv from 'minimist-argv';\nimport deepFreeze from 'deep-freeze-es6';\nimport parseJSON from 'parse-json-object-as-map';\nimport { NodeApplication, NodeConfig, PackageConfig } from 'alp-types';\n\nfunction _existsConfigSync(dirname: string, name: string) {\n  return existsSync(`${dirname}${name}.json`);\n}\n\nfunction _loadConfigSync(dirname: string, name: string) {\n  const content = readFileSync(`${dirname}${name}.json`, 'utf-8');\n  return parseJSON(content);\n}\n\nexport interface ConfigOptions {\n  argv?: string[];\n  packageConfig?: PackageConfig;\n  version?: string;\n}\n\nexport class Config {\n  packageConfig?: PackageConfig;\n\n  private _map: Map<string, any>;\n\n  private readonly _dirname: string;\n\n  constructor(dirname: string, options?: ConfigOptions) {\n    this._map = new Map();\n    this._dirname = dirname.replace(/\\/*$/, '/');\n    if (options) {\n      this.loadSync(options);\n    }\n  }\n\n  loadSync(options: ConfigOptions = {}): Config & NodeConfig {\n    const env = process.env.CONFIG_ENV || process.env.NODE_ENV || 'development';\n    const { argv: argvOverrides = [], packageConfig, version } = options;\n    this.packageConfig = packageConfig;\n\n    const config = this.loadConfigSync('common');\n    // eslint-disable-next-line no-restricted-syntax\n    for (const [key, value] of this.loadConfigSync(env)) {\n      config.set(key, value);\n    }\n\n    if (this.existsConfigSync('local')) {\n      // eslint-disable-next-line no-restricted-syntax\n      for (const [key, value] of this.loadConfigSync('local')) {\n        config.set(key, value);\n      }\n    }\n\n    if (config.has('version')) {\n      throw new Error('Cannot have \"version\", in config.');\n    }\n\n    config.set(\n      'version',\n      String(version || argv.version || packageConfig?.version),\n    );\n\n    const socketPath = argv['socket-path'] || argv.socketPath;\n    if (socketPath) {\n      config.set('socketPath', socketPath);\n    } else if (argv.port) {\n      config.set('port', argv.port);\n      config.delete('socketPath');\n    } else if (process.env.PORT) {\n      config.set('port', Number(process.env.PORT));\n      config.delete('socketPath');\n    }\n\n    argvOverrides.forEach((key) => {\n      const splitted = key.split('.');\n      const value =\n        splitted.length !== 0 &&\n        splitted.reduce((config, partialKey) => config?.[partialKey], argv);\n      if (value !== undefined) {\n        const last = splitted.pop() as string;\n        const map =\n          splitted.length === 0\n            ? config\n            : splitted.reduce(\n                (config, partialKey) => config.get(partialKey),\n                config,\n              );\n        map.set(last, value);\n      }\n    });\n\n    this._map = deepFreeze(config);\n    return this as Config & NodeConfig;\n  }\n\n  get(key: string): any {\n    return this._map.get(key);\n  }\n\n  existsConfigSync(name: string): boolean {\n    return _existsConfigSync(this._dirname, name);\n  }\n\n  loadConfigSync(name: string): Map<string, any> {\n    return _loadConfigSync(this._dirname, name);\n  }\n}\n\nexport default function getConfig(\n  app: NodeApplication,\n  config: Config & NodeConfig,\n): Config & NodeConfig {\n  return config;\n}\n"],"names":["_existsConfigSync","dirname","name","existsSync","_loadConfigSync","content","readFileSync","parseJSON","Config","constructor","options","_map","Map","_dirname","replace","loadSync","env","process","CONFIG_ENV","NODE_ENV","argv","argvOverrides","packageConfig","version","config","loadConfigSync","key","value","set","existsConfigSync","has","Error","String","socketPath","port","delete","PORT","Number","forEach","splitted","split","length","reduce","partialKey","undefined","last","pop","map","get","deepFreeze","getConfig","app"],"mappings":"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"}