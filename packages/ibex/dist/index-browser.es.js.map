{"version":3,"file":"index-browser.es.js","sources":["../src/compose.ts","../src/context.ts","../src/request.ts","../src/response.ts","../src/index.ts"],"sourcesContent":["import 'pob-babel';\nimport type {\n  Middleware as ComposeMiddleware,\n  ComposedMiddleware,\n} from 'koa-compose';\n\nexport type Composed<Context> = ComposedMiddleware<Context>;\nexport type Middleware<Context> = ComposeMiddleware<Context>;\n\n// TODO create lib\nexport default function compose<Context>(\n  middlewares: Middleware<Context>[],\n): Composed<Context> {\n  return function (ctx: Context): Promise<any> {\n    let index = -1;\n    return (function dispatch(i: number): Promise<any> {\n      if (i <= index) {\n        return Promise.reject(\n          new Error(!__DEV__ ? undefined : 'next() called multiple times'),\n        );\n      }\n      index = i;\n\n      const fn = middlewares[i];\n\n      let called = false;\n      try {\n        return Promise.resolve(\n          fn.call(ctx, ctx, (): Promise<any> => {\n            if (called) {\n              throw new Error(\n                !__DEV__ ? undefined : 'Cannot call next() more than once.',\n              );\n            }\n            called = true;\n            return dispatch(i + 1);\n          }),\n        );\n      } catch (err) {\n        return Promise.reject(err);\n      }\n    })(0);\n  };\n}\n","const proto = {};\n\nconst defineGetter = (target: string, name: string): void => {\n  Object.defineProperty(proto, name, {\n    get() {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return, @typescript-eslint/no-unsafe-member-access\n      return this[target][name];\n    },\n  });\n};\n\nconst defineAccess = (target: string, name: string): void => {\n  Object.defineProperty(proto, name, {\n    get() {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return, @typescript-eslint/no-unsafe-member-access\n      return this[target][name];\n    },\n    set(value) {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment,  @typescript-eslint/no-unsafe-member-access\n      this[target][name] = value;\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n      return value;\n    },\n  });\n};\n\nconst defineMethod = (target: string, name: string): void => {\n  Object.defineProperty(proto, name, {\n    value(...args: any[]) {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return, @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-call\n      return this[target][name].call(this[target], ...args);\n    },\n  });\n};\n\ndefineAccess('response', 'body');\ndefineMethod('response', 'redirect');\n\ndefineGetter('request', 'host');\ndefineGetter('request', 'hostname');\ndefineGetter('request', 'href');\ndefineGetter('request', 'origin');\ndefineGetter('request', 'path');\ndefineGetter('request', 'protocol');\ndefineGetter('request', 'query');\ndefineGetter('request', 'url');\ndefineGetter('request', 'search');\n\nexport default proto;\n","import type { BaseRequest as KoaBaseRequest } from 'koa';\nimport type Application from '.';\n\nexport interface BaseRequest {\n  readonly url: string;\n  readonly origin: string;\n  readonly href: string;\n  readonly path: string;\n  readonly query: never;\n  readonly querystring: string;\n  readonly search: string;\n  readonly host: string;\n  readonly protocol: string;\n  readonly hostname: string;\n  readonly headers: Record<string, string>;\n\n  accepts: KoaBaseRequest['accepts'];\n  acceptsLanguages: KoaBaseRequest['acceptsLanguages'];\n}\n\nexport interface Request extends BaseRequest {\n  readonly app: Application;\n}\n\nconst request: BaseRequest = {\n  get search() {\n    return window.location.search;\n  },\n  get path() {\n    return window.location.pathname;\n  },\n  get url() {\n    return window.location.pathname + window.location.search;\n  },\n  get origin() {\n    return window.location.origin;\n  },\n  get protocol() {\n    return window.location.protocol;\n  },\n  get query(): never {\n    throw new Error('Use context.searchParams instead.');\n  },\n  get querystring() {\n    return window.location.search;\n  },\n  get href() {\n    return window.location.href;\n  },\n  get host() {\n    return window.location.host;\n  },\n  get hostname() {\n    return window.location.hostname;\n  },\n  get headers(): never {\n    throw new Error('Headers not available in ibex request.');\n  },\n  get accepts(): never {\n    throw new Error('Not implemented.');\n  },\n  get acceptsLanguages(): never {\n    throw new Error('Not implemented.');\n  },\n};\n\nexport default request;\n","import type Application from '.';\n\nexport interface BaseResponse {\n  redirect: (url: string) => Promise<void>;\n}\n\nexport interface Response extends BaseResponse {\n  readonly app: Application;\n}\n\nconst response: BaseResponse = {\n  redirect(this: Response, url: string): Promise<void> {\n    if (!this.app.emit('redirect', url)) {\n      window.location.href = url;\n      return new Promise(() => {\n        // promise that never resolves.\n      });\n    }\n\n    return Promise.resolve();\n  },\n};\n\nexport default response;\n","import { EventEmitter } from 'events';\nimport type { BaseContext as KoaBaseContext } from 'koa';\nimport { Logger } from 'nightingale-logger';\nimport type { Composed, Middleware as ComposeMiddleware } from './compose';\nimport compose from './compose';\nimport context from './context';\nimport type { Request } from './request';\nimport request from './request';\nimport type { Response } from './response';\nimport response from './response';\n\nexport interface BaseContext extends KoaBaseContext {\n  app: Application;\n  redirect: (url: string) => Promise<void>;\n}\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\nexport interface DefaultState {}\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\nexport interface DefaultSanitizedState {}\n\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\nexport interface BaseRequest extends Request {}\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\nexport interface BaseResponse extends Response {}\n\nexport interface Context extends BaseContext {\n  request: BaseRequest;\n  response: BaseResponse;\n  req: never;\n  res: never;\n  originalUrl: string;\n  cookies: never;\n  state: DefaultState;\n  sanitizedState: DefaultSanitizedState;\n  respond?: boolean;\n}\n\nexport type Middleware = ComposeMiddleware<Context>;\n\nconst logger = new Logger('ibex');\n\nfunction respond(ctx: Context): void {\n  // allow bypassing\n  if (ctx.respond === false) {\n    return;\n  }\n\n  const body: unknown = ctx.body;\n  if (body == null) return;\n\n  // const code = ctx.status;\n\n  if (typeof body === 'string') {\n    document.body.innerHTML = body;\n    return;\n  }\n\n  if ((body as Node).nodeType) {\n    document.body.innerHTML = '';\n    document.body.append(body as Node);\n  }\n\n  throw new Error('Invalid body result');\n}\n\nexport default class Application extends EventEmitter {\n  middleware: Middleware[] = [];\n\n  context: BaseContext = Object.create(context) as BaseContext;\n\n  request: BaseRequest = Object.create(request) as BaseRequest;\n\n  response: BaseResponse = Object.create(response) as BaseResponse;\n\n  callback?: Composed<Context>;\n\n  constructor() {\n    super();\n    this.context.app = this;\n  }\n\n  use(fn: Middleware): this {\n    logger.debug('use', { name: fn.name || '-' });\n    this.middleware.push(fn);\n    return this;\n  }\n\n  onerror(e: unknown): void {\n    logger.error(e as Error);\n  }\n\n  run(url?: string): void {\n    if (this.listeners('error').length === 0) {\n      this.on('error', this.onerror);\n    }\n\n    this.callback = compose(this.middleware);\n\n    if (url) {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      this.load(url);\n    }\n  }\n\n  createContext(): Context {\n    const ctx: Context = Object.create(this.context) as Context;\n    ctx.request = Object.create(this.request) as Request;\n    ctx.response = Object.create(this.response) as Response;\n    Object.assign(ctx.request, { app: this });\n    Object.assign(ctx.response, { app: this });\n    ctx.state = {};\n    ctx.sanitizedState = {};\n    return ctx;\n  }\n\n  load(url: string): Promise<void> {\n    logger.debug('load', { url });\n\n    if (url.startsWith('?')) {\n      url = window.location.pathname + url;\n    }\n\n    if (!this.callback) {\n      throw new Error('You should call load() after run()');\n    }\n\n    const ctx = this.createContext();\n    return this.callback(ctx)\n      .then(() => {\n        respond(ctx);\n      })\n      .catch((err) => {\n        this.emit('error', err);\n      });\n  }\n}\n"],"names":["compose","middlewares","ctx","index","dispatch","i","Promise","reject","Error","undefined","fn","called","resolve","call","err","proto","defineGetter","target","name","Object","defineProperty","get","defineAccess","set","value","defineMethod","args","request","search","window","location","path","pathname","url","origin","protocol","query","querystring","href","host","hostname","headers","accepts","acceptsLanguages","response","redirect","app","emit","logger","Logger","respond","body","document","innerHTML","nodeType","append","Application","middleware","context","create","use","debug","push","onerror","e","error","run","listeners","length","on","callback","load","createContext","assign","state","sanitizedState","startsWith","then","EventEmitter"],"mappings":"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"}