{"version":3,"file":"index-browser.es.js","sources":["../src/compose.ts","../src/context.ts","../src/request.ts","../src/response.ts","../src/index.ts"],"sourcesContent":["import { PRODUCTION } from 'pob-babel';\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport {\n  Middleware as ComposeMiddleware,\n  ComposedMiddleware,\n} from 'koa-compose';\n\nexport type Composed<Context> = ComposedMiddleware<Context>;\nexport type Middleware<Context> = ComposeMiddleware<Context>;\n\n// TODO create lib\nexport default function compose<Context>(\n  middlewares: Array<Middleware<Context>>,\n): Composed<Context> {\n  return function(ctx: Context): Promise<any> {\n    let index = -1;\n    return (function dispatch(i: number): Promise<any> {\n      if (i <= index) {\n        return Promise.reject(\n          new Error(PRODUCTION ? undefined : 'next() called multiple times'),\n        );\n      }\n      index = i;\n\n      const fn = middlewares[i];\n\n      let called = false;\n      try {\n        return Promise.resolve(\n          fn.call(\n            ctx,\n            ctx,\n            (): Promise<any> => {\n              if (called) {\n                throw new Error(\n                  PRODUCTION ? undefined : 'Cannot call next() more than once.',\n                );\n              }\n              called = true;\n              return dispatch(i + 1);\n            },\n          ),\n        );\n      } catch (err) {\n        return Promise.reject(err);\n      }\n    })(0);\n  };\n}\n","import delegate from 'delegates';\n\nconst proto = {};\n\ndelegate(proto, 'response')\n  .access('body')\n  .method('redirect');\n\ndelegate(proto, 'request')\n  .getter('host')\n  .getter('hostname')\n  .getter('href')\n  .getter('origin')\n  .getter('path')\n  .getter('protocol')\n  .getter('query')\n  .getter('url')\n  .getter('search')\n  .getter('searchParams');\n\nexport default proto;\n","import { parse as parseQueryString, ParsedUrlQuery } from 'querystring';\n\nexport interface Request {\n  readonly url: string;\n  readonly origin: string;\n  readonly href: string;\n  readonly path: string;\n  readonly searchParams: URLSearchParams;\n  readonly query: ParsedUrlQuery;\n  readonly search: string;\n  readonly host: string;\n  readonly protocol: string;\n  readonly hostname: string;\n}\n\nconst request: Request = {\n  get search() {\n    return window.location.search;\n  },\n  get path() {\n    return window.location.pathname;\n  },\n  get url() {\n    return window.location.pathname + window.location.search;\n  },\n  get origin() {\n    return window.location.origin;\n  },\n  get protocol() {\n    return window.location.protocol;\n  },\n  get query() {\n    return parseQueryString(window.location.search);\n  },\n  get searchParams() {\n    return new URLSearchParams(\n      window.location.search.length === 0\n        ? window.location.search\n        : window.location.search.substr(1),\n    );\n  },\n  get href() {\n    return window.location.href;\n  },\n  get host() {\n    return window.location.host;\n  },\n  get hostname() {\n    return window.location.hostname;\n  },\n};\n\nexport default request;\n","import Application from '.';\n\nexport interface BaseResponse {\n  redirect(url: string): void;\n}\n\nexport interface Response extends BaseResponse {\n  app: Application;\n}\n\nconst response: BaseResponse = {\n  redirect(this: Response, url: string) {\n    if (this.app.emit('redirect', url) === false) {\n      window.location.href = url;\n    }\n  },\n};\n\nexport default response;\n","import { EventEmitter } from 'events';\nimport Logger from 'nightingale-logger';\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport { BaseContext } from 'koa';\nimport compose, { Composed, Middleware as ComposeMiddleware } from './compose';\nimport context from './context';\nimport request, { Request } from './request';\nimport response, { Response } from './response';\n\nexport interface Context extends BaseContext {\n  app: Application;\n  request: Request;\n  response: Response;\n  req: never;\n  res: never;\n  originalUrl: string;\n  cookies: never;\n  state: { [key: string]: any };\n  sanitizedState: { [key: string]: any };\n  respond?: boolean;\n}\n\nexport type Middleware = ComposeMiddleware<Context>;\n\nconst logger = new Logger('ibex');\n\nfunction respond(ctx: Context) {\n  // allow bypassing\n  if (ctx.respond === false) {\n    return;\n  }\n\n  const body = ctx.body;\n  if (body == null) return;\n\n  // const code = ctx.status;\n\n  if (typeof body === 'string') {\n    document.body.innerHTML = body;\n    return;\n  }\n\n  if (body.nodeType) {\n    document.body.innerHTML = '';\n    document.body.appendChild(body);\n  }\n\n  throw new Error('Invalid body result');\n}\n\nexport default class Application extends EventEmitter {\n  middleware: Middleware[] = [];\n\n  context: Context = Object.create(context);\n\n  callback?: Composed<Context>;\n\n  constructor() {\n    super();\n    this.context.app = this;\n  }\n\n  get environment() {\n    throw new Error('use process.env or POB_ENV instead');\n  }\n\n  use(fn: Middleware) {\n    logger.debug('use', { name: fn.name || '-' });\n    this.middleware.push(fn);\n    return this;\n  }\n\n  onerror(e: any) {\n    logger.error(e);\n  }\n\n  run(url?: string) {\n    if (this.listeners('error').length === 0) {\n      this.on('error', this.onerror);\n    }\n\n    this.callback = compose(this.middleware);\n\n    if (url) {\n      this.load(url);\n    }\n  }\n\n  createContext() {\n    const context = Object.create(this.context);\n    context.request = Object.create(request);\n    context.response = Object.create(response);\n    // eslint-disable-next-line no-multi-assign\n    context.request.app = context.response.app = this;\n    context.state = {};\n    context.sanitizedState = {};\n    return context;\n  }\n\n  load(url: string) {\n    logger.debug('load', { url });\n\n    if (url.startsWith('?')) {\n      url = window.location.pathname + url;\n    }\n\n    if (!this.callback) {\n      throw new Error('You should call load() after run()');\n    }\n\n    const context = this.createContext();\n    return this.callback(context)\n      .then(() => respond(context))\n      .catch((err) => this.emit('error', err));\n  }\n}\n"],"names":["compose","middlewares","ctx","index","dispatch","i","Promise","reject","Error","undefined","fn","called","resolve","call","err","proto","delegate","access","method","getter","request","search","window","location","path","pathname","url","origin","protocol","query","parseQueryString","searchParams","URLSearchParams","length","substr","href","host","hostname","response","redirect","app","emit","logger","Logger","respond","body","document","innerHTML","nodeType","appendChild","Application","middleware","context","Object","create","use","debug","name","push","onerror","e","error","run","listeners","on","callback","load","createContext","state","sanitizedState","startsWith","then","catch","EventEmitter"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAUA;AACA,AAAe,SAASA,OAAT,CACbC,WADa,EAEM;SACZ,UAASC,GAAT,EAAqC;QACtCC,KAAK,GAAG,CAAC,CAAb;WACQ,SAASC,QAAT,CAAkBC,CAAlB,EAA2C;UAC7CA,CAAC,IAAIF,KAAT,EAAgB;eACPG,OAAO,CAACC,MAAR,CACL,IAAIC,KAAJ,CAAuBC,SAAvB,CADK,CAAP;;;MAIFN,KAAK,GAAGE,CAAR;UAEMK,EAAE,GAAGT,WAAW,CAACI,CAAD,CAAtB;UAEIM,MAAM,GAAG,KAAb;;UACI;eACKL,OAAO,CAACM,OAAR,CACLF,EAAE,CAACG,IAAH,CACEX,GADF,EAEEA,GAFF,EAGE,YAAoB;cACdS,MAAJ,EAAY;kBACJ,IAAIH,KAAJ,CACSC,SADT,CAAN;;;UAIFE,MAAM,GAAG,IAAT;iBACOP,QAAQ,CAACC,CAAC,GAAG,CAAL,CAAf;SAVJ,CADK,CAAP;OADF,CAgBE,OAAOS,GAAP,EAAY;eACLR,OAAO,CAACC,MAAR,CAAeO,GAAf,CAAP;;KA5BG,CA8BJ,CA9BI,CAAP;GAFF;;;ACZF,IAAMC,KAAK,GAAG,EAAd;AAEAC,QAAQ,CAACD,KAAD,EAAQ,UAAR,CAAR,CACGE,MADH,CACU,MADV,EAEGC,MAFH,CAEU,UAFV;AAIAF,QAAQ,CAACD,KAAD,EAAQ,SAAR,CAAR,CACGI,MADH,CACU,MADV,EAEGA,MAFH,CAEU,UAFV,EAGGA,MAHH,CAGU,MAHV,EAIGA,MAJH,CAIU,QAJV,EAKGA,MALH,CAKU,MALV,EAMGA,MANH,CAMU,UANV,EAOGA,MAPH,CAOU,OAPV,EAQGA,MARH,CAQU,KARV,EASGA,MATH,CASU,QATV,EAUGA,MAVH,CAUU,cAVV;;ACOA,IAAMC,OAAgB,GAAG;MACnBC,MAAJ,GAAa;WACJC,MAAM,CAACC,QAAP,CAAgBF,MAAvB;GAFqB;;MAInBG,IAAJ,GAAW;WACFF,MAAM,CAACC,QAAP,CAAgBE,QAAvB;GALqB;;MAOnBC,GAAJ,GAAU;WACDJ,MAAM,CAACC,QAAP,CAAgBE,QAAhB,GAA2BH,MAAM,CAACC,QAAP,CAAgBF,MAAlD;GARqB;;MAUnBM,MAAJ,GAAa;WACJL,MAAM,CAACC,QAAP,CAAgBI,MAAvB;GAXqB;;MAanBC,QAAJ,GAAe;WACNN,MAAM,CAACC,QAAP,CAAgBK,QAAvB;GAdqB;;MAgBnBC,KAAJ,GAAY;WACHC,KAAgB,CAACR,MAAM,CAACC,QAAP,CAAgBF,MAAjB,CAAvB;GAjBqB;;MAmBnBU,YAAJ,GAAmB;WACV,IAAIC,eAAJ,CACLV,MAAM,CAACC,QAAP,CAAgBF,MAAhB,CAAuBY,MAAvB,KAAkC,CAAlC,GACIX,MAAM,CAACC,QAAP,CAAgBF,MADpB,GAEIC,MAAM,CAACC,QAAP,CAAgBF,MAAhB,CAAuBa,MAAvB,CAA8B,CAA9B,CAHC,CAAP;GApBqB;;MA0BnBC,IAAJ,GAAW;WACFb,MAAM,CAACC,QAAP,CAAgBY,IAAvB;GA3BqB;;MA6BnBC,IAAJ,GAAW;WACFd,MAAM,CAACC,QAAP,CAAgBa,IAAvB;GA9BqB;;MAgCnBC,QAAJ,GAAe;WACNf,MAAM,CAACC,QAAP,CAAgBc,QAAvB;;;CAjCJ;;ACLA,IAAMC,QAAsB,GAAG;EAC7BC,QAD6B,oBACJb,GADI,EACS;QAChC,KAAKc,GAAL,CAASC,IAAT,CAAc,UAAd,EAA0Bf,GAA1B,MAAmC,KAAvC,EAA8C;MAC5CJ,MAAM,CAACC,QAAP,CAAgBY,IAAhB,GAAuBT,GAAvB;;;CAHN;;ACcA,IAAMgB,MAAM,GAAG,IAAIC,MAAJ,CAAW,MAAX,CAAf;;AAEA,SAASC,OAAT,CAAiB1C,GAAjB,EAA+B;;MAEzBA,GAAG,CAAC0C,OAAJ,KAAgB,KAApB,EAA2B;;;;MAIrBC,IAAI,GAAG3C,GAAG,CAAC2C,IAAjB;MACIA,IAAI,IAAI,IAAZ,EAAkB,OAPW;;MAWzB,OAAOA,IAAP,KAAgB,QAApB,EAA8B;IAC5BC,QAAQ,CAACD,IAAT,CAAcE,SAAd,GAA0BF,IAA1B;;;;MAIEA,IAAI,CAACG,QAAT,EAAmB;IACjBF,QAAQ,CAACD,IAAT,CAAcE,SAAd,GAA0B,EAA1B;IACAD,QAAQ,CAACD,IAAT,CAAcI,WAAd,CAA0BJ,IAA1B;;;QAGI,IAAIrC,KAAJ,CAAU,qBAAV,CAAN;;;IAGmB0C;;;;;yBAOL;gBACZ,wBADY;;UANdC,UAMc,GANa,EAMb;UAJdC,OAIc,GAJKC,MAAM,CAACC,MAAP,CAAcF,KAAd,CAIL;UAEPA,OAAL,CAAaZ,GAAb;;;;;;SAOFe,MAAA,aAAI7C,EAAJ,EAAoB;IAClBgC,MAAM,CAACc,KAAP,CAAa,KAAb,EAAoB;MAAEC,IAAI,EAAE/C,EAAE,CAAC+C,IAAH,IAAW;KAAvC;SACKN,UAAL,CAAgBO,IAAhB,CAAqBhD,EAArB;WACO,IAAP;;;SAGFiD,UAAA,iBAAQC,CAAR,EAAgB;IACdlB,MAAM,CAACmB,KAAP,CAAaD,CAAb;;;SAGFE,MAAA,aAAIpC,GAAJ,EAAkB;QACZ,KAAKqC,SAAL,CAAe,OAAf,EAAwB9B,MAAxB,KAAmC,CAAvC,EAA0C;WACnC+B,EAAL,CAAQ,OAAR,EAAiB,KAAKL,OAAtB;;;SAGGM,QAAL,GAAgBjE,OAAO,CAAC,KAAKmD,UAAN,CAAvB;;QAEIzB,GAAJ,EAAS;WACFwC,IAAL,CAAUxC,GAAV;;;;SAIJyC,gBAAA,yBAAgB;QACRf,OAAO,GAAGC,MAAM,CAACC,MAAP,CAAc,KAAKF,OAAnB,CAAhB;IACAA,OAAO,CAAChC,OAAR,GAAkBiC,MAAM,CAACC,MAAP,CAAclC,OAAd,CAAlB;IACAgC,OAAO,CAACd,QAAR,GAAmBe,MAAM,CAACC,MAAP,CAAchB,QAAd,CAAnB,CAHc;;IAKdc,OAAO,CAAChC,OAAR,CAAgBoB,GAAhB,GAAsBY,OAAO,CAACd,QAAR,CAAiBE,GAAjB,GAAuB,IAA7C;IACAY,OAAO,CAACgB,KAAR,GAAgB,EAAhB;IACAhB,OAAO,CAACiB,cAAR,GAAyB,EAAzB;WACOjB,OAAP;;;SAGFc,OAAA,cAAKxC,GAAL,EAAkB;;;IAChBgB,MAAM,CAACc,KAAP,CAAa,MAAb,EAAqB;MAAE9B,GAAG,EAAHA;KAAvB;;QAEIA,GAAG,CAAC4C,UAAJ,CAAe,GAAf,CAAJ,EAAyB;MACvB5C,GAAG,GAAGJ,MAAM,CAACC,QAAP,CAAgBE,QAAhB,GAA2BC,GAAjC;;;QAGE,CAAC,KAAKuC,QAAV,EAAoB;YACZ,IAAIzD,KAAJ,CAAU,oCAAV,CAAN;;;QAGI4C,OAAO,GAAG,KAAKe,aAAL,EAAhB;WACO,KAAKF,QAAL,CAAcb,OAAd,EACJmB,IADI,CACC;aAAM3B,OAAO,CAACQ,OAAD,CAAb;KADD,EAEJoB,KAFI,CAEE,UAAC1D,GAAD;aAAS,MAAI,CAAC2B,IAAL,CAAU,OAAV,EAAmB3B,GAAnB,CAAT;KAFF,CAAP;;;;;wBAjDgB;YACV,IAAIN,KAAJ,CAAU,oCAAV,CAAN;;;;;EAbqCiE;;;;"}