{"version":3,"file":"index-browser.cjs.js","sources":["../src/compose.ts","../src/context.ts","../src/request.ts","../src/response.ts","../src/index.ts"],"sourcesContent":["import { PRODUCTION } from 'pob-babel';\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport {\n  Middleware as ComposeMiddleware,\n  ComposedMiddleware,\n} from 'koa-compose';\n\nexport type Composed<Context> = ComposedMiddleware<Context>;\nexport type Middleware<Context> = ComposeMiddleware<Context>;\n\n// TODO create lib\nexport default function compose<Context>(\n  middlewares: Middleware<Context>[],\n): Composed<Context> {\n  return function (ctx: Context): Promise<any> {\n    let index = -1;\n    return (function dispatch(i: number): Promise<any> {\n      if (i <= index) {\n        return Promise.reject(\n          new Error(PRODUCTION ? undefined : 'next() called multiple times'),\n        );\n      }\n      index = i;\n\n      const fn = middlewares[i];\n\n      let called = false;\n      try {\n        return Promise.resolve(\n          fn.call(\n            ctx,\n            ctx,\n            (): Promise<any> => {\n              if (called) {\n                throw new Error(\n                  PRODUCTION ? undefined : 'Cannot call next() more than once.',\n                );\n              }\n              called = true;\n              return dispatch(i + 1);\n            },\n          ),\n        );\n      } catch (err) {\n        return Promise.reject(err);\n      }\n    })(0);\n  };\n}\n","const proto = {};\n\nconst defineGetter = (target: string, name: string) => {\n  Object.defineProperty(proto, name, {\n    get() {\n      return this[target][name];\n    },\n  });\n};\n\nconst defineAccess = (target: string, name: string) => {\n  Object.defineProperty(proto, name, {\n    get() {\n      return this[target][name];\n    },\n    set(value) {\n      this[target][name] = value;\n      return value;\n    },\n  });\n};\n\nconst defineMethod = (target: string, name: string) => {\n  Object.defineProperty(proto, name, {\n    value(...args: any[]) {\n      return this[target][name].call(this[target], ...args);\n    },\n  });\n};\n\ndefineAccess('response', 'body');\ndefineMethod('response', 'redirect');\n\ndefineGetter('request', 'host');\ndefineGetter('request', 'hostname');\ndefineGetter('request', 'href');\ndefineGetter('request', 'origin');\ndefineGetter('request', 'path');\ndefineGetter('request', 'protocol');\ndefineGetter('request', 'query');\ndefineGetter('request', 'url');\ndefineGetter('request', 'search');\ndefineGetter('request', 'searchParams');\n\nexport default proto;\n","import { parse as parseQueryString, ParsedUrlQuery } from 'querystring';\n\nexport interface Request {\n  readonly url: string;\n  readonly origin: string;\n  readonly href: string;\n  readonly path: string;\n  readonly searchParams: URLSearchParams;\n  readonly query: ParsedUrlQuery;\n  readonly search: string;\n  readonly host: string;\n  readonly protocol: string;\n  readonly hostname: string;\n}\n\nconst request: Request = {\n  get search() {\n    return window.location.search;\n  },\n  get path() {\n    return window.location.pathname;\n  },\n  get url() {\n    return window.location.pathname + window.location.search;\n  },\n  get origin() {\n    return window.location.origin;\n  },\n  get protocol() {\n    return window.location.protocol;\n  },\n  get query() {\n    return window.location.search.length === 0\n      ? {}\n      : parseQueryString(window.location.search.slice(1));\n  },\n  get searchParams() {\n    return new URLSearchParams(\n      window.location.search.length === 0\n        ? window.location.search\n        : window.location.search.slice(1),\n    );\n  },\n  get href() {\n    return window.location.href;\n  },\n  get host() {\n    return window.location.host;\n  },\n  get hostname() {\n    return window.location.hostname;\n  },\n};\n\nexport default request;\n","import Application from '.';\n\nexport interface BaseResponse {\n  redirect(url: string): void;\n}\n\nexport interface Response extends BaseResponse {\n  app: Application;\n}\n\nconst response: BaseResponse = {\n  redirect(this: Response, url: string) {\n    if (this.app.emit('redirect', url) === false) {\n      window.location.href = url;\n    }\n  },\n};\n\nexport default response;\n","import { EventEmitter } from 'events';\nimport Logger from 'nightingale-logger';\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport { BaseContext } from 'koa';\nimport compose, { Composed, Middleware as ComposeMiddleware } from './compose';\nimport context from './context';\nimport request, { Request } from './request';\nimport response, { Response } from './response';\n\nexport interface Context extends BaseContext {\n  app: Application;\n  request: Request;\n  response: Response;\n  req: never;\n  res: never;\n  originalUrl: string;\n  cookies: never;\n  state: { [key: string]: any };\n  sanitizedState: { [key: string]: any };\n  respond?: boolean;\n}\n\nexport type Middleware = ComposeMiddleware<Context>;\n\nconst logger = new Logger('ibex');\n\nfunction respond(ctx: Context) {\n  // allow bypassing\n  if (ctx.respond === false) {\n    return;\n  }\n\n  const body = ctx.body;\n  if (body == null) return;\n\n  // const code = ctx.status;\n\n  if (typeof body === 'string') {\n    document.body.innerHTML = body;\n    return;\n  }\n\n  if (body.nodeType) {\n    document.body.innerHTML = '';\n    document.body.append(body);\n  }\n\n  throw new Error('Invalid body result');\n}\n\nexport default class Application extends EventEmitter {\n  middleware: Middleware[] = [];\n\n  context: Context = Object.create(context);\n\n  callback?: Composed<Context>;\n\n  constructor() {\n    super();\n    this.context.app = this;\n  }\n\n  get environment() {\n    throw new Error('use process.env or POB_ENV instead');\n  }\n\n  use(fn: Middleware) {\n    logger.debug('use', { name: fn.name || '-' });\n    this.middleware.push(fn);\n    return this;\n  }\n\n  onerror(e: any) {\n    logger.error(e);\n  }\n\n  run(url?: string) {\n    if (this.listeners('error').length === 0) {\n      this.on('error', this.onerror);\n    }\n\n    this.callback = compose(this.middleware);\n\n    if (url) {\n      this.load(url);\n    }\n  }\n\n  createContext() {\n    const context = Object.create(this.context);\n    context.request = Object.create(request);\n    context.response = Object.create(response);\n    // eslint-disable-next-line no-multi-assign\n    context.request.app = context.response.app = this;\n    context.state = {};\n    context.sanitizedState = {};\n    return context;\n  }\n\n  load(url: string) {\n    logger.debug('load', { url });\n\n    if (url.startsWith('?')) {\n      url = window.location.pathname + url;\n    }\n\n    if (!this.callback) {\n      throw new Error('You should call load() after run()');\n    }\n\n    const context = this.createContext();\n    return this.callback(context)\n      .then(() => respond(context))\n      .catch((err) => this.emit('error', err));\n  }\n}\n"],"names":["compose","middlewares","ctx","index","dispatch","i","Promise","reject","Error","undefined","fn","called","resolve","call","err","proto","defineGetter","target","name","Object","defineProperty","get","defineAccess","set","value","defineMethod","args","request","search","window","location","path","pathname","url","origin","protocol","query","length","parseQueryString","slice","searchParams","URLSearchParams","href","host","hostname","response","redirect","app","emit","logger","Logger","respond","body","document","innerHTML","nodeType","append","Application","middleware","context","create","use","debug","push","onerror","e","error","run","listeners","on","callback","load","createContext","state","sanitizedState","startsWith","then","catch","EventEmitter"],"mappings":";;;;;;;;;;;;;AAUA;AACe,SAASA,OAAT,CACbC,WADa,EAEM;AACnB,SAAO,UAAUC,GAAV,EAAsC;AAC3C,QAAIC,KAAK,GAAG,CAAC,CAAb;AACA,WAAQ,SAASC,QAAT,CAAkBC,CAAlB,EAA2C;AACjD,UAAIA,CAAC,IAAIF,KAAT,EAAgB;AACd,eAAOG,OAAO,CAACC,MAAR,CACL,IAAIC,KAAJ,CAAuBC,SAAvB,CADK,CAAP;AAGD;;AACDN,MAAAA,KAAK,GAAGE,CAAR;AAEA,UAAMK,EAAE,GAAGT,WAAW,CAACI,CAAD,CAAtB;AAEA,UAAIM,MAAM,GAAG,KAAb;;AACA,UAAI;AACF,eAAOL,OAAO,CAACM,OAAR,CACLF,EAAE,CAACG,IAAH,CACEX,GADF,EAEEA,GAFF,EAGE,YAAoB;AAClB,cAAIS,MAAJ,EAAY;AACV,kBAAM,IAAIH,KAAJ,CACSC,SADT,CAAN;AAGD;;AACDE,UAAAA,MAAM,GAAG,IAAT;AACA,iBAAOP,QAAQ,CAACC,CAAC,GAAG,CAAL,CAAf;AACD,SAXH,CADK,CAAP;AAeD,OAhBD,CAgBE,OAAOS,GAAP,EAAY;AACZ,eAAOR,OAAO,CAACC,MAAR,CAAeO,GAAf,CAAP;AACD;AACF,KA9BM,CA8BJ,CA9BI,CAAP;AA+BD,GAjCD;AAkCD;;AChDD,IAAMC,KAAK,GAAG,EAAd;;AAEA,IAAMC,YAAY,GAAG,SAAfA,YAAe,CAACC,MAAD,EAAiBC,IAAjB,EAAkC;AACrDC,EAAAA,MAAM,CAACC,cAAP,CAAsBL,KAAtB,EAA6BG,IAA7B,EAAmC;AACjCG,IAAAA,GADiC,iBAC3B;AACJ,aAAO,KAAKJ,MAAL,EAAaC,IAAb,CAAP;AACD;AAHgC,GAAnC;AAKD,CAND;;AAQA,IAAMI,YAAY,GAAG,SAAfA,YAAe,CAACL,MAAD,EAAiBC,IAAjB,EAAkC;AACrDC,EAAAA,MAAM,CAACC,cAAP,CAAsBL,KAAtB,EAA6BG,IAA7B,EAAmC;AACjCG,IAAAA,GADiC,iBAC3B;AACJ,aAAO,KAAKJ,MAAL,EAAaC,IAAb,CAAP;AACD,KAHgC;AAIjCK,IAAAA,GAJiC,eAI7BC,KAJ6B,EAItB;AACT,WAAKP,MAAL,EAAaC,IAAb,IAAqBM,KAArB;AACA,aAAOA,KAAP;AACD;AAPgC,GAAnC;AASD,CAVD;;AAYA,IAAMC,YAAY,GAAG,SAAfA,YAAe,CAACR,MAAD,EAAiBC,IAAjB,EAAkC;AACrDC,EAAAA,MAAM,CAACC,cAAP,CAAsBL,KAAtB,EAA6BG,IAA7B,EAAmC;AACjCM,IAAAA,KADiC,mBACX;AAAA,mCAAbE,IAAa;;AAAA,oCAAbA,IAAa;AAAbA,QAAAA,IAAa;AAAA;;AACpB,aAAO,0BAAKT,MAAL,EAAaC,IAAb,GAAmBL,IAAnB,2BAAwB,KAAKI,MAAL,CAAxB,SAAyCS,IAAzC,EAAP;AACD;AAHgC,GAAnC;AAKD,CAND;;AAQAJ,YAAY,CAAC,UAAD,EAAa,MAAb,CAAZ;AACAG,YAAY,CAAC,UAAD,EAAa,UAAb,CAAZ;AAEAT,YAAY,CAAC,SAAD,EAAY,MAAZ,CAAZ;AACAA,YAAY,CAAC,SAAD,EAAY,UAAZ,CAAZ;AACAA,YAAY,CAAC,SAAD,EAAY,MAAZ,CAAZ;AACAA,YAAY,CAAC,SAAD,EAAY,QAAZ,CAAZ;AACAA,YAAY,CAAC,SAAD,EAAY,MAAZ,CAAZ;AACAA,YAAY,CAAC,SAAD,EAAY,UAAZ,CAAZ;AACAA,YAAY,CAAC,SAAD,EAAY,OAAZ,CAAZ;AACAA,YAAY,CAAC,SAAD,EAAY,KAAZ,CAAZ;AACAA,YAAY,CAAC,SAAD,EAAY,QAAZ,CAAZ;AACAA,YAAY,CAAC,SAAD,EAAY,cAAZ,CAAZ;;AC3BA,IAAMW,OAAgB,GAAG;AACvB,MAAIC,MAAJ,GAAa;AACX,WAAOC,MAAM,CAACC,QAAP,CAAgBF,MAAvB;AACD,GAHsB;;AAIvB,MAAIG,IAAJ,GAAW;AACT,WAAOF,MAAM,CAACC,QAAP,CAAgBE,QAAvB;AACD,GANsB;;AAOvB,MAAIC,GAAJ,GAAU;AACR,WAAOJ,MAAM,CAACC,QAAP,CAAgBE,QAAhB,GAA2BH,MAAM,CAACC,QAAP,CAAgBF,MAAlD;AACD,GATsB;;AAUvB,MAAIM,MAAJ,GAAa;AACX,WAAOL,MAAM,CAACC,QAAP,CAAgBI,MAAvB;AACD,GAZsB;;AAavB,MAAIC,QAAJ,GAAe;AACb,WAAON,MAAM,CAACC,QAAP,CAAgBK,QAAvB;AACD,GAfsB;;AAgBvB,MAAIC,KAAJ,GAAY;AACV,WAAOP,MAAM,CAACC,QAAP,CAAgBF,MAAhB,CAAuBS,MAAvB,KAAkC,CAAlC,GACH,EADG,GAEHC,iBAAgB,CAACT,MAAM,CAACC,QAAP,CAAgBF,MAAhB,CAAuBW,KAAvB,CAA6B,CAA7B,CAAD,CAFpB;AAGD,GApBsB;;AAqBvB,MAAIC,YAAJ,GAAmB;AACjB,WAAO,IAAIC,eAAJ,CACLZ,MAAM,CAACC,QAAP,CAAgBF,MAAhB,CAAuBS,MAAvB,KAAkC,CAAlC,GACIR,MAAM,CAACC,QAAP,CAAgBF,MADpB,GAEIC,MAAM,CAACC,QAAP,CAAgBF,MAAhB,CAAuBW,KAAvB,CAA6B,CAA7B,CAHC,CAAP;AAKD,GA3BsB;;AA4BvB,MAAIG,IAAJ,GAAW;AACT,WAAOb,MAAM,CAACC,QAAP,CAAgBY,IAAvB;AACD,GA9BsB;;AA+BvB,MAAIC,IAAJ,GAAW;AACT,WAAOd,MAAM,CAACC,QAAP,CAAgBa,IAAvB;AACD,GAjCsB;;AAkCvB,MAAIC,QAAJ,GAAe;AACb,WAAOf,MAAM,CAACC,QAAP,CAAgBc,QAAvB;AACD;;AApCsB,CAAzB;;ACLA,IAAMC,QAAsB,GAAG;AAC7BC,EAAAA,QAD6B,oBACJb,GADI,EACS;AACpC,QAAI,KAAKc,GAAL,CAASC,IAAT,CAAc,UAAd,EAA0Bf,GAA1B,MAAmC,KAAvC,EAA8C;AAC5CJ,MAAAA,MAAM,CAACC,QAAP,CAAgBY,IAAhB,GAAuBT,GAAvB;AACD;AACF;AAL4B,CAA/B;;ACcA,IAAMgB,MAAM,GAAG,IAAIC,MAAJ,CAAW,MAAX,CAAf;;AAEA,SAASC,OAAT,CAAiBjD,GAAjB,EAA+B;AAC7B;AACA,MAAIA,GAAG,CAACiD,OAAJ,KAAgB,KAApB,EAA2B;AACzB;AACD;;AAED,MAAMC,IAAI,GAAGlD,GAAG,CAACkD,IAAjB;AACA,MAAIA,IAAI,IAAI,IAAZ,EAAkB,OAPW;;AAW7B,MAAI,OAAOA,IAAP,KAAgB,QAApB,EAA8B;AAC5BC,IAAAA,QAAQ,CAACD,IAAT,CAAcE,SAAd,GAA0BF,IAA1B;AACA;AACD;;AAED,MAAIA,IAAI,CAACG,QAAT,EAAmB;AACjBF,IAAAA,QAAQ,CAACD,IAAT,CAAcE,SAAd,GAA0B,EAA1B;AACAD,IAAAA,QAAQ,CAACD,IAAT,CAAcI,MAAd,CAAqBJ,IAArB;AACD;;AAED,QAAM,IAAI5C,KAAJ,CAAU,qBAAV,CAAN;AACD;;IAEoBiD;;;AAOnB,yBAAc;AAAA,gBACZ,wBADY;;AAAA,UANdC,UAMc,GANa,EAMb;AAAA,UAJdC,OAIc,GAJKxC,MAAM,CAACyC,MAAP,CAAcD,KAAd,CAIL;AAEZ,UAAKA,OAAL,CAAaZ,GAAb;AAFY;AAGb;;;;SAMDc,MAAA,aAAInD,EAAJ,EAAoB;AAClBuC,IAAAA,MAAM,CAACa,KAAP,CAAa,KAAb,EAAoB;AAAE5C,MAAAA,IAAI,EAAER,EAAE,CAACQ,IAAH,IAAW;AAAnB,KAApB;AACA,SAAKwC,UAAL,CAAgBK,IAAhB,CAAqBrD,EAArB;AACA,WAAO,IAAP;AACD;;SAEDsD,UAAA,iBAAQC,CAAR,EAAgB;AACdhB,IAAAA,MAAM,CAACiB,KAAP,CAAaD,CAAb;AACD;;SAEDE,MAAA,aAAIlC,GAAJ,EAAkB;AAChB,QAAI,KAAKmC,SAAL,CAAe,OAAf,EAAwB/B,MAAxB,KAAmC,CAAvC,EAA0C;AACxC,WAAKgC,EAAL,CAAQ,OAAR,EAAiB,KAAKL,OAAtB;AACD;;AAED,SAAKM,QAAL,GAAgBtE,OAAO,CAAC,KAAK0D,UAAN,CAAvB;;AAEA,QAAIzB,GAAJ,EAAS;AACP,WAAKsC,IAAL,CAAUtC,GAAV;AACD;AACF;;SAEDuC,gBAAA,yBAAgB;AACd,QAAMb,OAAO,GAAGxC,MAAM,CAACyC,MAAP,CAAc,KAAKD,OAAnB,CAAhB;AACAA,IAAAA,OAAO,CAAChC,OAAR,GAAkBR,MAAM,CAACyC,MAAP,CAAcjC,OAAd,CAAlB;AACAgC,IAAAA,OAAO,CAACd,QAAR,GAAmB1B,MAAM,CAACyC,MAAP,CAAcf,QAAd,CAAnB,CAHc;;AAKdc,IAAAA,OAAO,CAAChC,OAAR,CAAgBoB,GAAhB,GAAsBY,OAAO,CAACd,QAAR,CAAiBE,GAAjB,GAAuB,IAA7C;AACAY,IAAAA,OAAO,CAACc,KAAR,GAAgB,EAAhB;AACAd,IAAAA,OAAO,CAACe,cAAR,GAAyB,EAAzB;AACA,WAAOf,OAAP;AACD;;SAEDY,OAAA,cAAKtC,GAAL,EAAkB;AAAA;;AAChBgB,IAAAA,MAAM,CAACa,KAAP,CAAa,MAAb,EAAqB;AAAE7B,MAAAA,GAAG,EAAHA;AAAF,KAArB;;AAEA,QAAIA,GAAG,CAAC0C,UAAJ,CAAe,GAAf,CAAJ,EAAyB;AACvB1C,MAAAA,GAAG,GAAGJ,MAAM,CAACC,QAAP,CAAgBE,QAAhB,GAA2BC,GAAjC;AACD;;AAED,QAAI,CAAC,KAAKqC,QAAV,EAAoB;AAClB,YAAM,IAAI9D,KAAJ,CAAU,oCAAV,CAAN;AACD;;AAED,QAAMmD,OAAO,GAAG,KAAKa,aAAL,EAAhB;AACA,WAAO,KAAKF,QAAL,CAAcX,OAAd,EACJiB,IADI,CACC;AAAA,aAAMzB,OAAO,CAACQ,OAAD,CAAb;AAAA,KADD,EAEJkB,KAFI,CAEE,UAAC/D,GAAD;AAAA,aAAS,MAAI,CAACkC,IAAL,CAAU,OAAV,EAAmBlC,GAAnB,CAAT;AAAA,KAFF,CAAP;AAGD;;;;wBApDiB;AAChB,YAAM,IAAIN,KAAJ,CAAU,oCAAV,CAAN;AACD;;;;EAdsCsE;;;;"}