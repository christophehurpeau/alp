{"version":3,"file":"index-browser.cjs.js","sources":["../src/compose.js","../src/context.js","../src/request.js","../src/response.js","../src/index.js"],"sourcesContent":["// create lib\nexport default function compose(middlewares: Array<Function>) {\n  return function(ctx) {\n    let index = -1;\n    return (function dispatch(i) {\n      if (i <= index) {\n        return Promise.reject(new Error(!PRODUCTION && 'next() called multiple times'));\n      }\n      index = i;\n\n      const fn = middlewares[i];\n\n      let called = false;\n      try {\n        return Promise.resolve(\n          fn.call(ctx, ctx, () => {\n            if (called) throw new Error(!PRODUCTION && 'Cannot call next() more than once.');\n            called = true;\n            return dispatch(i + 1);\n          }),\n        );\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    })(0);\n  };\n}\n","import delegate from 'delegates';\n\nconst proto = {};\n\ndelegate(proto, 'response')\n  .access('body')\n  .method('redirect');\n\ndelegate(proto, 'request')\n  .getter('host')\n  .getter('hostname')\n  .getter('href')\n  .getter('origin')\n  .getter('path')\n  .getter('protocol')\n  .getter('query')\n  .getter('url')\n  .getter('search')\n  .getter('searchParams');\n\nexport default proto;\n","import { parse as parseQueryString } from 'querystring';\n\nexport default {\n  get search() {\n    return window.location.search;\n  },\n  get path() {\n    return window.location.pathname;\n  },\n  get port() {\n    return window.location.port;\n  },\n  get url() {\n    return window.location.url;\n  },\n  get origin() {\n    return window.location.origin;\n  },\n  get protocol() {\n    return window.location.protocol;\n  },\n  get query() {\n    return parseQueryString(window.location.search);\n  },\n  get searchParams() {\n    return new URLSearchParams(\n      window.location.search.length === 0\n        ? window.location.search\n        : window.location.search.substr(1),\n    );\n  },\n  get href() {\n    return window.location.href;\n  },\n  get host() {\n    return window.location.host;\n  },\n  get hostname() {\n    return window.location.hostname;\n  },\n};\n","export default {\n  redirect(url) {\n    if (this.app.emit('redirect', url) === false) {\n      window.location.href = url;\n    }\n  },\n};\n","import { EventEmitter } from 'events';\nimport Logger from 'nightingale-logger';\nimport compose from './compose';\nimport context from './context';\nimport request from './request';\nimport response from './response';\n\nconst logger = new Logger('ibex');\n\nfunction respond(ctx) {\n  // allow bypassing\n  if (ctx.respond === false) {\n    return;\n  }\n\n  const body = ctx.body;\n  if (body == null) return;\n\n  // const code = ctx.status;\n\n  if (typeof body === 'string') {\n    document.body.innerHTML = body;\n    return;\n  }\n\n  if (body.nodeType) {\n    document.body.innerHTML = '';\n    document.body.appendChild(body);\n  }\n\n  throw new Error('Invalid body result');\n}\n\nexport default class Application extends EventEmitter {\n  middleware: Array<Function> = [];\n  context: Object = Object.create(context);\n\n  constructor() {\n    super();\n    this.context.app = this;\n    this.context.state = {};\n  }\n\n  get environment(): string {\n    return this.env;\n  }\n\n  use(fn: Function) {\n    logger.debug('use', { name: fn.name || '-' });\n    this.middleware.push(fn);\n    return this;\n  }\n\n  onerror(e: any) {\n    logger.error(e);\n  }\n\n  run(url: mixed) {\n    if (!this.listeners('error').length) {\n      this.on('error', this.onerror);\n    }\n\n    this.callback = compose(this.middleware);\n\n    if (url) {\n      this.load(url);\n    }\n  }\n\n  createContext() {\n    const context = Object.create(this.context);\n    context.request = Object.create(request);\n    context.response = Object.create(response);\n    // eslint-disable-next-line no-multi-assign\n    context.request.app = context.response.app = this;\n    return context;\n  }\n\n  load(url: string) {\n    logger.debug('load', { url });\n\n    if (url.startsWith('?')) {\n      url = window.location.pathname + url;\n    }\n\n    const context = this.createContext();\n    return this.callback(context)\n      .then(() => respond(context))\n      .catch(err => this.emit('error', err));\n  }\n}\n"],"names":["compose","middlewares","ctx","index","dispatch","i","Promise","reject","Error","fn","called","resolve","call","e","proto","delegate","access","method","getter","search","window","location","path","pathname","port","url","origin","protocol","query","parseQueryString","searchParams","URLSearchParams","length","substr","href","host","hostname","app","emit","logger","Logger","respond","body","innerHTML","nodeType","appendChild","Application","middleware","context","Object","create","state","debug","name","push","error","listeners","on","onerror","callback","load","request","response","startsWith","createContext","then","catch","err","env","EventEmitter"],"mappings":"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"}