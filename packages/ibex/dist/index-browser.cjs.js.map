{"version":3,"file":"index-browser.cjs.js","sources":["../src/compose.ts","../src/context.ts","../src/request.ts","../src/response.ts","../src/index.ts"],"sourcesContent":["import { PRODUCTION } from 'pob-babel';\nimport type {\n  Middleware as ComposeMiddleware,\n  ComposedMiddleware,\n} from 'koa-compose';\n\nexport type Composed<Context> = ComposedMiddleware<Context>;\nexport type Middleware<Context> = ComposeMiddleware<Context>;\n\n// TODO create lib\nexport default function compose<Context>(\n  middlewares: Middleware<Context>[],\n): Composed<Context> {\n  return function (ctx: Context): Promise<any> {\n    let index = -1;\n    return (function dispatch(i: number): Promise<any> {\n      if (i <= index) {\n        return Promise.reject(\n          new Error(PRODUCTION ? undefined : 'next() called multiple times'),\n        );\n      }\n      index = i;\n\n      const fn = middlewares[i];\n\n      let called = false;\n      try {\n        return Promise.resolve(\n          fn.call(\n            ctx,\n            ctx,\n            (): Promise<any> => {\n              if (called) {\n                throw new Error(\n                  PRODUCTION ? undefined : 'Cannot call next() more than once.',\n                );\n              }\n              called = true;\n              return dispatch(i + 1);\n            },\n          ),\n        );\n      } catch (err) {\n        return Promise.reject(err);\n      }\n    })(0);\n  };\n}\n","const proto = {};\n\nconst defineGetter = (target: string, name: string): void => {\n  Object.defineProperty(proto, name, {\n    get() {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return, @typescript-eslint/no-unsafe-member-access\n      return this[target][name];\n    },\n  });\n};\n\nconst defineAccess = (target: string, name: string): void => {\n  Object.defineProperty(proto, name, {\n    get() {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return, @typescript-eslint/no-unsafe-member-access\n      return this[target][name];\n    },\n    set(value) {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment,  @typescript-eslint/no-unsafe-member-access\n      this[target][name] = value;\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n      return value;\n    },\n  });\n};\n\nconst defineMethod = (target: string, name: string): void => {\n  Object.defineProperty(proto, name, {\n    value(...args: any[]) {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return, @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-call\n      return this[target][name].call(this[target], ...args);\n    },\n  });\n};\n\ndefineAccess('response', 'body');\ndefineMethod('response', 'redirect');\n\ndefineGetter('request', 'host');\ndefineGetter('request', 'hostname');\ndefineGetter('request', 'href');\ndefineGetter('request', 'origin');\ndefineGetter('request', 'path');\ndefineGetter('request', 'protocol');\ndefineGetter('request', 'query');\ndefineGetter('request', 'url');\ndefineGetter('request', 'search');\ndefineGetter('request', 'searchParams');\n\nexport default proto;\n","import type { ParsedUrlQuery } from 'querystring';\nimport { parse as parseQueryString } from 'querystring';\nimport type { BaseRequest as KoaBaseRequest } from 'koa';\nimport type Application from '.';\n\nexport interface BaseRequest {\n  readonly url: string;\n  readonly origin: string;\n  readonly href: string;\n  readonly path: string;\n  readonly searchParams: URLSearchParams;\n  readonly query: ParsedUrlQuery;\n  readonly querystring: string;\n  readonly search: string;\n  readonly host: string;\n  readonly protocol: string;\n  readonly hostname: string;\n  readonly headers: Record<string, string>;\n\n  accepts: KoaBaseRequest['accepts'];\n  acceptsLanguages: KoaBaseRequest['acceptsLanguages'];\n}\n\nexport interface Request extends BaseRequest {\n  readonly app: Application;\n}\n\nconst request: BaseRequest = {\n  get search() {\n    return window.location.search;\n  },\n  get path() {\n    return window.location.pathname;\n  },\n  get url() {\n    return window.location.pathname + window.location.search;\n  },\n  get origin() {\n    return window.location.origin;\n  },\n  get protocol() {\n    return window.location.protocol;\n  },\n  get query() {\n    return window.location.search.length === 0\n      ? {}\n      : parseQueryString(window.location.search.slice(1));\n  },\n  get querystring() {\n    return window.location.search;\n  },\n  get searchParams() {\n    return new URLSearchParams(\n      window.location.search.length === 0\n        ? window.location.search\n        : window.location.search.slice(1),\n    );\n  },\n  get href() {\n    return window.location.href;\n  },\n  get host() {\n    return window.location.host;\n  },\n  get hostname() {\n    return window.location.hostname;\n  },\n  get headers(): never {\n    throw new Error('Headers not available in ibex request.');\n  },\n  get accepts(): never {\n    throw new Error('Not implemented.');\n  },\n  get acceptsLanguages(): never {\n    throw new Error('Not implemented.');\n  },\n};\n\nexport default request;\n","import type Application from '.';\n\nexport interface BaseResponse {\n  redirect: (url: string) => Promise<void>;\n}\n\nexport interface Response extends BaseResponse {\n  readonly app: Application;\n}\n\nconst response: BaseResponse = {\n  redirect(this: Response, url: string): Promise<void> {\n    if (this.app.emit('redirect', url) === false) {\n      window.location.href = url;\n      return new Promise(() => {\n        // promise that never resolves.\n      });\n    }\n\n    return Promise.resolve();\n  },\n};\n\nexport default response;\n","import { EventEmitter } from 'events';\nimport type { BaseContext as KoaBaseContext } from 'koa';\nimport Logger from 'nightingale-logger';\nimport type { Composed, Middleware as ComposeMiddleware } from './compose';\nimport compose from './compose';\nimport context from './context';\nimport type { Request } from './request';\nimport request from './request';\nimport type { Response } from './response';\nimport response from './response';\n\nexport interface BaseContext extends KoaBaseContext {\n  app: Application;\n  redirect: (url: string) => Promise<void>;\n}\nexport interface DefaultState {}\nexport interface DefaultSanitizedState {}\n\nexport interface Context extends BaseContext {\n  request: Request;\n  response: Response;\n  req: never;\n  res: never;\n  originalUrl: string;\n  cookies: never;\n  state: DefaultState;\n  sanitizedState: DefaultSanitizedState;\n  respond?: boolean;\n}\n\nexport type Middleware = ComposeMiddleware<Context>;\n\nconst logger = new Logger('ibex');\n\nfunction respond(ctx: Context): void {\n  // allow bypassing\n  if (ctx.respond === false) {\n    return;\n  }\n\n  const body: unknown = ctx.body;\n  if (body == null) return;\n\n  // const code = ctx.status;\n\n  if (typeof body === 'string') {\n    document.body.innerHTML = body;\n    return;\n  }\n\n  if ((body as Node).nodeType) {\n    document.body.innerHTML = '';\n    document.body.append(body as Node);\n  }\n\n  throw new Error('Invalid body result');\n}\n\nexport default class Application extends EventEmitter {\n  middleware: Middleware[] = [];\n\n  context: BaseContext = Object.create(context) as BaseContext;\n\n  callback?: Composed<Context>;\n\n  constructor() {\n    super();\n    this.context.app = this;\n  }\n\n  use(fn: Middleware): this {\n    logger.debug('use', { name: fn.name || '-' });\n    this.middleware.push(fn);\n    return this;\n  }\n\n  onerror(e: any): void {\n    logger.error(e);\n  }\n\n  run(url?: string): void {\n    if (this.listeners('error').length === 0) {\n      this.on('error', this.onerror);\n    }\n\n    this.callback = compose(this.middleware);\n\n    if (url) {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      this.load(url);\n    }\n  }\n\n  createContext(): Context {\n    const context: Context = Object.create(this.context) as Context;\n    context.request = Object.create(request) as Request;\n    context.response = Object.create(response) as Response;\n    Object.assign(context.request, { app: this });\n    Object.assign(context.response, { app: this });\n    context.state = {};\n    context.sanitizedState = {};\n    return context;\n  }\n\n  load(url: string): Promise<void> {\n    logger.debug('load', { url });\n\n    if (url.startsWith('?')) {\n      url = window.location.pathname + url;\n    }\n\n    if (!this.callback) {\n      throw new Error('You should call load() after run()');\n    }\n\n    const context = this.createContext();\n    return this.callback(context)\n      .then(() => respond(context))\n      .catch((err) => {\n        this.emit('error', err);\n      });\n  }\n}\n"],"names":["compose","middlewares","ctx","index","dispatch","i","Promise","reject","Error","undefined","fn","called","resolve","call","err","proto","defineGetter","target","name","Object","defineProperty","get","defineAccess","set","value","defineMethod","args","request","search","window","location","path","pathname","url","origin","protocol","query","length","parseQueryString","slice","querystring","searchParams","URLSearchParams","href","host","hostname","headers","accepts","acceptsLanguages","response","redirect","app","emit","logger","Logger","respond","body","document","innerHTML","nodeType","append","Application","middleware","context","create","use","debug","push","onerror","e","error","run","listeners","on","callback","load","createContext","assign","state","sanitizedState","startsWith","then","catch","EventEmitter"],"mappings":"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"}