{"version":3,"sources":["../src/index.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAIqB;;;;;;;;;AACjB,aADiB,WACjB,GAAc;8BADG,aACH;;2EADG,yBACH;;AAEV,cAAK,UAAL,GAAkB,EAAlB,CAFU;AAGV,cAAK,OAAL,GAAe,OAAO,MAAP,mBAAf,CAHU;AAIV,cAAK,aAAL,GAAqB,EAArB,CAJU;;KAAd;;iBADiB;;;;;+BAYZ,IAAI;AACL,iBAAK,aAAL,CAAmB,IAAnB,CAAwB,GAAG,IAAH,CAAxB,EADK;;;;;;;8BAIL,IAAI;;AAEJ,iBAAK,UAAL,CAAgB,IAAhB,CAAqB,EAArB,EAFI;AAGJ,mBAAO,IAAP,CAHI;;;;;;;kCAMA,GAAG;AACP,oBAAQ,GAAR,CAAY,EAAE,KAAF,IAAW,EAAE,OAAF,IAAa,CAAxB,CAAZ;AADO;;;;;gCAIL;;;AACF,mBAAO,QAAQ,GAAR,CAAY,KAAK,aAAL,CAAZ,CAAgC,IAAhC,CAAqC,YAAM;AAC9C,uBAAO,OAAK,aAAL,CADuC;;AAG9C,oBAAI,CAAC,OAAK,SAAL,CAAe,OAAf,EAAwB,MAAxB,EAAgC;AACjC,2BAAK,EAAL,CAAQ,OAAR,EAAiB,OAAK,OAAL,CAAjB,CADiC;iBAArC;;AAIA,uBAAK,QAAL,GAAgB,uBAAQ,OAAK,UAAL,CAAxB,CAP8C;aAAN,CAA5C,CADE;;;;;;;+BAYD,KAAK;;;AACN,gBAAI,IAAI,UAAJ,CAAe,GAAf,CAAJ,EAAyB;AACrB,sBAAM,OAAO,QAAP,CAAgB,QAAhB,GAA2B,GAA3B,CADe;aAAzB;;AAIA,iBAAK,OAAL,CAAa,IAAb,GAAoB,GAApB,CALM;AAMN,iBAAK,QAAL,CAAc,IAAd,CAAmB,KAAK,OAAL,CAAnB,CACK,IADL,CACU;uBAAM,QAAQ,IAAR,CAAa,OAAK,OAAL;aAAnB,CADV,CAEK,KAFL,CAEW,UAAC,GAAD;uBAAS,OAAK,IAAL,CAAU,OAAV,EAAmB,GAAnB;aAAT,CAFX,CANM;;;;;;8BA9BQ;AACd,mBAAO,KAAK,GAAL,CADO;;;;WARD;;;;;;;;AAkDrB,SAAS,OAAT,GAAmB;;AAEf,QAAI,KAAK,OAAL,KAAiB,KAAjB,EAAwB;AACxB,eADwB;KAA5B;;AAIA,QAAI,CAAC,KAAK,QAAL,EAAe,OAApB;;AAEA,QAAI,OAAO,KAAK,IAAL;;;AARI,QAWX,OAAO,IAAP,KAAgB,QAAhB,EAA0B;AAC1B,iBAAS,IAAT,CAAc,SAAd,GAA0B,IAA1B,CAD0B;AAE1B,eAF0B;KAA9B;;AAKA,QAAI,KAAK,QAAL,EAAe;AACf,iBAAS,IAAT,CAAc,SAAd,GAA0B,EAA1B,CADe;AAEf,iBAAS,IAAT,CAAc,WAAd,CAA0B,IAA1B,EAFe;KAAnB;;AAKA,UAAM,IAAI,KAAJ,CAAU,qBAAV,CAAN,CArBe;CAAnB","file":"index.js","sourcesContent":["import { EventEmitter } from 'events';\nimport compose from './compose';\nimport context from './context';\n\nexport default class Application extends EventEmitter {\n    constructor() {\n        super();\n        this.middleware = [];\n        this.context = Object.create(context);\n        this._initPromises = [];\n    }\n\n    get environment() {\n        return this.env;\n    }\n\n    init(fn) {\n        this._initPromises.push(fn(this));\n    }\n\n    use(fn) {\n        // logger.debug('use', {name: fn._name || fn.name || '-'});\n        this.middleware.push(fn);\n        return this;\n    }\n\n    onerror(e) {\n        console.log(e.stack || e.message || e); // eslint-disable-line no-console\n    }\n\n    run() {\n        return Promise.all(this._initPromises).then(() => {\n            delete this._initPromises;\n\n            if (!this.listeners('error').length) {\n                this.on('error', this.onerror);\n            }\n\n            this.callback = compose(this.middleware);\n        });\n    }\n\n    load(url) {\n        if (url.startsWith('?')) {\n            url = window.location.pathname + url;\n        }\n\n        this.context.path = url;\n        this.callback.call(this.context)\n            .then(() => respond.call(this.context))\n            .catch((err) => this.emit('error', err));\n    }\n}\n\nfunction respond() {\n    // allow bypassing\n    if (this.respond === false) {\n        return;\n    }\n\n    if (!this.writable) return;\n\n    let body = this.body;\n    // let code = this.status;\n\n    if (typeof body === 'string') {\n        document.body.innerHTML = body;\n        return;\n    }\n\n    if (body.nodeType) {\n        document.body.innerHTML = '';\n        document.body.appendChild(body);\n    }\n\n    throw new Error('Invalid body result');\n}\n"]}