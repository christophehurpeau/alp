{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import { deprecate } from 'util';\nimport argv from 'minimist-argv';\nimport deepFreeze from 'deep-freeze-es6';\nimport parseJSON from 'parse-json-object-as-map';\nimport { existsSync, readFileSync } from 'fs';\n\nfunction _existsConfigSync(dirname: string, name: string) {\n    return existsSync(`${dirname}${name}.json`);\n}\n\nfunction _loadConfigSync(dirname: string, name: string) {\n    let content = readFileSync(`${dirname}${name}.json`);\n    return parseJSON(content);\n}\n\ntype ConfigOptions = {\n    argv?: Array<string>,\n    packageConfig?: Object,\n    version?: string,\n}\n\nexport class Config {\n    _map: Map;\n    _dirname: string;\n\n    constructor(dirname: string) {\n        this._map = new Map();\n        this._dirname = dirname.replace(/\\/*$/, '/');\n    }\n\n    loadSync(options: ConfigOptions = {}): Map {\n        const env = process.env.CONFIG_ENV || process.env.NODE_ENV || 'development';\n        const { argv: argvOverrides = [], packageConfig, version } = options;\n\n        const config = this.loadConfigSync('common');\n        for (let [key, value] of this.loadConfigSync(env)) {\n            config.set(key, value);\n        }\n\n        if (this.existsConfigSync('local')) {\n            for (let [key, value] of this.loadConfigSync('local')) {\n                config.set(key, value);\n            }\n        }\n\n        if (!config.has('version')) {\n            config.set('version', version || packageConfig.version);\n        }\n\n        let socketPath = argv['socket-path'] || argv.socketPath;\n        if (socketPath) {\n            config.set('socketPath', socketPath);\n        } else if (argv.port) {\n            config.set('port', argv.port);\n            config.delete('socketPath');\n        }\n\n        argvOverrides.forEach(key => {\n            if (argv[key] !== undefined) {\n                const splitted = key.split('.');\n                const last = splitted.pop();\n                const map = splitted.length === 0 ? config\n                    : splitted.reduce((config, partialKey) => config.get(partialKey), config);\n                map.set(last, argv[key]);\n            }\n        });\n\n        return this._map = deepFreeze(config);\n    }\n\n    get(key: string): any {\n        return this._map.get(key);\n    }\n\n    existsConfigSync(name: string): boolean {\n        return _existsConfigSync(this._dirname, name);\n    }\n\n    loadConfigSync(name: string): Map {\n        return _loadConfigSync(this._dirname, name);\n    }\n}\n\nexport default function alpConfig(dirname: ?string, options: ConfigOptions = {}) {\n    return (app, config: ?Config) => {\n        if (!config) {\n            config = new Config(dirname, options);\n            config.loadSync(options);\n        }\n\n        app.existsConfig = deprecate((name) => config.existsConfigSync(name), 'use app.existsConfigSync');\n        app.loadConfig = deprecate((name) => config.loadConfigSync(name), 'use app.loadConfigSync');\n\n        app.config = config;\n        app.context.config = config;\n\n        return config;\n    };\n}\n"]}