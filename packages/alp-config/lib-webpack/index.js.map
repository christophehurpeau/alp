{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import { deprecate } from 'util';\nimport argv from 'minimist-argv';\nimport deepFreeze from 'deep-freeze-es6';\nimport parseJSON from 'parse-json-object-as-map';\nimport { existsSync, readFileSync } from 'fs';\n\nfunction _existsConfigSync(dirname: string, name: string) {\n    return existsSync(`${dirname}${name}.json`);\n}\n\nfunction _loadConfigSync(dirname: string, name: string) {\n    let content = readFileSync(`${dirname}${name}.json`);\n    return parseJSON(content);\n}\n\ntype ConfigOptions = {\n    argv?: Array<string>,\n    packageConfig?: Object,\n    version?: string,\n}\n\nexport class Config {\n    _map: Map;\n    _dirname: string;\n\n    constructor(dirname: string) {\n        this._map = new Map();\n        this._dirname = dirname.replace(/\\/*$/, '/');\n    }\n\n    loadSync(options: ConfigOptions = {}): Map {\n        const env = process.env.CONFIG_ENV || process.env.NODE_ENV || 'development';\n        const { argv: argvOverrides = [], packageConfig, version } = options;\n\n        const config = this.loadConfigSync('common');\n        for (let [key, value] of this.loadConfigSync(env)) {\n            config.set(key, value);\n        }\n\n        if (this.existsConfigSync('local')) {\n            for (let [key, value] of this.loadConfigSync('local')) {\n                config.set(key, value);\n            }\n        }\n\n        if (!config.has('version')) {\n            config.set('version', version || argv.version || packageConfig.version);\n        }\n\n        let socketPath = argv['socket-path'] || argv.socketPath;\n        if (socketPath) {\n            config.set('socketPath', socketPath);\n        } else if (argv.port) {\n            config.set('port', argv.port);\n            config.delete('socketPath');\n        }\n\n        argvOverrides.forEach(key => {\n            const splitted = key.split('.');\n            const value = splitted.length !== 0\n                && splitted.reduce((config, partialKey) => config && config[partialKey], argv);\n            if (value !== undefined) {\n                const last = splitted.pop();\n                const map = splitted.length === 0 ? config\n                    : splitted.reduce((config, partialKey) => config.get(partialKey), config);\n                map.set(last, value);\n            }\n        });\n\n        return this._map = deepFreeze(config);\n    }\n\n    get(key: string): any {\n        return this._map.get(key);\n    }\n\n    existsConfigSync(name: string): boolean {\n        return _existsConfigSync(this._dirname, name);\n    }\n\n    loadConfigSync(name: string): Map {\n        return _loadConfigSync(this._dirname, name);\n    }\n}\n\nexport default function alpConfig(dirname: ?string, options: ConfigOptions = {}) {\n    return (app, config: ?Config) => {\n        if (!config) {\n            config = new Config(dirname, options);\n            config.loadSync(options);\n        }\n\n        app.existsConfig = deprecate((name) => config.existsConfigSync(name), 'use app.existsConfigSync');\n        app.loadConfig = deprecate((name) => config.loadConfigSync(name), 'use app.loadConfigSync');\n\n        app.existsConfigSync = name => config.existsConfigSync(name);\n        app.loadConfigSync = name => config.loadConfigSync(name);\n\n        app.config = config;\n        app.context.config = config;\n\n        return config;\n    };\n}\n"]}