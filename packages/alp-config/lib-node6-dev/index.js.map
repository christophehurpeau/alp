{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import { deprecate } from 'util';\nimport argv from 'minimist-argv';\nimport deepFreeze from 'deep-freeze-es6';\nimport parseJSON from 'parse-json-object-as-map';\nimport { existsSync, readFileSync } from 'fs';\n\nfunction _existsConfigSync(dirname: string, name: string) {\n    return existsSync(`${dirname}${name}.json`);\n}\n\nfunction _loadConfigSync(dirname: string, name: string) {\n    let content = readFileSync(`${dirname}${name}.json`);\n    return parseJSON(content);\n}\n\ntype ConfigOptions = {\n    argv?: Array<string>,\n    packageConfig?: Object,\n    version?: string,\n}\n\nexport class Config {\n    _map: Map;\n    _dirname: string;\n    packageConfig: Object;\n\n    constructor(dirname: string) {\n        this._map = new Map();\n        this._dirname = dirname.replace(/\\/*$/, '/');\n    }\n\n    loadSync(options: ConfigOptions = {}): Map {\n        const env = process.env.CONFIG_ENV || process.env.NODE_ENV || 'development';\n        const { argv: argvOverrides = [], packageConfig, version } = options;\n        this.packageConfig = packageConfig;\n\n        const config = this.loadConfigSync('common');\n        for (let [key, value] of this.loadConfigSync(env)) {\n            config.set(key, value);\n        }\n\n        if (this.existsConfigSync('local')) {\n            for (let [key, value] of this.loadConfigSync('local')) {\n                config.set(key, value);\n            }\n        }\n\n        if (!config.has('version')) {\n            config.set('version', version || argv.version || packageConfig.version);\n        }\n\n        let socketPath = argv['socket-path'] || argv.socketPath;\n        if (socketPath) {\n            config.set('socketPath', socketPath);\n        } else if (argv.port) {\n            config.set('port', argv.port);\n            config.delete('socketPath');\n        }\n\n        argvOverrides.forEach(key => {\n            const splitted = key.split('.');\n            const value = splitted.length !== 0\n                && splitted.reduce((config, partialKey) => config && config[partialKey], argv);\n            if (value !== undefined) {\n                const last = splitted.pop();\n                const map = splitted.length === 0 ? config\n                    : splitted.reduce((config, partialKey) => config.get(partialKey), config);\n                map.set(last, value);\n            }\n        });\n\n        return this._map = deepFreeze(config);\n    }\n\n    get(key: string): any {\n        return this._map.get(key);\n    }\n\n    existsConfigSync(name: string): boolean {\n        return _existsConfigSync(this._dirname, name);\n    }\n\n    loadConfigSync(name: string): Map {\n        return _loadConfigSync(this._dirname, name);\n    }\n}\n\nexport default function alpConfig(dirname: ?string, options: ConfigOptions = {}) {\n    return (app, config: ?Config) => {\n        if (!config) {\n            config = new Config(dirname, options);\n            config.loadSync(options);\n        }\n\n        app.existsConfig = deprecate((name) => config.existsConfigSync(name), 'use app.existsConfigSync');\n        app.loadConfig = deprecate((name) => config.loadConfigSync(name), 'use app.loadConfigSync');\n\n        app.existsConfigSync = name => config.existsConfigSync(name);\n        app.loadConfigSync = name => config.loadConfigSync(name);\n\n        app.config = config;\n        app.context.config = config;\n\n        return config;\n    };\n}\n"]}