{"version":3,"file":"index-browser-dev.es.js","sources":["../src/index.js"],"sourcesContent":["import { existsSync, readFileSync } from 'fs';\nimport { deprecate } from 'util';\nimport argv from 'minimist-argv';\nimport deepFreeze from 'deep-freeze-es6';\nimport parseJSON from 'parse-json-object-as-map';\n\nfunction _existsConfigSync(dirname: string, name: string) {\n  return existsSync(`${dirname}${name}.json`);\n}\n\nfunction _loadConfigSync(dirname: string, name: string) {\n  const content = readFileSync(`${dirname}${name}.json`);\n  return parseJSON(content);\n}\n\ntype ConfigOptions = {|\n  argv?: ?Array<string>,\n  packageConfig?: ?Object,\n  version?: ?string,\n|};\n\nexport class Config {\n  _map: Map<string, any>;\n  _dirname: string;\n  packageConfig: Object;\n\n  constructor(dirname: string) {\n    this._map = new Map();\n    this._dirname = dirname.replace(/\\/*$/, '/');\n  }\n\n  loadSync(options: ConfigOptions = {}): Map<string, any> {\n    const env = process.env.CONFIG_ENV || process.env.NODE_ENV || 'development';\n    const { argv: argvOverrides = [], packageConfig, version } = options;\n    this.packageConfig = packageConfig;\n\n    const config = this.loadConfigSync('common');\n    // eslint-disable-next-line no-restricted-syntax\n    for (const [key, value] of this.loadConfigSync(env)) {\n      config.set(key, value);\n    }\n\n    if (this.existsConfigSync('local')) {\n      // eslint-disable-next-line no-restricted-syntax\n      for (const [key, value] of this.loadConfigSync('local')) {\n        config.set(key, value);\n      }\n    }\n\n    if (config.has('version')) {\n      throw new Error('Cannot have \"version\", in config.');\n    }\n\n    config.set('version', version || argv.version || packageConfig.version);\n\n    const socketPath = argv['socket-path'] || argv.socketPath;\n    if (socketPath) {\n      config.set('socketPath', socketPath);\n    } else if (argv.port) {\n      config.set('port', argv.port);\n      config.delete('socketPath');\n    } else if (process.env.PORT) {\n      config.set('port', Number(process.env.PORT));\n      config.delete('socketPath');\n    }\n\n    argvOverrides.forEach(key => {\n      const splitted = key.split('.');\n      const value =\n        splitted.length !== 0 &&\n        splitted.reduce((config, partialKey) => config && config[partialKey], argv);\n      if (value !== undefined) {\n        const last = splitted.pop();\n        const map =\n          splitted.length === 0\n            ? config\n            : splitted.reduce((config, partialKey) => config.get(partialKey), config);\n        map.set(last, value);\n      }\n    });\n\n    this._map = deepFreeze(config);\n    return this._map;\n  }\n\n  get(key: string): any {\n    return this._map.get(key);\n  }\n\n  existsConfigSync(name: string): boolean {\n    return _existsConfigSync(this._dirname, name);\n  }\n\n  loadConfigSync(name: string): Map<string, any> {\n    return _loadConfigSync(this._dirname, name);\n  }\n}\n\nexport default function alpConfig(dirname: ?string, options: ConfigOptions = {}) {\n  return (app, config: ?Config) => {\n    if (!config) {\n      config = new Config(dirname);\n      config.loadSync(options);\n    }\n\n    app.existsConfig = deprecate(name => config.existsConfigSync(name), 'use app.existsConfigSync');\n    app.loadConfig = deprecate(name => config.loadConfigSync(name), 'use app.loadConfigSync');\n\n    app.existsConfigSync = name => config.existsConfigSync(name);\n    app.loadConfigSync = name => config.loadConfigSync(name);\n\n    app.config = config;\n    app.context.config = config;\n\n    return config;\n  };\n}\n"],"names":["_existsConfigSync","dirname","name","existsSync","_loadConfigSync","content","readFileSync","parseJSON","Config","_map","Map","_dirname","replace","options","env","process","CONFIG_ENV","NODE_ENV","argv","argvOverrides","packageConfig","version","config","loadConfigSync","key","value","set","existsConfigSync","has","Error","socketPath","port","delete","PORT","Number","forEach","splitted","split","length","reduce","partialKey","undefined","last","pop","map","get","deepFreeze","alpConfig","app","loadSync","existsConfig","deprecate","loadConfig","context"],"mappings":"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"}