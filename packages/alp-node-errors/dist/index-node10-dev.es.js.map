{"version":3,"file":"index-node10-dev.es.js","sources":["../src/index.ts"],"sourcesContent":["import { STATUS_CODES } from 'http';\nimport ErrorHtmlRenderer from 'error-html';\nimport Logger from 'nightingale-logger';\nimport { Context } from 'alp-types';\n\nconst logger = new Logger('alp:errors');\nconst errorHtmlRenderer = new ErrorHtmlRenderer({\n  appPath: `${process.cwd()}/`,\n});\n\nexport default async function alpNodeErrors(\n  ctx: Context,\n  next: () => void | Promise<void>,\n): Promise<void> {\n  try {\n    await next();\n  } catch (err) {\n    // eslint-disable-next-line no-ex-assign\n    if (!err) err = new Error('Unknown error');\n    // eslint-disable-next-line no-ex-assign\n    if (typeof err === 'string') err = new Error(err);\n\n    ctx.status = err.status || 500;\n    logger.error(err);\n\n    switch (ctx.accepts('html', 'text', 'json')) {\n      case 'text':\n        ctx.type = 'text/plain';\n        if (process.env.NODE_ENV !== 'production' || err.expose) {\n          ctx.body = err.message;\n        } else {\n          throw err;\n        }\n\n        break;\n\n      case 'json':\n        ctx.type = 'application/json';\n        if (process.env.NODE_ENV !== 'production' || err.expose) {\n          ctx.body = { error: err.message };\n        } else {\n          ctx.body = { error: STATUS_CODES[ctx.status] };\n        }\n\n        break;\n\n      case 'html':\n        ctx.type = 'text/html';\n        if (process.env.NODE_ENV !== 'production') {\n          ctx.body = errorHtmlRenderer.render(err);\n        } else if (err.expose) {\n          ctx.body = err.message;\n        } else {\n          throw err;\n        }\n\n        break;\n    }\n  }\n}\n"],"names":["logger","Logger","errorHtmlRenderer","ErrorHtmlRenderer","appPath","process","cwd","alpNodeErrors","ctx","next","err","Error","status","error","accepts","type","env","NODE_ENV","expose","body","message","STATUS_CODES","render"],"mappings":";;;;AAKA,MAAMA,MAAM,GAAG,IAAIC,MAAJ,CAAW,YAAX,CAAf;AACA,MAAMC,iBAAiB,GAAG,IAAIC,iBAAJ,CAAsB;AAC9CC,EAAAA,OAAO,EAAG,GAAEC,OAAO,CAACC,GAAR,EAAc;AADoB,CAAtB,CAA1B;AAIe,eAAeC,aAAf,CACbC,GADa,EAEbC,IAFa,EAGE;AACf,MAAI;AACF,UAAMA,IAAI,EAAV;AACD,GAFD,CAEE,OAAOC,GAAP,EAAY;AACZ;AACA,QAAI,CAACA,GAAL,EAAUA,GAAG,GAAG,IAAIC,KAAJ,CAAU,eAAV,CAAN,CAFE;;AAIZ,QAAI,OAAOD,GAAP,KAAe,QAAnB,EAA6BA,GAAG,GAAG,IAAIC,KAAJ,CAAUD,GAAV,CAAN;AAE7BF,IAAAA,GAAG,CAACI,MAAJ,GAAaF,GAAG,CAACE,MAAJ,IAAc,GAA3B;AACAZ,IAAAA,MAAM,CAACa,KAAP,CAAaH,GAAb;;AAEA,YAAQF,GAAG,CAACM,OAAJ,CAAY,MAAZ,EAAoB,MAApB,EAA4B,MAA5B,CAAR;AACE,WAAK,MAAL;AACEN,QAAAA,GAAG,CAACO,IAAJ,GAAW,YAAX;;AACA,YAAIV,OAAO,CAACW,GAAR,CAAYC,QAAZ,KAAyB,YAAzB,IAAyCP,GAAG,CAACQ,MAAjD,EAAyD;AACvDV,UAAAA,GAAG,CAACW,IAAJ,GAAWT,GAAG,CAACU,OAAf;AACD,SAFD,MAEO;AACL,gBAAMV,GAAN;AACD;;AAED;;AAEF,WAAK,MAAL;AACEF,QAAAA,GAAG,CAACO,IAAJ,GAAW,kBAAX;;AACA,YAAIV,OAAO,CAACW,GAAR,CAAYC,QAAZ,KAAyB,YAAzB,IAAyCP,GAAG,CAACQ,MAAjD,EAAyD;AACvDV,UAAAA,GAAG,CAACW,IAAJ,GAAW;AAAEN,YAAAA,KAAK,EAAEH,GAAG,CAACU;AAAb,WAAX;AACD,SAFD,MAEO;AACLZ,UAAAA,GAAG,CAACW,IAAJ,GAAW;AAAEN,YAAAA,KAAK,EAAEQ,YAAY,CAACb,GAAG,CAACI,MAAL;AAArB,WAAX;AACD;;AAED;;AAEF,WAAK,MAAL;AACEJ,QAAAA,GAAG,CAACO,IAAJ,GAAW,WAAX;;AACA,YAAIV,OAAO,CAACW,GAAR,CAAYC,QAAZ,KAAyB,YAA7B,EAA2C;AACzCT,UAAAA,GAAG,CAACW,IAAJ,GAAWjB,iBAAiB,CAACoB,MAAlB,CAAyBZ,GAAzB,CAAX;AACD,SAFD,MAEO,IAAIA,GAAG,CAACQ,MAAR,EAAgB;AACrBV,UAAAA,GAAG,CAACW,IAAJ,GAAWT,GAAG,CAACU,OAAf;AACD,SAFM,MAEA;AACL,gBAAMV,GAAN;AACD;;AAED;AA/BJ;AAiCD;AACF;;;;"}