{"version":3,"file":"index-node14.mjs","sources":["../src/index.ts"],"sourcesContent":["import { STATUS_CODES } from 'http';\nimport type { Context, HtmlError } from 'alp-types';\nimport ErrorHtmlRenderer from 'error-html';\nimport { Logger } from 'nightingale-logger';\n\nconst logger = new Logger('alp:errors');\nconst errorHtmlRenderer = new ErrorHtmlRenderer({\n  appPath: `${process.cwd()}/`,\n});\n\nexport default async function alpNodeErrors(\n  ctx: Context,\n  next: () => void | Promise<void>,\n): Promise<void> {\n  try {\n    await next();\n  } catch (err: unknown) {\n    // eslint-disable-next-line no-ex-assign\n    if (!err) err = new Error('Unknown error');\n    // eslint-disable-next-line no-ex-assign\n    if (typeof err === 'string') err = new Error(err);\n\n    ctx.status = (err as HtmlError).status || 500;\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n    logger.error(err as any);\n\n    // eslint-disable-next-line @typescript-eslint/switch-exhaustiveness-check\n    switch (ctx.request.accepts('html', 'text', 'json')) {\n      case 'text':\n        ctx.type = 'text/plain';\n        if (\n          process.env.NODE_ENV !== 'production' ||\n          (err as HtmlError).expose\n        ) {\n          ctx.body = (err as Error).message;\n        } else {\n          throw err;\n        }\n\n        break;\n\n      case 'json':\n        ctx.type = 'application/json';\n        if (\n          process.env.NODE_ENV !== 'production' ||\n          (err as HtmlError).expose\n        ) {\n          ctx.body = { error: (err as Error).message };\n        } else {\n          ctx.body = { error: STATUS_CODES[ctx.status] };\n        }\n\n        break;\n\n      case 'html':\n        ctx.type = 'text/html';\n        if (process.env.NODE_ENV !== 'production') {\n          ctx.body = errorHtmlRenderer.render(err as Error);\n        } else if ((err as HtmlError).expose) {\n          ctx.body = (err as Error).message;\n        } else {\n          throw err;\n        }\n\n        break;\n    }\n  }\n}\n"],"names":["logger","Logger","errorHtmlRenderer","ErrorHtmlRenderer","appPath","process","cwd","alpNodeErrors","ctx","next","err","Error","status","error","request","accepts","type","env","NODE_ENV","expose","body","message","STATUS_CODES","render"],"mappings":";;;;AAKA,MAAMA,MAAM,GAAG,IAAIC,MAAJ,CAAW,YAAX,CAAf,CAAA;AACA,MAAMC,iBAAiB,GAAG,IAAIC,iBAAJ,CAAsB;AAC9CC,EAAAA,OAAO,EAAG,CAAA,EAAEC,OAAO,CAACC,GAAR,EAAc,CAAA,CAAA,CAAA;AADoB,CAAtB,CAA1B,CAAA;AAIe,eAAeC,aAAf,CACbC,GADa,EAEbC,IAFa,EAGE;EACf,IAAI;AACF,IAAA,MAAMA,IAAI,EAAV,CAAA;GADF,CAEE,OAAOC,GAAP,EAAqB;AACrB;IACA,IAAI,CAACA,GAAL,EAAUA,GAAG,GAAG,IAAIC,KAAJ,CAAU,eAAV,CAAN,CAFW;;IAIrB,IAAI,OAAOD,GAAP,KAAe,QAAnB,EAA6BA,GAAG,GAAG,IAAIC,KAAJ,CAAUD,GAAV,CAAN,CAAA;IAE7BF,GAAG,CAACI,MAAJ,GAAcF,GAAD,CAAmBE,MAAnB,IAA6B,GAA1C,CANqB;;AAQrBZ,IAAAA,MAAM,CAACa,KAAP,CAAaH,GAAb,EARqB;;IAWrB,QAAQF,GAAG,CAACM,OAAJ,CAAYC,OAAZ,CAAoB,MAApB,EAA4B,MAA5B,EAAoC,MAApC,CAAR;AACE,MAAA,KAAK,MAAL;QACEP,GAAG,CAACQ,IAAJ,GAAW,YAAX,CAAA;;QACA,IACEX,OAAO,CAACY,GAAR,CAAYC,QAAZ,KAAyB,YAAzB,IACCR,GAAD,CAAmBS,MAFrB,EAGE;AACAX,UAAAA,GAAG,CAACY,IAAJ,GAAYV,GAAD,CAAeW,OAA1B,CAAA;AACD,SALD,MAKO;AACL,UAAA,MAAMX,GAAN,CAAA;AACD,SAAA;;AAED,QAAA,MAAA;;AAEF,MAAA,KAAK,MAAL;QACEF,GAAG,CAACQ,IAAJ,GAAW,kBAAX,CAAA;;QACA,IACEX,OAAO,CAACY,GAAR,CAAYC,QAAZ,KAAyB,YAAzB,IACCR,GAAD,CAAmBS,MAFrB,EAGE;UACAX,GAAG,CAACY,IAAJ,GAAW;YAAEP,KAAK,EAAGH,GAAD,CAAeW,OAAAA;WAAnC,CAAA;AACD,SALD,MAKO;UACLb,GAAG,CAACY,IAAJ,GAAW;AAAEP,YAAAA,KAAK,EAAES,YAAY,CAACd,GAAG,CAACI,MAAL,CAAA;WAAhC,CAAA;AACD,SAAA;;AAED,QAAA,MAAA;;AAEF,MAAA,KAAK,MAAL;QACEJ,GAAG,CAACQ,IAAJ,GAAW,WAAX,CAAA;;AACA,QAAA,IAAIX,OAAO,CAACY,GAAR,CAAYC,QAAZ,KAAyB,YAA7B,EAA2C;UACzCV,GAAG,CAACY,IAAJ,GAAWlB,iBAAiB,CAACqB,MAAlB,CAAyBb,GAAzB,CAAX,CAAA;AACD,SAFD,MAEO,IAAKA,GAAD,CAAmBS,MAAvB,EAA+B;AACpCX,UAAAA,GAAG,CAACY,IAAJ,GAAYV,GAAD,CAAeW,OAA1B,CAAA;AACD,SAFM,MAEA;AACL,UAAA,MAAMX,GAAN,CAAA;AACD,SAAA;;AAED,QAAA,MAAA;AArCJ,KAAA;AAuCD,GAAA;AACF;;;;"}