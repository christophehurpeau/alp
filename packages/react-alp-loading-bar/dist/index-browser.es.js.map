{"version":3,"file":"index-browser.es.js","sources":["../src/index.tsx"],"sourcesContent":["import type { ReactElement } from 'react';\nimport { PureComponent } from 'react';\nimport ReactAlpContext from 'react-alp-context';\n\n/*\nExample with antd:\nimport { Progress } from 'antd';\n\nconst LoadingBarComponent = ({ progress }) => (\n  <Progress\n    type=\"line\"\n    status=\"active\"\n    percent={progress}\n    showInfo={false}\n  />\n);\n*/\n\n/* number between 0 and 1 */\nconst random = (): number => Math.ceil(Math.random() * 100) / 100;\n\n/**\n * around:\n * at 100ms 20%\n * at 1s 40%\n * at 2s 60%\n * at 3s 80%\n */\nconst calculatePercent = (percent: number): number => {\n  if (percent < 60) return percent + random() * 10 + 5;\n  if (percent < 70) return percent + random() * 10 + 3;\n  else if (percent < 80) return percent + random() + 5;\n  else if (percent < 90) return percent + random() + 1;\n  else if (percent < 95) return percent + 0.1;\n  else return percent;\n};\n\ninterface LoadingBarProps {\n  LoadingBarComponent: React.ComponentType<{ progress: number }>;\n}\n\ninterface LoadingBarState {\n  loading: boolean;\n  hidden: boolean;\n  progress: number;\n}\n\ninterface WebsocketInterface {\n  isConnected: () => boolean;\n  on: (event: 'connect' | 'disconnect', callback: () => unknown) => void;\n}\n\nexport default class LoadingBar extends PureComponent<\n  LoadingBarProps,\n  LoadingBarState\n> {\n  static contextType = ReactAlpContext;\n\n  state = {\n    loading: true,\n    hidden: true,\n    progress: 1,\n  };\n\n  fadeOffTimeout?: ReturnType<typeof setTimeout>;\n\n  resetTimeout?: ReturnType<typeof setTimeout>;\n\n  first20Timeout?: ReturnType<typeof setTimeout>;\n\n  progressTimer?: ReturnType<typeof setTimeout>;\n\n  componentDidMount(): void {\n    const websocket = this.getWebsocket();\n    if (websocket.isConnected()) {\n      this.setState((prevState) => ({\n        loading: false,\n        progress: 100,\n        hidden: prevState.hidden || prevState.progress === 100,\n      }));\n    }\n    websocket.on('connect', () => {\n      this.setState({ loading: false });\n    });\n    websocket.on('disconnect', () => {\n      this.setState({ loading: true, progress: 1, hidden: false });\n    });\n  }\n\n  componentDidUpdate(\n    prevProps: LoadingBarProps,\n    prevState: LoadingBarState,\n  ): void {\n    if (this.state.loading !== prevState.loading) {\n      if (this.state.loading) {\n        this.showBar();\n      } else {\n        this.hideBar();\n      }\n    }\n  }\n\n  componentWillUnmount(): void {\n    if (this.fadeOffTimeout) clearTimeout(this.fadeOffTimeout);\n    if (this.resetTimeout) clearTimeout(this.resetTimeout);\n    if (this.first20Timeout) clearTimeout(this.first20Timeout);\n    if (this.progressTimer) clearInterval(this.progressTimer);\n  }\n\n  getWebsocket(): WebsocketInterface {\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-return\n    return (this.context as any).app.websocket;\n  }\n\n  private showBar(): void {\n    if (this.fadeOffTimeout) clearTimeout(this.fadeOffTimeout);\n    if (this.resetTimeout) clearTimeout(this.resetTimeout);\n\n    this.first20Timeout = setTimeout(() => {\n      this.setState({ progress: 20 });\n    }, 100);\n\n    this.progressTimer = setInterval(() => {\n      this.setState((prevState) => {\n        const newValue = calculatePercent(prevState.progress);\n        return { progress: newValue };\n      });\n    }, 500);\n  }\n\n  private hideBar(): void {\n    if (this.first20Timeout) clearTimeout(this.first20Timeout);\n    if (this.progressTimer) clearInterval(this.progressTimer);\n\n    this.fadeOffTimeout = setTimeout(() => {\n      this.setState({\n        progress: 100,\n      });\n    }, 500);\n\n    this.resetTimeout = setTimeout(() => {\n      this.setState({\n        hidden: true,\n        progress: 1,\n      });\n    }, 1000);\n  }\n\n  render(): ReactElement {\n    const LoadingBarComponent = this.props.LoadingBarComponent;\n\n    return (\n      <div\n        hidden={this.state.hidden}\n        style={{\n          position: 'fixed',\n          top: 0,\n          left: 0,\n          right: 0,\n          zIndex: 4,\n          pointerEvents: 'none',\n        }}\n      >\n        <LoadingBarComponent progress={this.state.progress} />\n      </div>\n    );\n  }\n}\n"],"names":["random","Math","ceil","calculatePercent","percent","LoadingBar","_PureComponent","_inheritsLoose","_this","_len","args","_key","arguments","length","Array","call","apply","concat","state","loading","hidden","progress","_proto","prototype","componentDidMount","_this2","websocket","getWebsocket","isConnected","setState","prevState","on","componentDidUpdate","prevProps","showBar","hideBar","componentWillUnmount","fadeOffTimeout","clearTimeout","resetTimeout","first20Timeout","progressTimer","clearInterval","context","app","_this3","setTimeout","setInterval","newValue","_this4","render","LoadingBarComponent","props","_jsx","style","position","top","left","right","zIndex","pointerEvents","children","PureComponent","contextType","ReactAlpContext"],"mappings":"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"}