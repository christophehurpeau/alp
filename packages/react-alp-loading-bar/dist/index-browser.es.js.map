{"version":3,"file":"index-browser.es.js","sources":["../src/index.tsx"],"sourcesContent":["import type { ReactElement } from 'react';\nimport { PureComponent } from 'react';\nimport ReactAlpContext from 'react-alp-context';\n\n/*\nExample with antd:\nimport { Progress } from 'antd';\n\nconst LoadingBarComponent = ({ progress }) => (\n  <Progress\n    type=\"line\"\n    status=\"active\"\n    percent={progress}\n    showInfo={false}\n  />\n);\n*/\n\n/* number between 0 and 1 */\nconst random = (): number => Math.ceil(Math.random() * 100) / 100;\n\n/**\n * around:\n * at 100ms 20%\n * at 1s 40%\n * at 2s 60%\n * at 3s 80%\n */\nconst calculatePercent = (percent: number): number => {\n  if (percent < 60) return percent + random() * 10 + 5;\n  if (percent < 70) return percent + random() * 10 + 3;\n  else if (percent < 80) return percent + random() + 5;\n  else if (percent < 90) return percent + random() + 1;\n  else if (percent < 95) return percent + 0.1;\n  else return percent;\n};\n\ninterface LoadingBarProps {\n  LoadingBarComponent: React.ComponentType<{ progress: number }>;\n}\n\ninterface LoadingBarState {\n  loading: boolean;\n  hidden: boolean;\n  progress: number;\n}\n\ninterface WebsocketInterface {\n  isConnected: () => boolean;\n  on: (event: 'connect' | 'disconnect', callback: () => unknown) => void;\n}\n\nexport default class LoadingBar extends PureComponent<\n  LoadingBarProps,\n  LoadingBarState\n> {\n  static contextType = ReactAlpContext;\n\n  state = {\n    loading: true,\n    hidden: true,\n    progress: 1,\n  };\n\n  fadeOffTimeout?: ReturnType<typeof setTimeout>;\n\n  resetTimeout?: ReturnType<typeof setTimeout>;\n\n  first20Timeout?: ReturnType<typeof setTimeout>;\n\n  progressTimer?: ReturnType<typeof setTimeout>;\n\n  componentDidMount(): void {\n    const websocket = this.getWebsocket();\n    if (websocket.isConnected()) {\n      this.setState((prevState) => ({\n        loading: false,\n        progress: 100,\n        hidden: prevState.hidden || prevState.progress === 100,\n      }));\n    }\n    websocket.on('connect', () => {\n      this.setState({ loading: false });\n    });\n    websocket.on('disconnect', () => {\n      this.setState({ loading: true, progress: 1, hidden: false });\n    });\n  }\n\n  componentDidUpdate(\n    prevProps: LoadingBarProps,\n    prevState: LoadingBarState,\n  ): void {\n    if (this.state.loading !== prevState.loading) {\n      if (this.state.loading) {\n        this.showBar();\n      } else {\n        this.hideBar();\n      }\n    }\n  }\n\n  componentWillUnmount(): void {\n    if (this.fadeOffTimeout) clearTimeout(this.fadeOffTimeout);\n    if (this.resetTimeout) clearTimeout(this.resetTimeout);\n    if (this.first20Timeout) clearTimeout(this.first20Timeout);\n    if (this.progressTimer) clearInterval(this.progressTimer);\n  }\n\n  getWebsocket(): WebsocketInterface {\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-return\n    return (this.context as any).app.websocket;\n  }\n\n  private showBar(): void {\n    if (this.fadeOffTimeout) clearTimeout(this.fadeOffTimeout);\n    if (this.resetTimeout) clearTimeout(this.resetTimeout);\n\n    this.first20Timeout = setTimeout(() => {\n      this.setState({ progress: 20 });\n    }, 100);\n\n    this.progressTimer = setInterval(() => {\n      this.setState((prevState) => {\n        const newValue = calculatePercent(prevState.progress);\n        return { progress: newValue };\n      });\n    }, 500);\n  }\n\n  private hideBar(): void {\n    if (this.first20Timeout) clearTimeout(this.first20Timeout);\n    if (this.progressTimer) clearInterval(this.progressTimer);\n\n    this.fadeOffTimeout = setTimeout(() => {\n      this.setState({\n        progress: 100,\n      });\n    }, 500);\n\n    this.resetTimeout = setTimeout(() => {\n      this.setState({\n        hidden: true,\n        progress: 1,\n      });\n    }, 1000);\n  }\n\n  render(): ReactElement {\n    const LoadingBarComponent = this.props.LoadingBarComponent;\n\n    return (\n      <div\n        hidden={this.state.hidden}\n        style={{\n          position: 'fixed',\n          top: 0,\n          left: 0,\n          right: 0,\n          zIndex: 4,\n          pointerEvents: 'none',\n        }}\n      >\n        <LoadingBarComponent progress={this.state.progress} />\n      </div>\n    );\n  }\n}\n"],"names":["random","Math","ceil","calculatePercent","percent","LoadingBar","state","loading","hidden","progress","componentDidMount","websocket","getWebsocket","isConnected","setState","prevState","on","componentDidUpdate","prevProps","showBar","hideBar","componentWillUnmount","fadeOffTimeout","clearTimeout","resetTimeout","first20Timeout","progressTimer","clearInterval","context","app","setTimeout","setInterval","newValue","render","LoadingBarComponent","props","_jsx","position","top","left","right","zIndex","pointerEvents","PureComponent","contextType","ReactAlpContext"],"mappings":"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"}